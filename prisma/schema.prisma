generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ENUMS (Factura + e-Factura ready)

enum CustomerType {
  PF
  PJ
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PAID
  CANCELLED
}

enum EFacturaStatus {
  NONE
  READY
  SENT
  ACCEPTED
  REJECTED
}

enum VatCategory {
  S
  Z
  E
  AE
  K
  O
}

// CORE MODELS (existente)

model Tenant {
  id        String   @id
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime?

  products       Product[]
  customers      Customer[]
  invoices       Invoice[]
  companyProfile CompanyProfile?
}

model Product {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name      String
  uom       String   @default("buc")
  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime?

  invoiceItems InvoiceItem[]

  @@index([tenantId])
}

model Customer {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // EXISTENTE (păstrate)
  name      String
  email     String?
  phone     String?
  vatCode   String?
  regNo     String?
  address   String?
  city      String?
  country   String?  @default("RO")
  notes     String?

  // NOI (e-Factura-ready)
  type         CustomerType @default(PJ)
  taxId        String?
  addressLine1 String?
  addressLine2 String?
  county       String?
  postalCode   String?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  invoices  Invoice[]

  @@index([tenantId])
  @@index([tenantId, name])
}

// COMPANY PROFILE (emitent / setări per tenant)

model CompanyProfile {
  id       String @id @default(cuid())
  tenantId String @unique
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name       String
  taxId      String
  regCom     String?
  isVatPayer Boolean @default(true)

  country      String @default("RO")
  county       String?
  city         String?
  addressLine1 String?
  addressLine2 String?
  postalCode   String?

  iban     String?
  bankName String?

  invoiceSeries      String @default("FCT")
  invoiceNumberStart Int    @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// INVOICE (Factura) + ITEMS

model Invoice {
  id        String @id @default(cuid())
  tenantId  String
  tenant    Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  series    String
  number    Int
  issueDate DateTime @default(now())
  dueDate   DateTime?

  status   InvoiceStatus @default(DRAFT)
  currency String        @default("RON")

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Restrict)

  subtotal Decimal @db.Decimal(18, 2) @default(0)
  vatTotal  Decimal @db.Decimal(18, 2) @default(0)
  total     Decimal @db.Decimal(18, 2) @default(0)

  efacturaStatus   EFacturaStatus @default(NONE)
  efacturaUploadId String?
  efacturaErrors   String?

  items     InvoiceItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@unique([tenantId, series, number])
  @@index([tenantId, customerId])
}

model InvoiceItem {
  id        String @id @default(cuid())
  tenantId  String

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  productId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  description String
  uom         String @default("buc")

  quantity  Decimal @db.Decimal(18, 3) @default(1)
  unitPrice Decimal @db.Decimal(18, 2) @default(0)

  vatRate     Decimal     @db.Decimal(5, 2) @default(19)
  vatCategory VatCategory @default(S)

  lineNet   Decimal @db.Decimal(18, 2) @default(0)
  lineVat   Decimal @db.Decimal(18, 2) @default(0)
  lineTotal Decimal @db.Decimal(18, 2) @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([invoiceId])
}
