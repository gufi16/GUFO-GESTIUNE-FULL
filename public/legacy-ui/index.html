<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>POSHARD • Gestiune (Demo UI)</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --panel:#ffffff;
      --muted:#6b7280;
      --text:#0f172a;
      --border:rgba(15,23,42,.10);
      --shadow: 0 10px 30px rgba(15,23,42,.08);
      --shadow2: 0 6px 18px rgba(15,23,42,.10);
      --primary:#2563eb;
      --primary2:#1d4ed8;
      --chip:#eef2ff;
      --danger:#dc2626;
      --radius:18px;
      --radius2:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
      background: radial-gradient(900px 600px at 5% 0%, rgba(37,99,235,.10), transparent 55%),
                  radial-gradient(900px 600px at 95% 10%, rgba(99,102,241,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
    }

    /* Layout */
    .app{
      display:grid;
      grid-template-columns: 280px 1fr;
      grid-template-rows: 72px 1fr;
      grid-template-areas:
        "sidebar topbar"
        "sidebar main";
      height:100%;
    }
    .topbar{
      grid-area: topbar;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 14px 22px;
      border-bottom:1px solid var(--border);
      backdrop-filter: blur(12px);
      background: rgba(246,247,251,.60);
      position:sticky; top:0; z-index:5;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      font-weight:750;
      letter-spacing:.2px;
    }
    .logo{
      width:38px; height:38px; border-radius:12px;
      background: linear-gradient(135deg, var(--primary), #7c3aed);
      box-shadow: var(--shadow2);
      display:grid; place-items:center; color:#fff;
      font-weight:800;
    }
    .search{
      flex:1;
      max-width: 620px;
      margin:0 18px;
      display:flex; align-items:center;
      gap:10px;
      padding: 10px 12px;
      border:1px solid var(--border);
      border-radius: 999px;
      background: var(--panel);
      box-shadow: 0 1px 0 rgba(15,23,42,.04);
    }
    .search input{
      border:0; outline:0; width:100%;
      font-size:14px; background:transparent; color:var(--text);
    }
    .top-actions{
      display:flex; align-items:center; gap:10px;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: var(--chip);
      border:1px solid rgba(37,99,235,.15);
      color: var(--primary2);
      font-weight:650;
      font-size:13px;
      user-select:none;
    }
    .icon-btn{
      width:40px; height:40px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: var(--panel);
      display:grid; place-items:center;
      box-shadow: 0 1px 0 rgba(15,23,42,.04);
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .icon-btn:hover{ transform: translateY(-1px); box-shadow: var(--shadow2); border-color: rgba(37,99,235,.25); }
    .icon{ width:18px; height:18px; opacity:.85; }

    .sidebar{
      grid-area: sidebar;
      border-right:1px solid var(--border);
      background: rgba(255,255,255,.70);
      backdrop-filter: blur(14px);
      padding: 14px 14px 18px;
      overflow:auto;
    }
    .sidebar .section-title{
      margin: 18px 10px 10px;
      font-size: 12px;
      color: var(--muted);
      letter-spacing:.12em;
      font-weight:800;
      text-transform:uppercase;
    }
    .nav{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .nav-btn{
      display:flex;
      align-items:center;
      gap:12px;
      padding: 12px 12px;
      border-radius: 16px;
      border:1px solid var(--border);
      background: var(--panel);
      cursor:pointer;
      text-align:left;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      box-shadow: 0 1px 0 rgba(15,23,42,.04);
    }
    .nav-btn:hover{ transform: translateY(-1px); box-shadow: var(--shadow2); border-color: rgba(37,99,235,.25); }
    .nav-btn.active{
      border-color: rgba(37,99,235,.35);
      box-shadow: 0 10px 26px rgba(37,99,235,.12);
      background: linear-gradient(180deg, rgba(37,99,235,.07), rgba(255,255,255,1));
    }
    .nav-ico{
      width:42px; height:42px; border-radius: 14px;
      display:grid; place-items:center;
      background: rgba(37,99,235,.10);
      border:1px solid rgba(37,99,235,.18);
    }
    .nav-ico svg{ width:20px; height:20px; color: var(--primary2); }
    .nav-meta{
      display:flex; flex-direction:column; gap:2px;
      min-width:0;
    }
    .nav-title{
      font-weight:800; font-size: 14px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .nav-sub{
      font-size:12px; color: var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .main{
      grid-area: main;
      padding: 18px 22px 24px;
      overflow:auto;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.35fr .65fr;
      gap:16px;
      align-items:start;
    }
    .card{
      background: var(--panel);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-head{
      padding: 16px 16px 10px;
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:12px;
    }
    .card h2{
      margin:0;
      font-size: 16px;
      letter-spacing:.2px;
    }
    .card p{ margin:6px 0 0; color: var(--muted); font-size: 13px; line-height:1.35; }
    .card-body{ padding: 0 16px 16px; }
    .quick-grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .quick{
      border:1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
      background: linear-gradient(180deg, rgba(37,99,235,.05), rgba(255,255,255,1));
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .quick:hover{ transform: translateY(-1px); box-shadow: var(--shadow2); border-color: rgba(37,99,235,.25); }
    .quick .t{ font-weight:850; font-size: 13px; }
    .quick .s{ margin-top:4px; color:var(--muted); font-size:12px; line-height:1.25; }

    .list{
      display:flex; flex-direction:column; gap:10px;
    }
    .item{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding: 12px 12px;
      border-radius: 16px;
      border:1px solid var(--border);
      background: #fff;
    }
    .item .left{ display:flex; flex-direction:column; gap:3px; min-width:0; }
    .item .a{ font-weight:800; font-size: 13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .item .b{ color: var(--muted); font-size: 12px; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: #fff;
      font-weight:750; font-size: 12px;
    }

    /* Drawer (slide) */
    .backdrop{
      position:fixed; inset:0;
      background: rgba(15,23,42,.35);
      opacity:0; pointer-events:none;
      transition: opacity .18s ease;
      z-index: 20;
    }
    .backdrop.show{ opacity:1; pointer-events:auto; }
    .drawer{
      position:fixed;
      top: 12px;
      right: 12px;
      bottom: 12px;
      width: min(520px, calc(100vw - 24px));
      background: var(--panel);
      border:1px solid var(--border);
      border-radius: 22px;
      box-shadow: var(--shadow);
      transform: translateX(110%);
      transition: transform .22s ease;
      z-index: 25;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .drawer.show{ transform: translateX(0); }
    .drawer-head{
      padding: 14px 14px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, rgba(37,99,235,.06), rgba(255,255,255,1));
    }
    .drawer-title{
      display:flex; flex-direction:column; gap:2px;
    }
    .drawer-title .h{ font-weight:900; letter-spacing:.2px; }
    .drawer-title .s{ color:var(--muted); font-size:12px; }
    .drawer-close{
      width:40px; height:40px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: #fff;
      cursor:pointer;
      display:grid; place-items:center;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .drawer-close:hover{ transform: translateY(-1px); box-shadow: var(--shadow2); border-color: rgba(37,99,235,.25); }
    .drawer-body{
      padding: 14px;
      overflow:auto;
    }
    .drawer-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .action{
      border:1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
      background: #fff;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      min-height: 72px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:6px;
    }
    .action:hover{ transform: translateY(-1px); box-shadow: var(--shadow2); border-color: rgba(37,99,235,.25); }
    .action .t{ font-weight:900; font-size: 13px; letter-spacing:.15px; }
    .action .s{ color: var(--muted); font-size: 12px; line-height:1.25; }

    /* Responsive */
    @media (max-width: 980px){
      .app{ grid-template-columns: 92px 1fr; }
      .nav-meta{ display:none; }
      .sidebar{ padding: 14px 10px; }
      .nav-btn{ justify-content:center; padding: 12px; }
      .nav-ico{ width:44px; height:44px; }
      .search{ display:none; }
      .grid{ grid-template-columns: 1fr; }
      .quick-grid{ grid-template-columns: 1fr; }
    }

    /* Small helper */
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--muted);
    }
  
    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(15,23,42,.42);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 40;
    }
    .modal-backdrop.show{ display:flex; }
    .modal{
      width: min(980px, 100%);
      height: min(860px, calc(100vh - 36px));
      max-height: min(860px, calc(100vh - 36px));
      overflow:hidden;
      display:flex;
      flex-direction:column;
      background: var(--panel);
      border:1px solid var(--border);
      border-radius: 22px;
      box-shadow: var(--shadow);
    }
    .modal-head{
      padding: 14px 16px 10px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, rgba(37,99,235,.06), rgba(255,255,255,1));
    }
    .modal-title{
      display:flex; flex-direction:column; gap:2px;
    }
    .modal-title .h{ font-weight:950; letter-spacing:.2px; }
    .modal-title .s{ color: var(--muted); font-size: 12px; }
    .modal-close{
      width:40px; height:40px;
      border-radius: 14px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      display:grid; place-items:center;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .modal-close:hover{ transform: translateY(-1px); box-shadow: var(--shadow2); border-color: rgba(37,99,235,.25); }
    .modal-body{ padding: 14px 16px 16px; flex:1; overflow:auto; min-height:0; }
    .form-grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr .8fr;
      gap:10px;
      align-items:end;
    }
    .field{ display:flex; flex-direction:column; gap:6px; min-width:0; }
    .field label{ font-size: 12px; color: var(--muted); font-weight:800; letter-spacing:.02em; }
    .field input, .field select{
      height: 40px;
      border-radius: 14px;
      border:1px solid var(--border);
      background:#fff;
      padding: 8px 12px;
      outline:none;
      font-size: 14px;
      color: var(--text);
    }
    .field input:focus, .field select:focus{ border-color: rgba(37,99,235,.35); box-shadow: 0 0 0 4px rgba(37,99,235,.10); }
    .row{
      display:flex; gap:10px; align-items:end; flex-wrap:wrap;
    }
    .btn{
      height: 40px;
      border-radius: 14px;
      border:1px solid var(--border);
      background:#fff;
      padding: 0 12px;
      cursor:pointer;
      font-weight:850;
      color: var(--text);
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: var(--shadow2); border-color: rgba(37,99,235,.25); }
    .btn-primary{
      background: linear-gradient(135deg, var(--primary), #4f46e5);
      border-color: rgba(37,99,235,.35);
      color:#fff;
    }
    .btn-danger{
      background: #fff;
      border-color: rgba(220,38,38,.25);
      color: var(--danger);
    }
    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius: 16px;
      border:1px solid var(--border);
      background:#fff;
    }
    .table th, .table td{
      padding: 10px 10px;
      border-bottom:1px solid var(--border);
      font-size: 13px;
      text-align:left;
      vertical-align:middle;
    }
    .table th{
      background: rgba(37,99,235,.05);
      font-weight:950;
      color: var(--text);
    }
    .table tr:last-child td{ border-bottom:0; }
    .table input, .table select{
      width:100%;
      height: 36px;
      border-radius: 12px;
      border:1px solid var(--border);
      padding: 6px 10px;
      outline:none;
      font-size: 13px;
      background:#fff;
    }
    .totals{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      align-items:start;
    }
    .totals .box{
      border:1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
      background: #fff;
    }
    .totals .box .k{ color: var(--muted); font-size: 12px; font-weight:850; }
    .totals .box .v{ margin-top:6px; font-size: 18px; font-weight:950; letter-spacing:.2px; }
    .totals .box .v small{ font-size: 12px; color: var(--muted); font-weight:850; }
    .modal-actions{
      margin-top: 14px;
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    @media (max-width: 860px){
      .form-grid{ grid-template-columns: 1fr; }
      .totals{ grid-template-columns: 1fr; }
    }

  
    /* Receipt Modal */
    .split-head{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-items:end;
    }
    .hr{
      height:1px;
      background: var(--border);
      margin: 12px 0;
    }
    .section-h{
      font-weight:950;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size: 12px;
      color: var(--text);
      margin: 8px 0 10px;
    }
    .inline-actions{
      display:flex;
      gap:8px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .btn-ghost{
      background: rgba(37,99,235,.06);
      border-color: rgba(37,99,235,.18);
      color: var(--primary2);
    }
    .btn-muted{
      background:#fff;
      color: var(--muted);
    }
    .row-2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .row-3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 860px){
      .split-head{ grid-template-columns: 1fr; }
      .row-2, .row-3{ grid-template-columns: 1fr; }
    }

  
    /* Input focus safety */
    .modal, .modal *{ pointer-events:auto; }
    input, select, textarea{ -webkit-user-select:text; user-select:text; }

  
    /* Client Full Tabs */
    .btn[data-tab].active{
      background: rgba(37,99,235,.12);
      border-color: rgba(37,99,235,.28);
      color: var(--primary2);
    }

  
    /* Incasare Modal */
    .toolbar-right{ display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap; }
    .kpi-grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
      margin-top:10px;
    }
    .kpi{
      border:1px solid var(--border);
      border-radius: 16px;
      padding: 10px 12px;
      background:#fff;
    }
    .kpi .k{ color: var(--muted); font-size: 12px; font-weight:850; }
    .kpi .v{ margin-top:6px; font-size: 16px; font-weight:950; }
    .kpi .v small{ font-size: 12px; color: var(--muted); font-weight:850; }
    .table .chk{
      width:18px; height:18px;
      accent-color: var(--primary);
    }
    .status-pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 4px 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      font-size: 12px;
      font-weight:850;
      background:#fff;
    }
    .status-pill.ok{ border-color: rgba(34,197,94,.25); color: var(--ok); background: rgba(34,197,94,.06); }
    .status-pill.no{ border-color: rgba(220,38,38,.25); color: var(--danger); background: rgba(220,38,38,.06); }
    @media (max-width: 860px){
      .kpi-grid{ grid-template-columns: 1fr 1fr; }
    }

  
    /* Modal show hardening */
    .modal-backdrop.show{ display:flex !important; pointer-events:auto !important; }

  
    /* Modal stacking (z-index) */
    #incasareBackdrop{ z-index: 60; }
    #payBackdrop{ z-index: 70; }
    #receiptBackdrop{ z-index: 80; }
    #unitBackdrop{ z-index: 85; }
    #partnerBackdrop{ z-index: 85; }
    #clientFullBackdrop{ z-index: 90; } /* trebuie să fie peste Încasare */

  
    /* Gestiune lists stacking */
    #listClientsBackdrop{ z-index: 88; }
    #listSuppliersBackdrop{ z-index: 88; }
    #clientFullBackdrop{ z-index: 90; }

  
    /* doc settings tabs */
    .tabs{ display:flex; gap:10px; padding:8px; background:rgba(0,0,0,.03); border-radius:14px; margin-bottom:14px; }
    .tab{ padding:10px 14px; border-radius:12px; border:1px solid rgba(0,0,0,.08); background:transparent; font-weight:900; cursor:pointer; }
    .tab.active{ background:rgba(0,0,0,.06); }
    .tabpanels .panel{ display:none; }
    .tabpanels .panel.show{ display:block; }
    .hint{ margin-top:10px; color:var(--muted); font-weight:750; }
    #invoiceSettingsBackdrop{ z-index: 95; }

  
    /* docs lists */
    /* NIR */
    #nirBackdrop{ z-index: 94; }
    #nirProductBackdrop{ z-index: 97; }

    #docsInvoicesBackdrop, #docsProformasBackdrop, #docsReceiptsBackdrop{ z-index: 96; }
    .status-pill{ display:inline-flex; align-items:center; gap:10px; padding:8px 10px; border:1px solid var(--border); border-radius:999px; background:rgba(0,0,0,.02); }
    .status-pill input{ width:18px; height:18px; }
    .doc-actions{ display:flex; justify-content:flex-end; gap:8px; white-space:nowrap; }
    /* doc status picker */
    .doc-status-chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.02);
      font-weight:850;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .doc-status-chip:after{
      content:"▾";
      font-size:12px;
      opacity:.7;
    }
    .doc-status-chip[data-status="FINALIZATA"]{ background: rgba(34,197,94,.10); border-color: rgba(34,197,94,.25); }
    .doc-status-menu{
      position:fixed;
      min-width: 180px;
      border:1px solid var(--border);
      border-radius: 14px;
      background: var(--panel);
      box-shadow: var(--shadow2);
      padding:8px;
      z-index: 9999;
      display:none;
    }
    .doc-status-menu .opt{
      width:100%;
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 10px;
      border-radius: 12px;
      border:1px solid transparent;
      background:transparent;
      font-weight:900;
      cursor:pointer;
    }
    .doc-status-menu .opt:hover{
      background: rgba(0,0,0,.05);
      border-color: rgba(0,0,0,.06);
    }

    .btn.btn-danger{ background:#ef4444; border-color:#ef4444; color:#fff; }
    .btn.btn-danger:hover{ filter:brightness(.95); }

  
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(34,197,94,.12);color:#166534;font-weight:900;font-size:12px;}

    /* docs filters + scroll + pager (minimal, doar pentru ferestre Documente) */
    .docs-filters{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .docs-filters .btn{ padding:10px 12px; }
    .docs-filters .btn.active{ border-color: rgba(37,99,235,.45); box-shadow: 0 8px 18px rgba(37,99,235,.10); background: rgba(37,99,235,.08); }
    .docs-scroll{ max-height: 58vh; overflow:auto; border:1px solid var(--border); border-radius: 14px; background: var(--panel); }
    .docs-scroll .table{ margin-top:0 !important; border:0; }
    .docs-pager{ display:flex; align-items:center; justify-content:flex-end; gap:10px; padding:10px 2px 0; }
    .docs-pager .muted{ color: var(--muted); font-weight:800; }

  
/* --- Produse (ForIT-like) --- */
#productsBackdrop .products-modal{ width:min(1180px, calc(100vw - 56px)); height:min(760px, calc(100vh - 56px)); display:flex; flex-direction:column; }
#productsBackdrop .modal-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
#productsBackdrop .products-topbar{ display:flex; justify-content:space-between; align-items:center; gap:12px; padding:10px 12px; border:1px solid var(--border); border-radius:14px; background:rgba(255,255,255,.65); margin:10px 0; }
#productsBackdrop .pt-left{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
#productsBackdrop .pt-right{ display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
#productsBackdrop .pt-lbl{ font-weight:700; font-size:12px; color:var(--text); }
#productsBackdrop .pt-sel, #productsBackdrop .pt-inp{ height:34px; border-radius:10px; border:1px solid var(--border); background:#fff; padding:0 10px; font-size:13px; }
#productsBackdrop .pt-inp{ width:220px; }
#productsBackdrop .products-body{ display:flex; flex-direction:column; gap:10px; min-height:0; }
#productsBackdrop .products-table-wrap{ flex:1; min-height:0; overflow:auto; border:1px solid var(--border); border-radius:14px; background:#fff; }
#productsBackdrop .products-tbl{ width:100%; }
#productsBackdrop .products-tbl thead th{ position:sticky; top:0; z-index:1; background:#f5f7fb; }
#productsBackdrop .products-tbl tbody tr:hover{ background:#f7fbff; }
#productsBackdrop .products-tbl tbody tr.active{ background:#e6f1ff; }
#productsBackdrop .products-bottom{ border:1px solid var(--border); border-radius:14px; background:#fff; padding:10px; }
#productsBackdrop .prod-livebar{ padding:8px 10px; border-radius:12px; background:#f5f7fb; border:1px solid var(--border); font-weight:600; }
#productsBackdrop .prod-bottom-grid{ display:grid; grid-template-columns: 240px 1fr; gap:10px; margin-top:10px; }
#productsBackdrop .prod-left{ display:flex; flex-direction:column; gap:10px; }
#productsBackdrop .prod-pricebox{ border:1px solid var(--border); border-radius:12px; padding:10px; font-weight:800; font-size:16px; background:#fff; }
#productsBackdrop .prod-stock{ border:1px solid var(--border); border-radius:12px; padding:10px; display:flex; flex-direction:column; gap:8px; }
#productsBackdrop .prod-tabs{ border:1px solid var(--border); border-radius:12px; overflow:hidden; }
#productsBackdrop .tabs{ display:flex; gap:6px; padding:8px; background:#f5f7fb; border-bottom:1px solid var(--border); overflow:auto; }
#productsBackdrop .tab{ white-space:nowrap; padding:8px 10px; border:1px solid var(--border); border-radius:10px; background:#fff; font-weight:700; font-size:12px; cursor:pointer; }
#productsBackdrop .tab.active{ background:#e6f1ff; }
#productsBackdrop .tabpanels{ padding:10px; }
#productsBackdrop .tabpanel{ display:none; }
#productsBackdrop .tabpanel.show{ display:block; }
#productsBackdrop .prod-subhdr{ display:flex; justify-content:space-between; gap:10px; align-items:center; margin-bottom:8px; }
#productsBackdrop .prod-footer{ margin-top:10px; font-weight:700; }
#productsBackdrop .tbl.small th, #productsBackdrop .tbl.small td{ padding:6px 8px; font-size:12px; }
#productsBackdrop .muted{ color:var(--muted); }


/* Product Editor modal (modern) */
#productEditBackdrop .productedit-modal{ max-width: 1040px; width: min(1040px, calc(100vw - 28px)); border-radius: 18px; overflow: hidden; }
#productEditBackdrop .modal-head{ padding: 14px 16px; display:flex; align-items:center; justify-content:space-between; gap:12px; }
#productEditBackdrop .modal-title{ font-size: 16px; font-weight: 900; letter-spacing: .2px; }
#productEditBackdrop .modal-sub{ font-size: 12px; color: var(--muted); margin-top: 2px; font-weight: 700; }

#productEditBackdrop .tabs{ padding: 10px 12px 8px !important; gap: 8px; flex-wrap: wrap; border-bottom: 1px solid rgba(0,0,0,.06); background: #fff; }
#productEditBackdrop .tab{ border-radius: 999px; padding: 8px 12px; font-size: 12px; font-weight: 800; border: 1px solid rgba(0,0,0,.10); background: #fff; cursor: pointer; }
#productEditBackdrop .tab.active{ background: rgba(59,130,246,.10); border-color: rgba(59,130,246,.25); }

#productEditBackdrop .modal-body.prodedit-body{ padding: 14px; background: rgba(0,0,0,.02); max-height: calc(100vh - 190px); overflow: auto; }
#productEditBackdrop .pe-stack{ display: grid; gap: 12px; }

#productEditBackdrop .pe-card{ background: #fff; border: 1px solid rgba(0,0,0,.06); border-radius: 16px; padding: 12px; box-shadow: 0 8px 24px rgba(0,0,0,.06); }
#productEditBackdrop .pe-card-title{ font-weight: 900; font-size: 13px; margin: 0 0 10px; }

#productEditBackdrop .pe-grid{ display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }
#productEditBackdrop .pe-field{ display:flex; flex-direction:column; gap: 6px; }
#productEditBackdrop .pe-field label{ font-size: 12px; color: var(--muted); font-weight: 800; }

#productEditBackdrop .pe-field input,
#productEditBackdrop .pe-field textarea,
#productEditBackdrop .pe-field select{
  width: 100%;
  border: 1px solid rgba(0,0,0,.12);
  border-radius: 12px;
  background: #fff;
  padding: 10px 12px;
  font-weight: 700;
  outline: none;
}
#productEditBackdrop .pe-field input,
#productEditBackdrop .pe-field select{ height: 40px; }
#productEditBackdrop .pe-field textarea{ min-height: 96px; resize: vertical; }

#productEditBackdrop .pe-field input:focus,
#productEditBackdrop .pe-field textarea:focus,
#productEditBackdrop .pe-field select:focus{
  border-color: rgba(59,130,246,.55);
  box-shadow: 0 0 0 4px rgba(59,130,246,.12);
}

#productEditBackdrop .pe-row{ display:flex; gap: 8px; align-items:center; }
#productEditBackdrop .pe-row .btn{ height: 40px; padding: 0 12px; border-radius: 12px; }

#productEditBackdrop .chk{ display:flex; gap: 10px; align-items:center; font-size: 13px; color: var(--text); font-weight: 800; }
#productEditBackdrop .pe-inline{ justify-content:flex-start; padding-top: 24px; }

#productEditBackdrop .span-12{ grid-column: span 12; }
#productEditBackdrop .span-6{ grid-column: span 6; }
#productEditBackdrop .span-5{ grid-column: span 5; }
#productEditBackdrop .span-4{ grid-column: span 4; }
#productEditBackdrop .span-3{ grid-column: span 3; }
#productEditBackdrop .span-2{ grid-column: span 2; }

#productEditBackdrop .pe-empty{ padding: 18px; color: var(--muted); }

#productEditBackdrop .modal-foot{ background:#fff; border-top: 1px solid rgba(0,0,0,.06); padding: 12px 14px; display:flex; justify-content:flex-end; gap:10px; }
#productEditBackdrop #btnProdEditSave{ font-weight: 900; }
</style>

<style>
/* ===== FIX33 TOTALURI EXPUSE ===== */
#totalsExtended { margin-top:10px; border-top:1px solid rgba(0,0,0,.08); padding-top:10px; }
#totalsExtended .row { display:flex; justify-content:space-between; padding:6px 0; }
#totalsExtended .row b { font-weight:900; }
</style>

</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand" style="padding:6px 8px 10px;">
        <div class="logo">P</div>
        <div style="display:flex;flex-direction:column;gap:2px;">
          <div style="font-weight:900; letter-spacing:.2px;">POSHARD IMPEX</div>
          <div style="font-size:12px;color:var(--muted);">Interfață Gestiune • Light</div>
        </div>
      </div>

      <div class="section-title">Meniu principal</div>
      <div class="nav" id="mainNav">
        <!-- Buttons injected by JS to match your list -->
      </div>

      <div class="section-title">Sfat</div>
      <div class="card" style="box-shadow:none; background:rgba(255,255,255,.6);">
        <div class="card-body" style="padding:12px 12px 14px;">
          <div style="font-weight:850; font-size:13px;">Navigare rapidă</div>
          <p style="margin:6px 0 0;">Click pe un buton principal pentru a deschide slide-ul cu butoane secundare.</p>
          <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
            <span class="kbd">Esc</span><span class="kbd">închide slide</span>
          </div>
        </div>
      </div>
    </aside>

    <header class="topbar">
      <div class="brand">
        <div style="font-weight:900;">Dashboard</div>
        <div style="color:var(--muted); font-size:12px;">(UI demo)</div>
      </div>

      <div class="search" role="search">
        <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M21 21l-4.3-4.3m1.8-5.2a7 7 0 11-14 0 7 7 0 0114 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <input id="searchInput" placeholder="Caută (demo) — de ex. factura, stoc, clienti..." />
      </div>

      <div class="top-actions">
        <span class="chip" title="Cont activ">Admin</span>
        <button class="icon-btn" id="btnHelp" title="Ajutor (demo)" aria-label="Ajutor">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 18h.01M9.5 9a2.5 2.5 0 115 0c0 2-2.5 1.5-2.5 4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M12 22a10 10 0 110-20 10 10 0 010 20z" stroke="currentColor" stroke-width="2"/>
          </svg>
        </button>
        <button class="icon-btn" id="btnTheme" title="Tema (demo)" aria-label="Tema">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M21 12.8A8.5 8.5 0 1111.2 3 7 7 0 0021 12.8z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
    </header>

    <main class="main">
      <div class="grid">
        <section class="card">
          <div class="card-head">
            <div>
              <h2>Acțiuni rapide</h2>
              <p>Selecții comune (demo). Click = deschide slide-ul corespunzător sau afișează un mesaj.</p>
            </div>
            <span class="pill" id="activeModule">Neselectat</span>
          </div>
          <div class="card-body">
            <div class="quick-grid">
              <div class="quick" data-open="INREGISTRARE DOCUMENTE">
                <div class="t">Înregistrare documente</div>
                <div class="s">Factură, Proformă, Aviz, NIR etc.</div>
              </div>
              <div class="quick" data-open="GESTIUNE">
                <div class="t">Gestiune</div>
                <div class="s">Produse, clienți, furnizori, rulaj etc.</div>
              </div>
              <div class="quick" data-open="RAPOARTE">
                <div class="t">Rapoarte</div>
                <div class="s">Stoc, mișcări, vânzări, discounturi.</div>
              </div>
            </div>

            <div style="margin-top:14px;" class="list">
              <div class="item">
                <div class="left">
                  <div class="a">Ultima activitate</div>
                  <div class="b">Demo UI — fără backend.</div>
                </div>
                <span class="pill">Local</span>
              </div>
              <div class="item">
                <div class="left">
                  <div class="a">Stare integrare</div>
                  <div class="b">e-Factura / SAF-T / POS — de conectat în etape.</div>
                </div>
                <span class="pill">Planificare</span>
              </div>
            </div>
          </div>
        </section>

        <aside class="card">
          <div class="card-head">
            <div>
              <h2>Sumar</h2>
              <p>Carduri demonstrative pentru un dashboard modern.</p>
            </div>
          </div>
          <div class="card-body">
            <div class="list">
              <div class="item">
                <div class="left">
                  <div class="a">Documente</div>
                  <div class="b">Facturi, proforme, avize, NIR.</div>
                </div>
                <span class="pill">—</span>
              </div>
              <div class="item">
                <div class="left">
                  <div class="a">Stoc</div>
                  <div class="b">Intrări/ieșiri, mișcări, balanță.</div>
                </div>
                <span class="pill">—</span>
              </div>
              <div class="item">
                <div class="left">
                  <div class="a">Utilizatori</div>
                  <div class="b">Roluri, audit, istoric.</div>
                </div>
                <span class="pill">—</span>
              </div>
            </div>
          </div>
        </aside>
      </div>
    </main>
  </div>

  <!-- Drawer -->
  <div class="backdrop" id="backdrop" aria-hidden="true"></div>
  <aside class="drawer" id="drawer" aria-hidden="true">
    <div class="drawer-head">
      <div class="drawer-title">
        <div class="h" id="drawerTitle">Meniu</div>
        <div class="s" id="drawerSubtitle">Selectează o acțiune</div>
      </div>
      <button class="drawer-close" id="drawerClose" aria-label="Închide">
        <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
    <div class="drawer-body">
      <div class="drawer-grid" id="drawerGrid"></div>
    </div>
  </aside>

  <script>
    // Config: main buttons + secondary buttons (exact as provided)
    const MENU = [
      {
        key: "INREGISTRARE DOCUMENTE",
        hint: "Emiterea documentelor",
        icon: "docPlus",
        items: [
          "FACTURA","FACTURA PROFORMA","CHITANTA","INCASARE","DISPOZITII DE CASERIE","AVIZ","NOTA DE RECEPTIE",
          "BON DE CONSUM","BON DE TRANSFER","PROCES VERBAL DE DETERIOARE","PROCES VERBAL DE MODIFICARE PRET","PROCES VERBAL DE INVENTARIERE"
        ]
      },
      {
        key: "DOCUMENTE",
        hint: "Liste / arhivă",
        icon: "folder",
        items: [
          "FACTURI","FACTURI PROFORME","CHITANTE","DISPOZITII DE CASERIE","ORDIN DE PLATA","AVIZE","NOTE DE RECEPTII",
          "BONURI DE CONSUM","BONURI DE TRANSFER","PROCESE VERBALE DE DETERIOARE","PROCESE VERBALE DE MODIFICARE PRET","PROCESE VERBALE DE INVENTARIERE"
        ]
      },
      {
        key: "GESTIUNE",
        hint: "Stoc & parteneri",
        icon: "boxes",
        items: [
          "PRODUSE","INCHIDERE ZILNICA","CONFIGURARE GESTIUNE","FURNIZORI","CLIENTI","PRODUSE FINITE/RETETE",
          "GESTIONARE PRODUSE EXPIRATE","RETUR MARFA","ADMINISTRARE PROMOTII","ADAOS MAXIM","RULAJ MARFA",
          "CULEGERE DATE","PRODUSE /PROBLEME"
        ]
      },
      {
        key: "REGISTRU DE CASA / ALTE PLATI",
        hint: "Cashflow",
        icon: "cash",
        items: [
          "INREGISTRARE IN REGISTRU DE CASA","REGISTRU DE CASA","INREGISTRARE ALTA PLATA","ALTE PLATI"
        ]
      },
      {
        key: "RAPOARTE",
        hint: "Analiză & control",
        icon: "chart",
        items: [
          "STOC","RAPORT DE GESTIUNE","RAPORT DE PRODUCTIE","BALANTA STOCURILOR","MISCARI STOCURI","PRODUSE FURNIZORI",
          "SITUATIA VANZARILOR PRODUSELOR/CLIENTI","SITUATIA VANZARILOR PE PRODUSE","FACTURI/CLIENT","FACTURI EMISE",
          "BONURI FISCALE","RAPORT VANZARI","DISCOUNTURI","PRODUSE NEVANDUTE"
        ]
      },
      {
        key: "UTILIZATORI",
        hint: "Acces & audit",
        icon: "users",
        items: [
          "SCHIMBARE UTILIZATOR","SCHIMBARE PAROLA","INREGISTRARE UTILIZATOR","ISTORIC"
        ]
      },
      {
        key: "SETARI",
        hint: "Configurare",
        icon: "settings",
        items: [
          "SETARI FACTURA","SETARI INTERFATA DE VANZARE","SETARI LOCATII","SETARI GESTIUNE"
        ]
      }
    ];

    const ICONS = {
      docPlus: (c="currentColor") => `
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M14 2H7a2 2 0 00-2 2v16a2 2 0 002 2h10a2 2 0 002-2V8l-5-6z" stroke="${c}" stroke-width="2" stroke-linejoin="round"/>
          <path d="M14 2v6h6" stroke="${c}" stroke-width="2" stroke-linejoin="round"/>
          <path d="M12 11v6M9 14h6" stroke="${c}" stroke-width="2" stroke-linecap="round"/>
        </svg>`,
      folder: (c="currentColor") => `
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M3 7a2 2 0 012-2h5l2 2h7a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V7z" stroke="${c}" stroke-width="2" stroke-linejoin="round"/>
        </svg>`,
      boxes: (c="currentColor") => `
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M21 16V8a2 2 0 00-1.2-1.8l-7-3a2 2 0 00-1.6 0l-7 3A2 2 0 003 8v8a2 2 0 001.2 1.8l7 3a2 2 0 001.6 0l7-3A2 2 0 0021 16z" stroke="${c}" stroke-width="2"/>
          <path d="M3.3 7.6l8.7 3.8 8.7-3.8" stroke="${c}" stroke-width="2" stroke-linecap="round"/>
          <path d="M12 22V11" stroke="${c}" stroke-width="2" stroke-linecap="round"/>
        </svg>`,
      cash: (c="currentColor") => `
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M3 7h18v10H3V7z" stroke="${c}" stroke-width="2" stroke-linejoin="round"/>
          <path d="M7 12h.01M17 12h.01" stroke="${c}" stroke-width="2" stroke-linecap="round"/>
          <path d="M12 9.5a2.5 2.5 0 100 5 2.5 2.5 0 000-5z" stroke="${c}" stroke-width="2"/>
        </svg>`,
      chart: (c="currentColor") => `
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M4 19V5" stroke="${c}" stroke-width="2" stroke-linecap="round"/>
          <path d="M4 19h16" stroke="${c}" stroke-width="2" stroke-linecap="round"/>
          <path d="M8 15v-5M12 15v-8M16 15v-3" stroke="${c}" stroke-width="2" stroke-linecap="round"/>
        </svg>`,
      users: (c="currentColor") => `
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M16 21v-2a4 4 0 00-4-4H6a4 4 0 00-4 4v2" stroke="${c}" stroke-width="2" stroke-linecap="round"/>
          <path d="M9 11a4 4 0 100-8 4 4 0 000 8z" stroke="${c}" stroke-width="2"/>
          <path d="M22 21v-2a3 3 0 00-2-2.8" stroke="${c}" stroke-width="2" stroke-linecap="round"/>
          <path d="M17 3a4 4 0 010 8" stroke="${c}" stroke-width="2" stroke-linecap="round"/>
        </svg>`,
      settings: (c="currentColor") => `
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 15.5a3.5 3.5 0 110-7 3.5 3.5 0 010 7z" stroke="${c}" stroke-width="2"/>
          <path d="M19.4 15a7.8 7.8 0 00.1-1 7.8 7.8 0 00-.1-1l2.1-1.6-2-3.4-2.5 1a7.5 7.5 0 00-1.7-1l-.4-2.7H11l-.4 2.7a7.5 7.5 0 00-1.7 1l-2.5-1-2 3.4L6.5 13a7.8 7.8 0 00-.1 1 7.8 7.8 0 00.1 1l-2.1 1.6 2 3.4 2.5-1a7.5 7.5 0 001.7 1l.4 2.7h4l.4-2.7a7.5 7.5 0 001.7-1l2.5 1 2-3.4L19.4 15z" stroke="${c}" stroke-width="2" stroke-linejoin="round"/>
        </svg>`
    };

    const qs = (s, p=document) => p.querySelector(s);
    const qsa = (s, p=document) => [...p.querySelectorAll(s)];

    const nav = qs("#mainNav");
    const drawer = qs("#drawer");
    const backdrop = qs("#backdrop");
    const drawerTitle = qs("#drawerTitle");
    const drawerSubtitle = qs("#drawerSubtitle");
    const drawerGrid = qs("#drawerGrid");
    const activeModule = qs("#activeModule");

    function normalize(s){
      return (s||"")
        .toString()
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .replace(/\s+/g," ")
        .trim()
        .toUpperCase();
    }

    // FIX82: "Internet" lookup by CUI (ANAF PlatitorTvaRest v9) to auto-fill fields
    async function anafLookupByCui(rawCui){
      const cleaned = String(rawCui||"").toUpperCase().replace(/^RO/,"").replace(/[^0-9]/g,"").trim();
      if(!cleaned || cleaned.length < 2){ throw new Error("CUI invalid"); }

      // IMPORTANT: browser CORS blocks direct calls to ANAF.
      // Use server-side proxy (anaf.php) provided by you.
      const base = (window.ANAF_PROXY_URL || "/api/anaf.php");
      const url = base + "?cui=" + encodeURIComponent(cleaned);

      let res;
      try{
        res = await fetch(url, { method:"GET", headers:{ "Accept":"application/json" } });
      }catch(e){
        throw new Error("Nu pot apela endpoint-ul ANAF (proxy). Verifică că anaf.php este accesibil la: " + base);
      }
      if(!res.ok){
        throw new Error("Eroare proxy ANAF: " + res.status);
      }

      const j = await res.json();
      if(!j || j.ok !== true || !j.company){
        const msg = (j && (j.error || j.message)) ? (j.error || j.message) : ("Firma nu a fost găsită pentru CUI: " + cleaned);
        throw new Error(msg);
      }

      const c = j.company || {};
      const addrParts = [c.address, c.city, c.county].filter(Boolean).map(x=>String(x).trim()).filter(Boolean);
      const fullAddr = addrParts.join(", ");

      return {
        cui: String(c.cui || cleaned),
        denumire: c.name || "",
        nrRegCom: c.orc || "",
        adresa: fullAddr || "",

        // Extra fields (pentru compatibilitate cu completarea în configurare societate)
        localitate: c.city || "",
        judet: c.county || "",
        codPostal: c.postal || "",
        tara: c.country || "ROMANIA",

        // Not provided by proxy (keep empty)
        strada: "",
        nr: "",
        detalii: "",
        telefon: "",
        iban: ""
      };
    }

    function fillFieldsIfPresent(map){
      Object.entries(map).forEach(([sel,val])=>{
        const el = document.querySelector(sel);
        if(el && typeof el.value !== "undefined" && val !== undefined && val !== null){
          el.value = String(val);
        }
      });
    }

    async function handleCuiInternetClick(opts){
      const { cuiSelector, fill } = opts;
      const cuiEl = document.querySelector(cuiSelector);
      const cui = cuiEl ? cuiEl.value : "";
      if(!String(cui||"").trim()){ alert("Completeaza CUI/CIF."); return; }
      try{
        const info = await anafLookupByCui(cui);
        fill(info);
      }catch(e){
        alert(e.message || String(e));
      }
    }

    function openDrawer(menuKey){
      const m = MENU.find(x => normalize(x.key) === normalize(menuKey));
      if(!m) return;

      drawerTitle.textContent = m.key;
      drawerSubtitle.textContent = m.hint;
      activeModule.textContent = m.key;

      // Fill actions
      drawerGrid.innerHTML = "";
      m.items.forEach(label=>{
        const el = document.createElement("button");
        el.className = "action";
        el.type = "button";
        el.innerHTML = `<div class="t">${label}</div><div class="s">Deschide modul (demo)</div>`;
        el.addEventListener("click", () => {
          // Implementare cerută: doar pentru FACTURA / FACTURA PROFORMA / CHITANTA (înregistrare documente)
          if (normalize(m.key) === normalize("INREGISTRARE DOCUMENTE") && (normalize(label) === normalize("FACTURA") || normalize(label) === normalize("FACTURA PROFORMA"))) {
            openInvoiceModal(label);
            return;
          }
          if (normalize(m.key) === normalize("INREGISTRARE DOCUMENTE") && normalize(label) === normalize("CHITANTA")) {
            if (typeof window.openReceiptModal === "function") {
              window.openReceiptModal();
              return;
            }
            // fallback: open directly if script not loaded
            const rb = document.querySelector("#receiptBackdrop");
            if (rb) {
              rb.classList.add("show");
              rb.setAttribute("aria-hidden","false");
              document.body.style.overflow = "hidden";
              return;
            }
          }

          // PRODUSE (Gestiune)
          if (normalize(m.key) === normalize("GESTIUNE") && normalize(label) === normalize("PRODUSE")) {
            if (typeof window.openProductsModal === "function") {
              window.openProductsModal();
              return;
            }
            const pb = document.querySelector("#productsBackdrop");
            if (pb) {
              pb.classList.add("show");
              pb.setAttribute("aria-hidden","false");
              document.body.style.overflow = "hidden";
              return;
            }
          }

          alert(`${m.key} → ${label}

(Doar UI demo. Implementăm funcționalitatea pe rând.)`);
        });
        drawerGrid.appendChild(el);
      });

      drawer.classList.add("show");
      backdrop.classList.add("show");
      drawer.setAttribute("aria-hidden","false");
      backdrop.setAttribute("aria-hidden","false");
    }

    function closeDrawer(){
      drawer.classList.remove("show");
      backdrop.classList.remove("show");
      drawer.setAttribute("aria-hidden","true");
      backdrop.setAttribute("aria-hidden","true");
    }

    function setActiveBtn(key){
      qsa(".nav-btn").forEach(b=>{
        b.classList.toggle("active", normalize(b.dataset.key) === normalize(key));
      });
    }

    // Build nav from MENU
    MENU.forEach(m=>{
      const btn = document.createElement("button");
      btn.className = "nav-btn";
      btn.type = "button";
      btn.dataset.key = m.key;

      const ico = document.createElement("div");
      ico.className = "nav-ico";
      ico.innerHTML = (ICONS[m.icon] ? ICONS[m.icon]("#1d4ed8") : ICONS.folder("#1d4ed8"));

      const meta = document.createElement("div");
      meta.className = "nav-meta";
      meta.innerHTML = `<div class="nav-title">${m.key}</div><div class="nav-sub">${m.hint}</div>`;

      btn.appendChild(ico);
      btn.appendChild(meta);

      btn.addEventListener("click", ()=>{
        setActiveBtn(m.key);
        openDrawer(m.key);
      });

      nav.appendChild(btn);
    });

    // Quick actions
    qsa(".quick").forEach(q=>{
      q.addEventListener("click", ()=>{
        const key = q.dataset.open;
        setActiveBtn(key);
        openDrawer(key);
      });
    });

    // Close events
    qs("#drawerClose").addEventListener("click", closeDrawer);
    backdrop.addEventListener("click", closeDrawer);
    document.addEventListener("keydown", (e)=>{
      if(e.key === "Escape") closeDrawer();
    });

    // Simple search demo: opens the first menu that matches
    qs("#searchInput").addEventListener("keydown", (e)=>{
      if(e.key !== "Enter") return;
      const val = normalize(e.target.value);
      if(!val) return;
      // search menu key or any item label
      let found = MENU.find(m => normalize(m.key).includes(val));
      if(!found){
        found = MENU.find(m => m.items.some(it => normalize(it).includes(val)));
      }
      if(found){
        setActiveBtn(found.key);
        openDrawer(found.key);
      }else{
        alert("Nu am găsit în demo. În implementare reală va căuta în module.");
      }
    });

    // Top buttons (demo)
    qs("#btnHelp").addEventListener("click", ()=>{
      alert("Demo UI. Click pe un buton principal pentru slide-ul cu acțiuni secundare.");
    });
    qs("#btnTheme").addEventListener("click", ()=>{
      alert("Tema este Light (demo). Putem adăuga comutare Light/Dark dacă vrei.");
    });
</script>

  <!-- Invoice Modal (FACTURA / FACTURA PROFORMA) -->
  <div class="modal-backdrop" id="invoiceBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="invoiceTitle">
      <div class="modal-head">
        <div class="modal-title">
          <div class="h" id="invoiceTitle">Factură</div>
          <div class="s" id="invoiceSubtitle">Înregistrare document</div>
        </div>
        <button class="modal-close" type="button" id="invoiceClose" aria-label="Închide">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <div class="modal-body">
        <div class="form-grid" style="margin-bottom:12px;">
          <div class="field">
            <label>Client</label>
            <div class="row" style="gap:8px; align-items:center; flex-wrap:nowrap;">
              <input id="invClientName" type="text" placeholder="Scrie client (min 3 litere)..." style="flex:1; min-width:0;" autocomplete="off" />
              <button class="btn" type="button" id="btnAddClient" title="Adaugă client nou">Adaugă</button>
              <button class="btn" type="button" id="btnEditClient" title="Modifică client" style="display:none;">Modifică</button>
            </div>
            <select id="invClient" style="display:none;">
              <option value="">Selectează client…</option>
            </select>
          </div>

          <div class="field">
            <label>Serie factură</label>
            <input id="invSerie" type="text" readonly />
          </div>

          <div class="field">
            <label>Număr factură</label>
            <input id="invNumber" type="text" readonly />
          </div>

          <div class="field">
            <label>Data</label>
            <input id="invDate" type="date" />
          </div>

          <div class="field">
            <label>Termen de plată (zile)</label>
            <input id="invDueDays" type="number" min="0" value="0" />
          </div>

          <div class="field">
            <label>Monedă</label>
            <select id="invCurrency">
              <option value="RON">RON</option>
              <option value="EUR">EUR</option>
              <option value="USD">USD</option>
            </select>
          </div>

          <div class="field">
            <label>Curs valutar (pentru echivalent RON)</label>
            <input id="invFx" type="number" min="0" step="0.0001" value="1" />
          </div>

          <div class="field">
            <label>TVA (%)</label>
            <input id="invVatRate" type="number" min="0" step="0.01" value="19" />
          </div>

          <div class="field">
            <label>&nbsp;</label>
            <button class="btn btn-primary" type="button" id="btnAddLine">Adaugă linie produs</button>
          </div>
        </div>

        <table class="table" aria-label="Linii produse">
          <thead>
            <tr>
              <th style="width:34%;">Denumire produs</th>
              <th style="width:12%;">U.M.</th>
              <th style="width:12%;">Cantitate</th>
              <th style="width:16%;">Preț unitar</th>
              <th style="width:12%;">Monedă</th>
              <th style="width:14%;">Acțiuni</th>
            </tr>
          </thead>
          <tbody id="invLines"></tbody>
        </table>

        <div class="totals">
          <div class="box">
            <div class="k">Valoare fără TVA</div>
            <div class="v"><span id="tNet">0.00</span> <small id="tNetCur">RON</small></div>
          </div>
          <div class="box">
            <div class="k">Valoare TVA</div>
            <div class="v"><span id="tVat">0.00</span> <small id="tVatCur">RON</small></div>
          </div>
          <div class="box">
            <div class="k">Total de plată</div>
            <div class="v"><span id="tGross">0.00</span> <small id="tGrossCur">RON</small></div>
          </div>
          <div class="box">
            <div class="k">Echivalent RON (pe curs)</div>
            <div class="v"><span id="tRon">0.00</span> <small>RON</small></div>
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn" type="button" id="btnCancelInvoice">Închide</button>
          <button class="btn btn-primary" type="button" id="btnSaveInvoice">Salvează</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Client Modal -->
  <div class="modal-backdrop" id="clientBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="clientTitle" style="width:min(820px,100%);">
      <div class="modal-head">
        <div class="modal-title">
          <div class="h" id="clientTitle">Client nou</div>
          <div class="s">Detalii client</div>
        </div>
        <button class="modal-close" type="button" id="clientClose" aria-label="Închide">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <div class="modal-body">
        <div class="form-grid" style="grid-template-columns:1fr 1fr 1fr; margin-bottom:12px;">
          <div class="field">
            <label>Denumire client</label>
            <input id="cName" type="text" />
          </div>
          <div class="field">
            <label>CUI</label>
            <div class="row" style="gap:8px; flex-wrap:nowrap;">
              <input id="cCui" type="text" style="flex:1; min-width:0;" />
              <button class="btn btn-ghost" type="button" id="btnClientCuiLookup" title="Caută online după CUI">Internet</button>
            </div>
</div>
          <div class="field">
            <label>Nr. Reg. Com.</label>
            <input id="cReg" type="text" />
          </div>
          <div class="field" style="grid-column:1 / -1;">
            <label>Adresă (str., nr., oraș, județ)</label>
            <input id="cAddr" type="text" />
          </div>
          <div class="field">
            <label>Bancă</label>
            <input id="cBank" type="text" />
          </div>
          <div class="field" style="grid-column: span 2;">
            <label>IBAN</label>
            <input id="cIban" type="text" />
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn" type="button" id="btnCancelClient">Renunță</button>
          <button class="btn btn-primary" type="button" id="btnSaveClient">Salvează client</button>
        </div>
      </div>
    </div>
  </div>


  <script>
    // ===== FACTURA / FACTURA PROFORMA (modal) — implementare (doar aceste două butoane) =====
    // Notă: folosește helper-ele existente din fișier: qs(), normalize()

    const invoiceBackdrop = document.getElementById("invoiceBackdrop");
    const clientBackdrop  = document.getElementById("clientBackdrop");

    function __storage(){
        try{
          const k="__t__";
          localStorage.setItem(k,"1");
          localStorage.removeItem(k);
          return { ok:true, get:(key)=>localStorage.getItem(key), set:(key,val)=>localStorage.setItem(key,val) };
        }catch(e){
          const mem = window.__memStore || (window.__memStore = {});
          return { ok:false, get:(key)=> (key in mem ? mem[key] : null), set:(key,val)=>{ mem[key]=val; } };
        }
      }
      const __st = __storage();
      function lsGet(key, fallback){
        try{ const raw = __st.get(key); if(raw==null) return fallback; const v = JSON.parse(raw); return (v ?? fallback); }catch{ return fallback; }
      }
      function lsSet(key, val){
        try{ __st.set(key, JSON.stringify(val)); }catch(e){ /* ignore */ }
      }
    function money(n){
      const x = Number(n);
      if(!isFinite(x)) return "0.00";
      return x.toFixed(2);
    }

    function getInvoiceSettings(){
      const s = lsGet("invoiceSettings", null);
      if(s && typeof s === "object") return { serie: (s.serie || "F"), lastNumber: Number(s.lastNumber || 0) };
      return { serie: "F", lastNumber: 0 };
    }
    function setInvoiceSettings(partial){
      const cur = getInvoiceSettings();
      const next = { ...cur, ...partial };
      lsSet("invoiceSettings", next);
    }
    function nextInvoiceNumber(){
      const s = getInvoiceSettings();
      return Number(s.lastNumber || 0) + 1;
    }

    function openModal(backdropEl){
      if(!backdropEl) return;
      backdropEl.classList.add("show");
      backdropEl.setAttribute("aria-hidden","false");
      document.body.style.overflow = "hidden";
    }
    function closeModal(backdropEl){
      try{ const dd = document.getElementById("rcptPartnerDD"); if(dd){ dd.style.display="none"; dd.innerHTML=""; } }catch(e){}

      if(!backdropEl) return;
      backdropEl.classList.remove("show");
      backdropEl.setAttribute("aria-hidden","true");
      document.body.style.overflow = "";
    }

    // Elements (invoice)
    const invoiceTitle    = document.getElementById("invoiceTitle");
    const invoiceSubtitle = document.getElementById("invoiceSubtitle");
    const invClient       = document.getElementById("invClient");
    const invSerie        = document.getElementById("invSerie");
    const invNumber       = document.getElementById("invNumber");
    const invDate         = document.getElementById("invDate");
    const invDueDays      = document.getElementById("invDueDays");
    const invCurrency     = document.getElementById("invCurrency");
    const invFx           = document.getElementById("invFx");
    const invVatRate      = document.getElementById("invVatRate");
    const invLines        = document.getElementById("invLines");

    const tNet    = document.getElementById("tNet");
    const tVat    = document.getElementById("tVat");
    const tGross  = document.getElementById("tGross");
    const tRon    = document.getElementById("tRon");
    const tNetCur = document.getElementById("tNetCur");
    const tVatCur = document.getElementById("tVatCur");
    const tGrossCur = document.getElementById("tGrossCur");

    let invoiceMode = "FACTURA"; // or "FACTURA PROFORMA"

    function loadClientsIntoSelect(selectedId=null){
      const clients = lsGet("clients", []);
      invClient.innerHTML = `<option value="">Selectează client…</option>` + clients.map(c => {
        const name = (c.name || "").replace(/</g,"&lt;");
        return `<option value="${c.id}">${name}</option>`;
      }).join("");
      if(selectedId) invClient.value = selectedId;
    }


    // FIX78: Invoice client instant search (min 3 chars) like chitanta
    function setupInvoiceClientTypeahead(){
      const input = qs("#invClientName");
      const select = qs("#invClient");
      if(!input || !select) return;

      input.setAttribute("autocomplete","off");

      const fieldWrap = input.closest(".field");
      if(!fieldWrap || fieldWrap.__invTypeahead) return;
      fieldWrap.__invTypeahead = true;
      fieldWrap.style.position = "relative";

      const box = document.createElement("div");
      box.className = "typeahead-box";
      box.id = "invClientTypeahead";
      fieldWrap.appendChild(box);

      function hide(){ box.style.display="none"; box.innerHTML=""; }
      function show(){ box.style.display="block"; }

      function getList(){
        let list = lsGet("clientsFull", null);
        if(!Array.isArray(list) || !list.length) list = lsGet("clients", []);
        if(!Array.isArray(list)) list = [];
        return list;
      }

      function render(q){
        const nq = normalize(q || "");
        if(!nq || nq.length < 3){ hide(); return; }

        const list = getList();
        const matches = list.filter(c=>{
          const name = normalize(c?.name || "");
          const cui  = normalize(c?.cui  || "");
          const orc  = normalize(c?.orc  || c?.regcom || "");
          return (name && name.includes(nq)) || (cui && cui.includes(nq)) || (orc && orc.includes(nq));
        }).slice(0, 12);

        if(!matches.length){ hide(); return; }

        box.innerHTML = matches.map(c=>{
          const meta = [c?.cui ? ("CUI: " + (c.cui||"")) : "", (c?.orc||c?.regcom) ? ("ORC: " + (c.orc||c.regcom)) : ""].filter(Boolean).join("  •  ");
          const nm = (c?.name||"").replace(/</g,"&lt;");
          return `<div class="typeahead-item" data-id="${c.id}">
                    <div><strong>${nm}</strong></div>
                    ${meta ? `<div class="typeahead-meta">${meta}</div>` : ``}
                  </div>`;
        }).join("");
        show();
      }

      box.addEventListener("mousedown", (e)=>{
        const item = e.target.closest(".typeahead-item");
        if(!item) return;
        e.preventDefault(); // keep focus
        const id = item.getAttribute("data-id");
        if(!id) return;

        // ensure option exists
        let opt = [...select.options].find(o=> o.value === id);
        if(!opt){
          const list = getList();
          const c = list.find(x=> String(x.id)===String(id));
          opt = document.createElement("option");
          opt.value = id;
          opt.textContent = c?.name || ("Client " + id);
          select.appendChild(opt);
        }
        select.value = id;

        // sync input text with selected option

        if(btnEdit){ btnEdit.style.display = "inline-flex"; }

        // sync input text with selected option
        const selOpt = select.options[select.selectedIndex];
        input.value = selOpt ? selOpt.textContent : "";
        hide();
      });

      input.addEventListener("input", ()=> { if((input.value||"").trim().length===0){ try{ select.value=""; }catch(e){}; if(btnEdit){ btnEdit.style.display="none"; } } render(input.value); });
      input.addEventListener("focus", ()=> { if(input.value && input.value.length>=3) render(input.value); });
      input.addEventListener("blur", ()=> setTimeout(hide, 120));

      // keep input synced when user changes select manually
      select.addEventListener("change", ()=>{
        const selOpt = select.options[select.selectedIndex];
        input.value = selOpt && select.value ? selOpt.textContent : "";
      });

      // Expose helpers to reset form
      window.__invClientTypeaheadReset = function(){
        input.value = "";
        try{ select.value = ""; }catch(e){}
        if(btnEdit){ btnEdit.style.display = "none"; }
        hide();
      };
    }

    function addLineRow(data){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="text" class="ln-name" placeholder="Denumire produs" value="${(data?.name||"").replace(/"/g,"&quot;")}"></td>
        <td><input type="text" class="ln-um" placeholder="buc" value="${(data?.um||"").replace(/"/g,"&quot;")}"></td>
        <td><input type="number" class="ln-qty" min="0" step="0.0001" value="${data?.qty ?? 1}"></td>
        <td><input type="number" class="ln-price" min="0" step="0.0001" value="${data?.price ?? 0}"></td>
        <td>
          <select class="ln-cur">
            <option value="RON">RON</option>
            <option value="EUR">EUR</option>
            <option value="USD">USD</option>
          </select>
        </td>
        <td style="text-align:right;">
          <button type="button" class="btn btn-danger ln-del">Șterge</button>
        </td>
      `;
      const curSel = tr.querySelector(".ln-cur");
      curSel.value = data?.cur || invCurrency.value || "RON";

      function bindRecalc(){ recalcTotals(); }
      tr.querySelectorAll("input,select").forEach(el => el.addEventListener("input", bindRecalc));
      tr.querySelector(".ln-del").addEventListener("click", ()=>{
        tr.remove();
        recalcTotals();
      });

      invLines.appendChild(tr);
      recalcTotals();
    }

    function recalcTotals(){
      const vatRate = Number(invVatRate.value || 0) / 100.0;
      const fx = Number(invFx.value || 1) || 1;
      const docCur = invCurrency.value || "RON";

      // Convert all lines to document currency using fx (simplified demo)
      let netDoc = 0;
      [...invLines.querySelectorAll("tr")].forEach(tr=>{
        const qty = Number(tr.querySelector(".ln-qty").value || 0);
        const price = Number(tr.querySelector(".ln-price").value || 0);
        const cur = tr.querySelector(".ln-cur").value || docCur;
        const lineNet = qty * price;

        if(cur === docCur){
          netDoc += lineNet;
        }else{
          if(docCur === "RON"){
            netDoc += lineNet * fx;
          }else{
            netDoc += (lineNet / fx);
          }
        }
      });

      const vat = netDoc * vatRate;
      const gross = netDoc + vat;

      tNet.textContent = money(netDoc);
      tVat.textContent = money(vat);
      tGross.textContent = money(gross);

      tNetCur.textContent = docCur;
      tVatCur.textContent = docCur;
      tGrossCur.textContent = docCur;

      const grossRon = (docCur === "RON") ? gross : (gross * fx);
      tRon.textContent = money(grossRon);
    }

    function resetInvoiceForm(){
      const s = getInvoiceSettings();
      invSerie.value = s.serie || "F";
      invNumber.value = String(nextInvoiceNumber());
      invDate.value = new Date().toISOString().slice(0,10);
      invDueDays.value = 0;
      invCurrency.value = "RON";
      invFx.value = 1;
      invVatRate.value = 19;

      loadClientsIntoSelect();
      try{ window.__invClientTypeaheadReset && window.__invClientTypeaheadReset(); }catch{}
      invLines.innerHTML = "";
      addLineRow({name:"", um:"", qty:1, price:0, cur:"RON"});
      recalcTotals();
    }

    function openInvoiceModal(label){
      invoiceMode = normalize(label) === normalize("FACTURA PROFORMA") ? "FACTURA PROFORMA" : "FACTURA";
      invoiceTitle.textContent = (invoiceMode === "FACTURA") ? "Factură" : "Factură proformă";
      invoiceSubtitle.textContent = "Înregistrare document";
      resetInvoiceForm();
    try{ window.__invClientTypeaheadReset && window.__invClientTypeaheadReset(); }catch(e){}
      openModal(invoiceBackdrop);
    
    // FIX81: init client typeahead after invoice modal is in DOM
    setTimeout(()=>{ try{ setupInvoiceClientTypeahead(); }catch(e){} }, 0);
}

    function gatherInvoicePayload(){
      const clientId = invClient.value || null;
      const clients = lsGet("clients", []);
      const client = clientId ? clients.find(c => c.id === clientId) : null;

      const s = getInvoiceSettings();
      const number = Number(invNumber.value || nextInvoiceNumber());
      const serie = invSerie.value || s.serie || "F";

      const lines = [...invLines.querySelectorAll("tr")].map(tr => ({
        name: tr.querySelector(".ln-name").value.trim(),
        um: tr.querySelector(".ln-um").value.trim(),
        qty: Number(tr.querySelector(".ln-qty").value || 0),
        price: Number(tr.querySelector(".ln-price").value || 0),
        cur: tr.querySelector(".ln-cur").value || (invCurrency.value || "RON")
      })).filter(l => l.name || l.qty || l.price);

      return {
        id: "INV-" + Math.random().toString(16).slice(2) + "-" + Date.now(),
        type: invoiceMode,
        serie,
        number,
        date: invDate.value,
        dueDays: Number(invDueDays.value || 0),
        currency: invCurrency.value,
        fx: Number(invFx.value || 1),
        vatRate: Number(invVatRate.value || 0),
        totals: {
          net: Number(tNet.textContent || 0),
          vat: Number(tVat.textContent || 0),
          gross: Number(tGross.textContent || 0),
          ron: Number(tRon.textContent || 0)
        },
        client: client ? {...client} : null,
        lines
      };
    }

    // Bind invoice modal buttons
    document.getElementById("invoiceClose").addEventListener("click", ()=>closeModal(invoiceBackdrop));
    document.getElementById("btnCancelInvoice").addEventListener("click", ()=>closeModal(invoiceBackdrop));
    invoiceBackdrop.addEventListener("click", (e)=>{ if(e.target === invoiceBackdrop) closeModal(invoiceBackdrop); });

    document.getElementById("btnAddLine").addEventListener("click", ()=>addLineRow({name:"", um:"", qty:1, price:0, cur: invCurrency.value || "RON"}));
    [invCurrency, invFx, invVatRate].forEach(el => el.addEventListener("input", recalcTotals));

    document.getElementById("btnSaveInvoice").addEventListener("click", ()=>{
      const payload = gatherInvoicePayload();
      if(!payload.serie || !String(payload.number).trim()){
        alert("Seria și numărul sunt obligatorii.");
        return;
      }

      const storageKey = (payload.type === "FACTURA") ? "invoices" : "proformas";
      const list = lsGet(storageKey, []);
      list.push(payload);
      lsSet(storageKey, list);

      // Avansăm numerotarea doar pentru FACTURA (dacă vrei și pentru proformă, schimbăm)
      if(payload.type === "FACTURA"){
        setInvoiceSettings({ lastNumber: payload.number });
      }

      closeModal(invoiceBackdrop);
      alert(`${payload.type} salvat(ă). (Demo LocalStorage)`);
    });

    // Client modal
    const cName = document.getElementById("cName");
    const cCui  = document.getElementById("cCui");
    const cReg  = document.getElementById("cReg");
    const cAddr = document.getElementById("cAddr");
    const cBank = document.getElementById("cBank");
    const cIban = document.getElementById("cIban");

    function resetClientForm(){
      cName.value = "";
      cCui.value = "";
      cReg.value = "";
      cAddr.value = "";
      cBank.value = "";
      cIban.value = "";
    }
    function openClientModal(){
      resetClientForm();
      openModal(clientBackdrop);
      cName.focus();
    }
    function closeClientModal(){ closeModal(clientBackdrop); }

    document.getElementById("btnAddClient").addEventListener("click", openClientModal);
    document.getElementById("clientClose").addEventListener("click", closeClientModal);
    document.getElementById("btnCancelClient").addEventListener("click", closeClientModal);
    clientBackdrop.addEventListener("click", (e)=>{ if(e.target === clientBackdrop) closeClientModal(); });

    document.getElementById("btnSaveClient").addEventListener("click", ()=>{
      const name = cName.value.trim();
      if(!name){
        alert("Denumirea clientului este obligatorie.");
        return;
      }
      const clients = lsGet("clients", []);
      const newClient = {
        id: "C-" + Math.random().toString(16).slice(2) + "-" + Date.now(),
        name,
        cui: cCui.value.trim(),
        reg: cReg.value.trim(),
        address: cAddr.value.trim(),
        bank: cBank.value.trim(),
        iban: cIban.value.trim()
      };
      clients.push(newClient);
      lsSet("clients", clients);
      loadClientsIntoSelect(newClient.id);
      closeClientModal();
    });

    // Escape closes modals
    document.addEventListener("keydown", (e)=>{
      if(e.key !== "Escape") return;
      if(invoiceBackdrop.classList.contains("show")) closeModal(invoiceBackdrop);
      if(clientBackdrop.classList.contains("show")) closeModal(clientBackdrop);
    });

    // Init demo storage
    (function initInvoiceDefaults(){
      const s = lsGet("invoiceSettings", null);
      if(!s) setInvoiceSettings({ serie: "F", lastNumber: 0 });
      if(!Array.isArray(lsGet("clients", []))) lsSet("clients", []);
    })();
    // ===== END FACTURA / PROFORMA =====
  </script>


  <!-- Receipt Modal (CHITANTA) -->
  <div class="modal-backdrop" id="receiptBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="receiptTitle" style="width:min(980px,100%);">
      <div class="modal-head">
        <div class="modal-title">
          <div class="h" id="receiptTitle">Chitanță</div>
          <div class="s" id="receiptSubtitle">Înregistrare document</div>
        </div>
        <button class="modal-close" type="button" id="receiptClose" aria-label="Închide">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <div class="modal-body">
        <div class="split-head" style="margin-bottom:6px;">
          <div class="field">
            <label>Nr. doc.</label>
            <input id="rcptNumber" type="text" readonly />
          </div>
          <div class="field">
            <label>Data doc.</label>
            <input id="rcptDate" type="date" />
          </div>
        </div>

        <div class="hr"></div>

        <div class="section-h">UNITATEA</div>
        <div class="row" style="align-items:flex-end;">
          <div class="field" style="flex:1; min-width:260px;">
            <label>Denumire unitate</label>
            <input id="rcptUnitName" type="text" />
          </div>
          <div class="inline-actions">
            <button class="btn btn-ghost" type="button" id="btnUnitAdd">Adaugă</button>
            <button class="btn btn-ghost" type="button" id="btnUnitEdit">Modifică</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="section-h">AM PRIMIT DE LA</div>
        <div class="row" style="align-items:flex-end;">
          <div class="field" style="flex:1; min-width:260px;">
            <label>Partener</label>
            <input id="rcptPartnerName" type="text" />
          </div>
          <div class="inline-actions">
            <button class="btn btn-ghost" type="button" id="btnPartnerAdd">Adaugă</button>
            <button class="btn btn-ghost" type="button" id="btnPartnerEdit">Modifică</button>
          </div>
        </div>

        <div class="row-3" style="margin-top:10px;">
          <div class="field">
            <label>C.I.F.</label>
            <input id="rcptPartnerCui" type="text" />
          </div>
          <div class="field">
            <label>Nr. de înreg. la Reg. Com.</label>
            <input id="rcptPartnerReg" type="text" />
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <input type="text" readonly style="opacity:0;" />
          </div>
        </div>
        <div class="field" style="margin-top:10px;">
          <label>Adresă</label>
          <input id="rcptPartnerAddr" type="text" />
        </div>

        <div class="hr"></div>

        <div class="section-h">SUMA</div>
        <div class="row-3">
          <div class="field">
            <label>Suma</label>
            <input id="rcptAmount" type="number" min="0" step="0.01" value="0" />
          </div>
          <div class="field">
            <label>Monedă</label>
            <select id="rcptCurrency">
              <option value="RON">RON</option>
              <option value="EUR">EUR</option>
              <option value="USD">USD</option>
            </select>
          </div>
          <div class="field">
            <label>Curs valutar</label>
            <input id="rcptFx" type="number" min="0" step="0.0001" value="1" />
          </div>
        </div>

        <div class="field" style="margin-top:10px;">
          <label>Suma în litere</label>
          <input id="rcptAmountWords" type="text" readonly />
        </div>

        <div class="hr"></div>

        <div class="section-h">REPREZENTÂND</div>
        <div class="field">
          <label>Reprezentând</label>
          <input id="rcptRepresentative" type="text" placeholder="Nume reprezentant" />
        </div>

        <div class="row" style="margin-top:10px; align-items:center;">
          <label style="display:flex; align-items:center; gap:10px; color:var(--muted); font-weight:850;">
            <input id="rcptHasVoucher" type="checkbox" />
            Identificator voucher
          </label>
          <div class="field" style="flex:1; min-width:240px;">
            <input id="rcptVoucher" type="text" placeholder="ID voucher" disabled />
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn btn-muted" type="button" id="btnPrintReceipt">Tipărește</button>
          <button class="btn" type="button" id="btnCancelReceipt">Renunță</button>
          <button class="btn btn-primary" type="button" id="btnSaveReceipt">Salvează</button>
        </div>
      </div>
    </div>
  </div>

  
  <!-- Nota de receptie (NIR) Modal -->
  <div class="modal-backdrop" id="nirBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="nirTitle" style="width:min(1180px,100%); min-height:72vh;">
    <div class="modal-head">
      <div class="modal-title">
        <div class="h" id="nirTitle">Notă de recepție și constatare de diferențe</div>
        <div class="s">NIR – înregistrare</div>
      </div>
      <button class="modal-close" type="button" id="nirCloseTop" aria-label="Închide">
        <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>

    <div class="modal-body">
      <!-- Tabs -->
      <div class="tabs" style="margin-bottom:12px;">
        <button class="tab active" type="button" data-nir-tab="items">Bunurile recepționate</button>
        <button class="tab" type="button" data-nir-tab="doc">Document însoțitor</button>
        <button class="tab" type="button" data-nir-tab="comm">Gestiunar / Comisia recepție</button>
        <button class="tab" type="button" data-nir-tab="attach">Atașamente</button>
      </div>

      <!-- Header (common) -->
      <div class="row-3">
        <div class="field">
          <label>Nr. doc.</label>
          <input id="nirDocNo" type="text" readonly />
        </div>
        <div class="field">
          <label>Data doc.</label>
          <input id="nirDocDate" type="date" />
        </div>
        <div class="field">
          <label>Data recepție</label>
          <input id="nirDateReceived" type="date" />
        </div>
      </div>

      <div class="row-3" style="margin-top:10px;">
        <div class="field" style="grid-column: span 2;">
          <label>De la (furnizor)</label>
          <div class="row" style="gap:8px; align-items:center; flex-wrap:nowrap;">
            <input id="nirSupplierName" type="text" placeholder="Scrie furnizor (min 3 litere)..." style="flex:1; min-width:0;" autocomplete="off" />
            <button class="btn btn-ghost" type="button" id="btnNirSupplierInternet">Internet</button>
            <button class="btn" type="button" id="btnNirSupplierAdd">Adaugă</button>
          </div>
          <select id="nirSupplier" style="display:none;">
            <option value="">Selectează furnizor…</option>
          </select>
        </div>
        <div class="field">
          <label>Gestiune</label>
          <input id="nirGestiune" type="text" placeholder="ex: GESTIUNE 1" />
        </div>
      </div>

      <div class="row-3" style="margin-top:10px;">
        <div class="field">
          <label>C.I.F.</label>
          <input id="nirSupplierCui" type="text" readonly />
        </div>
        <div class="field">
          <label>Nr. de înreg. la Reg. Com.</label>
          <input id="nirSupplierReg" type="text" readonly />
        </div>
        <div class="field">
          <label>Adresă</label>
          <input id="nirSupplierAddr" type="text" readonly />
        </div>
      </div>

      <div class="row-3" style="margin-top:10px;">
        <div class="field">
          <label>Monedă</label>
          <select id="nirCurrency">
            <option value="RON">RON</option>
            <option value="EUR">EUR</option>
            <option value="USD">USD</option>
          </select>
        </div>
        <div class="field">
          <label>Curs valutar</label>
          <input id="nirFx" type="number" step="0.0001" min="0" value="1" />
        </div>
        <div class="field">
          <label>Operator</label>
          <input id="nirOperator" type="text" placeholder="ex: Operator" />
        </div>
      </div>

      <div class="row-3" style="margin-top:10px;">
        <div class="field">
          <label>Cota T.V.A. (vânzare)</label>
          <select id="nirVatOur">
            <option value="19">19%</option>
            <option value="9">9%</option>
            <option value="5">5%</option>
            <option value="0">0%</option>
          </select>
        </div>
        <div class="field">
          <label>Cota T.V.A. achiz.</label>
          <select id="nirVatBuy">
            <option value="19">19%</option>
            <option value="9">9%</option>
            <option value="5">5%</option>
            <option value="0">0%</option>
          </select>
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <div class="hint">Info TVA pe linii: „TVA nostru / TVA achiziție”.</div>
        </div>
      </div>

      <div class="tabpanels" style="margin-top:14px;">
        <!-- Panel: Items -->
        <div class="panel show" data-nir-panel="items">
          <div class="hr" style="margin:14px 0;"></div>

          <div class="field">
            <label>Bunurile recepționate</label>
            <div class="row" style="gap:10px; align-items:flex-end; flex-wrap:wrap;">
              <div class="field" style="min-width:260px; flex:1;">
                <label style="font-size:12px; color:var(--muted);">Denumire produs</label>
                <div class="row" style="gap:8px; flex-wrap:nowrap;">
                  <input id="nirLineName" type="text" placeholder="ex: PÂINE" style="flex:1; min-width:0;" />
                  <button class="btn" type="button" id="btnNirAddProduct">Adaugă produs</button>
                </div>
              </div>

              <div class="field" style="min-width:110px;">
                <label style="font-size:12px; color:var(--muted);">U.M.</label>
                <select id="nirLineUM">
                  <option value="buc.">buc.</option>
                  <option value="kg">kg</option>
                  <option value="l">l</option>
                  <option value="m">m</option>
                  <option value="mp">mp</option>
                </select>
              </div>

              <div class="field" style="min-width:140px;">
                <label style="font-size:12px; color:var(--muted);">Cant. cf. doc.</label>
                <input id="nirLineQtyDoc" type="number" step="0.0001" min="0" value="0" />
              </div>

              <div class="field" style="min-width:130px;">
                <label style="font-size:12px; color:var(--muted);">Cant. recep.</label>
                <input id="nirLineQty" type="number" step="0.0001" min="0" value="1" />
              </div>

              <div class="field" style="min-width:160px;">
                <label style="font-size:12px; color:var(--muted);">Preț achiziție</label>
                <input id="nirLineBuy" type="number" step="0.0001" min="0" value="0" />
              </div>

              <div class="field" style="min-width:160px;">
                <label style="font-size:12px; color:var(--muted);">Preț vânzare</label>
                <input id="nirLineSell" type="number" step="0.0001" min="0" value="0" />
              </div>

              <div class="field" style="min-width:160px;">
                <label style="font-size:12px; color:var(--muted);">TVA info</label>
                <input id="nirLineVatInfo" type="text" readonly />
              </div>

              <div class="field" style="min-width:120px;">
                <label style="font-size:12px; color:var(--muted);">Monedă</label>
                <input id="nirLineCurrency" type="text" readonly />
              </div>

              <div class="field" style="min-width:140px;">
                <label style="font-size:12px; color:var(--muted);">&nbsp;</label>
                <button class="btn btn-primary" type="button" id="btnNirAddLine">Adaugă linie</button>
              </div>
            </div>
          </div>

          <div class="docs-scroll" style="margin-top:12px;">
            <table class="table" aria-label="Linii NIR">
              <thead>
                <tr>
                  <th style="width:6%;">Poz.</th>
                  <th style="width:26%;">Denumire</th>
                  <th style="width:8%;">U.M.</th>
                  <th style="width:10%;">Cant.cf.doc.</th>
                  <th style="width:10%;">Cant.</th>
                  <th style="width:10%;">P. achiz.</th>
                  <th style="width:10%;">Val. achiz.</th>
                  <th style="width:10%;">TVA</th>
                  <th style="width:10%;">P. vânz.</th>
                  <th style="width:10%;">Acțiuni</th>
                </tr>
              </thead>
              <tbody id="nirLinesRows"></tbody>
            </table>
          </div>

          <div class="row-3" style="margin-top:12px;">
            <div class="field">
              <label>Total (fără TVA)</label>
              <input id="nirTotal" type="text" readonly />
            </div>
            <div class="field">
              <label>TVA (achiziție)</label>
              <input id="nirVatTotal" type="text" readonly />
            </div>
            <div class="field">
              <label>Total document</label>
              <input id="nirGrandTotal" type="text" readonly />
            </div>
          </div>
        </div>

        <!-- Panel: Base document -->
        <div class="panel" data-nir-panel="doc">
          <div class="hr" style="margin:14px 0;"></div>
          <div class="row-3">
            <div class="field">
              <label>Tip doc. însoțitor</label>
              <select id="nirBaseDocType">
                <option value="">—</option>
                <option value="FACTURA">Factură</option>
                <option value="AVIZ">Aviz</option>
                <option value="BON">Bon</option>
                <option value="ALTUL">Altul</option>
              </select>
            </div>
            <div class="field">
              <label>Nr. doc. însoțitor</label>
              <input id="nirBaseDocNo" type="text" placeholder="ex: 123/2026" />
            </div>
            <div class="field">
              <label>Data doc. însoțitor</label>
              <input id="nirBaseDocDate" type="date" />
            </div>
          </div>
          <div class="field" style="margin-top:10px;">
            <label>Observații</label>
            <input id="nirNotes" type="text" placeholder="opțional" />
          </div>
        </div>

        <!-- Panel: Commission -->
        <div class="panel" data-nir-panel="comm">
          <div class="hr" style="margin:14px 0;"></div>
          <div class="row-2">
            <div class="field">
              <label>Gestiunar</label>
              <input id="nirManagementName" type="text" placeholder="ex: GESTIONAR 1" />
            </div>
            <div class="field">
              <label>Comisia de recepție (nume)</label>
              <input id="nirComm1" type="text" placeholder="Membru 1" />
            </div>
          </div>
          <div class="row-2" style="margin-top:10px;">
            <div class="field">
              <label>&nbsp;</label>
              <input id="nirComm2" type="text" placeholder="Membru 2" />
            </div>
            <div class="field">
              <label>&nbsp;</label>
              <input id="nirComm3" type="text" placeholder="Membru 3" />
            </div>
          </div>
        </div>

        <!-- Panel: Attachments -->
        <div class="panel" data-nir-panel="attach">
          <div class="hr" style="margin:14px 0;"></div>
          <div class="field">
            <label>Atașamente (doar nume fișiere – demo)</label>
            <input id="nirAttach" type="file" multiple />
            <div class="hint" id="nirAttachHint">Fișierele nu se urcă nicăieri în varianta HTML (se salvează doar numele lor).</div>
          </div>
          <div class="docs-scroll" style="margin-top:10px; max-height:28vh;">
            <table class="table" aria-label="Atașamente NIR">
              <thead><tr><th>Nume fișier</th><th style="width:14%;">Acțiuni</th></tr></thead>
              <tbody id="nirAttachRows"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn" type="button" id="nirCancel">Renunță</button>
        <button class="btn btn-primary" type="button" id="btnNirSave">Salvează</button>
      </div>
    </div>
  </div>
</div>

<!-- Unit Modal -->
  <div class="modal-backdrop" id="unitBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="unitTitle" style="width:min(860px,100%);">
      <div class="modal-head">
        <div class="modal-title">
          <div class="h" id="unitTitle">Unitatea</div>
          <div class="s">Detalii firmă (setări)</div>
        </div>
        <button class="modal-close" type="button" id="unitClose" aria-label="Închide">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="row-3">
          <div class="field">
            <label>Denumire</label>
            <input id="uName" type="text" />
          </div>
          <div class="field">
            <label>CUI</label>
            <input id="uCui" type="text" />
          </div>
          <div class="field">
            <label>Nr. Reg. Com.</label>
            <input id="uReg" type="text" />
          </div>
        </div>
        <div class="field" style="margin-top:10px;">
          <label>Adresă</label>
          <input id="uAddr" type="text" />
        </div>
        <div class="row-2" style="margin-top:10px;">
          <div class="field">
            <label>Bancă</label>
            <input id="uBank" type="text" />
          </div>
          <div class="field">
            <label>IBAN</label>
            <input id="uIban" type="text" />
          </div>
        </div>
        <div class="modal-actions">
          <button class="btn" type="button" id="btnCancelUnit">Renunță</button>
          <button class="btn btn-primary" type="button" id="btnSaveUnit">Salvează</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Partner Modal (used for "Am primit de la") -->
  <div class="modal-backdrop" id="partnerBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="partnerTitle" style="width:min(860px,100%);">
      <div class="modal-head">
        <div class="modal-title">
          <div class="h" id="partnerTitle">Partener</div>
          <div class="s">Client/Furnizor (pentru chitanță)</div>
        </div>
        <button class="modal-close" type="button" id="partnerClose" aria-label="Închide">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="row-3">
          <div class="field">
            <label>Denumire</label>
            <input id="pName" type="text" />
          </div>
          <div class="field">
            <label>CUI</label>
            <input id="pCui" type="text" />
          </div>
          <div class="field">
            <label>Nr. Reg. Com.</label>
            <input id="pReg" type="text" />
          </div>
        </div>
        <div class="field" style="margin-top:10px;">
          <label>Adresă</label>
          <input id="pAddr" type="text" />
        </div>
        <div class="modal-actions">
          <button class="btn" type="button" id="btnCancelPartner">Renunță</button>
          <button class="btn btn-primary" type="button" id="btnSavePartner">Salvează</button>
        </div>
      </div>
    </div>
  </div>


  <script>
    // ===== CHITANTA (modal) — implementare minimă, fără a schimba restul UI-ului =====
    (function(){
      const qs = (s, p=document) => p.querySelector(s);
      const normalize = (s)=> (s||"").toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").trim().toUpperCase();

      function __storage(){
        try{
          const k="__t__";
          localStorage.setItem(k,"1");
          localStorage.removeItem(k);
          return { ok:true, get:(key)=>localStorage.getItem(key), set:(key,val)=>localStorage.setItem(key,val) };
        }catch(e){
          const mem = window.__memStore || (window.__memStore = {});
          return { ok:false, get:(key)=> (key in mem ? mem[key] : null), set:(key,val)=>{ mem[key]=val; } };
        }
      }
      const __st = __storage();
      function lsGet(key, fallback){
        try{ const raw = __st.get(key); if(raw==null) return fallback; const v = JSON.parse(raw); return (v ?? fallback); }catch{ return fallback; }
      }
      function lsSet(key, val){
        try{ __st.set(key, JSON.stringify(val)); }catch(e){ /* ignore */ }
      }

      function openModal(backdropEl){
        if(!backdropEl) return;
        backdropEl.classList.add("show");
        backdropEl.setAttribute("aria-hidden","false");
        document.body.style.overflow = "hidden";
      }
      function closeModal(backdropEl){
        if(!backdropEl) return;
        backdropEl.classList.remove("show");
        backdropEl.setAttribute("aria-hidden","true");
        document.body.style.overflow = "";
      }

      const receiptBackdrop = qs("#receiptBackdrop");
      const unitBackdrop = qs("#unitBackdrop");
      const partnerBackdrop = qs("#partnerBackdrop");

      const rcptNumber = qs("#rcptNumber");
      const rcptDate = qs("#rcptDate");
      const rcptUnitName = qs("#rcptUnitName");

      const rcptPartnerName = qs("#rcptPartnerName");
      const rcptPartnerCui = qs("#rcptPartnerCui");
      const rcptPartnerReg = qs("#rcptPartnerReg");
      const rcptPartnerAddr = qs("#rcptPartnerAddr");
      let receiptSelectedPartner = null; // selected from typeahead


      const rcptAmount = qs("#rcptAmount");
      const rcptCurrency = qs("#rcptCurrency");
      const rcptFx = qs("#rcptFx");
      const rcptAmountWords = qs("#rcptAmountWords");

      const rcptRepresentative = qs("#rcptRepresentative");
      const rcptHasVoucher = qs("#rcptHasVoucher");
      const rcptVoucher = qs("#rcptVoucher");

      // Unit modal fields
      const uName = qs("#uName"), uCui = qs("#uCui"), uReg = qs("#uReg"), uAddr = qs("#uAddr"), uBank = qs("#uBank"), uIban = qs("#uIban");
      // Partner modal fields
      const pName = qs("#pName"), pCui = qs("#pCui"), pReg = qs("#pReg"), pAddr = qs("#pAddr");

      function getReceiptSettings(){
        const s = lsGet("receiptSettings", null);
        if(s && typeof s === "object") return { prefix: (s.prefix || "CHIT_NR"), lastNumber: Number(s.lastNumber || 0) };
        return { prefix: "CHIT_NR", lastNumber: 0 };
      }
      function setReceiptSettings(partial){
        const cur = getReceiptSettings();
        lsSet("receiptSettings", { ...cur, ...partial });
      }
      function nextReceiptNumber(){
        const s = getReceiptSettings();
        return `${s.prefix}-${Number(s.lastNumber||0) + 1}`;
      }

      function getUnit(){
        const u = lsGet("unit", null);
        if(u && typeof u === "object") return u;
        const def = { name: "POSHARD IMPEX S.R.L.", cui:"", reg:"", address:"", bank:"", iban:"" };
        lsSet("unit", def);
        return def;
      }
      function setUnit(u){ lsSet("unit", u); }

      function getLastPartner(){
        const p = lsGet("receiptPartner", null);
        if(p && typeof p === "object") return p;
        const def = { name:"", cui:"", reg:"", address:"" };
        lsSet("receiptPartner", def);
        return def;
      }
      function setLastPartner(p){ lsSet("receiptPartner", p); }

      // Amount to words (RO) — simplified
      const RO_UNITS_M = ["zero","unu","doi","trei","patru","cinci","șase","șapte","opt","nouă"];
      const RO_UNITS_F = ["zero","una","două","trei","patru","cinci","șase","șapte","opt","nouă"];
      const RO_TEENS = ["zece","unsprezece","doisprezece","treisprezece","paisprezece","cincisprezece","șaisprezece","șaptesprezece","optsprezece","nouăsprezece"];
      const RO_TENS = ["","", "douăzeci","treizeci","patruzeci","cincizeci","șaizeci","șaptezeci","optzeci","nouăzeci"];

      function twoDigitsToWords(n, feminine){
        n = n|0;
        if(n < 10) return (feminine ? RO_UNITS_F[n] : RO_UNITS_M[n]);
        if(n < 20) return RO_TEENS[n-10];
        const t = Math.floor(n/10);
        const u = n % 10;
        if(u === 0) return RO_TENS[t];
        return `${RO_TENS[t]} și ${(feminine ? RO_UNITS_F[u] : RO_UNITS_M[u])}`;
      }
      function threeDigitsToWords(n, feminine){
        n = n|0;
        const h = Math.floor(n/100);
        const r = n % 100;
        let parts = [];
        if(h){
          if(h === 1) parts.push("o sută");
          else parts.push(`${(feminine ? RO_UNITS_F[h] : RO_UNITS_M[h])} sute`);
        }
        if(r){
          parts.push(twoDigitsToWords(r, feminine));
        }
        if(!parts.length) parts.push("zero");
        return parts.join(" ");
      }
      function intToWordsRO(n){
        n = Math.floor(Math.abs(n));
        if(n === 0) return "zero";
        let parts = [];
        const millions = Math.floor(n/1000000);
        const thousands = Math.floor((n%1000000)/1000);
        const rest = n % 1000;

        if(millions){
          if(millions === 1) parts.push("un milion");
          else parts.push(`${threeDigitsToWords(millions,false)} milioane`);
        }
        if(thousands){
          if(thousands === 1) parts.push("o mie");
          else parts.push(`${threeDigitsToWords(thousands,true)} mii`);
        }
        if(rest){
          parts.push(threeDigitsToWords(rest,false));
        }
        return parts.join(" ");
      }
      function amountToWords(amount, currency){
        const val = Number(amount || 0);
        const abs = Math.abs(val);
        const main = Math.floor(abs);
        const frac = Math.round((abs - main) * 100);

        let curMain = "lei", curSub = "bani";
        if(currency === "EUR"){ curMain = "euro"; curSub = "cenți"; }
        if(currency === "USD"){ curMain = "dolari"; curSub = "cenți"; }

        return `${intToWordsRO(main)} ${curMain} și ${twoDigitsToWords(frac,false)} ${curSub}`;
      }

      function refreshReceiptHeader(){
        rcptNumber.value = nextReceiptNumber();
        rcptDate.value = new Date().toISOString().slice(0,10);

        const u = getUnit();
        rcptUnitName.value = u.name || "";

        const p = getLastPartner();
        rcptPartnerName.value = p.name || "";
        rcptPartnerCui.value = p.cui || "";
        rcptPartnerReg.value = p.reg || "";
        rcptPartnerAddr.value = p.address || "";
      }
      function refreshAmountWords(){
        rcptAmountWords.value = amountToWords(rcptAmount.value, rcptCurrency.value);
      }

      function openReceiptModal(){
        refreshReceiptHeader();
        // clear partner fields (no default like 'sistloial')
        receiptSelectedPartner = null;
        rcptPartnerName.value = "";
        rcptPartnerCui.value = "";
        rcptPartnerReg.value = "";
        rcptPartnerAddr.value = "";
rcptAmount.value = 0;
        rcptCurrency.value = "RON";
        rcptFx.value = 1;
        rcptRepresentative.value = "";
        rcptHasVoucher.checked = false;
        rcptVoucher.value = "";
        rcptVoucher.disabled = true;
        refreshAmountWords();
        openModal(receiptBackdrop);
      }

      
      // FIX78: Typeahead for Partner in Receipt (min 3 chars) - searches clientsFull (clients + suppliers)
      (function(){
        const input = rcptPartnerName;
        if(!input) return;

        // create dropdown
        const dd = document.createElement("div");
        dd.id = "rcptPartnerDD";
        dd.style.position = "absolute";
        dd.style.zIndex = "9999";
        dd.style.background = "white";
        dd.style.border = "1px solid rgba(0,0,0,.10)";
        dd.style.borderRadius = "12px";
        dd.style.boxShadow = "0 14px 40px rgba(0,0,0,.12)";
        dd.style.padding = "6px";
        dd.style.display = "none";
        dd.style.maxHeight = "260px";
        dd.style.overflow = "auto";
        dd.style.minWidth = "260px";

        document.body.appendChild(dd);

        function place(){
          const r = input.getBoundingClientRect();
          dd.style.left = (r.left + window.scrollX) + "px";
          dd.style.top = (r.bottom + window.scrollY + 6) + "px";
          dd.style.width = r.width + "px";
        }

        function hide(){
          dd.style.display = "none";
          dd.innerHTML = "";
        }

        function show(list){
          place();
          dd.innerHTML = "";
          list.slice(0, 10).forEach(c=>{
            const item = document.createElement("button");
            item.type = "button";
            item.style.width = "100%";
            item.style.textAlign = "left";
            item.style.border = "0";
            item.style.background = "transparent";
            item.style.padding = "10px 10px";
            item.style.borderRadius = "10px";
            item.style.cursor = "pointer";
            item.onmouseenter = ()=> item.style.background = "rgba(0,0,0,.05)";
            item.onmouseleave = ()=> item.style.background = "transparent";

            const name = c.name || "-";
            const cui = c.cui ? (" | CUI: " + c.cui) : "";
            const orc = c.orc ? (" | ORC: " + c.orc) : "";
            item.textContent = name + cui + orc;

            item.addEventListener("click", ()=>{
              receiptSelectedPartner = c;
              rcptPartnerName.value = c.name || "";
              rcptPartnerCui.value = c.cui || "";
              rcptPartnerReg.value = c.orc || "";
              rcptPartnerAddr.value = c.address || "";
              hide();
            });

            dd.appendChild(item);
          });

          dd.style.display = dd.childElementCount ? "block" : "none";
        }

        function search(){
          const q = (input.value||"").trim().toLowerCase();
          receiptSelectedPartner = null;
          // clear auto-fields when typing (keeps name typed)
          rcptPartnerCui.value = "";
          rcptPartnerReg.value = "";
          rcptPartnerAddr.value = "";

          if(q.length < 3){
            hide();
            return;
          }

          const all = lsGet("clientsFull", []);
          const filtered = (Array.isArray(all) ? all : []).filter(c=>{
            // allow both client and supplier
            if(!c || (!c.isClient && !c.isSupplier)) return false;
            const n = (c.name||"").toLowerCase();
            const cui = (c.cui||"").toLowerCase();
            const orc = (c.orc||"").toLowerCase();
            return n.includes(q) || cui.includes(q) || orc.includes(q);
          });

          show(filtered);
        }

        // events
        input.addEventListener("input", search);
        input.addEventListener("focus", ()=>{ if((input.value||"").trim().length>=3) search(); });
        window.addEventListener("resize", ()=>{ if(dd.style.display==="block") place(); });
        window.addEventListener("scroll", ()=>{ if(dd.style.display==="block") place(); }, true);

        document.addEventListener("click", (e)=>{
          if(e.target === input) return;
          if(dd.contains(e.target)) return;
          hide();
        }, true);

        input.addEventListener("keydown", (e)=>{
          if(e.key === "Escape"){ hide(); }
          if(e.key === "Enter"){
            // pick first item if visible
            const first = dd.querySelector("button");
            if(first && dd.style.display==="block"){
              e.preventDefault();
              first.click();
            }
          }
        });
      })();


      // Capture click on CHITANTA action (drawer buttons are dynamic)
      document.addEventListener("click", (e)=>{
        const btn = e.target.closest(".action");
        if(!btn) return;
        const label = btn.querySelector(".t")?.textContent || "";
        const title = document.querySelector("#drawerTitle")?.textContent || "";
        if(normalize(title) === normalize("INREGISTRARE DOCUMENTE") && normalize(label) === normalize("CHITANTA")){
          openReceiptModal();
          e.preventDefault();
          e.stopPropagation();
        }
      }, true);

      // Close/cancel
      qs("#receiptClose")?.addEventListener("click", ()=>closeModal(receiptBackdrop));
      qs("#btnCancelReceipt")?.addEventListener("click", ()=>closeModal(receiptBackdrop));
      receiptBackdrop?.addEventListener("click", (e)=>{ if(e.target === receiptBackdrop) closeModal(receiptBackdrop); });

      rcptHasVoucher?.addEventListener("change", ()=>{
        rcptVoucher.disabled = !rcptHasVoucher.checked;
        if(!rcptHasVoucher.checked) rcptVoucher.value = "";
      });
      [rcptAmount, rcptCurrency].forEach(el => el?.addEventListener("input", refreshAmountWords));

      // Unit modal
      function openUnitModal(){
        const u = getUnit();
        uName.value = u.name || "";
        uCui.value = u.cui || "";
        uReg.value = u.reg || "";
        uAddr.value = u.address || "";
        uBank.value = u.bank || "";
        uIban.value = u.iban || "";
        openModal(unitBackdrop);
        uName.focus();
      }
      qs("#btnUnitAdd")?.addEventListener("click", openUnitModal);
      qs("#btnUnitEdit")?.addEventListener("click", openUnitModal);
      qs("#unitClose")?.addEventListener("click", ()=>closeModal(unitBackdrop));
      qs("#btnCancelUnit")?.addEventListener("click", ()=>closeModal(unitBackdrop));
      unitBackdrop?.addEventListener("click", (e)=>{ if(e.target === unitBackdrop) closeModal(unitBackdrop); });
      qs("#btnSaveUnit")?.addEventListener("click", ()=>{
        const u = {
          name: (uName.value||"").trim(),
          cui: (uCui.value||"").trim(),
          reg: (uReg.value||"").trim(),
          address: (uAddr.value||"").trim(),
          bank: (uBank.value||"").trim(),
          iban: (uIban.value||"").trim()
        };
        if(!u.name){ alert("Denumirea unității este obligatorie."); return; }
        setUnit(u);
        rcptUnitName.value = u.name;
        closeModal(unitBackdrop);
      });

      // Partner modal
      function openPartnerModal(){
        const p = getLastPartner();
        pName.value = p.name || "";
        pCui.value = p.cui || "";
        pReg.value = p.reg || "";
        pAddr.value = p.address || "";
        openModal(partnerBackdrop);
        pName.focus();
      }
      qs("#btnPartnerAdd")?.addEventListener("click", openPartnerModal);
      qs("#btnPartnerEdit")?.addEventListener("click", openPartnerModal);
      qs("#partnerClose")?.addEventListener("click", ()=>closeModal(partnerBackdrop));
      qs("#btnCancelPartner")?.addEventListener("click", ()=>closeModal(partnerBackdrop));
      partnerBackdrop?.addEventListener("click", (e)=>{ if(e.target === partnerBackdrop) closeModal(partnerBackdrop); });
      qs("#btnSavePartner")?.addEventListener("click", ()=>{
        const p = {
          name: (pName.value||"").trim(),
          cui: (pCui.value||"").trim(),
          reg: (pReg.value||"").trim(),
          address: (pAddr.value||"").trim()
        };
        if(!p.name){ alert("Denumirea partenerului este obligatorie."); return; }
        setLastPartner(p);
        rcptPartnerName.value = p.name;
        rcptPartnerCui.value = p.cui;
        rcptPartnerReg.value = p.reg;
        rcptPartnerAddr.value = p.address;
        closeModal(partnerBackdrop);
      });

      qs("#btnPrintReceipt")?.addEventListener("click", ()=>alert("Tipărire (demo)."));
      qs("#btnSaveReceipt")?.addEventListener("click", ()=>{
        const __w = qs("#rcptAmountWords"); if(__w && typeof cleanWords==="function") __w.value = cleanWords(__w.value);

        const s = getReceiptSettings();
        // FIX54: plafon chitanta 5000 lei (cash) - blocheaza generarea peste plafon
        const amt = Number(rcptAmount.value||0);
        const cur = (rcptCurrency.value||"RON").toUpperCase();
        const fx = Number(rcptFx.value||1) || 1;
        const amtRon = (cur === "RON") ? amt : (amt * fx);
        if(amtRon > 5000){
          alert("Nu se poate genera chitanță pentru încasări mai mari de 5.000 lei. Reduce suma sau folosește ordin de plată/virament.");
          return;
        }

        if(!(rcptPartnerName.value||"").trim()){
          alert("Selecteaza sau scrie partenerul (minim 3 litere pentru cautare).");
          return;
        }
const payload = {
          id: "RCPT-" + Math.random().toString(16).slice(2) + "-" + Date.now(),
          number: rcptNumber.value,
          date: rcptDate.value,
          unit: getUnit(),
          partner: (receiptSelectedPartner ? {
            id: receiptSelectedPartner.id,
            name: receiptSelectedPartner.name || "",
            cui: receiptSelectedPartner.cui || "",
            orc: receiptSelectedPartner.orc || "",
            address: receiptSelectedPartner.address || ""
          } : {
            id: null,
            name: (rcptPartnerName.value||"").trim(),
            cui: (rcptPartnerCui.value||"").trim(),
            orc: (rcptPartnerReg.value||"").trim(),
            address: (rcptPartnerAddr.value||"").trim()
          }),
          amount: Number(rcptAmount.value||0),
          currency: rcptCurrency.value,
          fx: Number(rcptFx.value||1),
          amountWords: strictAscii(rcptAmountWords.value),
          representative: (rcptRepresentative.value||"").trim(),
          voucherId: rcptHasVoucher.checked ? (rcptVoucher.value||"").trim() : ""
        };
        const list = lsGet("receipts", []);
        list.push(payload);
        lsSet("receipts", list);

        // advance number
        const last = Number(s.lastNumber||0) + 1;
        setReceiptSettings({ lastNumber: last });

        closeModal(receiptBackdrop);
        alert("Chitanță salvată. (Demo LocalStorage)");
      });

      // Escape closes
      document.addEventListener("keydown", (e)=>{
        if(e.key !== "Escape") return;
        if(receiptBackdrop?.classList.contains("show")) closeModal(receiptBackdrop);
        if(unitBackdrop?.classList.contains("show")) closeModal(unitBackdrop);
        if(partnerBackdrop?.classList.contains("show")) closeModal(partnerBackdrop);
      });

      // Init defaults
      (function init(){
        if(!lsGet("receiptSettings", null)) setReceiptSettings({ prefix:"CHIT_NR", lastNumber:0 });
        getUnit(); getLastPartner();
      })();

      window.openReceiptModal = openReceiptModal;
    })();
    // ===== END CHITANTA =====
  </script>


  <script>
    // Focus helper (non-invasive)
    (function(){
      function focusFirst(backdropSel, fieldSel){
        const b = document.querySelector(backdropSel);
        const f = document.querySelector(fieldSel);
        if(!b || !f) return;
        const mo = new MutationObserver(()=>{
          if(b.classList.contains("show")){
            setTimeout(()=>{ try{ f.focus(); f.select?.(); }catch{} }, 60);
          }
        });
        mo.observe(b, { attributes:true, attributeFilter:["class"] });
      }
      focusFirst("#receiptBackdrop", "#rcptAmount");
      focusFirst("#invoiceBackdrop", "#invDate");
      focusFirst("#clientBackdrop", "#cName");
      focusFirst("#unitBackdrop", "#uName");
      focusFirst("#partnerBackdrop", "#pName");
    })();
  </script>


  <!-- Client Full Modal (CLIENTI) -->
  <div class="modal-backdrop" id="clientFullBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="clientFullTitle" style="width:min(1020px,100%);">
      <div class="modal-head">
        <div class="modal-title">
          <div class="h" id="clientFullTitle">Informații societate/partener</div>
          <div class="s" id="clientFullSubtitle">Client</div>
        </div>
        <button class="modal-close" type="button" id="clientFullClose" aria-label="Închide">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <div class="modal-body">
        <div class="row" style="gap:8px; margin-bottom:10px;">
          <button class="btn btn-ghost" type="button" data-tab="gen" id="tabGen">Informații generale</button>
          <button class="btn btn-ghost" type="button" data-tab="contact" id="tabContact">Informații de contact</button>
          <button class="btn btn-ghost" type="button" data-tab="other" id="tabOther">Alte informații</button>
          <button class="btn btn-ghost" type="button" data-tab="disc" id="tabDisc">Discount/Fidelitate</button>
          <div style="flex:1;"></div>
          <div class="field" style="min-width:260px;">
            <label>Tip</label>
            <select id="cfEntityType">
              <option value="societate">Societate</option>
              <option value="persoana_fizica">Persoană fizică</option>
              <option value="organizatie">Organizație guvernamentală</option>
            </select>
          </div>
        </div>

        <!-- TAB: GENERALE -->
        <div id="cfTabGen" class="cfTab">
          <div class="row-2">
            <div class="field">
              <label>Denumire (ex. S.C. Exemplu S.R.L.)</label>
              <input id="cfName" type="text" />
            </div>
            <div class="field">
              <label>Gestiune (unde se vede clientul)</label>
              <input id="cfGestiune" type="text" placeholder="ex: Depozit 1 / Magazin / Restaurant" />
            </div>
          </div>

          <div class="row-2" style="margin-top:10px;">
            <div class="field">
              <label>C.I.F. (persoane fizice: nume prenume)</label>
              <div class="row" style="gap:8px; flex-wrap:nowrap;">
                <input id="cfCui" type="text" style="flex:1; min-width:0;" />
                <button class="btn btn-ghost" type="button" id="btnCuiLookup" title="Caută online după CUI">Internet</button>
              </div>
            </div>
            <div class="field">
              <label>Nr. O.R.C.</label>
              <input id="cfOrc" type="text" />
            </div>
          </div>

          <div class="field" style="margin-top:10px;">
            <label>Adresă - Strada Nr. (bl., sc., ap., etc.)</label>
            <input id="cfAddress" type="text" />
          </div>

          <div class="row-3" style="margin-top:10px;">
            <div class="field">
              <label>Localitate</label>
              <input id="cfCity" type="text" />
            </div>
            <div class="field">
              <label>Cod poștal</label>
              <input id="cfPostal" type="text" />
            </div>
            <div class="field">
              <label>Județ</label>
              <input id="cfCounty" type="text" />
            </div>
          </div>

          <div class="row-2" style="margin-top:10px;">
            <div class="field">
              <label>Țară</label>
              <input id="cfCountry" type="text" value="ROMÂNIA" />
            </div>
            <div class="field">
              <label>Adresă punct de lucru</label>
              <input id="cfWorkPoint" type="text" />
            </div>
          </div>

          <div class="hr"></div>

          <div class="section-h">Conturi bancare</div>
          <div class="row-3">
            <div class="field" style="grid-column: span 2;">
              <label>IBAN</label>
              <input id="cfIban" type="text" />
            </div>
            <div class="field">
              <label>Bancă</label>
              <input id="cfBank" type="text" />
            </div>
          </div>
          <div class="row" style="justify-content:flex-end; margin-top:10px;">
            <button class="btn btn-ghost" type="button" id="btnAddBankRow">Adaugă</button>
          </div>

          <table class="table" aria-label="Conturi bancare" style="margin-top:10px;">
            <thead>
              <tr>
                <th style="width:45%;">Bancă</th>
                <th style="width:45%;">IBAN</th>
                <th style="width:10%;">Acțiuni</th>
              </tr>
            </thead>
            <tbody id="cfBankRows"></tbody>
          </table>

          <div class="row" style="align-items:center; gap:14px; margin-top:12px;">
            <label style="display:flex; align-items:center; gap:10px; color:var(--muted); font-weight:850;">
              <input id="cfIsClient" type="checkbox" checked />
              Client
            </label>
            <label style="display:flex; align-items:center; gap:10px; color:var(--muted); font-weight:850;">
              <input id="cfIsSupplier" type="checkbox" />
              Furnizor
            </label>
            <label style="display:flex; align-items:center; gap:10px; color:var(--muted); font-weight:850;">
              <input id="cfVatCash" type="checkbox" />
              T.V.A. la încasare
            </label>
          </div>
        </div>

        <!-- TAB: CONTACT -->
        <div id="cfTabContact" class="cfTab" style="display:none;">
          <div class="row-2">
            <div class="field">
              <label>Adresă email</label>
              <input id="cfEmail" type="email" />
            </div>
            <div class="field">
              <label>Nr. telefon</label>
              <input id="cfPhone" type="tel" />
            </div>
          </div>
        </div>

        <!-- TAB: OTHER -->
        <div id="cfTabOther" class="cfTab" style="display:none;">
          <div class="row-2">
            <div class="field">
              <label>Capital social</label>
              <input id="cfCapital" type="number" min="0" step="0.01" />
            </div>
            <div class="field">
              <label>Alte informații</label>
              <input id="cfOtherInfo" type="text" />
            </div>
          </div>
        </div>

        <!-- TAB: DISCOUNT -->
        <div id="cfTabDisc" class="cfTab" style="display:none;">
          <div class="row-2">
            <div class="field">
              <label>Discount (%)</label>
              <input id="cfDiscount" type="number" min="0" step="0.01" value="0" />
            </div>
            <div class="field">
              <label>Fidelitate / Observații</label>
              <input id="cfLoyalty" type="text" />
            </div>
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn" type="button" id="btnCancelClientFull">Renunță</button>
          <button class="btn btn-primary" type="button" id="btnSaveClientFull">Salvează</button>
        </div>
      </div>
    </div>
  </div>


  <script>
    // ===== CLIENT FULL (modal) — se folosește din FACTURA / PROFORMA / CHITANTA și oriunde există buton "Adaugă client" =====
    (function(){
      const qs = (s, p=document) => p.querySelector(s);
      const qsa = (s, p=document) => [...p.querySelectorAll(s)];
      const normalize = (s)=> (s||"").toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").trim().toUpperCase();

      // Safe storage (dacă localStorage e blocat)
      const memStore = window.__memStore || (window.__memStore = {});
      function safeGetItem(k){
        try{ return localStorage.getItem(k); }catch{ return memStore[k] ?? null; }
      }
      function safeSetItem(k,v){
        try{ localStorage.setItem(k,v); }catch{ memStore[k]=v; }
      }
      function lsGet(key, fallback){
        try{
          const raw = safeGetItem(key);
          if(raw === null || raw === undefined) return fallback;
          const v = JSON.parse(raw);
          return (v ?? fallback);
        }catch{ return fallback; }
      }
      function lsSet(key, val){
        safeSetItem(key, JSON.stringify(val));
      }

      function openModal(backdropEl){
        if(!backdropEl) return;
        backdropEl.classList.add("show");
        backdropEl.setAttribute("aria-hidden","false");
        document.body.style.overflow = "hidden";
      }
      function closeModal(backdropEl){
        if(!backdropEl) return;
        backdropEl.classList.remove("show");
        backdropEl.setAttribute("aria-hidden","true");
        document.body.style.overflow = "";
      }

      const backdrop = qs("#clientFullBackdrop");
      if(!backdrop) return;

      const tabs = {
        gen: qs("#cfTabGen"),
        contact: qs("#cfTabContact"),
        other: qs("#cfTabOther"),
        disc: qs("#cfTabDisc"),
      };
      const tabBtns = qsa('[data-tab]');

      function setTab(name){
        Object.entries(tabs).forEach(([k,el]) => { if(el) el.style.display = (k===name ? "" : "none"); });
        tabBtns.forEach(b => b.classList.toggle("active", b.getAttribute("data-tab")===name));
      }

      // Fields
      const cfEntityType = qs("#cfEntityType");
      const cfName = qs("#cfName");
      const cfGestiune = qs("#cfGestiune");
      const cfCui = qs("#cfCui");
      const cfOrc = qs("#cfOrc");
      const cfAddress = qs("#cfAddress");
      const cfCity = qs("#cfCity");
      const cfPostal = qs("#cfPostal");
      const cfCounty = qs("#cfCounty");
      const cfCountry = qs("#cfCountry");
      const cfWorkPoint = qs("#cfWorkPoint");
      const cfIban = qs("#cfIban");
      const cfBank = qs("#cfBank");
      const cfBankRows = qs("#cfBankRows");
      const cfIsClient = qs("#cfIsClient");
      const cfIsSupplier = qs("#cfIsSupplier");
      const cfVatCash = qs("#cfVatCash");
      const cfEmail = qs("#cfEmail");
      const cfPhone = qs("#cfPhone");
      const cfCapital = qs("#cfCapital");
      const cfOtherInfo = qs("#cfOtherInfo");
      const cfDiscount = qs("#cfDiscount");
      const cfLoyalty = qs("#cfLoyalty");

      const titleEl = qs("#clientFullTitle");
      const subEl = qs("#clientFullSubtitle");

      let currentId = null;
      let onSaveCb = null;

      function bankRowTr(bank, iban){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${(bank||"").replace(/</g,"&lt;")}</td>
          <td>${(iban||"").replace(/</g,"&lt;")}</td>
          <td style="text-align:right;"><button type="button" class="btn btn-danger btnDelBank">Șterge</button></td>
        `;
        tr.querySelector(".btnDelBank").addEventListener("click", ()=>tr.remove());
        return tr;
      }

      function clearForm(){
        currentId = null;
        onSaveCb = null;
        cfEntityType.value = "societate";
        cfName.value = "";
        cfGestiune.value = "";
        cfCui.value = "";
        cfOrc.value = "";
        cfAddress.value = "";
        cfCity.value = "";
        cfPostal.value = "";
        cfCounty.value = "";
        cfCountry.value = "ROMÂNIA";
        cfWorkPoint.value = "";
        cfIban.value = "";
        cfBank.value = "";
        cfBankRows.innerHTML = "";
        cfIsClient.checked = true;
        cfIsSupplier.checked = false;
        cfVatCash.checked = false;
        cfEmail.value = "";
        cfPhone.value = "";
        cfCapital.value = "";
        cfOtherInfo.value = "";
        cfDiscount.value = 0;
        cfLoyalty.value = "";
        setTab("gen");
      }

      function loadClient(id){
        const all = lsGet("clientsFull", []);
        const c = all.find(x => x.id === id);
        if(!c) return null;

        currentId = c.id;
        cfEntityType.value = c.entityType || "societate";
        cfName.value = c.name || "";
        cfGestiune.value = c.gestiune || "";
        cfCui.value = c.cui || "";
        cfOrc.value = c.orc || "";
        cfAddress.value = c.address || "";
        cfCity.value = c.city || "";
        cfPostal.value = c.postal || "";
        cfCounty.value = c.county || "";
        cfCountry.value = c.country || "ROMÂNIA";
        cfWorkPoint.value = c.workPoint || "";
        cfIban.value = "";
        cfBank.value = "";
        cfBankRows.innerHTML = "";
        (c.bankAccounts || []).forEach(b => cfBankRows.appendChild(bankRowTr(b.bank, b.iban)));

        cfIsClient.checked = !!c.isClient;
        cfIsSupplier.checked = !!c.isSupplier;
        cfVatCash.checked = !!c.vatCash;

        cfEmail.value = c.email || "";
        cfPhone.value = c.phone || "";
        cfCapital.value = (c.capital ?? "");
        cfOtherInfo.value = c.otherInfo || "";
        cfDiscount.value = (c.discount ?? 0);
        cfLoyalty.value = c.loyalty || "";

        return c;
      }

      function gather(){
        const bankAccounts = [...cfBankRows.querySelectorAll("tr")].map(tr => ({
          bank: tr.children[0].textContent || "",
          iban: tr.children[1].textContent || ""
        }));

        return {
          id: currentId || ("C-" + Math.random().toString(16).slice(2) + "-" + Date.now()),
          entityType: cfEntityType.value,
          name: (cfName.value||"").trim(),
          gestiune: (cfGestiune.value||"").trim(),
          cui: (cfCui.value||"").trim(),
          orc: (cfOrc.value||"").trim(),
          address: (cfAddress.value||"").trim(),



          country: (cfCountry.value||"").trim() || "ROMÂNIA",
          workPoint: (cfWorkPoint.value||"").trim(),
          bankAccounts,
          email: (cfEmail.value||"").trim(),
          phone: (cfPhone.value||"").trim(),
          capital: (cfCapital.value === "" ? null : Number(cfCapital.value||0)),
          otherInfo: (cfOtherInfo.value||"").trim(),
          discount: Number(cfDiscount.value||0),
          loyalty: (cfLoyalty.value||"").trim(),
          isClient: !!cfIsClient.checked,
          isSupplier: !!cfIsSupplier.checked,
          vatCash: !!cfVatCash.checked,
          updatedAt: new Date().toISOString()
        };
      }

      function upsertClient(c){
        const all = lsGet("clientsFull", []);
        const idx = all.findIndex(x => x.id === c.id);
        if(idx >= 0) all[idx] = c; else all.push(c);
        lsSet("clientsFull", all);

        // compat list pentru dropdown-ul existent la factură (folosit de loadClientsIntoSelect)
        const compat = lsGet("clients", []);
        const c2 = {
          id: c.id,
          name: c.name,
          cui: c.cui,
          reg: c.orc,
          address: [c.address, c.city, c.county].filter(Boolean).join(", "),
          bank: (c.bankAccounts?.[0]?.bank || ""),
          iban: (c.bankAccounts?.[0]?.iban || "")
        };
        const i2 = compat.findIndex(x => x.id === c2.id);
        if(i2 >= 0) compat[i2] = c2; else compat.push(c2);
        lsSet("clients", compat);

        return c2;
      }

      function openClientModal(opts={}){
        clearForm();
        titleEl.textContent = "Informații societate/partener";
        subEl.textContent = opts.subtitle || "Client";

        if(opts.clientId){
          loadClient(opts.clientId);
        }else if(opts.prefill && typeof opts.prefill === "object"){
          // prefill minimal
          if(opts.prefill.name) cfName.value = opts.prefill.name;
          if(opts.prefill.cui) cfCui.value = opts.prefill.cui;
          if(opts.prefill.orc) cfOrc.value = opts.prefill.orc;
          if(opts.prefill.address) cfAddress.value = opts.prefill.address;
        }

        onSaveCb = (typeof opts.onSave === "function") ? opts.onSave : null;

        openModal(backdrop);
        setTimeout(()=>{ try{ cfName.focus(); }catch{} }, 50);
      }

      // Tabs
      tabBtns.forEach(b => b.addEventListener("click", ()=>setTab(b.getAttribute("data-tab"))));

      // Close
      qs("#clientFullClose").addEventListener("click", ()=>closeModal(backdrop));
      qs("#btnCancelClientFull").addEventListener("click", ()=>closeModal(backdrop));
      backdrop.addEventListener("click", (e)=>{ if(e.target === backdrop) closeModal(backdrop); });

      // Add bank row
      qs("#btnAddBankRow").addEventListener("click", ()=>{
        const iban = (cfIban.value||"").trim();
        const bank = (cfBank.value||"").trim();
        if(!iban && !bank) return;
        cfBankRows.appendChild(bankRowTr(bank, iban));
        cfIban.value = "";
        cfBank.value = "";
      });

      // Save
      qs("#btnSaveClientFull").addEventListener("click", ()=>{
        const c = gather();
        if(!c.name){
          alert("Denumirea este obligatorie.");
          setTab("gen");
          cfName.focus();
          return;
        }
        const compat = upsertClient(c);
        closeModal(backdrop);


        // Route to GESTIUNE lists based on checkboxes (Client / Furnizor)
        (function(){
          const entry = { id: c.id, name: c.name||"", cui: c.cui||"", reg: c.orc||"", address: [c.address,c.city,c.county].filter(Boolean).join(", ") };
          function upsertList(key){
            const list = lsGet(key, []);
            const idx = list.findIndex(x => String(x.id) === String(entry.id));
            if(idx >= 0) list[idx] = entry; else list.push(entry);
            lsSet(key, list);
          }
          if(c.isClient) upsertList("gestiune_clients");
          if(c.isSupplier) upsertList("gestiune_suppliers");
        })();

        if(onSaveCb){
          try{ onSaveCb(c, compat); }catch{}
        }
      });

      // "Internet" lookup: implicit caută în lista locală; pentru online, lasă hook extern
      qs("#btnCuiLookup").addEventListener("click", async ()=>{
        const cui = (cfCui.value||"").trim();
        if(!cui){ alert("Completează C.I.F. înainte de căutare."); return; }

        // 1) local lookup
        const all = lsGet("clientsFull", []);
        const found = all.find(x => (x.cui||"").replace(/\s+/g,"") === cui.replace(/\s+/g,""));
        if(found){
          loadClient(found.id);
          return;
        }

        // 2) external hook (dacă o vei lega ulterior)
        if(typeof window.lookupCompanyByCUI === "function"){
          try{
            const data = await window.lookupCompanyByCUI(cui);
            if(data && typeof data === "object"){
              // Map fields if present
              if(data.name) cfName.value = data.name;
              if(data.orc) cfOrc.value = data.orc;
              if(data.address) cfAddress.value = data.address;
              if(data.city) cfCity.value = data.city;
              if(data.county) cfCounty.value = data.county;
              if(data.postal) cfPostal.value = data.postal;
              if(data.country) cfCountry.value = data.country;
              alert("Date preluate (hook extern). Verifică și salvează.");
              return;
            }
          }catch(e){
            alert("Căutarea online a eșuat (hook extern).");
            return;
          }
        }

        alert("Nu există implementare online în acest fișier. Momentan caută doar în lista locală. (Se poate lega ulterior de un API.)");
      });

      // Expose API pentru a fi reutilizat oriunde
      window.openClientModal = openClientModal;

      // HOOKS: deschide fereastra client din:
      // - Factura/Proforma: butonul "Adaugă" lângă client (#btnAddClient)
      // - Chitanță: "Am primit de la" Adaugă/Modifică (#btnPartnerAdd / #btnPartnerEdit)
      // + oricare alt buton viitor cu [data-open-client]
      document.addEventListener("click", (e)=>{
        const t = e.target;

        // Invoice add client
        if(t && t.closest && t.closest("#btnAddClient")){
          e.preventDefault(); e.stopPropagation();
          openClientModal({
            subtitle: "Client (pentru factură)",
            onSave: (full, compat)=>{
              // Reîncarcă dropdown-ul existent + selectează clientul nou
              try{
                if(typeof window.loadClientsIntoSelect === "function") window.loadClientsIntoSelect(full.id);
                const sel = qs("#invClient");
                if(sel) sel.value = full.id;
              }catch{}
            }
          });
          return;
        }

        // Receipt partner add/edit -> reuse client modal
        if(t && t.closest && (t.closest("#btnPartnerAdd") || t.closest("#btnPartnerEdit"))){
          e.preventDefault(); e.stopPropagation();
          // prefill with current receipt partner (if any)
          const curPartner = lsGet("receiptPartner", {name:"",cui:"",reg:"",address:""});
          openClientModal({
            subtitle: "Partener (pentru chitanță)",
            prefill: {
              name: curPartner.name || "",
              cui: curPartner.cui || "",
              orc: curPartner.reg || "",
              address: curPartner.address || ""
            },
            onSave: (full, compat)=>{
              // write to receipt fields if modal exists
              const n = qs("#rcptPartnerName"); if(n) n.value = full.name || "";
              const c = qs("#rcptPartnerCui"); if(c) c.value = full.cui || "";
              const r = qs("#rcptPartnerReg"); if(r) r.value = full.orc || "";
              const a = qs("#rcptPartnerAddr"); if(a) a.value = full.address || "";
              lsSet("receiptPartner", { id: full.id, name: full.name, cui: full.cui, reg: full.orc, address: full.address });
            }
          });
          return;
        }

        // Generic future hook
        const any = t && t.closest && t.closest("[data-open-client]");
        if(any){
          e.preventDefault(); e.stopPropagation();
          openClientModal({ subtitle: "Client", clientId: any.getAttribute("data-client-id") || null });
          return;
        }
      }, true);

      // Escape close
      document.addEventListener("keydown", (e)=>{
        if(e.key !== "Escape") return;
        if(backdrop.classList.contains("show")) closeModal(backdrop);
      });

      // Defaults init
      (function init(){
        if(!Array.isArray(lsGet("clientsFull", []))) lsSet("clientsFull", []);
      })();

    })();
    // ===== END CLIENT FULL =====
  </script>


  <!-- Incasare Modal (INCASARE) -->
  <div class="modal-backdrop" id="incasareBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="incasareTitle" style="width:min(1040px,100%);">
      <div class="modal-head">
        <div class="modal-title">
          <div class="h" id="incasareTitle">Încasare</div>
          <div class="s">Selectează clientul și facturile de încasat</div>
        </div>
        <button class="modal-close" type="button" id="incasareClose" aria-label="Închide">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <div class="modal-body">
        <div class="section-h">Încasare de la</div>

        <div class="row" style="align-items:flex-end; gap:10px;">
          <div class="field" style="flex:1; min-width:260px;">
            <label>Client</label>
            <input id="incClientName" type="text" placeholder="Selectează client…" readonly />
          </div>
          <div class="toolbar-right">
            <button class="btn btn-ghost" type="button" id="btnIncClientAdd">Adaugă</button>
            <button class="btn btn-ghost" type="button" id="btnIncClientEdit">Modifică</button>
          </div>
        </div>

        <div class="row-3" style="margin-top:10px;">
          <div class="field">
            <label>C.I.F.</label>
            <input id="incClientCui" type="text" />
          </div>
          <div class="field">
            <label>Nr. de înreg. la Reg. Com.</label>
            <input id="incClientOrc" type="text" />
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <div class="toolbar-right">
              <button class="btn btn-ghost" type="button" id="btnIncSelectAll">Toate</button>
              <button class="btn btn-ghost" type="button" id="btnIncSelectNone">Niciuna</button>
            </div>
          </div>
        </div>

        <div class="field" style="margin-top:10px;">
          <label>Adresă</label>
          <input id="incClientAddr" type="text" />
        </div>

        <div class="hr"></div>

        <div class="section-h">Facturile neîncasate</div>

        <table class="table" aria-label="Facturile clientului" style="margin-top:6px;">
          <thead>
            <tr>
              <th style="width:5%;"></th>
              <th style="width:18%;">Data doc.</th>
              <th style="width:22%;">Nr. doc.</th>
              <th style="width:20%;">Total (RON)</th>
              <th style="width:20%;">Rămas (RON)</th>
              <th style="width:15%;">Plătit</th>
            </tr>
          </thead>
          <tbody id="incInvoiceRows"></tbody>
        </table>

        <div class="kpi-grid">
          <div class="kpi">
            <div class="k">Total facturi</div>
            <div class="v"><span id="kTotalFacturi">0</span></div>
          </div>
          <div class="kpi">
            <div class="k">Total facturi selectate</div>
            <div class="v"><span id="kTotalSelectate">0</span></div>
          </div>
          <div class="kpi">
            <div class="k">Sold (neplătit)</div>
            <div class="v"><span id="kSold">0.00</span> <small>RON</small></div>
          </div>
          <div class="kpi">
            <div class="k">Total de plată</div>
            <div class="v"><span id="kDePlata">0.00</span> <small>RON</small></div>
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn btn-primary" type="button" id="btnIncChitanta">Încasare cu chitanță</button>
          <button class="btn" type="button" id="btnIncAltTip">Încasare cu alt tip de document</button>
          <button class="btn btn-muted" type="button" id="btnIncClose">Închide</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Payment Method Modal (OP / CARD) -->
  <div class="modal-backdrop" id="payBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="payTitle" style="width:min(720px,100%);">
      <div class="modal-head">
        <div class="modal-title">
          <div class="h" id="payTitle">Încasare – alt tip</div>
          <div class="s">Ordin de plată / Card</div>
        </div>
        <button class="modal-close" type="button" id="payClose" aria-label="Închide">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="row-2">
          <div class="field">
            <label>Tip încasare</label>
            <select id="payType">
              <option value="OP">Ordin de plată</option>
              <option value="CARD">Card</option>
            </select>
          </div>
          <div class="field">
            <label>Număr document</label>
            <input id="payDocNo" type="text" placeholder="ex: OP123 / POS-456" />
          </div>
        </div>
        <div class="row-2" style="margin-top:10px;">
          <div class="field">
            <label>Data</label>
            <input id="payDate" type="date" />
          </div>
          <div class="field">
            <label>Sumă (RON)</label>
            <input id="payAmount" type="number" min="0" step="0.01" />
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn" type="button" id="btnPayCancel">Renunță</button>
          <button class="btn btn-primary" type="button" id="btnPaySave">Salvează</button>
        </div>
      </div>
    </div>
  </div>


  <script>
    // ===== INCASARE (modal) — implementare minimă, fără a modifica restul aplicației =====
    (function(){
      const qs = (s, p=document) => p.querySelector(s);
      const qsa = (s, p=document) => [...p.querySelectorAll(s)];
      const normalize = (s)=> (s||"").toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").trim().toUpperCase();

      // Safe storage
      const memStore = window.__memStore || (window.__memStore = {});
      function safeGetItem(k){ try{ return localStorage.getItem(k); }catch{ return memStore[k] ?? null; } }
      function safeSetItem(k,v){ try{ localStorage.setItem(k,v); }catch{ memStore[k]=v; } }
      function lsGet(key, fallback){
        try{
          const raw = safeGetItem(key);
          if(raw === null || raw === undefined) return fallback;
          const v = JSON.parse(raw);
          return (v ?? fallback);
        }catch{ return fallback; }
      }
      function lsSet(key, val){ safeSetItem(key, JSON.stringify(val)); }

      function openModal(backdropEl){
        if(!backdropEl) return;
        backdropEl.classList.add("show");
        backdropEl.setAttribute("aria-hidden","false");
        document.body.style.overflow = "hidden";
      }
      function closeModal(backdropEl){
        if(!backdropEl) return;
        backdropEl.classList.remove("show");
        backdropEl.setAttribute("aria-hidden","true");
        document.body.style.overflow = "";
      }
      function money(n){
        const x = Number(n);
        if(!isFinite(x)) return "0.00";
        return x.toFixed(2);
      }

      const incBackdrop = qs("#incasareBackdrop");
      if(!incBackdrop) return;

      const incClientName = qs("#incClientName");
      const incClientCui  = qs("#incClientCui");
      const incClientOrc  = qs("#incClientOrc");
      const incClientAddr = qs("#incClientAddr");

      const rowsBody = qs("#incInvoiceRows");
      const kTotalFacturi = qs("#kTotalFacturi");
      const kTotalSelectate = qs("#kTotalSelectate");
      const kSold = qs("#kSold");
      const kDePlata = qs("#kDePlata");

      let currentClient = null; // full client object (clientsFull)
      let currentClientCompat = null; // compat for invoice storage
      let currentInvoices = []; // filtered invoices for current client (FACTURA only)
      let selectedInvoiceIds = new Set();

      function invoiceDisplayNo(inv){
        const serie = inv.serie || "";
        const num = (inv.number !== undefined && inv.number !== null) ? String(inv.number) : "";
        return [serie, num].filter(Boolean).join("-");
      }

      function invoiceTotalRon(inv){
        // Use totals.ron when present, else gross, else 0
        const t = inv?.totals || {};
        const ron = Number(t.ron);
        if(isFinite(ron) && ron > 0) return ron;
        const gross = Number(t.gross);
        if(isFinite(gross)) return gross;
        return 0;
      }

      function getPayments(){
        return lsGet("payments", []);
      }

      function paidByInvoiceId(){
        const map = {};
        getPayments().forEach(p=>{
          (p.allocations || []).forEach(a=>{
            map[a.invoiceId] = (map[a.invoiceId] || 0) + Number(a.amount || 0);
          });
        });
        return map;
      }

      function remainingForInvoice(inv, paidMap){
        const total = invoiceTotalRon(inv);
        const paid = Number(paidMap[inv.id] || 0);
        const rem = Math.max(0, total - paid);
        return { total, paid, rem, isPaid: rem <= 0.009 };
      }

      function recalcKpis(){
        const paidMap = paidByInvoiceId();
        let totalCount = currentInvoices.length;

        let sold = 0;
        let selectedCount = 0;
        let dePlata = 0;

        currentInvoices.forEach(inv=>{
          const r = remainingForInvoice(inv, paidMap);
          sold += r.rem;
          if(selectedInvoiceIds.has(inv.id)){
            selectedCount += 1;
            dePlata += r.rem;
          }
        });

        kTotalFacturi.textContent = String(totalCount);
        kTotalSelectate.textContent = String(selectedCount);
        kSold.textContent = money(sold);
        kDePlata.textContent = money(dePlata);
      }

      function renderInvoices(){
        rowsBody.innerHTML = "";
        selectedInvoiceIds.clear();

        const paidMap = paidByInvoiceId();

        // Only show invoices with client match; show all, but default select unpaid
        currentInvoices.forEach(inv=>{
          const r = remainingForInvoice(inv, paidMap);

          const tr = document.createElement("tr");
          const checked = !r.isPaid;
          if(checked) selectedInvoiceIds.add(inv.id);

          tr.innerHTML = `
            <td><input class="chk" type="checkbox" ${checked ? "checked" : ""} ${r.isPaid ? "" : ""} data-id="${inv.id}"></td>
            <td>${(inv.date || "").replace(/</g,"&lt;")}</td>
            <td>${invoiceDisplayNo(inv).replace(/</g,"&lt;")}</td>
            <td>${money(r.total)}</td>
            <td>${money(r.rem)}</td>
            <td>${r.isPaid ? '<span class="status-pill ok">DA</span>' : '<span class="status-pill no">NU</span>'}</td>
          `;
          rowsBody.appendChild(tr);
        });

        rowsBody.querySelectorAll(".chk").forEach(chk=>{
          chk.addEventListener("change", ()=>{
            const id = chk.getAttribute("data-id");
            if(chk.checked) selectedInvoiceIds.add(id); else selectedInvoiceIds.delete(id);
            recalcKpis();
          });
        });

        recalcKpis();
      }

      function filterInvoicesForClient(clientId){
        const invoices = lsGet("invoices", []);
        const proformas = lsGet("proformas", []);
        const all = []
          .concat(Array.isArray(invoices)?invoices:[])
          .concat(Array.isArray(proformas)?proformas:[]);
        // payload stores client as object with id
        const list = all.filter(inv => inv?.client?.id && String(inv.client.id) === String(clientId));
        // Sort by date then number
        list.sort((a,b)=>{
          const da = (a.date||""); const db = (b.date||"");
          if(da !== db) return da.localeCompare(db);
          return String(a.number||"").localeCompare(String(b.number||""));
        });
        return list;
      }

      function setClientFromFull(fullClient){
        if(!fullClient) return;
        currentClient = fullClient;

        // Compat object (already built by client modal in "clients")
        const compatList = lsGet("clients", []);
        currentClientCompat = compatList.find(c => String(c.id) === String(fullClient.id)) || {
          id: fullClient.id,
          name: fullClient.name || "",
          cui: fullClient.cui || "",
          reg: fullClient.orc || "",
          address: fullClient.address || "",
          bank: (fullClient.bankAccounts?.[0]?.bank || ""),
          iban: (fullClient.bankAccounts?.[0]?.iban || "")
        };

        incClientName.value = fullClient.name || "";
        incClientCui.value = fullClient.cui || "";
        incClientOrc.value = fullClient.orc || "";
        incClientAddr.value = fullClient.address || "";

        currentInvoices = filterInvoicesForClient(fullClient.id);
        renderInvoices();
      }


      // FIX51: export setClientFromFull pentru typeahead
      window.__incSetClientFromFull = setClientFromFull;

      function openIncasareModal(){
        // reset
        currentClient = null;
        currentClientCompat = null;
        currentInvoices = [];
        selectedInvoiceIds.clear();

        incClientName.value = "";
        incClientCui.value = "";
        incClientOrc.value = "";
        incClientAddr.value = "";
        rowsBody.innerHTML = "";
        kTotalFacturi.textContent = "0";
        kTotalSelectate.textContent = "0";
        kSold.textContent = "0.00";
        kDePlata.textContent = "0.00";

        openModal(incBackdrop);
      }

      // Open on INREGISTRARE DOCUMENTE -> INCASARE
      document.addEventListener("click", (e)=>{
        const btn = e.target.closest(".action");
        if(!btn) return;
        const label = btn.querySelector(".t")?.textContent || "";
        const title = document.querySelector("#drawerTitle")?.textContent || "";
        if(normalize(title) === normalize("INREGISTRARE DOCUMENTE") && normalize(label) === normalize("INCASARE")){
          openIncasareModal();
          e.preventDefault();
          e.stopPropagation();
        }
      }, true);

      // Close buttons
      qs("#incasareClose").addEventListener("click", ()=>closeModal(incBackdrop));
      qs("#btnIncClose").addEventListener("click", ()=>closeModal(incBackdrop));
      incBackdrop.addEventListener("click", (e)=>{ if(e.target === incBackdrop) closeModal(incBackdrop); });

      // Client add/edit using the already created full client modal
      qs("#btnIncClientAdd").addEventListener("click", ()=>{
        if(typeof window.openClientModal !== "function"){
          alert("Fereastra client nu este disponibilă.");
          return;
        }
        window.openClientModal({
          subtitle: "Client (pentru încasare)",
          onSave: (full, compat)=>{
            setClientFromFull(full);
          }
        });
      });

      qs("#btnIncClientEdit").addEventListener("click", ()=>{
        if(!currentClient){
          // if none, behave like add
          qs("#btnIncClientAdd").click();
          return;
        }
        if(typeof window.openClientModal !== "function"){
          alert("Fereastra client nu este disponibilă.");
          return;
        }
        window.openClientModal({
          subtitle: "Client (modificare)",
          clientId: currentClient.id,
          onSave: (full, compat)=>{
            setClientFromFull(full);
          }
        });
      });

      // If user manually edits fields, keep in currentClientCompat for receipt partner
      [incClientCui, incClientOrc, incClientAddr].forEach(el=>{
        el.addEventListener("input", ()=>{
          if(!currentClient) return;
          currentClient.cui = incClientCui.value;
          currentClient.orc = incClientOrc.value;
          currentClient.address = incClientAddr.value;
          // update compat storage
          const all = lsGet("clientsFull", []);
          const idx = all.findIndex(x => x.id === currentClient.id);
          if(idx >= 0){ all[idx] = currentClient; lsSet("clientsFull", all); }
        });
      });

      // Select all / none
      qs("#btnIncSelectAll").addEventListener("click", ()=>{
        selectedInvoiceIds = new Set(currentInvoices.map(i=>i.id));
        rowsBody.querySelectorAll(".chk").forEach(c=>c.checked = true);
        recalcKpis();
      });
      qs("#btnIncSelectNone").addEventListener("click", ()=>{
        selectedInvoiceIds.clear();
        rowsBody.querySelectorAll(".chk").forEach(c=>c.checked = false);
        recalcKpis();
      });

      function selectedInvoicesRemainingTotal(){
        const paidMap = paidByInvoiceId();
        let total = 0;
        const selected = currentInvoices.filter(inv => selectedInvoiceIds.has(inv.id));
        selected.forEach(inv=>{
          total += remainingForInvoice(inv, paidMap).rem;
        });
        return { total, selected };
      }

      // Allocation: distribute amount across selected invoices (oldest first)
      function allocateAcrossSelected(amountRon, selected){
        const paidMap = paidByInvoiceId();
        let remaining = Number(amountRon || 0);
        const allocations = [];
        for(const inv of selected){
          if(remaining <= 0.0001) break;
          const r = remainingForInvoice(inv, paidMap);
          if(r.rem <= 0.0001) continue;
          const pay = Math.min(r.rem, remaining);
          allocations.push({ invoiceId: inv.id, amount: Number(pay.toFixed(2)) });
          remaining -= pay;
        }
        return allocations;
      }

      function addPaymentRecord(method, docNo, amountRon, allocations){
        const payments = lsGet("payments", []);
        payments.push({
          id: "PAY-" + Math.random().toString(16).slice(2) + "-" + Date.now(),
          method,
          docNo: docNo || "",
          date: new Date().toISOString().slice(0,10),
          clientId: currentClient?.id || null,
          clientName: currentClient?.name || "",
          amountRon: Number(amountRon || 0),
          allocations: allocations || []
        });
        lsSet("payments", payments);
      }

      // INCASARE CU CHITANTA
      qs("#btnIncChitanta").addEventListener("click", ()=>{
        if(!currentClient){
          alert("Selectează un client.");
          return;
        }
        const { total, selected } = selectedInvoicesRemainingTotal();
        if(selected.length === 0){
          alert("Selectează cel puțin o factură.");
          return;
        }
        if(total <= 0.0001){
          alert("Nu există sold de încasat pe facturile selectate.");
          return;
        }

        // Context global used by receipt save hook
        window.__incasare_ctx = {
          client: { id: currentClient.id, name: currentClient.name, cui: incClientCui.value, reg: incClientOrc.value, address: incClientAddr.value },
          selectedInvoiceIds: selected.map(i=>i.id),
          totalRon: total
        };

        // Prefill receipt partner
        lsSet("receiptPartner", { id: currentClient.id, name: currentClient.name, cui: incClientCui.value, reg: incClientOrc.value, address: incClientAddr.value });

        if(typeof window.openReceiptModal === "function"){
          window.openReceiptModal();
          // After open, set amount
          setTimeout(()=>{
            const amt = qs("#rcptAmount");
            if(amt) { amt.value = String((Math.round(total*100)/100).toFixed(2)); amt.dispatchEvent(new Event("input")); }
            const n = qs("#rcptPartnerName"); if(n) n.value = currentClient.name || "";
            const c = qs("#rcptPartnerCui"); if(c) c.value = incClientCui.value || "";
            const r = qs("#rcptPartnerReg"); if(r) r.value = incClientOrc.value || "";
            const a = qs("#rcptPartnerAddr"); if(a) a.value = incClientAddr.value || "";
            // FIX53: Reprezentând = numar factura/proforma selectata(e)
            const rep = qs("#rcptRepresentative");
            if(rep){
              const nums = selected.map(i=>invoiceDisplayNo(i)).filter(Boolean);
              rep.value = nums.length ? nums.join(", ") : "";
            }
            const w = qs("#rcptAmountWords");
            const cur = qs("#rcptCurrency");
            if(w && typeof moneyToWordsRo === "function"){
              w.value = moneyToWordsRo(qs("#rcptAmount")?.value || "0", (cur?.value || "RON"));
            }
          }, 80);
        }else{
          alert("Fereastra de chitanță nu este disponibilă.");
        }
      });

      // Hook receipt save to record payments + allocations
      // We attach once (capture), without blocking existing handler.
      (function hookReceiptSave(){
        const btn = qs("#btnSaveReceipt");
        if(!btn || btn.__incHooked) return;
        btn.__incHooked = true;

        btn.addEventListener("click", ()=>{
          const ctx = window.__incasare_ctx;
          if(!ctx || !ctx.selectedInvoiceIds) return;
          // Ensure inc modal still open or context present
          const amount = Number(ctx.totalRon || 0);
          if(!isFinite(amount) || amount <= 0) return;

          // Build selected invoices list by ids
          const invAll = lsGet("invoices", []);
          const selected = invAll.filter(inv => ctx.selectedInvoiceIds.includes(inv.id));
          // Sort by date
          selected.sort((a,b)=> (a.date||"").localeCompare(b.date||""));
          const allocations = allocateAcrossSelected(amount, selected);

          // doc number from receipt modal (if available)
          const docNo = (qs("#rcptNumber")?.value || "CHITANTA");
          addPaymentRecord("CHITANTA", docNo, amount, allocations);

          // Clear context after a short delay (allow receipt save to run)
          setTimeout(()=>{ window.__incasare_ctx = null; }, 0);

          // refresh table after receipt closes
          setTimeout(()=>{ 
            if(currentClient) { currentInvoices = filterInvoicesForClient(currentClient.id); renderInvoices(); }
          }, 200);
        }, true);
      })();

      // ALT TIP modal
      const payBackdrop = qs("#payBackdrop");
      const payType = qs("#payType");
      const payDocNo = qs("#payDocNo");
      const payDate = qs("#payDate");
      const payAmount = qs("#payAmount");

      function openPayModal(defaultAmount){
        payType.value = "OP";
        payDocNo.value = "";
        payDate.value = new Date().toISOString().slice(0,10);
        payAmount.value = money(defaultAmount || 0);
        openModal(payBackdrop);
        setTimeout(()=>payDocNo.focus(), 60);
      }
      function closePayModal(){ closeModal(payBackdrop); }

      qs("#btnIncAltTip").addEventListener("click", ()=>{
        if(!currentClient){
          alert("Selectează un client.");
          return;
        }
        const { total, selected } = selectedInvoicesRemainingTotal();
        if(selected.length === 0){
          alert("Selectează cel puțin o factură.");
          return;
        }
        if(total <= 0.0001){
          alert("Nu există sold de încasat pe facturile selectate.");
          return;
        }
        openPayModal(total);
      });

      qs("#payClose").addEventListener("click", closePayModal);
      qs("#btnPayCancel").addEventListener("click", closePayModal);
      payBackdrop.addEventListener("click", (e)=>{ if(e.target === payBackdrop) closePayModal(); });

      qs("#btnPaySave").addEventListener("click", ()=>{
        const amt = Number(payAmount.value || 0);
        if(!isFinite(amt) || amt <= 0){
          alert("Suma este obligatorie.");
          return;
        }
        const { selected } = selectedInvoicesRemainingTotal();
        const allocations = allocateAcrossSelected(amt, selected);
        addPaymentRecord(payType.value, payDocNo.value, amt, allocations);
        closePayModal();

        // Refresh table
        if(currentClient){ currentInvoices = filterInvoicesForClient(currentClient.id); renderInvoices(); }
        alert("Încasare salvată. (Demo LocalStorage)");
      });

      // Escape closes
      document.addEventListener("keydown", (e)=>{
        if(e.key !== "Escape") return;
        if(payBackdrop.classList.contains("show")) closePayModal();
        if(incBackdrop.classList.contains("show")) closeModal(incBackdrop);
      });

      // Expose for debug
      window.openIncasareModal = openIncasareModal;
    })();
    // ===== END INCASARE =====
  </script>


  <script>
    // ===== INCASARE PATCH FIX9 =====
    (function(){
      const qs = (s, p=document) => p.querySelector(s);

      function forceBackdropInteractive(id){
        const b = qs(id);
        if(!b) return;
        // When shown, ensure display/pointer-events are correct (even if other CSS interferes)
        const mo = new MutationObserver(()=>{
          if(b.classList.contains("show")){
            b.style.display = "flex";
            b.style.pointerEvents = "auto";
            // Ensure inputs are writable
            b.querySelectorAll("input,select,textarea,button").forEach(el=>{
              // do not enable intentionally disabled voucher in receipt etc — only within incasare/pay
              if(el.id === "rcptVoucher") return;
              if(el.hasAttribute("disabled") && (id==="#incasareBackdrop" || id==="#payBackdrop")){
                el.disabled = false;
              }
            });
            // Focus first input that should be writable
            const first = b.querySelector('input:not([readonly]):not([disabled]), select:not([disabled]), textarea:not([disabled])');
            if(first) setTimeout(()=>{ try{ first.focus(); }catch{} }, 30);
          }else{
            b.style.display = "";
            b.style.pointerEvents = "";
          }
        });
        mo.observe(b, { attributes:true, attributeFilter:["class"] });
      }

      forceBackdropInteractive("#incasareBackdrop");
      forceBackdropInteractive("#payBackdrop");

      // Close drawer/backdrop when opening incasare (prevents any overlay issues)
      document.addEventListener("click", (e)=>{
        const t = e.target;
        const a = t && t.closest ? t.closest(".action") : null;
        if(!a) return;
        const label = a.querySelector(".t")?.textContent?.trim() || "";
        const title = qs("#drawerTitle")?.textContent?.trim() || "";
        const norm = (s)=> (s||"").toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").trim().toUpperCase();
        if(norm(title)==="INREGISTRARE DOCUMENTE" && norm(label)==="INCASARE"){
          // Close drawer UI if open
          const drawer = qs("#drawer");
          const bd = qs("#backdrop");
          if(drawer) drawer.classList.remove("show");
          if(bd) bd.classList.remove("show");
        }
      }, true);

      // Always keep the invoice table visible with an empty row message
      const tbody = qs("#incInvoiceRows");
      const b = qs("#incasareBackdrop");
      if(tbody && b){
        const ensureEmptyRow = ()=>{
          const hasRows = tbody.querySelectorAll("tr").length > 0;
          if(!hasRows){
            const tr = document.createElement("tr");
            tr.innerHTML = '<td colspan="6" style="padding:14px; color:var(--muted); font-weight:850;">Nu există facturi pentru acest client (încă).</td>';
            tbody.appendChild(tr);
          }
        };
        const mo2 = new MutationObserver(()=>{
          if(b.classList.contains("show")) setTimeout(ensureEmptyRow, 50);
        });
        mo2.observe(b, { attributes:true, attributeFilter:["class"] });
        // Also run once if already open
        setTimeout(ensureEmptyRow, 50);
      }
    })();
    // ===== END INCASARE PATCH FIX9 =====
  </script>


  <script>
    // ===== MODAL STACK PATCH FIX10 =====
    (function(){
      const qs = (s,p=document)=>p.querySelector(s);

      const inc = qs("#incasareBackdrop");
      const client = qs("#clientFullBackdrop");
      if(!inc || !client) return;

      const mo = new MutationObserver(()=>{
        if(client.classList.contains("show")){
          // harden stacking
          client.style.zIndex = "90";
          inc.style.zIndex = "60";
        }else{
          client.style.zIndex = "";
          inc.style.zIndex = "";
        }
      });
      mo.observe(client, { attributes:true, attributeFilter:["class"] });
    })();
    // ===== END MODAL STACK PATCH FIX10 =====
  </script>

  <!-- GESTIUNE: LISTA CLIENTI -->
  <div class="modal-backdrop" id="listClientsBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="listClientsTitle" style="width:min(1040px,100%);">
      <div class="modal-head">
        <div class="modal-title">
          <div class="h" id="listClientsTitle">Clienți</div>
          <div class="s">Gestiune – listă clienți</div>
        </div>
        <div class="row" style="gap:10px; align-items:center;">
          <button class="btn btn-primary" type="button" id="btnAddClientFromList">Adaugă client</button>
          <button class="modal-close" type="button" id="listClientsClose" aria-label="Închide">
            <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
      </div>
      <div class="modal-body">
        <div class="row-3">
          <div class="field">
            <label>Caută</label>
            <input id="clientsSearch" type="text" placeholder="Denumire / CUI" />
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <button class="btn btn-ghost" type="button" id="btnClientsRefresh">Reîncarcă</button>
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <div style="height:40px;"></div>
          </div>
        </div>

        <table class="table" aria-label="Lista clienți" style="margin-top:10px;">
          <thead>
            <tr>
              <th style="width:32%;">Denumire</th>
              <th style="width:18%;">CUI</th>
              <th style="width:18%;">Reg. Com.</th>
              <th style="width:32%;">Adresă</th>
            </tr>
          </thead>
          <tbody id="clientsRows"></tbody>
        </table>

        <div class="modal-actions">
          <button class="btn btn-muted" type="button" id="btnClientsCloseBottom">Închide</button>
        </div>
      </div>
    </div>
  </div>

  <!-- GESTIUNE: LISTA FURNIZORI -->
  <div class="modal-backdrop" id="listSuppliersBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="listSuppliersTitle" style="width:min(1040px,100%);">
      <div class="modal-head">
        <div class="modal-title">
          <div class="h" id="listSuppliersTitle">Furnizori</div>
          <div class="s">Gestiune – listă furnizori</div>
        </div>
        <div class="row" style="gap:10px; align-items:center;">
          <button class="btn btn-primary" type="button" id="btnAddSupplierFromList">Adaugă furnizor</button>
          <button class="modal-close" type="button" id="listSuppliersClose" aria-label="Închide">
            <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
      </div>
      <div class="modal-body">
        <div class="row-3">
          <div class="field">
            <label>Caută</label>
            <input id="suppliersSearch" type="text" placeholder="Denumire / CUI" />
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <button class="btn btn-ghost" type="button" id="btnSuppliersRefresh">Reîncarcă</button>
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <div style="height:40px;"></div>
          </div>
        </div>

        <table class="table" aria-label="Lista furnizori" style="margin-top:10px;">
          <thead>
            <tr>
              <th style="width:32%;">Denumire</th>
              <th style="width:18%;">CUI</th>
              <th style="width:18%;">Reg. Com.</th>
              <th style="width:32%;">Adresă</th>
            </tr>
          </thead>
          <tbody id="suppliersRows"></tbody>
        </table>

        <div class="modal-actions">
          <button class="btn btn-muted" type="button" id="btnSuppliersCloseBottom">Închide</button>
        </div>
      </div>
    </div>
  </div>


  <script>
    // ===== GESTIUNE LISTE CLIENTI/FURNIZORI FIX12 =====
    (function(){
      const qs = (s,p=document)=>p.querySelector(s);
      const normalize = (s)=> (s||"").toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").trim().toUpperCase();

      // Safe storage shared
      const memStore = window.__memStore || (window.__memStore = {});
      function safeGetItem(k){ try{ return localStorage.getItem(k); }catch{ return memStore[k] ?? null; } }
      function safeSetItem(k,v){ try{ localStorage.setItem(k,v); }catch{ memStore[k]=v; } }
      function lsGet(key, fallback){
        try{
          const raw = safeGetItem(key);
          if(raw === null || raw === undefined) return fallback;
          const v = JSON.parse(raw);
          return (v ?? fallback);
        }catch{ return fallback; }
      }
      function lsSet(key, val){ safeSetItem(key, JSON.stringify(val)); }

      function openModal(b){
        if(!b) return;
        b.classList.add("show");
        b.setAttribute("aria-hidden","false");
        b.style.display = "flex";
        b.style.pointerEvents = "auto";
        document.body.style.overflow = "hidden";
      }
      function closeModal(b){
        if(!b) return;
        b.classList.remove("show");
        b.setAttribute("aria-hidden","true");
        b.style.display = "";
        b.style.pointerEvents = "";
        document.body.style.overflow = "";
      }

      const listClientsBackdrop = qs("#listClientsBackdrop");
      const listSuppliersBackdrop = qs("#listSuppliersBackdrop");

      const clientsRows = qs("#clientsRows");
      const suppliersRows = qs("#suppliersRows");

      const clientsSearch = qs("#clientsSearch");
      const suppliersSearch = qs("#suppliersSearch");

      function upsert(listKey, entry){
        const list = lsGet(listKey, []);
        const idx = list.findIndex(x => String(x.id) === String(entry.id));
        if(idx >= 0) list[idx] = entry; else list.push(entry);
        lsSet(listKey, list);
      }

      function renderList(listKey, tbody, query){
        const list = lsGet(listKey, []);
        const q = (query||"").trim().toLowerCase();
        const filtered = !q ? list : list.filter(x =>
          (x.name||"").toLowerCase().includes(q) || (x.cui||"").toLowerCase().includes(q)
        );

        tbody.innerHTML = "";
        if(filtered.length === 0){
          const tr = document.createElement("tr");
          tr.innerHTML = '<td colspan="4" style="padding:14px; color:var(--muted); font-weight:850;">Nicio înregistrare.</td>';
          tbody.appendChild(tr);
          return;
        }

        filtered.forEach(x=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${(x.name||"").replace(/</g,"&lt;")}</td>
            <td>${(x.cui||"").replace(/</g,"&lt;")}</td>
            <td>${(x.reg||"").replace(/</g,"&lt;")}</td>
            <td>${(x.address||"").replace(/</g,"&lt;")}</td>
          `;
          tbody.appendChild(tr);
        });
        wireDocStatusPickers(tbody);
      }

      function openClientsList(){
        renderList("gestiune_clients", clientsRows, clientsSearch.value);
        openModal(listClientsBackdrop);
        setTimeout(()=>clientsSearch.focus(), 50);
      }
      function openSuppliersList(){
        renderList("gestiune_suppliers", suppliersRows, suppliersSearch.value);
        openModal(listSuppliersBackdrop);
        setTimeout(()=>suppliersSearch.focus(), 50);
      }

      // Open from drawer actions: GESTIUNE -> CLIENTI / FURNIZORI
      document.addEventListener("click", (e)=>{
        const btn = e.target.closest(".action");
        if(!btn) return;
        const label = btn.querySelector(".t")?.textContent || "";
        const title = qs("#drawerTitle")?.textContent || "";
        if(normalize(title) !== normalize("GESTIUNE")) return;

        if(normalize(label) === normalize("CLIENTI")){
          openClientsList();
          e.preventDefault(); e.stopPropagation();
          return;
        }
        if(normalize(label) === normalize("FURNIZORI")){
          openSuppliersList();
          e.preventDefault(); e.stopPropagation();
          return;
        }
      }, true);

      // Close handlers
      qs("#listClientsClose").addEventListener("click", ()=>closeModal(listClientsBackdrop));
      qs("#btnClientsCloseBottom").addEventListener("click", ()=>closeModal(listClientsBackdrop));
      listClientsBackdrop.addEventListener("click", (e)=>{ if(e.target === listClientsBackdrop) closeModal(listClientsBackdrop); });

      qs("#listSuppliersClose").addEventListener("click", ()=>closeModal(listSuppliersBackdrop));
      qs("#btnSuppliersCloseBottom").addEventListener("click", ()=>closeModal(listSuppliersBackdrop));
      listSuppliersBackdrop.addEventListener("click", (e)=>{ if(e.target === listSuppliersBackdrop) closeModal(listSuppliersBackdrop); });

      qs("#btnClientsRefresh").addEventListener("click", ()=>renderList("gestiune_clients", clientsRows, clientsSearch.value));
      qs("#btnSuppliersRefresh").addEventListener("click", ()=>renderList("gestiune_suppliers", suppliersRows, suppliersSearch.value));

      clientsSearch.addEventListener("input", ()=>renderList("gestiune_clients", clientsRows, clientsSearch.value));
      suppliersSearch.addEventListener("input", ()=>renderList("gestiune_suppliers", suppliersRows, suppliersSearch.value));

      // Add buttons: open existing full client modal; enforce checkbox defaults + route on save
      qs("#btnAddClientFromList").addEventListener("click", ()=>{
        if(typeof window.openClientModal !== "function"){ alert("Fereastra client nu este disponibilă."); return; }
        // close list? keep open behind but client modal is above due to z-index.
        window.openClientModal({
          subtitle: "Client (gestiune)",
          onSave: (full, compat)=>{
            // route based on checkboxes
            const entry = { id: full.id, name: full.name||"", cui: full.cui||"", reg: full.orc||"", address: full.address||"" };
            if(full.isClient) upsert("gestiune_clients", entry);
            if(full.isSupplier) upsert("gestiune_suppliers", entry);
            if(!full.isClient && !full.isSupplier){
              // fallback: client
              upsert("gestiune_clients", entry);
            }
            renderList("gestiune_clients", clientsRows, clientsSearch.value);
          }
        });

        // Set default checkboxes when modal opens (without editing modal code)
        setTimeout(()=>{
          const c = qs("#cfIsClient"); const s = qs("#cfIsSupplier");
          if(c) c.checked = true;
          if(s) s.checked = false;
        }, 80);
      });

      qs("#btnAddSupplierFromList").addEventListener("click", ()=>{
        if(typeof window.openClientModal !== "function"){ alert("Fereastra client nu este disponibilă."); return; }
        window.openClientModal({
          subtitle: "Furnizor (gestiune)",
          onSave: (full, compat)=>{
            const entry = { id: full.id, name: full.name||"", cui: full.cui||"", reg: full.orc||"", address: full.address||"" };
            if(full.isClient) upsert("gestiune_clients", entry);
            if(full.isSupplier) upsert("gestiune_suppliers", entry);
            if(!full.isClient && !full.isSupplier){
              // fallback: supplier
              upsert("gestiune_suppliers", entry);
            }
            renderList("gestiune_suppliers", suppliersRows, suppliersSearch.value);
          }
        });

        setTimeout(()=>{
          const c = qs("#cfIsClient"); const s = qs("#cfIsSupplier");
          if(c) c.checked = false;
          if(s) s.checked = true;
        }, 80);
      });

      // Escape closes top lists
      document.addEventListener("keydown", (e)=>{
        if(e.key !== "Escape") return;
        if(listClientsBackdrop.classList.contains("show")) closeModal(listClientsBackdrop);
        if(listSuppliersBackdrop.classList.contains("show")) closeModal(listSuppliersBackdrop);
      });

      // Ensure lists exist
      (function init(){
        if(!Array.isArray(lsGet("gestiune_clients", []))) lsSet("gestiune_clients", []);
        if(!Array.isArray(lsGet("gestiune_suppliers", []))) lsSet("gestiune_suppliers", []);
      })();

    })();
    // ===== END GESTIUNE LISTE CLIENTI/FURNIZORI FIX12 =====
  </script>


  <script>
    // ===== GESTIUNE SAVE PATCH FIX13 =====
    (function(){
      const qs = (s,p=document)=>p.querySelector(s);

      // Shared safe storage (window.__memStore fallback)
      const memStore = window.__memStore || (window.__memStore = {});
      function safeGetItem(k){ try{ return localStorage.getItem(k); }catch{ return memStore[k] ?? null; } }
      function safeSetItem(k,v){ try{ localStorage.setItem(k,v); }catch{ memStore[k]=v; } }
      function lsGet(key, fallback){
        try{
          const raw = safeGetItem(key);
          if(raw === null || raw === undefined) return fallback;
          const v = JSON.parse(raw);
          return (v ?? fallback);
        }catch{ return fallback; }
      }
      function lsSet(key, val){ safeSetItem(key, JSON.stringify(val)); }

      function upsert(listKey, entry){
        const list = lsGet(listKey, []);
        const idx = list.findIndex(x => String(x.id) === String(entry.id));
        if(idx >= 0) list[idx] = entry; else list.push(entry);
        lsSet(listKey, list);
      }

      // Track which list is active (clients or suppliers) for refresh
      window.__gestiune_list_open = window.__gestiune_list_open || null;

      // When opening list modals, set flag (non-invasive)
      const lc = qs("#listClientsBackdrop");
      const ls = qs("#listSuppliersBackdrop");
      if(lc){
        const mo = new MutationObserver(()=>{ if(lc.classList.contains("show")) window.__gestiune_list_open = "clients"; });
        mo.observe(lc, { attributes:true, attributeFilter:["class"] });
      }
      if(ls){
        const mo2 = new MutationObserver(()=>{ if(ls.classList.contains("show")) window.__gestiune_list_open = "suppliers"; });
        mo2.observe(ls, { attributes:true, attributeFilter:["class"] });
      }

      // Hard hook on client modal save — ensures routing to gestiune lists always happens
      const btnSave = qs("#btnSaveClientFull");
      if(!btnSave || btnSave.__gestiunePatched) return;
      btnSave.__gestiunePatched = true;

      btnSave.addEventListener("click", ()=>{
        // Defer to allow modal's own validation/close logic; then read fields and persist
        setTimeout(()=>{
          const name = (qs("#cfName")?.value || "").trim();
          if(!name) return; // modal already alerts

          const cui = (qs("#cfCui")?.value || "").trim();
          const orc = (qs("#cfOrc")?.value || "").trim();
          const addr = (qs("#cfAddress")?.value || "").trim();
          const city = (qs("#cfCity")?.value || "").trim();
          const county = (qs("#cfCounty")?.value || "").trim();
          const fullAddr = [addr, city, county].filter(Boolean).join(", ");

          const isClient = !!qs("#cfIsClient")?.checked;
          const isSupplier = !!qs("#cfIsSupplier")?.checked;

          // Stable id: try to reuse last saved full client id if available; else generate
          let id = null;
          const all = lsGet("clientsFull", []);
          if(Array.isArray(all) && all.length){
            // pick the one with same name+cui updated most recently (best effort)
            const same = all
              .filter(x => (x.name||"") === name && ((x.cui||"") === cui || !cui))
              .sort((a,b)=> String(b.updatedAt||"").localeCompare(String(a.updatedAt||"")));
            if(same[0]?.id) id = same[0].id;
          }
          if(!id){
            id = "C-" + Math.random().toString(16).slice(2) + "-" + Date.now();
          }

          const entry = { id, name, cui, reg: orc, address: fullAddr };

          // Route strictly by checkboxes
          if(isClient) upsert("gestiune_clients", entry);
          if(isSupplier) upsert("gestiune_suppliers", entry);

          // If none checked, do nothing (user requested explicit)
          // Refresh open lists (if open)
          try{
            if(window.__gestiune_list_open === "clients"){
              const tbody = qs("#clientsRows");
              const q = qs("#clientsSearch")?.value || "";
              // reuse render by triggering refresh button
              qs("#btnClientsRefresh")?.click();
            }
            if(window.__gestiune_list_open === "suppliers"){
              qs("#btnSuppliersRefresh")?.click();
            }
          }catch{}
        }, 0);
      }, true);

    })();
    // ===== END GESTIUNE SAVE PATCH FIX13 =====
  </script>


  <script>
    // ===== GESTIUNE GUARANTEE SAVE FIX14 =====
    (function(){
      const qs = (s,p=document)=>p.querySelector(s);

      // shared safe storage
      const memStore = window.__memStore || (window.__memStore = {});
      function safeGetItem(k){ try{ return localStorage.getItem(k); }catch{ return memStore[k] ?? null; } }
      function safeSetItem(k,v){ try{ localStorage.setItem(k,v); }catch{ memStore[k]=v; } }
      function lsGet(key, fallback){
        try{
          const raw = safeGetItem(key);
          if(raw === null || raw === undefined) return fallback;
          const v = JSON.parse(raw);
          return (v ?? fallback);
        }catch{ return fallback; }
      }
      function lsSet(key, val){ safeSetItem(key, JSON.stringify(val)); }
      function upsert(listKey, entry){
        const list = lsGet(listKey, []);
        const idx = list.findIndex(x => String(x.id) === String(entry.id));
        if(idx >= 0) list[idx] = entry; else list.push(entry);
        lsSet(listKey, list);
      }

      // Set mode when opening client modal from lists
      const btnAddClient = qs("#btnAddClientFromList");
      const btnAddSupplier = qs("#btnAddSupplierFromList");
      if(btnAddClient){
        btnAddClient.addEventListener("click", ()=>{ window.__gestiune_add_mode = "clients"; }, true);
      }
      if(btnAddSupplier){
        btnAddSupplier.addEventListener("click", ()=>{ window.__gestiune_add_mode = "suppliers"; }, true);
      }

      // Guarantee save on every click of Save in client modal
      const btnSave = qs("#btnSaveClientFull");
      if(!btnSave || btnSave.__gestiuneFix14) return;
      btnSave.__gestiuneFix14 = true;

      btnSave.addEventListener("click", ()=>{
        // Read fields immediately (capture), before modal resets
        const name = (qs("#cfName")?.value || "").trim();
        if(!name) return; // validation handled elsewhere

        const cui = (qs("#cfCui")?.value || "").trim();
        const orc = (qs("#cfOrc")?.value || "").trim();
        const addr = (qs("#cfAddress")?.value || "").trim();
        const city = (qs("#cfCity")?.value || "").trim();
        const county = (qs("#cfCounty")?.value || "").trim();
        const fullAddr = [addr, city, county].filter(Boolean).join(", ");

        const isClient = !!qs("#cfIsClient")?.checked;
        const isSupplier = !!qs("#cfIsSupplier")?.checked;

        // determine id using current selection if available; else create stable one
        let id = null;
        // try from clientsFull storage (if exists)
        const all = lsGet("clientsFull", []);
        if(Array.isArray(all) && all.length){
          const same = all
            .filter(x => (x.name||"") === name && ((x.cui||"") === cui || !cui))
            .sort((a,b)=> String(b.updatedAt||"").localeCompare(String(a.updatedAt||"")));
          if(same[0]?.id) id = same[0].id;
        }
        if(!id){
          // fallback: hash-ish from name+cui
          id = "C-" + (name + "|" + cui).toLowerCase().replace(/[^a-z0-9]+/g,"-").slice(0,32) + "-" + Date.now();
        }

        const entry = { id, name, cui, reg: orc, address: fullAddr };

        // Route strictly by checkboxes; if none checked, route by mode
        if(isClient) upsert("gestiune_clients", entry);
        if(isSupplier) upsert("gestiune_suppliers", entry);
        if(!isClient && !isSupplier){
          if(window.__gestiune_add_mode === "suppliers") upsert("gestiune_suppliers", entry);
          if(window.__gestiune_add_mode === "clients") upsert("gestiune_clients", entry);
        }

        // Refresh lists if open
        setTimeout(()=>{
          try{
            if(qs("#listClientsBackdrop")?.classList.contains("show")) qs("#btnClientsRefresh")?.click();
            if(qs("#listSuppliersBackdrop")?.classList.contains("show")) qs("#btnSuppliersRefresh")?.click();
          }catch{}
        }, 0);

      }, true);

      // Ensure arrays exist
      (function init(){
        if(!Array.isArray(lsGet("gestiune_clients", []))) lsSet("gestiune_clients", []);
        if(!Array.isArray(lsGet("gestiune_suppliers", []))) lsSet("gestiune_suppliers", []);
      })();
    })();
    // ===== END GESTIUNE GUARANTEE SAVE FIX14 =====
  </script>


  <script>
    // ===== GESTIUNE FINAL REFRESH FIX15 =====
    (function(){
      const qs = (s,p=document)=>p.querySelector(s);
      const clientBackdrop = qs("#clientFullBackdrop");
      if(!clientBackdrop) return;

      // When client modal closes, refresh gestiune lists if open
      const mo = new MutationObserver(()=>{
        if(!clientBackdrop.classList.contains("show")){
          try{
            if(qs("#listClientsBackdrop")?.classList.contains("show")) qs("#btnClientsRefresh")?.click();
            if(qs("#listSuppliersBackdrop")?.classList.contains("show")) qs("#btnSuppliersRefresh")?.click();
          }catch{}
        }
      });
      mo.observe(clientBackdrop, { attributes:true, attributeFilter:["class"] });
    })();
    // ===== END GESTIUNE FINAL REFRESH FIX15 =====
  </script>


  <script>
    // ===== GESTIUNE DERIVE LISTS FIX17 =====
    (function(){
      const qs = (s,p=document)=>p.querySelector(s);
      const normalize = (s)=> (s||"").toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").trim().toUpperCase();

      // Safe storage (shared)
      const memStore = window.__memStore || (window.__memStore = {});
      function safeGetItem(k){ try{ return localStorage.getItem(k); }catch{ return memStore[k] ?? null; } }
      function safeSetItem(k,v){ try{ localStorage.setItem(k,v); }catch{ memStore[k]=v; } }
      function lsGet(key, fallback){
        try{
          const raw = safeGetItem(key);
          if(raw === null || raw === undefined) return fallback;
          const v = JSON.parse(raw);
          return (v ?? fallback);
        }catch{ return fallback; }
      }
      function lsSet(key, val){ safeSetItem(key, JSON.stringify(val)); }

      function openModal(b){
        if(!b) return;
        b.classList.add("show");
        b.setAttribute("aria-hidden","false");
        b.style.display = "flex";
        b.style.pointerEvents = "auto";
        document.body.style.overflow = "hidden";
      }
      function closeModal(b){
        if(!b) return;
        b.classList.remove("show");
        b.setAttribute("aria-hidden","true");
        b.style.display = "";
        b.style.pointerEvents = "";
        document.body.style.overflow = "";
      }

      const listClientsBackdrop = qs("#listClientsBackdrop");
      const listSuppliersBackdrop = qs("#listSuppliersBackdrop");
      const clientsRows = qs("#clientsRows");
      const suppliersRows = qs("#suppliersRows");
      const clientsSearch = qs("#clientsSearch");
      const suppliersSearch = qs("#suppliersSearch");

      function toEntry(c){
        return {
          id: c.id,
          name: c.name || "",
          cui: c.cui || "",
          reg: c.orc || c.reg || "",
          address: [c.address, c.city, c.county].filter(Boolean).join(", ") || c.address || ""
        };
      }

      function getDerived(type){
        const all = lsGet("clientsFull", []);
        const list = Array.isArray(all) ? all : [];
        const filtered = list.filter(c => type==="clients" ? !!c.isClient : !!c.isSupplier);
        // sort by name
        filtered.sort((a,b)=> (a.name||"").localeCompare((b.name||""), "ro"));
        return filtered.map(toEntry);
      }

      function renderDerived(type){
        const q = (type==="clients" ? (clientsSearch.value||"") : (suppliersSearch.value||"")).trim().toLowerCase();
        const tbody = (type==="clients" ? clientsRows : suppliersRows);
        const base = getDerived(type);
        const filtered = !q ? base : base.filter(x =>
          (x.name||"").toLowerCase().includes(q) || (x.cui||"").toLowerCase().includes(q)
        );

        tbody.innerHTML = "";
        if(filtered.length === 0){
          const tr = document.createElement("tr");
          tr.innerHTML = '<td colspan="4" style="padding:14px; color:var(--muted); font-weight:850;">Nicio înregistrare.</td>';
          tbody.appendChild(tr);
          return;
        }
        filtered.forEach(x=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${(x.name||"").replace(/</g,"&lt;")}</td>
            <td>${(x.cui||"").replace(/</g,"&lt;")}</td>
            <td>${(x.reg||"").replace(/</g,"&lt;")}</td>
            <td>${(x.address||"").replace(/</g,"&lt;")}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      // Intercept drawer clicks and open our derived lists (ensures lists always reflect checkbox state)
      document.addEventListener("click", (e)=>{
        const btn = e.target.closest(".action");
        if(!btn) return;
        const label = btn.querySelector(".t")?.textContent || "";
        const title = qs("#drawerTitle")?.textContent || "";
        if(normalize(title) !== normalize("GESTIUNE")) return;

        if(normalize(label) === normalize("CLIENTI")){
          openModal(listClientsBackdrop);
          setTimeout(()=>{ renderDerived("clients"); clientsSearch.focus(); }, 0);
          e.preventDefault(); e.stopPropagation();
          return;
        }
        if(normalize(label) === normalize("FURNIZORI")){
          openModal(listSuppliersBackdrop);
          setTimeout(()=>{ renderDerived("suppliers"); suppliersSearch.focus(); }, 0);
          e.preventDefault(); e.stopPropagation();
          return;
        }
      }, true);

      // Hook refresh/search
      qs("#btnClientsRefresh")?.addEventListener("click", ()=>renderDerived("clients"), true);
      qs("#btnSuppliersRefresh")?.addEventListener("click", ()=>renderDerived("suppliers"), true);
      clientsSearch?.addEventListener("input", ()=>renderDerived("clients"), true);
      suppliersSearch?.addEventListener("input", ()=>renderDerived("suppliers"), true);

      // On client modal save, also refresh derived lists (if open) without relying on gestiune_* keys
      const btnSave = qs("#btnSaveClientFull");
      if(btnSave && !btnSave.__deriveFix17){
        btnSave.__deriveFix17 = true;
        btnSave.addEventListener("click", ()=>{
          setTimeout(()=>{
            if(listClientsBackdrop?.classList.contains("show")) renderDerived("clients");
            if(listSuppliersBackdrop?.classList.contains("show")) renderDerived("suppliers");
          }, 0);
        }, true);
      }

      // Close handlers remain as implemented; no changes needed
    })();
    // ===== END GESTIUNE DERIVE LISTS FIX17 =====
  </script>


  <script>
    // ===== STORAGE BRIDGE FIX18 (unifică toate salvările) =====
    (function(){
      const ms = window.__memStore || (window.__memStore = {});
      // Safe JSON helpers
      window.__safeJSONGet = function(key, fallback){
        try{
          // prefer ms mirror
          const rawMs = ms[key];
          if(rawMs !== undefined && rawMs !== null){
            return JSON.parse(rawMs);
          }
        }catch{}
        try{
          if(window.localStorage){
            const raw = window.localStorage.getItem(key);
            if(raw !== null && raw !== undefined) return JSON.parse(raw);
          }
        }catch{}
        return fallback;
      };
      window.__safeJSONSet = function(key, val){
        const raw = JSON.stringify(val);
        ms[key] = raw;
        try{
          if(window.localStorage) window.localStorage.setItem(key, raw);
        }catch{}
      };

      // Monkeypatch localStorage (best effort) to always mirror into ms
      try{
        if(window.localStorage){
          const ls = window.localStorage;
          const og = ls.getItem ? ls.getItem.bind(ls) : null;
          const os = ls.setItem ? ls.setItem.bind(ls) : null;

          if(og){
            ls.getItem = function(k){
              try{ return og(k); }catch{ return (ms[k] ?? null); }
            };
          }
          if(os){
            ls.setItem = function(k,v){
              ms[k] = String(v);
              try{ return os(k,v); }catch{ /* ignore */ }
            };
          }
        }
      }catch{
        // If localStorage is not accessible at all, we rely fully on ms.
      }
    })();
    // ===== END STORAGE BRIDGE FIX18 =====
  </script>


  <script>
    // ===== GESTIUNE HARD SAVE FIX18 (scrie sigur în liste și actualizează tabelul) =====
    (function(){
      const qs = (s,p=document)=>p.querySelector(s);

      const btnSave = qs("#btnSaveClientFull");
      if(!btnSave || btnSave.__hardGestiuneFix18) return;
      btnSave.__hardGestiuneFix18 = true;

      function upsert(list, entry){
        const idx = list.findIndex(x => String(x.id) === String(entry.id));
        if(idx >= 0) list[idx] = entry; else list.push(entry);
        return list;
      }

      btnSave.addEventListener("click", ()=>{
        // read immediately
        const name = (qs("#cfName")?.value || "").trim();
        if(!name) return;

        const cui = (qs("#cfCui")?.value || "").trim();
        const orc = (qs("#cfOrc")?.value || "").trim();
        const addr = (qs("#cfAddress")?.value || "").trim();
        const city = (qs("#cfCity")?.value || "").trim();
        const county = (qs("#cfCounty")?.value || "").trim();
        const fullAddr = [addr, city, county].filter(Boolean).join(", ");

        const isClient = !!qs("#cfIsClient")?.checked;
        const isSupplier = !!qs("#cfIsSupplier")?.checked;

        // Determine id: if the client modal script already has currentId stored in clientsFull, reuse by matching latest by name+cui
        const allFull = window.__safeJSONGet("clientsFull", []);
        let id = null;
        if(Array.isArray(allFull) && allFull.length){
          const same = allFull
            .filter(x => (x.name||"") === name && ((x.cui||"") === cui || !cui))
            .sort((a,b)=> String(b.updatedAt||"").localeCompare(String(a.updatedAt||"")));
          if(same[0]?.id) id = same[0].id;
        }
        if(!id) id = "C-" + Math.random().toString(16).slice(2) + "-" + Date.now();

        const entry = { id, name, cui, reg: orc, address: fullAddr };

        // Write lists
        if(isClient){
          const list = window.__safeJSONGet("gestiune_clients", []);
          window.__safeJSONSet("gestiune_clients", upsert(Array.isArray(list)?list:[], entry));
        }
        if(isSupplier){
          const list = window.__safeJSONGet("gestiune_suppliers", []);
          window.__safeJSONSet("gestiune_suppliers", upsert(Array.isArray(list)?list:[], entry));
        }

        // Also ensure flags in clientsFull record (so derived views work)
        try{
          if(Array.isArray(allFull)){
            const idx = allFull.findIndex(x => String(x.id) === String(id));
            if(idx >= 0){
              allFull[idx].isClient = !!isClient;
              allFull[idx].isSupplier = !!isSupplier;
              allFull[idx].name = name;
              allFull[idx].cui = cui;
              allFull[idx].orc = orc;
              allFull[idx].address = addr;
              allFull[idx].city = city;
              allFull[idx].county = county;
              allFull[idx].updatedAt = new Date().toISOString();
              window.__safeJSONSet("clientsFull", allFull);
            }
          }
        }catch{}

        // Refresh open lists UI immediately if visible
        setTimeout(()=>{
          try{
            if(qs("#listClientsBackdrop")?.classList.contains("show")) qs("#btnClientsRefresh")?.click();
            if(qs("#listSuppliersBackdrop")?.classList.contains("show")) qs("#btnSuppliersRefresh")?.click();
          }catch{}
        }, 0);

      }, true);
    })();
    // ===== END GESTIUNE HARD SAVE FIX18 =====
  </script>


  <script>
    // ===== POST-SAVE SYNC FIX19 (după Salvare client, sincronizează listele Gestiune din clientsFull) =====
    (function(){
      const qs = (s,p=document)=>p.querySelector(s);

      // Use bridge helpers if present, else fallback
      const get = window.__safeJSONGet || function(key, fallback){
        try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }catch{ return fallback; }
      };
      const set = window.__safeJSONSet || function(key, val){
        try{ localStorage.setItem(key, JSON.stringify(val)); }catch{}
      };

      function upsert(list, entry){
        const idx = list.findIndex(x => String(x.id) === String(entry.id));
        if(idx >= 0) list[idx] = entry; else list.push(entry);
        return list;
      }

      function mostRecentClientBy(name, cui){
        const all = get("clientsFull", []);
        if(!Array.isArray(all) || all.length === 0) return null;
        const n = (name||"").trim();
        const c = (cui||"").trim();
        const candidates = all.filter(x => (x?.name||"").trim() === n && ((x?.cui||"").trim() === c || !c));
        const pickFrom = candidates.length ? candidates : all;
        pickFrom.sort((a,b)=> String(b?.updatedAt||"").localeCompare(String(a?.updatedAt||"")));
        // if candidates exist, return best candidate, else null
        return candidates.length ? pickFrom[0] : null;
      }

      const btnSave = qs("#btnSaveClientFull");
      if(!btnSave || btnSave.__postSaveFix19) return;
      btnSave.__postSaveFix19 = true;

      // Run AFTER the original client save handler (which writes clientsFull) using setTimeout(0)
      btnSave.addEventListener("click", ()=>{
        const name = (qs("#cfName")?.value || "").trim();
        const cui  = (qs("#cfCui")?.value || "").trim();

        setTimeout(()=>{
          const saved = mostRecentClientBy(name, cui);
          if(!saved) return;

          const entry = {
            id: saved.id,
            name: saved.name || "",
            cui: saved.cui || "",
            reg: saved.orc || saved.reg || "",
            address: [saved.address, saved.city, saved.county].filter(Boolean).join(", ") || saved.address || ""
          };

          // Write gestiune lists based strictly on saved flags
          if(saved.isClient){
            const list = get("gestiune_clients", []);
            set("gestiune_clients", upsert(Array.isArray(list)?list:[], entry));
          }
          if(saved.isSupplier){
            const list = get("gestiune_suppliers", []);
            set("gestiune_suppliers", upsert(Array.isArray(list)?list:[], entry));
          }

          // Refresh UI if lists are open
          try{
            if(qs("#listClientsBackdrop")?.classList.contains("show")) qs("#btnClientsRefresh")?.click();
            if(qs("#listSuppliersBackdrop")?.classList.contains("show")) qs("#btnSuppliersRefresh")?.click();
          }catch{}

        }, 0);
      }, true);
    })();
    // ===== END POST-SAVE SYNC FIX19 =====
  </script>


  <script>
    // ===== FIX20 SINGLE SAVE + MODIFY BUTTONS =====
    (function(){
      const qs = (s,p=document)=>p.querySelector(s);

      // ---- Storage helpers (prefer bridge if present) ----
      const get = window.__safeJSONGet || function(key, fallback){
        try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }catch{ return fallback; }
      };
      const set = window.__safeJSONSet || function(key, val){
        try{ localStorage.setItem(key, JSON.stringify(val)); }catch{
          const ms = window.__memStore || (window.__memStore = {});
          ms[key] = JSON.stringify(val);
        }
      };

      // ---- Patch openClientModal to remember context for a deterministic single-save ----
      if(typeof window.openClientModal === "function" && !window.openClientModal.__fix20Wrapped){
        const orig = window.openClientModal;
        const wrapped = function(opts){
          window.__clientModalOnSave = (opts && typeof opts.onSave === "function") ? opts.onSave : null;
          window.__clientModalEditId = (opts && opts.clientId) ? opts.clientId : null;
          window.__clientModalSubtitle = (opts && opts.subtitle) ? opts.subtitle : "";
          return orig(opts || {});
        };
        wrapped.__fix20Wrapped = true;
        window.openClientModal = wrapped;
      }

      // ---- Replace SAVE button to avoid multiple event listeners firing ----
      const oldBtn = qs("#btnSaveClientFull");
      if(oldBtn && !oldBtn.__fix20Replaced){
        const clone = oldBtn.cloneNode(true); // removes all listeners
        clone.__fix20Replaced = true;
        oldBtn.parentNode.replaceChild(clone, oldBtn);

        // Minimal close
        function closeClientModal(){
          const b = qs("#clientFullBackdrop");
          if(!b) return;
          b.classList.remove("show");
          b.setAttribute("aria-hidden","true");
          b.style.display = "";
          b.style.pointerEvents = "";
          document.body.style.overflow = "";
        }

        function upsertById(arr, obj){
          const idx = arr.findIndex(x => String(x.id) === String(obj.id));
          if(idx >= 0) arr[idx] = obj; else arr.push(obj);
          return arr;
        }

        function readBankRows(){
          const rows = qs("#cfBankRows");
          if(!rows) return [];
          return [...rows.querySelectorAll("tr")].map(tr => ({
            bank: tr.children?.[0]?.textContent?.trim() || "",
            iban: tr.children?.[1]?.textContent?.trim() || ""
          })).filter(x => x.bank || x.iban);
        }

        function gatherClient(){
          const id = window.__clientModalEditId || ("C-" + Math.random().toString(16).slice(2) + "-" + Date.now());
          const name = (qs("#cfName")?.value || "").trim();
          const gestiune = (qs("#cfGestiune")?.value || "").trim();
          const cui = (qs("#cfCui")?.value || "").trim();
          const orc = (qs("#cfOrc")?.value || "").trim();
          const address = (qs("#cfAddress")?.value || "").trim();
          const city = (qs("#cfCity")?.value || "").trim();
          const postal = (qs("#cfPostal")?.value || "").trim();
          const county = (qs("#cfCounty")?.value || "").trim();
          const country = (qs("#cfCountry")?.value || "").trim() || "ROMÂNIA";
          const workPoint = (qs("#cfWorkPoint")?.value || "").trim();

          const entityType = (qs("#cfEntityType")?.value || "societate");
          const email = (qs("#cfEmail")?.value || "").trim();
          const phone = (qs("#cfPhone")?.value || "").trim();
          const capitalRaw = (qs("#cfCapital")?.value || "");
          const capital = (capitalRaw === "" ? null : Number(capitalRaw));
          const otherInfo = (qs("#cfOtherInfo")?.value || "").trim();
          const discount = Number(qs("#cfDiscount")?.value || 0);
          const loyalty = (qs("#cfLoyalty")?.value || "").trim();
          const isClient = !!qs("#cfIsClient")?.checked;
          const isSupplier = !!qs("#cfIsSupplier")?.checked;
          const vatCash = !!qs("#cfVatCash")?.checked;

          const bankAccounts = readBankRows();

          return {
            id, entityType, name, gestiune, cui, orc, address, city, postal, county, country, workPoint,
            bankAccounts, email, phone, capital, otherInfo, discount, loyalty,
            isClient, isSupplier, vatCash,
            updatedAt: new Date().toISOString()
          };
        }

        function compatFromFull(c){
          return {
            id: c.id,
            name: c.name,
            cui: c.cui,
            reg: c.orc,
            address: [c.address, c.city, c.county].filter(Boolean).join(", "),
            bank: (c.bankAccounts?.[0]?.bank || ""),
            iban: (c.bankAccounts?.[0]?.iban || "")
          };
        }

        // Deterministic single-save handler
        clone.addEventListener("click", ()=>{
          const name = (qs("#cfName")?.value || "").trim();
          if(!name){
            alert("Denumirea este obligatorie.");
            qs("#tabGen")?.click?.();
            qs("#cfName")?.focus?.();
            return;
          }

          const c = gatherClient();

          // Save clientsFull
          const allFull = get("clientsFull", []);
          set("clientsFull", upsertById(Array.isArray(allFull)?allFull:[], c));

          // Save compat clients list (used by invoice dropdown etc.)
          const allCompat = get("clients", []);
          set("clients", upsertById(Array.isArray(allCompat)?allCompat:[], compatFromFull(c)));

          // Save GESTIUNE lists (explicit keys) based on checkboxes
          const entry = { id: c.id, name: c.name, cui: c.cui, reg: c.orc, address: [c.address,c.city,c.county].filter(Boolean).join(", ") };
          if(c.isClient){
            const l = get("gestiune_clients", []);
            set("gestiune_clients", upsertById(Array.isArray(l)?l:[], entry));
          }
          if(c.isSupplier){
            const l = get("gestiune_suppliers", []);
            set("gestiune_suppliers", upsertById(Array.isArray(l)?l:[], entry));
          }

          // Callback to the opener, if any
          const cb = window.__clientModalOnSave;
          if(typeof cb === "function"){
            try{ cb(c, compatFromFull(c)); }catch{}
          }

          // Close modal and clear context
          closeClientModal();
          window.__clientModalEditId = null;
          window.__clientModalOnSave = null;

          // Refresh lists if open
          try{
            if(qs("#listClientsBackdrop")?.classList.contains("show")) qs("#btnClientsRefresh")?.click();
            if(qs("#listSuppliersBackdrop")?.classList.contains("show")) qs("#btnSuppliersRefresh")?.click();
          }catch{}
        }, true);
      }

      // ---- Add "Modifică" buttons in GESTIUNE lists ----
      function renderGestiune(type){
        const rows = (type==="clients") ? qs("#clientsRows") : qs("#suppliersRows");
        const q = ((type==="clients") ? (qs("#clientsSearch")?.value||"") : (qs("#suppliersSearch")?.value||"")).trim().toLowerCase();

        // Prefer explicit lists (they are populated by FIX20 save). If empty, derive from clientsFull.
        let list = get(type==="clients" ? "gestiune_clients" : "gestiune_suppliers", []);
        if(!Array.isArray(list) || list.length === 0){
          const all = get("clientsFull", []);
          const filtered = (Array.isArray(all)?all:[]).filter(c => type==="clients" ? !!c.isClient : !!c.isSupplier)
            .map(c => ({ id:c.id, name:c.name||"", cui:c.cui||"", reg:c.orc||"", address:[c.address,c.city,c.county].filter(Boolean).join(", ") }));
          list = filtered;
        }

        const filtered = !q ? list : list.filter(x =>
          (x.name||"").toLowerCase().includes(q) || (x.cui||"").toLowerCase().includes(q)
        );

        // Ensure header has action column
        const table = rows?.closest("table");
        const theadRow = table?.querySelector("thead tr");
        if(theadRow && !theadRow.__fix20ActionCol){
          const th = document.createElement("th");
          th.style.width = "12%";
          th.textContent = "Acțiuni";
          theadRow.appendChild(th);
          theadRow.__fix20ActionCol = true;
        }

        rows.innerHTML = "";
        if(filtered.length === 0){
          const tr = document.createElement("tr");
          tr.innerHTML = '<td colspan="5" style="padding:14px; color:var(--muted); font-weight:850;">Nicio înregistrare.</td>';
          rows.appendChild(tr);
          return;
        }

        filtered.forEach(x=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${(x.name||"").replace(/</g,"&lt;")}</td>
            <td>${(x.cui||"").replace(/</g,"&lt;")}</td>
            <td>${(x.reg||"").replace(/</g,"&lt;")}</td>
            <td>${(x.address||"").replace(/</g,"&lt;")}</td>
            <td style="text-align:right;">
              <button type="button" class="btn btn-ghost btnEditGestiune" data-id="${String(x.id).replace(/"/g,"&quot;")}">Modifică</button>
            </td>
          `;
          rows.appendChild(tr);
        });
      }

      // Override refresh buttons to use our renderer
      qs("#btnClientsRefresh")?.addEventListener("click", (e)=>{ renderGestiune("clients"); }, true);
      qs("#btnSuppliersRefresh")?.addEventListener("click", (e)=>{ renderGestiune("suppliers"); }, true);
      qs("#clientsSearch")?.addEventListener("input", ()=>renderGestiune("clients"), true);
      qs("#suppliersSearch")?.addEventListener("input", ()=>renderGestiune("suppliers"), true);

      // When list modals open, render
      const lc = qs("#listClientsBackdrop");
      const ls = qs("#listSuppliersBackdrop");
      if(lc && !lc.__fix20MO){
        const mo = new MutationObserver(()=>{ if(lc.classList.contains("show")) setTimeout(()=>renderGestiune("clients"), 0); });
        mo.observe(lc, {attributes:true, attributeFilter:["class"]});
        lc.__fix20MO = true;
      }
      if(ls && !ls.__fix20MO){
        const mo = new MutationObserver(()=>{ if(ls.classList.contains("show")) setTimeout(()=>renderGestiune("suppliers"), 0); });
        mo.observe(ls, {attributes:true, attributeFilter:["class"]});
        ls.__fix20MO = true;
      }

      // Edit button handler (delegated)
      document.addEventListener("click", (e)=>{
        const btn = e.target.closest && e.target.closest(".btnEditGestiune");
        if(!btn) return;
        const id = btn.getAttribute("data-id");
        if(typeof window.openClientModal !== "function"){
          alert("Fereastra client nu este disponibilă.");
          return;
        }
        window.openClientModal({
          subtitle: "Modificare",
          clientId: id,
          onSave: ()=>{ 
            // refresh current list
            if(qs("#listClientsBackdrop")?.classList.contains("show")) renderGestiune("clients");
            if(qs("#listSuppliersBackdrop")?.classList.contains("show")) renderGestiune("suppliers");
          }
        });
        e.preventDefault(); e.stopPropagation();
      }, true);

    })();
    // ===== END FIX20 =====
  </script>


  <script>
    // ===== FIX21 DELETE BUTTONS (Clienti/Furnizori) =====
    (function(){
      const qs = (s,p=document)=>p.querySelector(s);

      const get = window.__safeJSONGet || function(key, fallback){
        try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }catch{ return fallback; }
      };
      const set = window.__safeJSONSet || function(key, val){
        try{ localStorage.setItem(key, JSON.stringify(val)); }catch{
          const ms = window.__memStore || (window.__memStore = {});
          ms[key] = JSON.stringify(val);
        }
      };

      function removeById(list, id){
        return (Array.isArray(list)?list:[]).filter(x => String(x.id) !== String(id));
      }

      // Extend renderer output by swapping buttons cell HTML when present
      // We just add a delegated click for delete and let existing render create button class.
      document.addEventListener("click", (e)=>{
        const del = e.target.closest && e.target.closest(".btnDeleteGestiune");
        if(!del) return;

        const id = del.getAttribute("data-id");
        const type = del.getAttribute("data-type"); // clients or suppliers
        const isClients = (type === "clients");

        const name = del.getAttribute("data-name") || "înregistrarea";
        if(!confirm(`Sigur vrei să ștergi "${name}"?`)){
          e.preventDefault(); e.stopPropagation();
          return;
        }

        // Remove from explicit gestiune lists
        const key = isClients ? "gestiune_clients" : "gestiune_suppliers";
        const list = get(key, []);
        set(key, removeById(list, id));

        // Also update flags in clientsFull (so derived views remain consistent)
        const allFull = get("clientsFull", []);
        if(Array.isArray(allFull)){
          const idx = allFull.findIndex(x => String(x.id) === String(id));
          if(idx >= 0){
            if(isClients) allFull[idx].isClient = false;
            else allFull[idx].isSupplier = false;
            allFull[idx].updatedAt = new Date().toISOString();
            set("clientsFull", allFull);
          }
        }

        // Refresh current list
        try{
          if(qs("#listClientsBackdrop")?.classList.contains("show")) qs("#btnClientsRefresh")?.click();
          if(qs("#listSuppliersBackdrop")?.classList.contains("show")) qs("#btnSuppliersRefresh")?.click();
        }catch{}

        e.preventDefault(); e.stopPropagation();
      }, true);

      // Patch renderer by injecting delete button into action cells after each render.
      // We'll observe table bodies for changes and add delete buttons if missing.
      function ensureDeleteButtons(tbodySel, type){
        const tbody = qs(tbodySel);
        if(!tbody) return;
        const mo = new MutationObserver(()=>{
          [...tbody.querySelectorAll("tr")].forEach(tr=>{
            const btnEdit = tr.querySelector(".btnEditGestiune");
            if(!btnEdit) return;
            // If delete already exists, skip
            if(tr.querySelector(".btnDeleteGestiune")) return;

            const id = btnEdit.getAttribute("data-id");
            const name = tr.children?.[0]?.textContent?.trim() || "";
            const cell = btnEdit.closest("td");
            if(!cell) return;

            // Keep edit, add delete next to it
            const del = document.createElement("button");
            del.type = "button";
            del.className = "btn btn-danger btnDeleteGestiune";
            del.setAttribute("data-id", id);
            del.setAttribute("data-type", type);
            del.setAttribute("data-name", name);
            del.textContent = "Șterge";

            cell.style.whiteSpace = "nowrap";
            cell.style.display = "flex";
            cell.style.justifyContent = "flex-end";
            cell.style.gap = "8px";
            cell.appendChild(del);
          });
        });
        mo.observe(tbody, { childList:true, subtree:true });
      }

      ensureDeleteButtons("#clientsRows", "clients");
      ensureDeleteButtons("#suppliersRows", "suppliers");

    })();
    // ===== END FIX21 =====
  </script>


  <script>
    // ===== FIX22 STABLE LIST RENDER (nu dispar butoanele Modifică/Șterge) =====
    (function(){
      const qs = (s,p=document)=>p.querySelector(s);

      const get = window.__safeJSONGet || function(key, fallback){
        try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }catch{ return fallback; }
      };
      const set = window.__safeJSONSet || function(key, val){
        try{ localStorage.setItem(key, JSON.stringify(val)); }catch{
          const ms = window.__memStore || (window.__memStore = {});
          ms[key] = JSON.stringify(val);
        }
      };

      function ensureActionHeader(tbodySel){
        const tbody = qs(tbodySel);
        const table = tbody?.closest("table");
        const theadRow = table?.querySelector("thead tr");
        if(!theadRow) return;
        // If already has 5 columns, assume ok.
        if(theadRow.children.length >= 5) return;
        const th = document.createElement("th");
        th.style.width = "12%";
        th.textContent = "Acțiuni";
        theadRow.appendChild(th);
      }

      function upsertById(arr, obj){
        const idx = arr.findIndex(x => String(x.id) === String(obj.id));
        if(idx >= 0) arr[idx] = obj; else arr.push(obj);
        return arr;
      }

      function deriveList(type){
        // prefer explicit lists; fallback derive from clientsFull
        const key = type === "clients" ? "gestiune_clients" : "gestiune_suppliers";
        let list = get(key, []);
        if(!Array.isArray(list) || list.length === 0){
          const all = get("clientsFull", []);
          const filtered = (Array.isArray(all)?all:[])
            .filter(c => type==="clients" ? !!c.isClient : !!c.isSupplier)
            .map(c => ({
              id: c.id,
              name: c.name || "",
              cui: c.cui || "",
              reg: c.orc || c.reg || "",
              address: [c.address, c.city, c.county].filter(Boolean).join(", ") || c.address || ""
            }));
          list = filtered;
          // keep a mirror for consistency
          try{ set(key, list); }catch{}
        }
        return Array.isArray(list) ? list : [];
      }

      function render(type){
        const tbodySel = type==="clients" ? "#clientsRows" : "#suppliersRows";
        const searchSel = type==="clients" ? "#clientsSearch" : "#suppliersSearch";
        const tbody = qs(tbodySel);
        if(!tbody) return;

        ensureActionHeader(tbodySel);

        const q = (qs(searchSel)?.value || "").trim().toLowerCase();
        const base = deriveList(type);

        const filtered = !q ? base : base.filter(x =>
          (x.name||"").toLowerCase().includes(q) || (x.cui||"").toLowerCase().includes(q)
        );

        tbody.innerHTML = "";
        if(filtered.length === 0){
          const tr = document.createElement("tr");
          tr.innerHTML = '<td colspan="5" style="padding:14px; color:var(--muted); font-weight:850;">Nicio înregistrare.</td>';
          tbody.appendChild(tr);
          return;
        }

        filtered.forEach(x=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${(x.name||"").replace(/</g,"&lt;")}</td>
            <td>${(x.cui||"").replace(/</g,"&lt;")}</td>
            <td>${(x.reg||"").replace(/</g,"&lt;")}</td>
            <td>${(x.address||"").replace(/</g,"&lt;")}</td>
            <td style="text-align:right; white-space:nowrap; display:flex; justify-content:flex-end; gap:8px;">
              <button type="button" class="btn btn-ghost btnEditGestiune" data-id="${String(x.id).replace(/"/g,"&quot;")}" data-type="${type}">Modifică</button>
              <button type="button" class="btn btn-danger btnDeleteGestiune" data-id="${String(x.id).replace(/"/g,"&quot;")}" data-type="${type}" data-name="${(x.name||"").replace(/"/g,"&quot;")}">Șterge</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }

      window.__renderGestiuneList = render;

      // ---- Rewire refresh + search to avoid other listeners overriding our render ----
      function rewireButton(id, handler){
        const b = qs(id);
        if(!b || b.__fix22) return;
        const clone = b.cloneNode(true);
        clone.__fix22 = true;
        b.parentNode.replaceChild(clone, b);
        clone.addEventListener("click", handler, true);
      }
      function rewireInput(id, handler){
        const i = qs(id);
        if(!i || i.__fix22) return;
        const clone = i.cloneNode(true);
        clone.__fix22 = true;
        i.parentNode.replaceChild(clone, i);
        clone.addEventListener("input", handler, true);
      }

      rewireButton("#btnClientsRefresh", ()=>render("clients"));
      rewireButton("#btnSuppliersRefresh", ()=>render("suppliers"));
      rewireInput("#clientsSearch", ()=>render("clients"));
      rewireInput("#suppliersSearch", ()=>render("suppliers"));

      // When modals open, render immediately (stable)
      const lc = qs("#listClientsBackdrop");
      const ls = qs("#listSuppliersBackdrop");
      if(lc && !lc.__fix22MO){
        const mo = new MutationObserver(()=>{ if(lc.classList.contains("show")) setTimeout(()=>render("clients"), 0); });
        mo.observe(lc, {attributes:true, attributeFilter:["class"]});
        lc.__fix22MO = true;
      }
      if(ls && !ls.__fix22MO){
        const mo = new MutationObserver(()=>{ if(ls.classList.contains("show")) setTimeout(()=>render("suppliers"), 0); });
        mo.observe(ls, {attributes:true, attributeFilter:["class"]});
        ls.__fix22MO = true;
      }

      // Ensure delete handler refresh uses stable renderer
      document.addEventListener("click", (e)=>{
        const del = e.target.closest && e.target.closest(".btnDeleteGestiune");
        if(!del) return;

        const id = del.getAttribute("data-id");
        const type = del.getAttribute("data-type") || "clients";
        const name = del.getAttribute("data-name") || "înregistrarea";

        if(!confirm(`Sigur vrei să ștergi "${name}"?`)){
          e.preventDefault(); e.stopPropagation();
          return;
        }

        const key = type === "suppliers" ? "gestiune_suppliers" : "gestiune_clients";
        const list = get(key, []);
        const next = (Array.isArray(list)?list:[]).filter(x => String(x.id) !== String(id));
        set(key, next);

        // Update flags in clientsFull (keep record but uncheck)
        const all = get("clientsFull", []);
        if(Array.isArray(all)){
          const idx = all.findIndex(x => String(x.id) === String(id));
          if(idx >= 0){
            if(type === "suppliers") all[idx].isSupplier = false;
            else all[idx].isClient = false;
            all[idx].updatedAt = new Date().toISOString();
            set("clientsFull", all);
          }
        }

        // Stable re-render
        render(type === "suppliers" ? "suppliers" : "clients");

        e.preventDefault(); e.stopPropagation();
      }, true);

      // Edit handler should refresh stable renderer after save
      document.addEventListener("click", (e)=>{
        const btn = e.target.closest && e.target.closest(".btnEditGestiune");
        if(!btn) return;
        const id = btn.getAttribute("data-id");
        const type = btn.getAttribute("data-type") || "clients";

        if(typeof window.openClientModal !== "function"){
          alert("Fereastra client nu este disponibilă.");
          return;
        }

        window.openClientModal({
          subtitle: "Modificare",
          clientId: id,
          onSave: ()=>{ render(type === "suppliers" ? "suppliers" : "clients"); }
        });

        e.preventDefault(); e.stopPropagation();
      }, true);

    })();
    // ===== END FIX22 =====
  </script>


  <script>
    // ===== FIX23 INTERNAL CODE (cod intern pentru Client/Furnizor) =====
    (function(){
      const qs = (s,p=document)=>p.querySelector(s);

      // Storage helpers
      const get = window.__safeJSONGet || function(key, fallback){
        try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }catch{
          const ms = window.__memStore || (window.__memStore = {});
          try{ return ms[key] ? JSON.parse(ms[key]) : fallback; }catch{ return fallback; }
        }
      };
      const set = window.__safeJSONSet || function(key, val){
        const raw = JSON.stringify(val);
        try{ localStorage.setItem(key, raw); }catch{
          const ms = window.__memStore || (window.__memStore = {});
          ms[key] = raw;
        }
      };

      function pad6(n){ return String(n).padStart(6, "0"); }
      function nextSeq(seqKey){
        let n = Number(get(seqKey, 0) || 0);
        n = (isFinite(n) ? n : 0) + 1;
        set(seqKey, n);
        return n;
      }
      function pickPrefix(c){
        // dacă este client -> CL, dacă este furnizor -> FU, altfel PX
        if(c && c.isClient) return { prefix:"CL", key:"seq_client_code" };
        if(c && c.isSupplier) return { prefix:"FU", key:"seq_supplier_code" };
        return { prefix:"PX", key:"seq_partner_code" };
      }
      function assignCodeIfMissing(c){
        if(!c) return c;
        if(c.internalCode && String(c.internalCode).trim()) return c;
        const p = pickPrefix(c);
        const code = p.prefix + pad6(nextSeq(p.key));
        c.internalCode = code;
        return c;
      }

      function upsertById(arr, obj){
        const idx = arr.findIndex(x => String(x.id) === String(obj.id));
        if(idx >= 0) arr[idx] = obj; else arr.push(obj);
        return arr;
      }

      function syncDerivedListsFromFullRecord(full){
        if(!full || !full.id) return;

        const entry = {
          id: full.id,
          code: full.internalCode || "",
          name: full.name || "",
          cui: full.cui || "",
          reg: full.orc || full.reg || "",
          address: [full.address, full.city, full.county].filter(Boolean).join(", ") || full.address || ""
        };

        // gestiune_clients
        if(full.isClient){
          const l = get("gestiune_clients", []);
          const next = upsertById(Array.isArray(l)?l:[], entry);
          set("gestiune_clients", next);
        }
        // gestiune_suppliers
        if(full.isSupplier){
          const l = get("gestiune_suppliers", []);
          const next = upsertById(Array.isArray(l)?l:[], entry);
          set("gestiune_suppliers", next);
        }

        // compat clients (dropdown) – păstrăm și codul
        const compat = {
          id: full.id,
          code: full.internalCode || "",
          name: full.name || "",
          cui: full.cui || "",
          reg: full.orc || "",
          address: [full.address, full.city, full.county].filter(Boolean).join(", "),
          bank: (full.bankAccounts?.[0]?.bank || ""),
          iban: (full.bankAccounts?.[0]?.iban || "")
        };
        const cc = get("clients", []);
        set("clients", upsertById(Array.isArray(cc)?cc:[], compat));
      }

      function ensureCodesForAll(){
        const all = get("clientsFull", []);
        if(!Array.isArray(all) || all.length === 0) return;

        let changed = false;
        all.forEach(c=>{
          if(!c.internalCode || !String(c.internalCode).trim()){
            assignCodeIfMissing(c);
            changed = true;
          }
        });
        if(changed) set("clientsFull", all);

        // Re-sync gestiune lists (best-effort)
        try{
          const clients = all.filter(c=>!!c.isClient).map(c=>({
            id:c.id, code:c.internalCode||"", name:c.name||"", cui:c.cui||"", reg:c.orc||"", address:[c.address,c.city,c.county].filter(Boolean).join(", ")
          }));
          const suppliers = all.filter(c=>!!c.isSupplier).map(c=>({
            id:c.id, code:c.internalCode||"", name:c.name||"", cui:c.cui||"", reg:c.orc||"", address:[c.address,c.city,c.county].filter(Boolean).join(", ")
          }));
          set("gestiune_clients", clients);
          set("gestiune_suppliers", suppliers);
        }catch{}
      }

      // Run once at load (backfill codes for existing)
      ensureCodesForAll();

      // After save click, post-process the saved record and add internalCode if missing
      const btnSave = qs("#btnSaveClientFull");
      if(btnSave && !btnSave.__fix23){
        btnSave.__fix23 = true;
        btnSave.addEventListener("click", ()=>{
          const name = (qs("#cfName")?.value || "").trim();
          const cui  = (qs("#cfCui")?.value || "").trim();

          setTimeout(()=>{
            const all = get("clientsFull", []);
            if(!Array.isArray(all) || all.length === 0) return;

            // find most recent matching record by name (+optional cui)
            const candidates = all.filter(x => (x?.name||"").trim() === name && ( (x?.cui||"").trim() === cui || !cui ));
            const pick = (candidates.length ? candidates : all)
              .slice()
              .sort((a,b)=> String(b?.updatedAt||"").localeCompare(String(a?.updatedAt||"")));
            const saved = candidates.length ? pick[0] : null;
            if(!saved) return;

            const before = saved.internalCode;
            assignCodeIfMissing(saved);
            if(saved.internalCode !== before){
              // persist back
              const idx = all.findIndex(x => String(x.id) === String(saved.id));
              if(idx >= 0) all[idx] = saved;
              set("clientsFull", all);
            }

            // sync into lists + compat
            syncDerivedListsFromFullRecord(saved);

            // refresh lists UI if open (keeps buttons via FIX22)
            try{
              if(qs("#listClientsBackdrop")?.classList.contains("show")) window.__renderGestiuneList && window.__renderGestiuneList("clients");
              if(qs("#listSuppliersBackdrop")?.classList.contains("show")) window.__renderGestiuneList && window.__renderGestiuneList("suppliers");
            }catch{}
          }, 0);
        }, true);
      }

      // Optional: show code in list without breaking layout (prepend in name)
      // Only if not already shown; keep minimal.
      function decorateNamesWithCode(){
        ["#clientsRows", "#suppliersRows"].forEach(sel=>{
          const tbody = qs(sel);
          if(!tbody) return;
          [...tbody.querySelectorAll("tr")].forEach(tr=>{
            const td = tr.children && tr.children[0];
            if(!td) return;
            if(td.getAttribute("data-coded") === "1") return;
            const name = td.textContent || "";
            // Find id from edit button
            const id = tr.querySelector(".btnEditGestiune")?.getAttribute("data-id");
            if(!id) return;
            const all = get("clientsFull", []);
            const rec = Array.isArray(all) ? all.find(x => String(x.id) === String(id)) : null;
            const code = rec?.internalCode;
            if(code){
              td.textContent = "[" + code + "] " + name;
              td.setAttribute("data-coded", "1");
            }
          });
        });
      }

      // When lists render, decorate names once
      document.addEventListener("click", (e)=>{
        const b = e.target.closest && e.target.closest("#btnClientsRefresh, #btnSuppliersRefresh");
        if(!b) return;
        setTimeout(decorateNamesWithCode, 0);
      }, true);

      const lc = qs("#listClientsBackdrop");
      const ls = qs("#listSuppliersBackdrop");
      if(lc){
        const mo = new MutationObserver(()=>{ if(lc.classList.contains("show")) setTimeout(decorateNamesWithCode, 50); });
        mo.observe(lc, {attributes:true, attributeFilter:["class"]});
      }
      if(ls){
        const mo2 = new MutationObserver(()=>{ if(ls.classList.contains("show")) setTimeout(decorateNamesWithCode, 50); });
        mo2.observe(ls, {attributes:true, attributeFilter:["class"]});
      }

    })();
    // ===== END FIX23 INTERNAL CODE =====
  </script>


  <!-- SETARI: FACTURA / PROFORMA / CHITANTA -->
  <div class="modal-backdrop" id="invoiceSettingsBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="invoiceSettingsTitle" style="width:min(920px,100%);">
      <div class="modal-head">
        <div class="modal-title">
          <div class="h" id="invoiceSettingsTitle">Setări documente</div>
          <div class="s">Serii, numerotare, TVA – Factură / Proformă / Chitanță</div>
        </div>
        <button class="modal-close" type="button" id="invoiceSettingsClose" aria-label="Închide">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <div class="modal-body">
        <div class="tabs">
          <button class="tab active" type="button" data-docset-tab="inv">Factură</button>
          <button class="tab" type="button" data-docset-tab="pro">Factură proformă</button>
          <button class="tab" type="button" data-docset-tab="rcp">Chitanță</button>
        </div>

        <div class="tabpanels">
          <section class="panel show" data-docset-panel="inv">
            <div class="row-3">
              <div class="field">
                <label>Serie</label>
                <input id="setInvSerie" type="text" placeholder="Ex: FCT" maxlength="12">
              </div>
              <div class="field">
                <label>Începe numerotarea de la</label>
                <input id="setInvStart" type="number" min="1" step="1" placeholder="1">
              </div>
              <div class="field">
                <label>&nbsp;</label>
                <label class="chk">
                  <input id="setInvVatPayer" type="checkbox">
                  <span>Plătitor TVA</span>
                </label>
              </div>
            </div>
            <div class="hint">Aceste setări se aplică la Factură (serie fixă + număr automat). Dacă „Plătitor TVA” este debifat, TVA va fi 0 în factură.</div>
          </section>

          <section class="panel" data-docset-panel="pro">
            <div class="row-3">
              <div class="field">
                <label>Serie</label>
                <input id="setProSerie" type="text" placeholder="Ex: PRO" maxlength="12">
              </div>
              <div class="field">
                <label>Începe numerotarea de la</label>
                <input id="setProStart" type="number" min="1" step="1" placeholder="1">
              </div>
              <div class="field">
                <label>&nbsp;</label>
                <label class="chk">
                  <input id="setProVatPayer" type="checkbox">
                  <span>Plătitor TVA</span>
                </label>
              </div>
            </div>
            <div class="hint">Aceste setări se aplică la Factură proformă (serie fixă + număr automat).</div>
          </section>

          <section class="panel" data-docset-panel="rcp">
            <div class="row-3">
              <div class="field">
                <label>Serie</label>
                <input id="setRcpSerie" type="text" placeholder="Ex: CHIT" maxlength="12">
              </div>
              <div class="field">
                <label>Începe numerotarea de la</label>
                <input id="setRcpStart" type="number" min="1" step="1" placeholder="1">
              </div>
              <div class="field">
                <label>&nbsp;</label>
                <label class="chk">
                  <input id="setRcpVatPayer" type="checkbox">
                  <span>Plătitor TVA</span>
                </label>
              </div>
            </div>
            <div class="hint">Setările pentru Chitanță (serie + număr automat). TVA nu se aplică sumei încasate, dar păstrăm opțiunea pentru consistență.</div>
          </section>
        </div>

        <div class="modal-actions">
          <button class="btn btn-ghost" type="button" id="invoiceSettingsReset">Resetează implicit</button>
          <div style="flex:1"></div>
          <button class="btn btn-muted" type="button" id="invoiceSettingsCancel">Renunță</button>
          <button class="btn btn-primary" type="button" id="invoiceSettingsSave">Salvează</button>
        </div>
      </div>
    </div>
  </div>


  <script>
    // ===== FIX24 SETARI FACTURA / PROFORMA / CHITANTA =====
    (function(){
      const qs = (s,p=document)=>p.querySelector(s);
      const qsa = (s,p=document)=>[...p.querySelectorAll(s)];
      const normalize = (s)=> (s||"").toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").trim().toUpperCase();

      // Storage helpers (prefer bridge)
      const get = window.__safeJSONGet || function(key, fallback){
        try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }catch{
          const ms = window.__memStore || (window.__memStore = {});
          try{ return ms[key] ? JSON.parse(ms[key]) : fallback; }catch{ return fallback; }
        }
      };
      const set = window.__safeJSONSet || function(key, val){
        const raw = JSON.stringify(val);
        try{ localStorage.setItem(key, raw); }catch{
          const ms = window.__memStore || (window.__memStore = {});
          ms[key] = raw;
        }
      };

      const DEFAULTS = {
        inv: { serie:"FCT", next:1, vatPayer:true },
        pro: { serie:"PRO", next:1, vatPayer:true },
        rcp: { serie:"CHIT", next:1, vatPayer:false }
      };

      function loadDocSettings(){
        const s = get("docSettings", null);
        if(!s || typeof s !== "object"){
          set("docSettings", DEFAULTS);
          return JSON.parse(JSON.stringify(DEFAULTS));
        }
        // backfill
        ["inv","pro","rcp"].forEach(k=>{
          s[k] = s[k] || {};
          if(!("serie" in s[k])) s[k].serie = DEFAULTS[k].serie;
          if(!("next" in s[k])) s[k].next = DEFAULTS[k].next;
          if(!("vatPayer" in s[k])) s[k].vatPayer = DEFAULTS[k].vatPayer;
        });
        set("docSettings", s);
        return s;
      }
      function saveDocSettings(s){ set("docSettings", s); }

      // Modal open/close helpers
      const backdrop = qs("#invoiceSettingsBackdrop");
      if(!backdrop) return;

      function openModal(){
        backdrop.classList.add("show");
        backdrop.style.display = "flex";
        backdrop.style.pointerEvents = "auto";
        backdrop.setAttribute("aria-hidden","false");
        document.body.style.overflow = "hidden";
      }
      function closeModal(){
        backdrop.classList.remove("show");
        backdrop.style.display = "";
        backdrop.style.pointerEvents = "";
        backdrop.setAttribute("aria-hidden","true");
        document.body.style.overflow = "";
      }

      // Tabs
      function setTab(key){
        qsa("[data-docset-tab]").forEach(b=> b.classList.toggle("active", b.getAttribute("data-docset-tab")===key));
        qsa("[data-docset-panel]").forEach(p=> p.classList.toggle("show", p.getAttribute("data-docset-panel")===key));
      }
      qsa("[data-docset-tab]").forEach(b=>{
        b.addEventListener("click", ()=>setTab(b.getAttribute("data-docset-tab")));
      });

      // Populate fields
      function fill(){
        const s = loadDocSettings();
        (function(){const _el=qs("#setInvSerie"); if(_el) _el.value = s.inv.serie || "";})();
        (function(){const _el=qs("#setInvStart"); if(_el) _el.value = String(s.inv.next ?? 1);})();
        qs("#setInvVatPayer").checked = !!s.inv.vatPayer;

        (function(){const _el=qs("#setProSerie"); if(_el) _el.value = s.pro.serie || "";})();
        (function(){const _el=qs("#setProStart"); if(_el) _el.value = String(s.pro.next ?? 1);})();
        qs("#setProVatPayer").checked = !!s.pro.vatPayer;

        (function(){const _el=qs("#setRcpSerie"); if(_el) _el.value = s.rcp.serie || "";})();
        (function(){const _el=qs("#setRcpStart"); if(_el) _el.value = String(s.rcp.next ?? 1);})();
        qs("#setRcpVatPayer").checked = !!s.rcp.vatPayer;
      }

      function collect(){
        const s = loadDocSettings();
        s.inv.serie = (qs("#setInvSerie").value || "").trim() || DEFAULTS.inv.serie;
        s.inv.next = Math.max(1, parseInt(qs("#setInvStart").value || "1", 10) || 1);
        s.inv.vatPayer = !!qs("#setInvVatPayer").checked;

        s.pro.serie = (qs("#setProSerie").value || "").trim() || DEFAULTS.pro.serie;
        s.pro.next = Math.max(1, parseInt(qs("#setProStart").value || "1", 10) || 1);
        s.pro.vatPayer = !!qs("#setProVatPayer").checked;

        s.rcp.serie = (qs("#setRcpSerie").value || "").trim() || DEFAULTS.rcp.serie;
        s.rcp.next = Math.max(1, parseInt(qs("#setRcpStart").value || "1", 10) || 1);
        s.rcp.vatPayer = !!qs("#setRcpVatPayer").checked;
        return s;
      }

      qs("#invoiceSettingsClose").addEventListener("click", closeModal);
      qs("#invoiceSettingsCancel").addEventListener("click", closeModal);
      backdrop.addEventListener("click", (e)=>{ if(e.target === backdrop) closeModal(); });

      qs("#invoiceSettingsReset").addEventListener("click", ()=>{
        if(!confirm("Sigur vrei să resetezi setările implicite?")) return;
        saveDocSettings(JSON.parse(JSON.stringify(DEFAULTS)));
        fill();
      });

      qs("#invoiceSettingsSave").addEventListener("click", ()=>{
        const s = collect();
        saveDocSettings(s);
        closeModal();
      });

      // Open from SETARI -> SETARI FACTURA
      document.addEventListener("click", (e)=>{
        const a = e.target.closest && e.target.closest(".action");
        if(!a) return;

        const title = qs("#drawerTitle")?.textContent || "";
        const label = a.querySelector(".t")?.textContent || "";
        if(normalize(title) === normalize("SETARI") && normalize(label) === normalize("SETARI FACTURA")){
          // close drawer if open (avoid overlays)
          qs("#drawer")?.classList.remove("show");
          qs("#backdrop")?.classList.remove("show");

          setTab("inv");
          fill();
          openModal();
          e.preventDefault(); e.stopPropagation();
        }
      }, true);

      // ---- Integrări: aplică serie/număr automat + TVA payer în ferestre ----

      function formatDocNo(serie, n){
        const sn = String(n).padStart(6,"0");
        return (serie ? (serie + "_" + sn) : sn);
      }

      // Hook on open invoice/proforma: when modal backdrop becomes visible, set defaults.
      const invoiceBackdrop = qs("#invoiceBackdrop");      // factura/proforma modal
      const receiptBackdrop = qs("#receiptBackdrop");      // chitanta modal

      function applyToInvoice(kind){
        // kind: "inv" | "pro"
        const s = loadDocSettings();
        const conf = s[kind];

        // IDs used earlier in invoice modal (best-effort, only set if exist)
        const serieEl = qs("#invSerie");
        const noEl = qs("#invNo");
        const vatPayerEl = qs("#invVatPayer"); // might not exist; we enforce via totals
        const vatValEl = qs("#invVatValue");
        const vatVal2El = qs("#invVat"); // fallback id
        const vatTotalEl = qs("#invTotal");
        const subtotalEl = qs("#invSubtotal");

        if(serieEl) { serieEl.value = conf.serie; serieEl.readOnly = true; }
        if(noEl){
          noEl.value = formatDocNo(conf.serie, conf.next);
          noEl.readOnly = true;
        }

        // If not VAT payer -> force TVA = 0 and disable TVA inputs if present
        const vatInputs = [vatValEl, vatVal2El].filter(Boolean);
        if(!conf.vatPayer){
          vatInputs.forEach(el=>{ el.value = "0"; el.disabled = true; });
          // Recompute total if we can
          if(subtotalEl && vatTotalEl){
            const sub = parseFloat((subtotalEl.value||"0").replace(",", ".")) || 0;
            vatTotalEl.value = String(sub.toFixed(2));
          }
        }else{
          vatInputs.forEach(el=>{ el.disabled = false; });
        }
      }

      function bumpInvoiceNumber(kind){
        const s = loadDocSettings();
        s[kind].next = Math.max(1, (parseInt(s[kind].next,10)||1) + 1);
        saveDocSettings(s);
      }
      function bumpReceiptNumber(){
        const s = loadDocSettings();
        s.rcp.next = Math.max(1, (parseInt(s.rcp.next,10)||1) + 1);
        saveDocSettings(s);
      }

      // Detect whether the invoice modal opened as proforma or factura.
      // We rely on a window flag set when clicking the buttons (FACTURA / FACTURA PROFORMA).
      window.__openInvoiceKind = window.__openInvoiceKind || "inv";

      document.addEventListener("click", (e)=>{
        const a = e.target.closest && e.target.closest(".action");
        if(!a) return;
        const title = qs("#drawerTitle")?.textContent || "";
        const label = a.querySelector(".t")?.textContent || "";

        if(normalize(title) === normalize("INREGISTRARE DOCUMENTE")){
          if(normalize(label) === normalize("FACTURA")) window.__openInvoiceKind = "inv";
          if(normalize(label) === normalize("FACTURA PROFORMA")) window.__openInvoiceKind = "pro";
          if(normalize(label) === normalize("CHITANTA")) window.__openInvoiceKind = "rcp";
        }
      }, true);

      if(invoiceBackdrop){
        const mo = new MutationObserver(()=>{
          if(invoiceBackdrop.classList.contains("show")){
            try{ applyToInvoice(window.__openInvoiceKind === "pro" ? "pro" : "inv"); }catch{}
          }
        });
        mo.observe(invoiceBackdrop, { attributes:true, attributeFilter:["class"] });
      }
      if(receiptBackdrop){
        const mo2 = new MutationObserver(()=>{
          if(receiptBackdrop.classList.contains("show")){
            const s = loadDocSettings();
            const conf = s.rcp;
            const noEl = qs("#rcptNo") || qs("#rcptDocNo");
            if(noEl){
              noEl.value = formatDocNo(conf.serie, conf.next);
              noEl.readOnly = true;
            }
          }
        });
        mo2.observe(receiptBackdrop, { attributes:true, attributeFilter:["class"] });
      }

      // On save buttons, bump next number once per save
      // Invoice save button id in earlier file: btnSaveInvoice
      const btnInvSave = qs("#btnSaveInvoice");
      if(btnInvSave && !btnInvSave.__fix24){
        btnInvSave.__fix24 = true;
        btnInvSave.addEventListener("click", ()=>{
          // Only bump if modal is open and likely saved (no validation errors). Best-effort.
          setTimeout(()=>{
            if(invoiceBackdrop && invoiceBackdrop.classList.contains("show")) return; // if still open, probably failed validation
            const kind = (window.__openInvoiceKind === "pro") ? "pro" : "inv";
            bumpInvoiceNumber(kind);
          }, 0);
        }, true);
      }
      const btnRcpSave = qs("#btnSaveReceipt");
      if(btnRcpSave && !btnRcpSave.__fix24){
        btnRcpSave.__fix24 = true;
        btnRcpSave.addEventListener("click", ()=>{
          setTimeout(()=>{
            if(receiptBackdrop && receiptBackdrop.classList.contains("show")) return;
            bumpReceiptNumber();
          }, 0);
        }, true);
      }

    })();
    // ===== END FIX24 SETARI FACTURA =====
  </script>


  <!-- DOCUMENTE: FACTURI -->
  <div class="modal-backdrop" id="docsInvoicesBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="docsInvoicesTitle" style="width:min(1100px,100%);">
      <div class="modal-head">
        <div class="modal-title">
          <div class="h" id="docsInvoicesTitle">Facturi</div>
          <div class="s">Documente – listă facturi</div>
        </div>
        <button class="modal-close" type="button" id="docsInvoicesClose" aria-label="Închide">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="row-3">
          <div class="field">
            <label>Caută</label>
            <input id="docsInvSearch" type="text" placeholder="Nr / Client / CUI">
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <button class="btn btn-ghost" type="button" id="docsInvRefresh">Reîncarcă</button>
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <div style="height:40px;"></div>
          </div>
</div>

        <div class="docs-filters" id="docsInvFilters">
          <button class="btn btn-ghost" type="button" data-filter="current" id="docsInvBtnCurrent">Luna în curs</button>
          <button class="btn btn-ghost" type="button" data-filter="prev" id="docsInvBtnPrev">Luna trecută</button>
          <button class="btn btn-ghost" type="button" data-filter="all" id="docsInvBtnAll">Toate</button>
        </div>

<div class="docs-scroll">


<table class="table" aria-label="Lista facturi" style="margin-top:10px;">
          <thead>
            <tr>
              <th style="width:16%;">Nr.</th>
              <th style="width:14%;">Data</th>
              <th style="width:26%;">Client</th>
              <th style="width:14%;">Total</th>
              <th style="width:16%;">Stare</th>
              <th style="width:14%;">Acțiuni</th>
            </tr>
          </thead>
          <tbody id="docsInvRows"></tbody>
        </table>

        </div>

        <div class="docs-pager" id="docsInvPager">
          <button class="btn btn-muted" type="button" id="docsInvPrevPage">Înapoi</button>
          <div class="muted" id="docsInvPageInfo">Pagina 1</div>
          <button class="btn btn-muted" type="button" id="docsInvNextPage">Înainte</button>
        </div>

        <div class="modal-actions">
          <button class="btn btn-muted" type="button" id="docsInvCloseBottom">Închide</button>
        </div>
      </div>
    </div>
  </div>

  <!-- DOCUMENTE: FACTURI PROFORME -->
  <div class="modal-backdrop" id="docsProformasBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="docsProformasTitle" style="width:min(1100px,100%);">
      <div class="modal-head">
        <div class="modal-title">
          <div class="h" id="docsProformasTitle">Facturi proforme</div>
          <div class="s">Documente – listă proforme</div>
        </div>
        <button class="modal-close" type="button" id="docsProformasClose" aria-label="Închide">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="row-3">
          <div class="field">
            <label>Caută</label>
            <input id="docsProSearch" type="text" placeholder="Nr / Client / CUI">
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <button class="btn btn-ghost" type="button" id="docsProRefresh">Reîncarcă</button>
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <div style="height:40px;"></div>
          </div>
</div>

        <div class="docs-filters" id="docsProFilters">
          <button class="btn btn-ghost" type="button" data-filter="current" id="docsProBtnCurrent">Luna în curs</button>
          <button class="btn btn-ghost" type="button" data-filter="prev" id="docsProBtnPrev">Luna trecută</button>
          <button class="btn btn-ghost" type="button" data-filter="all" id="docsProBtnAll">Toate</button>
        </div>

<div class="docs-scroll">


<table class="table" aria-label="Lista proforme" style="margin-top:10px;">
          <thead>
            <tr>
              <th style="width:16%;">Nr.</th>
              <th style="width:14%;">Data</th>
              <th style="width:26%;">Client</th>
              <th style="width:14%;">Total</th>
              <th style="width:16%;">Stare</th>
              <th style="width:14%;">Acțiuni</th>
            </tr>
          </thead>
          <tbody id="docsProRows"></tbody>
        </table>

        </div>

        <div class="docs-pager" id="docsProPager">
          <button class="btn btn-muted" type="button" id="docsProPrevPage">Înapoi</button>
          <div class="muted" id="docsProPageInfo">Pagina 1</div>
          <button class="btn btn-muted" type="button" id="docsProNextPage">Înainte</button>
        </div>

        <div class="modal-actions">
          <button class="btn btn-muted" type="button" id="docsProCloseBottom">Închide</button>
        </div>
      </div>
    </div>
  </div>

  <!-- DOCUMENTE: CHITANTE -->
  <div class="modal-backdrop" id="docsReceiptsBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="docsReceiptsTitle" style="width:min(1100px,100%);">
      <div class="modal-head">
        <div class="modal-title">
          <div class="h" id="docsReceiptsTitle">Chitanțe</div>
          <div class="s">Documente – listă chitanțe</div>
        </div>
        <button class="modal-close" type="button" id="docsReceiptsClose" aria-label="Închide">
          <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="row-3">
          <div class="field">
            <label>Caută</label>
            <input id="docsRcpSearch" type="text" placeholder="Nr / Partener / CUI">
          </div>

          <div class="field">
            <label>De la</label>
            <input id="docsRcpFrom" type="date">
          </div>

          <div class="field">
            <label>Până la</label>
            <input id="docsRcpTo" type="date">
          </div>

          <div class="field">
            <label>&nbsp;</label>
            <div style="display:flex; gap:10px; align-items:center; justify-content:flex-end; flex-wrap:nowrap;">
              <label style="display:flex; align-items:center; gap:8px; font-weight:850; color:var(--muted);">
                <input type="checkbox" id="docsRcpSelectAll">
                Selectează toate
              </label>
              <button class="btn btn-ghost" type="button" id="docsRcpRefresh">Actualizează</button>
              <button class="btn btn-primary" type="button" id="docsRcpPrintTable">Tipărește tabel</button>
            </div>
          </div>
        </div>
</div>

        <div class="docs-filters" id="docsRecFilters">
          <button class="btn btn-ghost" type="button" data-filter="current" id="docsRecBtnCurrent">Luna în curs</button>
          <button class="btn btn-ghost" type="button" data-filter="prev" id="docsRecBtnPrev">Luna trecută</button>
          <button class="btn btn-ghost" type="button" data-filter="all" id="docsRecBtnAll">Toate</button>
        </div>

<div class="docs-scroll">


<table class="table" aria-label="Lista chitanțe" style="margin-top:10px;">
          <thead>
            <tr>
              <th style="width:4%;"><input type="checkbox" id="docsRcpAllHead" aria-label="Selectează toate"></th>
              <th style="width:12%;">Nr. doc.</th>
              <th style="width:12%;">Data doc.</th>
              <th style="width:28%;">A primit de la</th>
              <th style="width:12%;">Sumă</th>
              <th style="width:26%;">Reprezentând</th>
              <th style="width:12%;">Stare</th>
              <th style="width:6%;">PDF</th>
            </tr>
          </thead>
          <tbody id="docsRcpRows"></tbody>
        </table>

        </div>

        <div class="docs-pager" id="docsRecPager">
          <button class="btn btn-muted" type="button" id="docsRecPrevPage">Înapoi</button>
          <div class="muted" id="docsRecPageInfo">Pagina 1</div>
          <button class="btn btn-muted" type="button" id="docsRecNextPage">Înainte</button>
        </div>

        <div class="modal-actions">
          <button class="btn btn-muted" type="button" id="docsRcpCloseBottom">Închide</button>
        </div>
      </div>
    </div>
  </div>


  <script>
    // ===== FIX25 DOCUMENTE LISTE + MODIFICARE + STATUS + PDF =====
    (function(){
      const qs = (s,p=document)=>p.querySelector(s);
      const qsa = (s,p=document)=>[...p.querySelectorAll(s)];
      const normalize = (s)=> (s||"").toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").trim().toUpperCase();

      // Storage helpers (prefer bridge)
      const get = window.__safeJSONGet || function(key, fallback){
        try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }catch{
          const ms = window.__memStore || (window.__memStore = {});
          try{ return ms[key] ? JSON.parse(ms[key]) : fallback; }catch{ return fallback; }
        }
      };
      const set = window.__safeJSONSet || function(key, val){
        const raw = JSON.stringify(val);
        try{ localStorage.setItem(key, raw); }catch{
          const ms = window.__memStore || (window.__memStore = {});
          ms[key] = raw;
        }
      };

      function openModal(b){
        if(!b) return;
        b.classList.add("show");
        b.style.display = "flex";
        b.style.pointerEvents = "auto";
        b.setAttribute("aria-hidden","false");
        document.body.style.overflow = "hidden";
      }
      function closeModal(b){
        if(!b) return;
        b.classList.remove("show");
        b.style.display = "";
        b.style.pointerEvents = "";
        b.setAttribute("aria-hidden","true");
        document.body.style.overflow = "";
      }

      // ---- Document list helpers ----
      function money(n){ 
        const x = Number(n||0);
        return x.toLocaleString("ro-RO", { minimumFractionDigits:2, maximumFractionDigits:2 });
      }
      function docNo(serie, number){
        const sn = String(Number(number||0)).padStart(6,"0");
        return (serie ? (serie + "_" + sn) : sn);
      }
      function ensureStatus(obj){
        if(!obj.status) obj.status = "IN_LUCRU";
        return obj;
      }
      function upsert(list, obj){
        const idx = list.findIndex(x => String(x.id) === String(obj.id));
        if(idx >= 0) list[idx] = obj; else list.push(obj);
        return list;
      }
      function loadList(key){
        const list = get(key, []);
        return (Array.isArray(list)?list:[]).map(ensureStatus);
      }
      function saveList(key, list){
        set(key, Array.isArray(list)?list:[]);
      }

      // ---- PDF (opens print dialog; user can Save as PDF) ----
      
function openPdfWindow(title, htmlBody){

        const w = window.open("", "_blank");

        if(!w){ alert("Popup blocat. Permite popups pentru PDF."); return; }

        const doc = `<!doctype html><html><head><meta charset="utf-8"><title>${String(title||"")}</title>

        <style>

          @page{ size:A4; margin:10mm; }

          body{ font-family: Arial, Helvetica, sans-serif; color:#000; font-size:12px; }

        </style></head><body>${htmlBody||""}

<script>
(function(){
  const qs = (s, r=document)=>r.querySelector(s);
  const qsa = (s, r=document)=>Array.from(r.querySelectorAll(s));
  const norm = (s)=>String(s||"").trim().toLowerCase();
  const money = (n)=>{ const x=Number(n); return (isFinite(x)? x.toFixed(2):"0.00"); };

  function loadProducts(){
    // reuse NIR storage if exists
    if (typeof window.nirLoadProducts === "function") return window.nirLoadProducts() || [];
    if (typeof window.lsGet === "function") return window.lsGet("gestiune_products", []) || [];
    try{ return JSON.parse(localStorage.getItem("gestiune_products")||"[]") || []; }catch{ return []; }
  }
  function saveProducts(list){
    if (typeof window.lsSet === "function") { window.lsSet("gestiune_products", list); return; }
    localStorage.setItem("gestiune_products", JSON.stringify(list||[]));
  }

  function getId(p){
    return p && (p.id || p.ProductID || (String(p.name||p.denumire||"").trim().toUpperCase()+"|"+String(p.um||p.MeasuringUnit||"").trim().toUpperCase()));
  }

  let selectedId = null;

  function matchField(p, field, val, mode){
    const v = norm(val);
    const starts = mode === "starts";
    const get = (x)=>norm(x||"");
    let target="";
    if(field==="name") target = get(p.name||p.denumire);
    else if(field==="barcode") target = get(p.barcode||p.cod_bare||p.coddebare);
    else if(field==="code") target = get(p.code||p.cod);
    else if(field==="desc") target = get(p.description||p.descriere);
    else if(field==="cat") target = get(p.category||p.categorie);
    else { // auto
      const all = [
        p.name||p.denumire, p.barcode||p.cod_bare||p.coddebare, p.code||p.cod, p.description||p.descriere, p.category||p.categorie
      ].map(get).join(" ");
      target = all;
    }
    return starts ? target.startsWith(v) : target.includes(v);
  }

  function renderProducts(){
    const tbody = qs("#productsTbody");
    const live = qs("#prodLiveBar");
    const count = qs("#prodCount");
    if(!tbody || !live || !count) return;

    const mode = qs("#prodFilterMode")?.value || "contains";
    const text = qs("#prodFilterText")?.value || "";
    const ftype = qs("#prodFilterType")?.value || "auto";
    const ptype = norm(qs("#prodType")?.value || "toate");

    let list = loadProducts().slice();

    if (ptype && ptype !== "toate") {
      list = list.filter(p => norm(p.productTypeStr || p.clasificare || p.productType || p.tip || p.type) === ptype);
    }
    if (text.trim()!=="") {
      list = list.filter(p => matchField(p, ftype, text, mode));
    }

    tbody.innerHTML = "";
    list.forEach(p=>{
      const id = getId(p);
      const tr = document.createElement("tr");
      tr.dataset.id = id;
      if (selectedId && selectedId===id) tr.classList.add("active");

      const um = p.um || p.MeasuringUnit || p.measuringUnit || "—";
      const name = p.name || p.denumire || "";
      const code = p.code || p.cod || "";
      const barcode = p.barcode || p.cod_bare || p.coddebare || "";
      const price = p.priceRetail ?? p.pretAmanunt ?? p.fullSalesPrice ?? p.pret ?? 0;
      const vat = p.vat ?? p.vatPercent ?? p.tva ?? 0;
      const clas = p.productTypeStr || p.clasificare || p.productType || "Marfa";
      const adaos = p.adaos ?? 0;
      const cat = p.category || p.categorie || "";
      const dep = p.department || p.departament || "";

      tr.innerHTML = `
        <td><input type="checkbox" class="prod-chk" /></td>
        <td>
          <button type="button" class="icon-btn prod-edit" title="Modifică">✎</button>
          <button type="button" class="icon-btn prod-del" title="Șterge">✖</button>
        </td>
        <td>${escapeHtml(name)}</td>
        <td>${escapeHtml(um)}</td>
        <td>${escapeHtml(code)}</td>
        <td>${escapeHtml(barcode)}</td>
        <td style="text-align:right;">${money(price)}</td>
        <td style="text-align:right;">${money(vat)}</td>
        <td>${escapeHtml(String(clas))}</td>
        <td style="text-align:right;">${money(adaos)}</td>
        <td>${escapeHtml(cat)}</td>
        <td>${escapeHtml(dep)}</td>
      `;

      tr.addEventListener("click", (e)=>{
        if((e.target && (e.target.classList.contains("prod-edit") || e.target.classList.contains("prod-del") || e.target.classList.contains("prod-chk")))) return;
        selectedId = id;
        qsa("#productsTbody tr").forEach(r=>r.classList.toggle("active", r.dataset.id===id));
        const txt = `${name || "—"} - Pret amanunt: ${money(price)}, Cota TVA: ${money(vat)}%`;
        live.textContent = txt;
        qs("#prodStock").textContent = money(p.stock ?? p.stoc ?? 0);
        qs("#prodUm").textContent = um;
      });

      tr.querySelector(".prod-del")?.addEventListener("click", (e)=>{
        e.stopPropagation();
        const all = loadProducts().slice();
        const idx = all.findIndex(x=>getId(x)===id);
        if(idx>=0){
          all.splice(idx,1);
          saveProducts(all);
          if(selectedId===id) selectedId=null;
          renderProducts();
        }
      });

      tr.querySelector(".prod-edit")?.addEventListener("click", (e)=>{
        e.stopPropagation();
        openProductEditor(p);
      });

      tbody.appendChild(tr);
    });

    count.textContent = `Produse in lista: ${list.length}`;
    if(!selectedId || !list.some(p=>getId(p)===selectedId)){
      live.textContent = "—";
      qs("#prodStock").textContent = "0.00";
      qs("#prodUm").textContent = "—";
    }
  }

  function escapeHtml(s){
    return String(s??"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
  }

  function __last(sel){ const a=document.querySelectorAll(sel); return a.length?a[a.length-1]:null; }

function openProductEditor(p){
    bindProductEditorOnce();

    const bd = __last("#productEditBackdrop");
    if(!bd) return;

    // keep reference for save
    bd._editing = p ? JSON.parse(JSON.stringify(p)) : null;

    // defaults
    const d = {
      name: p?.name || p?.denumire || "",
      category: p?.category || p?.categorie || "",
      department: p?.department || p?.departament || "",
      desc: p?.desc || p?.descriere || "",
      um: p?.um || p?.MeasuringUnit || "buc.",
      gramaj: p?.gramaj || p?.weight || "",
      um2: p?.um2 || p?.UM2 || "buc.",
      transfGramaj: !!(p?.transfGramaj),
      clasif: p?.clasif || p?.ProductTypeStr || "marfa",
      isService: !!(p?.isService || p?.servicii),
      ambSgr: p?.ambSgr || "",
      monitorMin: (p?.monitorMin!==undefined) ? !!p.monitorMin : true,
      minStock: (p?.minStock!==undefined) ? p.minStock : 0,
      stocOptim: (p?.stocOptim!==undefined) ? p.stocOptim : 0,
      stocMax: (p?.stocMax!==undefined) ? p.stocMax : 0,
      barcode: p?.barcode || p?.cod_bare || "",
      code: p?.code || p?.cod || "",
      sku: p?.sku || "",
      vat: (p?.vat!==undefined) ? p.vat : (p?.vatPercent!==undefined ? p.vatPercent : 19),
      priceRetail: (p?.priceRetail!==undefined) ? p.priceRetail : (p?.pretAmanunt!==undefined ? p.pretAmanunt : 0),
      pretFacturare: (p?.pretFacturare!==undefined) ? !!p.pretFacturare : true,
      cantar: (p?.cantar!==undefined) ? !!p.cantar : false,
    };

    qs("#peName").value = d.name;
    qs("#peCategory").value = d.category;
    qs("#peDepartment").value = d.department;
    qs("#peUM").value = d.um;
    qs("#peGramaj").value = d.gramaj;
    qs("#peUM2").value = d.um2;
    qs("#peDesc").value = d.desc;
    qs("#peTransfGramaj").checked = d.transfGramaj;
    qs("#peClasif").value = d.clasif;
    qs("#peIsService").checked = d.isService;
    qs("#peAmbSgr").value = d.ambSgr;
    qs("#peMonitorMin").checked = d.monitorMin;
    qs("#peMinStock").value = d.minStock;
    qs("#peStocOptim").value = d.stocOptim;
    qs("#peStocMax").value = d.stocMax;
    qs("#peBarcode").value = d.barcode;
    qs("#peCode").value = d.code;
    qs("#peSKU").value = d.sku;
    qs("#peVAT").value = String(d.vat);
    qs("#pePriceRetail").value = String(d.priceRetail);

    qs("#pePretFacturare").checked = d.pretFacturare;
    qs("#peCantar").checked = d.cantar;

    // tabs reset
    Array.from(bd.querySelectorAll("#prodEditTabs .tab")).forEach((b,i)=>b.classList.toggle("active", i===0));
    Array.from(bd.querySelectorAll(".tab-panel")).forEach((pnl,i)=>pnl.classList.toggle("active", i===0));

    updateProductPriceCalc();

    bd.classList.add("show");
    bd.setAttribute("aria-hidden","false");
    document.body.style.overflow="hidden";
    setTimeout(()=>{ const inp = bd.querySelector("#peName"); inp && inp.focus(); }, 30);
  }

  
  // expose for safe delegated bindings (avoid duplicate-id issues)
  try{ window.__openProductEditor = openProductEditor; }catch(e){}

function closeProductEditor(){
    const bd = __last("#productEditBackdrop");
    if(!bd) return;
    bd.classList.remove("show");
    bd.setAttribute("aria-hidden","true");
    // daca este deschis si products modal, pastram scroll lock
    const pb = qs("#productsBackdrop");
    if(pb && pb.classList.contains("show")) {
      document.body.style.overflow="hidden";
    } else {
      document.body.style.overflow="";
    }
  }

  function updateProductPriceCalc(){
    const vat = Number(qs("#peVAT")?.value || 0) || 0;
    const gross = Number(qs("#pePriceRetail")?.value || 0) || 0;
    const net = vat>0 ? (gross / (1 + vat/100)) : gross;
    qs("#pePriceNet").value = isFinite(net) ? net.toFixed(2) : "0.00";
    qs("#pePriceGross").value = isFinite(gross) ? gross.toFixed(2) : "0.00";
  }

  function generateBarcode(){
    // 13 digits demo
    const s = String(Math.floor(Math.random()*9)+1) + String(Math.floor(Math.random()*1e12)).padStart(12,"0");
    qs("#peBarcode").value = s.slice(0,13);
  }

  function saveProductFromEditor(){
    const bd = __last("#productEditBackdrop");
    const prev = bd? bd._editing : null;

    const obj = {
      ...(prev||{}),
      name: qs("#peName").value.trim(),
      category: qs("#peCategory").value.trim(),
      department: qs("#peDepartment").value.trim(),
      desc: qs("#peDesc").value.trim(),
      um: qs("#peUM").value.trim(),
      gramaj: qs("#peGramaj").value.trim(),
      um2: qs("#peUM2").value.trim(),
      transfGramaj: qs("#peTransfGramaj").checked,
      clasif: qs("#peClasif").value,
      isService: qs("#peIsService").checked,
      ambSgr: qs("#peAmbSgr").value,
      monitorMin: qs("#peMonitorMin").checked,
      minStock: Number(qs("#peMinStock").value||0)||0,
      stocOptim: Number(qs("#peStocOptim").value||0)||0,
      stocMax: Number(qs("#peStocMax").value||0)||0,
      barcode: qs("#peBarcode").value.trim(),
      code: qs("#peCode").value.trim(),
      sku: qs("#peSKU").value.trim(),
      vat: Number(qs("#peVAT").value||0)||0,
      priceRetail: Number(qs("#pePriceRetail").value||0)||0,
      pretFacturare: qs("#pePretFacturare").checked,
      cantar: qs("#peCantar").checked
    };

    if(!obj.name){
      alert("Completeaza Denumire.");
      qs("#peName")?.focus();
      return;
    }

    const list = loadProducts().slice();
    const id = getId(prev || {name: obj.name, um: obj.um});
    obj.id = id;
    const idx = list.findIndex(x=>getId(x)===id);
    if(idx>=0) list[idx] = { ...list[idx], ...obj };
    else list.unshift(obj);
    saveProducts(list);
    selectedId = id;
    renderProducts();
    closeProductEditor();
  }

  function bindProductEditorOnce(){
    if(window.__prodEditorBound) return;
    window.__prodEditorBound = true;

    const __bd = __last("#productEditBackdrop");
    const qsPE = (sel)=> __bd ? __bd.querySelector(sel) : document.querySelector(sel);
    const qsaPE = (sel)=> __bd ? Array.from(__bd.querySelectorAll(sel)) : Array.from(document.querySelectorAll(sel));

    // close
    qsPE("#btnCloseProdEdit")?.addEventListener("click", closeProductEditor);
    qsPE("#btnProdEditCancel")?.addEventListener("click", closeProductEditor);
    __last("#productEditBackdrop")?.addEventListener("click", (e)=>{ if(e.target && e.target.id==="productEditBackdrop") closeProductEditor(); });

    document.addEventListener("keydown", (e)=>{
      if(e.key==="Escape"){
        const bd = __last("#productEditBackdrop");
        if(bd && bd.classList.contains("show")){
          e.preventDefault();
          closeProductEditor();
        }
      }
    });

    // tabs
    qsPE("#prodEditTabs")?.addEventListener("click", (e)=>{
      const btn = e.target?.closest?.(".tab");
      if(!btn) return;
      const tab = btn.dataset.tab;
      qsaPE("#prodEditTabs .tab").forEach(b=>b.classList.toggle("active", b===btn));
      qsaPE(".tab-panel").forEach(pnl=>pnl.classList.toggle("active", pnl.dataset.panel===tab));
    });

    // calc
    ["peVAT","pePriceRetail"].forEach(id=>{
      qsPE("#"+id)?.addEventListener("input", updateProductPriceCalc);
      qsPE("#"+id)?.addEventListener("change", updateProductPriceCalc);
    });

    qsPE("#btnGenBarcode")?.addEventListener("click", generateBarcode);
    qsPE("#btnProdEditSave")?.addEventListener("click", saveProductFromEditor);
  }


  window.openProductsModal = function(){
    const pb = qs("#productsBackdrop");
    if(!pb) return;
    pb.classList.add("show");
    pb.setAttribute("aria-hidden","false");
    document.body.style.overflow="hidden";
    renderProducts();
    setTimeout(()=>qs("#prodFilterText")?.focus(), 50);
  };

  function closeProductsModal(){
    const pb = qs("#productsBackdrop");
    if(!pb) return;
    pb.classList.remove("show");
    pb.setAttribute("aria-hidden","true");
    document.body.style.overflow="";
  }
  qs("#btnCloseProducts")?.addEventListener("click", closeProductsModal);
  qs("#productsBackdrop")?.addEventListener("click", (e)=>{ if(e.target && e.target.id==="productsBackdrop") closeProductsModal(); });
  // PATCH v44: asiguram inchiderea ferestrei PRODUSE (X / click pe fundal / ESC)
  // fara sa atingem alte ferestre/logici
  try{ window.closeProductsModal = closeProductsModal; }catch(e){}
  (function(){
    const pb = document.getElementById("productsBackdrop");
    if(!pb) return;

    // Re-bind sigur pe butonul X (capturing ca sa nu fie blocat de alte handler-e)
    const btn = document.getElementById("btnCloseProducts");
    if(btn && !btn.dataset.prodCloseBound){
      btn.dataset.prodCloseBound = "1";
      btn.addEventListener("click", function(ev){
        try{ ev.stopPropagation(); }catch(e){}
        try{ closeProductsModal(); }catch(e){
          // fallback minim
          pb.classList.remove("show");
          pb.setAttribute("aria-hidden","true");
          document.body.style.overflow="";
        }
      }, true);
    }

    // ESC inchide doar daca PRODUSE e deschis
    if(!document.documentElement.dataset.prodEscBound){
      document.documentElement.dataset.prodEscBound = "1";
      document.addEventListener("keydown", function(ev){
        try{
          if(ev.key === "Escape" || ev.key === "Esc"){
            const p = document.getElementById("productsBackdrop");
            if(p && p.classList.contains("show")){
              closeProductsModal();
            }
          }
        }catch(e){}
      }, true);
    }
  })();


  // filter events
  ["prodFilterMode","prodFilterText","prodFilterType","prodType"].forEach(id=>{
    const el = qs("#"+id);
    if(!el) return;
    el.addEventListener("input", renderProducts);
    el.addEventListener("change", renderProducts);
  });

  // toolbar basic
  qs("#btnProdRefresh")?.addEventListener("click", renderProducts);
  qs("#btnProdNew")?.addEventListener("click", ()=>openProductEditor(null));
  // DELEGATED_PROD_NEW_OPEN (fix duplicate-id / late-bind)
  document.addEventListener("click", function(e){
    const btn = e.target && e.target.closest ? e.target.closest("button#btnProdNew") : null;
    if(!btn) return;
    const pb = btn.closest ? btn.closest("#productsBackdrop") : null;
    if(!pb || !pb.classList.contains("show")) return;
    e.preventDefault();
    e.stopPropagation();
    try { openProductEditor(null); }
    catch(err){ try{ window.openProductEditor && window.openProductEditor(null); }catch(_){ /* ignore */ } }
  }, true);
  qs("#btnProdRaport")?.addEventListener("click", ()=>{ /* demo */ });
  ["btnProdPrintList","btnProdLabels","btnProdExportLabels","btnProdPvmp","btnProdInventar","btnProdCat"].forEach(id=>{
    qs("#"+id)?.addEventListener("click", ()=>{ /* demo */ });
  });

  // tabs
  qs("#prodTabs")?.addEventListener("click", (e)=>{
    const btn = e.target?.closest?.(".tab");
    if(!btn) return;
    const tab = btn.dataset.tab;
    qsa("#prodTabs .tab").forEach(b=>b.classList.toggle("active", b===btn));
    qsa("#productsBackdrop .tabpanel").forEach(p=>p.classList.toggle("show", p.dataset.tabpanel===tab));
  });
})();
</script>

  <!-- Produse si servicii (PRODUSE) -->
  <div class="modal-backdrop" id="productsBackdrop" aria-hidden="true">
    <div class="modal products-modal" role="dialog" aria-modal="true" aria-label="Produse si servicii">
      <div class="modal-head">
        <div>
          <div class="modal-title">Produse si servicii</div>
          <div class="modal-sub">Gestiune • Lista produse (demo)</div>
        </div>
        <button class="icon-btn" type="button" id="btnCloseProducts" title="Închide">✕</button>
      </div>

      <!-- Top filter row (ca in ForIT) -->
      <div class="products-topbar">
        <div class="pt-left">
          <label class="pt-lbl">Filtru:</label>
          <select id="prodFilterMode" class="pt-sel">
            <option value="contains">contine</option>
            <option value="starts">incepe cu</option>
          </select>
          <input id="prodFilterText" class="pt-inp" type="text" placeholder="" />
          <select id="prodFilterType" class="pt-sel">
            <option value="auto">Auto</option>
            <option value="name">Denumire</option>
            <option value="barcode">Cod de bare</option>
            <option value="code">Cod produs</option>
            <option value="desc">Descriere</option>
            <option value="cat">Categorie</option>
          </select>
          <select id="prodType" class="pt-sel">
            <option value="toate">toate</option>
            <option value="nespecificat">nespecificat</option>
            <option value="materie prima">materie prima</option>
            <option value="alte materiale">alte materiale</option>
            <option value="produs finit">produs finit</option>
            <option value="marfa">marfa</option>
            <option value="obiect de inv.">obiect de inv.</option>
            <option value="ambalaje">ambalaje</option>
            <option value="semifabricate">semifabricate</option>
            <option value="reziduale">reziduale</option>
            <option value="consumabile">consumabile</option>
            <option value="servicii">servicii</option>
          </select>
        </div>

        <div class="pt-right">
          <button class="icon-btn" type="button" id="btnProdNew" title="Inregistrare produs nou">➕</button>
          <button class="icon-btn" type="button" id="btnProdPrintList" title="Tiparire lista produse">🖨</button>
          <button class="icon-btn" type="button" id="btnProdLabels" title="Tiparire etichete">🏷</button>
          <button class="icon-btn" type="button" id="btnProdExportLabels" title="Export etichete">⬇</button>
          <button class="icon-btn" type="button" id="btnProdPvmp" title="Proces verbal modificare preturi">💲</button>
          <button class="icon-btn" type="button" id="btnProdInventar" title="Proces verbal inventariere">📋</button>
          <button class="icon-btn" type="button" id="btnProdCat" title="Setare categorie/departament (multi)">🧩</button>
          <button class="icon-btn" type="button" id="btnProdRefresh" title="Actualizare lista">⟳</button>
        </div>
      </div>

      <!-- Main grid -->
      <div class="products-body">
        <div class="products-table-wrap">
          <table class="tbl products-tbl" id="productsTable">
            <thead>
              <tr>
                <th style="width:28px;"></th>
                <th style="width:44px;"></th>
                <th>Denumire</th>
                <th style="width:70px;">U.M.</th>
                <th style="width:90px;">Cod</th>
                <th style="width:150px;">Cod de bare</th>
                <th style="width:110px;">Pret Amnt.</th>
                <th style="width:70px;">TVA%</th>
                <th style="width:120px;">Clasificare</th>
                <th style="width:80px;">Adaos</th>
                <th style="width:140px;">Categorie</th>
                <th style="width:140px;">Departament</th>
              </tr>
            </thead>
            <tbody id="productsTbody"></tbody>
          </table>
        </div>

        <!-- Bottom info + tabs -->
        <div class="products-bottom">
          <div class="prod-livebar" id="prodLiveBar">—</div>

          <div class="prod-bottom-grid">
            <div class="prod-left">
              <div class="prod-pricebox" id="prodPriceBox">0.00</div>
              <div class="prod-stock">
                <div><b>Stoc curent:</b> <span id="prodStock">0.00</span></div>
                <div><b>U.M.:</b> <span id="prodUm">—</span></div>
                <button class="btn secondary" type="button" id="btnProdRaport">Raport extins…</button>
              </div>
            </div>

            <div class="prod-tabs">
              <div class="tabs" id="prodTabs">
                <button type="button" class="tab active" data-tab="hist">Istoric</button>
                <button type="button" class="tab" data-tab="pp">Evolutia pretului de achizitie</button>
                <button type="button" class="tab" data-tab="sp">Evolutia pretului de vanzare</button>
                <button type="button" class="tab" data-tab="sales">Evolutia vanzarilor</button>
                <button type="button" class="tab" data-tab="other">Alte informatii</button>
              </div>

              <div class="tabpanels">
                <div class="tabpanel show" data-tabpanel="hist">
                  <div class="prod-subhdr">
                    <div><b>Ultimul furnizor:</b> <span id="prodLastSupplier">—</span></div>
                    <div class="muted" id="prodLastSupplierInfo"></div>
                  </div>
                  <table class="tbl small">
                    <thead>
                      <tr>
                        <th style="width:110px;">Intr./iesire</th>
                        <th style="width:110px;">Data</th>
                        <th style="width:110px;">Nr. doc.</th>
                        <th style="width:120px;">Doc.</th>
                        <th>Partener</th>
                        <th style="width:90px;">Cant.</th>
                        <th style="width:90px;">Stoc</th>
                      </tr>
                    </thead>
                    <tbody id="prodHistBody">
                      <tr><td colspan="7" class="muted" style="text-align:center;padding:14px;">Istoric (demo)</td></tr>
                    </tbody>
                  </table>
                </div>

                <div class="tabpanel" data-tabpanel="pp">
                  <div class="muted" style="padding:12px;">Evolutia pretului de achizitie (demo)</div>
                </div>
                <div class="tabpanel" data-tabpanel="sp">
                  <div class="muted" style="padding:12px;">Evolutia pretului de vanzare (demo)</div>
                </div>
                <div class="tabpanel" data-tabpanel="sales">
                  <div class="muted" style="padding:12px;">Evolutia vanzarilor (demo)</div>
                </div>
                <div class="tabpanel" data-tabpanel="other">
                  <div class="muted" style="padding:12px;">Alte informatii (demo)</div>
                </div>
              </div>
            </div>
          </div>

          <div class="prod-footer">
            <div id="prodCount">Produse in lista: 0</div>
          </div>
        </div>
      </div>
    </div>
  </div>


<script>
/* PRODUSE: tooltip pe iconite (hover/long-press) - patch minimal */
(function(){
  function ensureTip(){
    var tip = document.getElementById('prodIconTip');
    if(tip) return tip;
    tip = document.createElement('div');
    tip.id = 'prodIconTip';
    tip.setAttribute('role','tooltip');
    tip.style.position = 'fixed';
    tip.style.zIndex = '99999';
    tip.style.pointerEvents = 'none';
    tip.style.padding = '6px 10px';
    tip.style.borderRadius = '10px';
    tip.style.background = 'rgba(15,15,18,.92)';
    tip.style.color = '#fff';
    tip.style.font = '700 12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial';
    tip.style.boxShadow = '0 12px 30px rgba(0,0,0,.25)';
    tip.style.opacity = '0';
    tip.style.transform = 'translateY(4px)';
    tip.style.transition = 'opacity .12s ease, transform .12s ease';
    document.body.appendChild(tip);
    return tip;
  }

  function posTip(tip, x, y){
    var pad = 14;
    var left = x + pad;
    var top  = y + pad;
    tip.style.left = left + 'px';
    tip.style.top  = top  + 'px';
  }

  function attach(){
    var backdrop = document.getElementById('productsBackdrop');
    if(!backdrop) return;

    // doar iconitele din PRODUSE (nu afectam restul aplicatiei)
    var buttons = backdrop.querySelectorAll('.pt-right .icon-btn');
    if(!buttons || !buttons.length) return;

    var tip = ensureTip();
    var hideT = null;

    function show(e, text){
      if(!text) return;
      if(hideT){ clearTimeout(hideT); hideT=null; }
      tip.textContent = text;
      tip.style.opacity = '1';
      tip.style.transform = 'translateY(0)';
      var cx = (e && (e.clientX || (e.touches && e.touches[0] && e.touches[0].clientX))) || 0;
      var cy = (e && (e.clientY || (e.touches && e.touches[0] && e.touches[0].clientY))) || 0;
      posTip(tip, cx, cy);
    }
    function move(e){
      var cx = (e && (e.clientX || (e.touches && e.touches[0] && e.touches[0].clientX))) || 0;
      var cy = (e && (e.clientY || (e.touches && e.touches[0] && e.touches[0].clientY))) || 0;
      posTip(tip, cx, cy);
    }
    function hide(){
      tip.style.opacity = '0';
      tip.style.transform = 'translateY(4px)';
    }

    buttons.forEach(function(btn){
      if(btn.dataset && btn.dataset.prodTipBound==="1"){ return; }
      if(btn.dataset){ btn.dataset.prodTipBound="1"; }
      // fallback label: aria-label -> title -> text
      var label = btn.getAttribute('aria-label') || btn.getAttribute('title') || '';
      if(label){
        btn.setAttribute('aria-label', label);
        btn.setAttribute('title', label); // pastreaza si tooltip-ul nativ
      }
      btn.addEventListener('mouseenter', function(e){ show(e, label); });
      btn.addEventListener('mousemove', move);
      btn.addEventListener('mouseleave', hide);
      btn.addEventListener('focus', function(e){ show(e, label); });
      btn.addEventListener('blur', hide);

      // Mobile: long-press/press (fara sa blocam click)
      btn.addEventListener('touchstart', function(e){
        show(e, label);
        if(hideT){ clearTimeout(hideT); }
        hideT = setTimeout(hide, 1200);
      }, {passive:true});
      btn.addEventListener('touchmove', move, {passive:true});
      btn.addEventListener('touchend', function(){ if(hideT){ clearTimeout(hideT); } hideT = setTimeout(hide, 200); }, {passive:true});
    });
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', attach);
  } else {
    attach();
  }

  // re-attach doar pana cand legam o data (evitam atasari infinite)
  var attachedOnce = false;
  function safeAttach(){
    try{
      attach();
      // daca exista toolbar-ul si am marcat macar un buton, ne oprim
      var backdrop = document.getElementById("productsBackdrop");
      if(backdrop && backdrop.querySelector(".pt-right .icon-btn[data-prod-tip-bound=\"1\"]")){
        attachedOnce = true;
      }
    }catch(e){}
    if(attachedOnce && mo){ try{ mo.disconnect(); }catch(e){} }
  }

  var mo = new MutationObserver(function(){
    if(attachedOnce) return;
    // ruleaza doar cand apare backdrop-ul (nu pe fiecare modificare de text)
    if(document.getElementById("productsBackdrop")){
      safeAttach();
    }
  });
  mo.observe(document.documentElement, {childList:true, subtree:true});
})();
</script>


<script>
/* PATCH v45: Inchidere PRODUSE (X / click fundal / ESC) - bind dupa ce exista DOM-ul.
   Nu atinge alte ferestre. */
(function(){
  function closeProductsSafe(){
    try{
      if(typeof window.closeProductsModal === "function"){
        window.closeProductsModal();
        return;
      }
    }catch(e){}
    var pb = document.getElementById("productsBackdrop");
    if(!pb) return;
    pb.classList.remove("show");
    pb.setAttribute("aria-hidden","true");
    // nu fortam overflow daca mai exista alte modale deschise
    try{
      var openModals = document.querySelectorAll(".modal-backdrop.show");
      if(!openModals || openModals.length <= 1){
        document.body.style.overflow = "";
      }
    }catch(e){ document.body.style.overflow=""; }
  }

  function bindOnce(){
    var pb = document.getElementById("productsBackdrop");
    if(!pb) return false;
    if(pb.dataset.prodCloseBound === "1") return true;
    pb.dataset.prodCloseBound = "1";

    var btn = document.getElementById("btnCloseProducts");
    if(btn){
      btn.addEventListener("click", function(ev){
        try{ ev.preventDefault(); ev.stopPropagation(); }catch(e){}
        closeProductsSafe();
      }, true);
    }

    // click pe fundal (doar daca apesi pe overlay, nu in continut)
    pb.addEventListener("click", function(ev){
      try{
        if(ev.target === pb){
          closeProductsSafe();
        }
      }catch(e){}
    }, true);

    // ESC
    if(!document.documentElement.dataset.prodEscBound){
      document.documentElement.dataset.prodEscBound = "1";
      document.addEventListener("keydown", function(ev){
        try{
          if(ev.key === "Escape" || ev.key === "Esc"){
            var p = document.getElementById("productsBackdrop");
            if(p && p.classList.contains("show")){
              closeProductsSafe();
            }
          }
        }catch(e){}
      }, true);
    }
    return true;
  }

  function boot(){
    if(bindOnce()) return;
    // asteapta DOM, apoi observa aparitia ferestrei PRODUSE
    var mo = new MutationObserver(function(){
      if(bindOnce()){
        try{ mo.disconnect(); }catch(e){}
      }
    });
    mo.observe(document.documentElement, {childList:true, subtree:true});
  }

  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", boot);
  }else{
    boot();
  }
})();
</script>

<!-- Product Editor Modal (INREGISTRARE / EDITARE PRODUS) -->
<div class="modal-backdrop" id="productEditBackdrop" aria-hidden="true">
  <div class="modal productedit-modal" role="dialog" aria-modal="true" aria-label="Proprietatile produsului sau a serviciului">
    <div class="modal-head">
      <div>
        <div class="modal-title">Proprietatile produsului sau a serviciului</div>
        <div class="modal-sub">Inregistrare / modificare produs (demo UI)</div>
      </div>
      <button class="icon-btn" type="button" id="btnCloseProdEdit" title="Închide">✕</button>
    </div>

    <div class="tabs" id="prodEditTabs" style="padding:10px 12px 0;">
      <button type="button" class="tab active" data-tab="general">General</button>
      <button type="button" class="tab" data-tab="retetar">Retetar</button>
      <button type="button" class="tab" data-tab="auxiliare">Auxiliare</button>
      <button type="button" class="tab" data-tab="disponibilitate">Disponibilitate</button>
      <button type="button" class="tab" data-tab="furnizori">Furnizori</button>
      <button type="button" class="tab" data-tab="imagini">Imagini</button>
      <button type="button" class="tab" data-tab="avansat">Avansat</button>
      <button type="button" class="tab" data-tab="attobs">Att./Obs.</button>
    </div>

    <div class="modal-body prodedit-body">
      <!-- GENERAL -->
      <div class="tab-panel active" data-panel="general">
        <div class="pe-section-title">Informatii generale despre produs/serviciu</div>

        <div class="pe-grid">
          <div class="pe-field span-6">
            <label>Denumire:</label>
            <input id="peName" type="text" />
          </div>

          <div class="pe-field span-3">
            <label>U.M.:</label>
            <input id="peUM" type="text" />
          </div>

          <div class="pe-field span-3">
            <label>Gramaj:</label>
            <input id="peGramaj" type="number" step="0.001" />
          </div>

          <div class="pe-field span-3">
            <label>U.M. 2:</label>
            <input id="peUM2" type="text" />
          </div>

          <div class="pe-field span-4">
            <label>Categoria:</label>
            <input id="peCategory" type="text" />
          </div>

          <div class="pe-field span-4">
            <label>Dept.:</label>
            <input id="peDepartment" type="text" />
          </div>

          <div class="pe-field span-12">
            <label>Descriere:</label>
            <textarea id="peDesc" rows="4"></textarea>
          </div>

          <div class="pe-field span-6 pe-inline">
            <label class="chk">
              <input id="peTransfGramaj" type="checkbox" />
              Transformare pe baza gramajului
            </label>
          </div>

          <div class="pe-field span-6"></div>

          <div class="pe-field span-4">
            <label>Clasificare:</label>
            <select id="peClasif">
              <option value="nespecificat">nespecificat</option>
              <option value="materie prima">materie prima</option>
              <option value="alte materiale">alte materiale</option>
              <option value="produs finit">produs finit</option>
              <option value="marfa" selected>marfa</option>
              <option value="obiect de inv.">obiect de inv.</option>
              <option value="ambalaje">ambalaje</option>
              <option value="semifabricate">semifabricate</option>
              <option value="reziduale">reziduale</option>
              <option value="consumabile">consumabile</option>
              <option value="servicii">servicii</option>
            </select>
          </div>

          <div class="pe-field span-3 pe-inline">
            <label class="chk">
              <input id="peIsService" type="checkbox" />
              Servicii
            </label>
          </div>

          <div class="pe-field span-5">
            <label>Amb. SGR:</label>
            <select id="peAmbSgr">
              <option value="">&lt;fara&gt;</option>
              <option value="da">da</option>
              <option value="nu">nu</option>
            </select>
          </div>

          <div class="pe-field span-4 pe-inline">
            <label class="chk">
              <input id="peMonitorMin" type="checkbox" checked />
              Monitorizare stoc minim:
            </label>
          </div>

          <div class="pe-field span-2">
            <label>&nbsp;</label>
            <input id="peMinStock" type="number" step="0.01" />
          </div>

          <div class="pe-field span-3">
            <label>Stoc optim:</label>
            <input id="peStocOptim" type="number" step="0.01" />
          </div>

          <div class="pe-field span-3">
            <label>Stoc maxim:</label>
            <input id="peStocMax" type="number" step="0.01" />
          </div>
        </div>

        <div class="pe-section-title" style="margin-top:12px;">Codurile produsului</div>

        <div class="pe-grid">
          <div class="pe-field span-6">
            <label>Cod de bare:</label>
            <div class="pe-row">
              <input id="peBarcode" type="text" />
              <button type="button" class="btn" id="btnGenBarcode" title="Genereaza cod de bare">▦</button>
              <button type="button" class="btn" id="btnPrintBarcode" title="Tipareste cod de bare">🖨️</button>
            </div>
          </div>

          <div class="pe-field span-3">
            <label>Cod:</label>
            <input id="peCode" type="text" />
          </div>

          <div class="pe-field span-3">
            <label>SKU:</label>
            <input id="peSKU" type="text" />
          </div>

          <div class="pe-field span-3">
            <label>Cota TVA:</label>
            <select id="peVAT">
              <option value="0">0</option>
              <option value="5">5</option>
              <option value="9">9</option>
              <option value="19" selected>19</option>
            </select>
          </div>

          <div class="pe-field span-3">
            <label>Pret vanzare:</label>
            <input id="pePriceRetail" type="number" step="0.01" />
          </div>

          <div class="pe-field span-3">
            <label>Fara TVA:</label>
            <input id="pePriceNet" type="text" readonly />
          </div>

          <div class="pe-field span-3">
            <label>TVA inclus:</label>
            <input id="pePriceGross" type="text" readonly />
          </div>

          <div class="pe-field span-4 pe-inline">
            <label class="chk">
              <input id="pePretFacturare" type="checkbox" checked />
              Pret facturare
            </label>
          </div>

          <div class="pe-field span-4 pe-inline">
            <label class="chk">
              <input id="peCantar" type="checkbox" />
              Cantar
            </label>
          </div>
        </div>
      </div>

      <!-- Placeholder panels -->
      <div class="tab-panel" data-panel="retetar">
        <div class="pe-empty">Retetar (demo)</div>
      </div>
      <div class="tab-panel" data-panel="auxiliare">
        <div class="pe-empty">Auxiliare (demo)</div>
      </div>
      <div class="tab-panel" data-panel="disponibilitate">
        <div class="pe-empty">Disponibilitate (demo)</div>
      </div>
      <div class="tab-panel" data-panel="furnizori">
        <div class="pe-empty">Furnizori (demo)</div>
      </div>
      <div class="tab-panel" data-panel="imagini">
        <div class="pe-empty">Imagini (demo)</div>
      </div>
      <div class="tab-panel" data-panel="avansat">
        <div class="pe-empty">Avansat (demo)</div>
      </div>
      <div class="tab-panel" data-panel="attobs">
        <div class="pe-empty">Atasamente / Observatii (demo)</div>
      </div>
    </div>

    <div class="modal-foot">
      <button class="btn" type="button" id="btnProdEditSave">Salveaza</button>
      <button class="btn secondary" type="button" id="btnProdEditCancel">Renunta</button>
    </div>
  </div>
</div>


<script>
/* PROD: delegated open for 'Inregistrare produs nou' (handles duplicate IDs + late DOM) */
(function(){
  function handler(e){
    var btn = e.target && e.target.closest ? e.target.closest('button#btnProdNew') : null;
    if(!btn) return;
    // only within Produse modal
    var bd = btn.closest ? btn.closest('.modal-backdrop') : null;
    if(!bd || bd.id !== 'productsBackdrop') return;
    if(typeof window.__openProductEditor === 'function'){
      try{ e.preventDefault(); e.stopPropagation(); }catch(_){}
      try{ window.__openProductEditor(null); }catch(err){ console.error(err); }
    }
  }
  document.addEventListener('click', handler, true);
})();
</script>


<script>
/* PATCH: PRODUSE -> Inregistrare produs nou (fallback click binding, fara alte schimbari) */
(function(){
  function fallbackOpenProductEditor(){
    var bd = document.getElementById('productEditBackdrop');
    if(!bd) return;
    bd.classList.add('show');
    bd.setAttribute('aria-hidden','false');
    document.body.style.overflow = 'hidden';
  }

  // delegated capture listener so it works even if other bindings fail
  document.addEventListener('click', function(ev){
    var t = ev.target;
    if(!t || !t.closest) return;
    var btn = t.closest('#btnProdNew');
    if(!btn) return;

    ev.preventDefault();
    ev.stopPropagation();

    try{
      if(typeof window.openProductEditor === 'function'){
        window.openProductEditor(null);
      }else if(typeof window.__openProductEditor === 'function'){
        window.__openProductEditor(null);
      }else{
        fallbackOpenProductEditor();
      }
    }catch(err){
      try{ console.error(err); }catch(_){}
      fallbackOpenProductEditor();
    }
  }, true);

  // expose existing implementation if it's in local scope (best-effort)
  try{
    if(typeof openProductEditor === 'function' && typeof window.openProductEditor !== 'function'){
      window.openProductEditor = openProductEditor;
    }
  }catch(_){}
})();
</script>

</body></html>`;

        w.document.open();

        w.document.write(doc);

        w.document.close();

        try{ w.focus(); }catch(e){}

        try{ setTimeout(()=>{ try{ w.print(); }catch(e){} }, 250); }catch(e){}

      }


      function openModal(){
        const b = qs("#companyConfigBackdrop");
        if(!b) return;
        b.classList.add("show");
        b.style.display = "flex";
        b.style.pointerEvents = "auto";
        b.setAttribute("aria-hidden","false");
        document.body.style.overflow = "hidden";
      }
      function closeModal(){
        const b = qs("#companyConfigBackdrop");
        if(!b) return;
        b.classList.remove("show");
        b.style.display = "";
        b.style.pointerEvents = "";
        b.setAttribute("aria-hidden","true");
        document.body.style.overflow = "";
      }

      function load(){
        // FIX89: load strictly from localStorage to ensure persistence
        try{
          const raw = localStorage.getItem("companyProfile") || localStorage.getItem("companyProfile_backup");
          if(raw){
            const c = JSON.parse(raw);
            if(c && typeof c === "object") return c;
          }
        }catch(e){}
        // fallback to previous helper (in-memory)
        const c2 = get("companyProfile", null);
        return (c2 && typeof c2 === "object") ? c2 : JSON.parse(JSON.stringify(DEFAULT_CO));
      }
      function save(obj){
        // FIX89: save to localStorage (and backup) + in-memory
        const raw = JSON.stringify(obj);
        try{
          localStorage.setItem("companyProfile", raw);
          localStorage.setItem("companyProfile_backup", raw);
        }catch(e){
          // ignore
        }
        set("companyProfile", obj);
      }

      function fill(){
        const c = load();
        qs("#coName").value = c.name || "";
        qs("#coEntityType").value = c.entityType || "societate";
        qs("#coGestiune").value = c.gestiune || "";
        qs("#coCui").value = c.cui || "";
        qs("#coOrc").value = c.reg || "";
        qs("#coCapital").value = (c.capital ?? "");
        qs("#coAddress").value = c.address || "";
qs("#coCountry").value = c.country || "ROMÂNIA";
        qs("#coWorkPoint").value = c.workPoint || "";
        qs("#coEmail").value = c.email || "";
        qs("#coPhone").value = c.phone || "";
        qs("#coIban").value = c.iban || "";
        qs("#coBank").value = c.bank || "";
      }

      function collect(){
        return {
          name: (qs("#coName").value||"").trim(),
          entityType: qs("#coEntityType").value,
          gestiune: (qs("#coGestiune").value||"").trim(),
          cui: (qs("#coCui").value||"").trim(),
          reg: (qs("#coOrc").value||"").trim(),
          capital: (qs("#coCapital").value||"").trim(),
          address: (qs("#coAddress").value||"").trim(),



          country: (qs("#coCountry").value||"").trim() || "ROMÂNIA",
          workPoint: (qs("#coWorkPoint").value||"").trim(),
          email: (qs("#coEmail").value||"").trim(),
          phone: (qs("#coPhone").value||"").trim(),
          iban: (qs("#coIban").value||"").trim(),
          bank: (qs("#coBank").value||"").trim(),
          updatedAt: new Date().toISOString()
        };
      }

      // Buttons
      qs("#companyConfigClose").addEventListener("click", closeModal);
      qs("#companyConfigCancel").addEventListener("click", closeModal);
      qs("#companyConfigBackdrop").addEventListener("click", (e)=>{ if(e.target===qs("#companyConfigBackdrop")) closeModal(); });

      qs("#companyConfigReset").addEventListener("click", ()=>{
        if(!confirm("Sigur vrei să resetezi datele societății?")) return;
        save(JSON.parse(JSON.stringify(DEFAULT_CO)));
        fill();
      });

      qs("#companyConfigSave").addEventListener("click", ()=>{
        const c = collect();
        if(!c.name){
          alert("Denumirea este obligatorie.");
          qs("#coName").focus();
          return;
        }
        save(c);
        // FIX89: keep fields consistent after save
        fill();
        closeModal();
      });

      // Open from SETARI -> CONFIGURARE SOCIETATE
      document.addEventListener("click", (e)=>{
        const a = e.target.closest && e.target.closest(".action");
        if(!a) return;
        const title = qs("#drawerTitle")?.textContent || "";
        const label = a.querySelector(".t")?.textContent || "";

        if(normalize(title) === normalize("SETARI") && normalize(label) === normalize("CONFIGURARE SOCIETATE")){
          // close drawer overlays to avoid double modal
          qs("#drawer")?.classList.remove("show");
          qs("#backdrop")?.classList.remove("show");
          fill();
          openModal();
          e.preventDefault(); e.stopPropagation();
        }
      }, true);

      // Expose getUnit used by PDF (override to prefer companyProfile)
      // If getUnit already exists, wrap it; else create it.
      const prevGetUnit = window.getUnit;
      window.getUnit = function(){
        const c = load();
        // prefer companyProfile; merge with previous getUnit if it returns more
        const base = (typeof prevGetUnit === "function") ? (prevGetUnit() || {}) : {};
        return {
          ...base,
          name: c.name || base.name,
          cui: c.cui || base.cui,
          reg: c.reg || base.reg,
          address: c.address || base.address,


          capital: c.capital || base.capital,
          iban: c.iban || base.iban,
          bank: c.bank || base.bank,
          workPoint: c.workPoint || base.workPoint
        };
      };

    })();
    // ===== END FIX27 =====
  </script>


  <script>
    // ===== FIX27 ADD BUTTON SETARI (inserare buton CONFIGURARE SOCIETATE) =====
    (function(){
      const qs = (s,p=document)=>p.querySelector(s);
      const qsa = (s,p=document)=>[...p.querySelectorAll(s)];
      const normalize = (s)=> (s||"").toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").trim().toUpperCase();

      const drawer = qs("#drawer");
      const list = qs("#drawerActions");
      const titleEl = qs("#drawerTitle");
      if(!drawer || !list || !titleEl) return;

      const mo = new MutationObserver(()=>{
        if(!drawer.classList.contains("show")) return;
        const title = titleEl.textContent || "";
        if(normalize(title) !== normalize("SETARI")) return;

        // if already present, skip
        const exists = qsa(".action .t", list).some(el => normalize(el.textContent) === normalize("CONFIGURARE SOCIETATE"));
        if(exists) return;

        // Create a new action button matching existing markup
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "action";
        btn.innerHTML = `
          <div class="i">
            <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 2a4 4 0 014 4v2h2a4 4 0 014 4v6a4 4 0 01-4 4H6a4 4 0 01-4-4v-6a4 4 0 014-4h2V6a4 4 0 014-4z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
              <path d="M9 8V6a3 3 0 016 0v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          <div class="t">CONFIGURARE SOCIETATE</div>
          <div class="s">Date societate (furnizor)</div>
        `;
        // Insert at top
        list.insertBefore(btn, list.firstChild);
      });

      mo.observe(drawer, {attributes:true, attributeFilter:["class"]});
    })();
    // ===== END FIX27 ADD BUTTON SETARI =====
  </script>


  <script>
    // ===== FIX28 CURS VALUTAR + ORDINE NUMERE (Factură/Proformă/Chitanță) =====
    (function(){
      const qs = (s,p=document)=>p.querySelector(s);

      // Use existing safe storage helpers if present
      const get = window.__safeJSONGet || function(key, fallback){
        try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }catch{
          const ms = window.__memStore || (window.__memStore = {});
          try{ return ms[key] ? JSON.parse(ms[key]) : fallback; }catch{ return fallback; }
        }
      };
      const set = window.__safeJSONSet || function(key, val){
        const raw = JSON.stringify(val);
        try{ localStorage.setItem(key, raw); }catch{
          const ms = window.__memStore || (window.__memStore = {});
          ms[key] = raw;
        }
      };

      function toNum(v){
        if(typeof v === "number") return isFinite(v) ? v : 0;
        const s = (v ?? "").toString().trim().replace(/\s/g,"").replace(",", ".");
        const n = parseFloat(s);
        return isFinite(n) ? n : 0;
      }

      function loadDocSettings(){
        const s = get("docSettings", null);
        if(!s || typeof s !== "object") return null;
        // ensure shape
        ["inv","pro","rcp"].forEach(k=>{
          s[k] = s[k] || {};
          if(typeof s[k].next !== "number") s[k].next = toNum(s[k].next) || 1;
        });
        return s;
      }
      function saveDocSettings(s){ set("docSettings", s); }

      function currentInvoiceKind(){
        // invoiceMode is global in the page; fallback to __openInvoiceKind
        const mode = (window.invoiceMode || "").toString().toUpperCase();
        if(mode.includes("PROFORMA")) return "pro";
        if(window.__openInvoiceKind === "pro") return "pro";
        return "inv";
      }

      // ---- Override numbering helpers to respect Setări (start number) ----
      window.getInvoiceSettings = function(){
        const s = loadDocSettings();
        const kind = currentInvoiceKind();
        const conf = s && s[kind] ? s[kind] : { serie:"FCT", next:1 };
        return { serie: conf.serie || "FCT", lastNumber: Math.max(0, (toNum(conf.next)||1) - 1) };
      };
      window.setInvoiceSettings = function(partial){
        const s = loadDocSettings();
        if(!s) return;
        const kind = currentInvoiceKind();
        s[kind] = s[kind] || {};
        if(partial && typeof partial === "object"){
          if("serie" in partial) s[kind].serie = (partial.serie || s[kind].serie || "FCT");
          // If someone sets lastNumber, we translate to next = lastNumber+1
          if("lastNumber" in partial){
            const ln = toNum(partial.lastNumber);
            s[kind].next = Math.max(1, Math.floor(ln) + 1);
          }
        }
        saveDocSettings(s);
      };
      window.nextInvoiceNumber = function(){
        const s = loadDocSettings();
        const kind = currentInvoiceKind();
        const conf = s && s[kind] ? s[kind] : { next:1 };
        return Math.max(1, Math.floor(toNum(conf.next) || 1));
      };

      // Receipt numbering uses docSettings.rcp.next (numeric)
      window.nextReceiptNumber = function(){
        const s = loadDocSettings();
        const conf = s && s.rcp ? s.rcp : { next:1 };
        return String(Math.max(1, Math.floor(toNum(conf.next) || 1)));
      };
      // Override refreshReceiptHeader to use the new nextReceiptNumber()
      window.refreshReceiptHeader = function(){
        const rcptNumber = qs("#rcptNumber");
        const rcptDate   = qs("#rcptDate");
        const rcptUnitName = qs("#rcptUnitName");
        const rcptPartnerName = qs("#rcptPartnerName");
        const rcptPartnerCui  = qs("#rcptPartnerCui");
        const rcptPartnerReg  = qs("#rcptPartnerReg");
        const rcptPartnerAddr = qs("#rcptPartnerAddr");
      let receiptSelectedPartner = null; // selected from typeahead


        if(rcptNumber) rcptNumber.value = window.nextReceiptNumber();
        if(rcptDate) rcptDate.value = new Date().toISOString().slice(0,10);

        if(typeof window.getUnit === "function"){
          const u = window.getUnit() || {};
          if(rcptUnitName) rcptUnitName.value = u.name || "";
        }
        if(typeof window.getLastPartner === "function"){
          const p = window.getLastPartner() || {};
          if(rcptPartnerName) rcptPartnerName.value = p.name || "";
          if(rcptPartnerCui)  rcptPartnerCui.value = p.cui || "";
          if(rcptPartnerReg)  rcptPartnerReg.value = p.reg || "";
          if(rcptPartnerAddr) rcptPartnerAddr.value = p.address || "";
        }
      };

      // ---- Override resetInvoiceForm to always use docSettings next number (respect start) ----
      const prevResetInvoiceForm = window.resetInvoiceForm;
      window.resetInvoiceForm = function(){
        const invSerie = qs("#invSerie");
        const invNumber= qs("#invNumber");
        const invDate  = qs("#invDate");
        const invDueDays=qs("#invDueDays");
        const invCurrency=qs("#invCurrency");
        const invFx    = qs("#invFx");
        const invVatRate=qs("#invVatRate");
        const invLines = qs("#invLines");

        const s = loadDocSettings();
        const kind = currentInvoiceKind();
        const conf = s && s[kind] ? s[kind] : { serie:"FCT", next:1 };

        if(invSerie){ invSerie.value = conf.serie || "FCT"; invSerie.readOnly = true; }
        if(invNumber){ invNumber.value = String(Math.max(1, Math.floor(toNum(conf.next)||1))); invNumber.readOnly = true; }
        if(invDate) invDate.value = new Date().toISOString().slice(0,10);
        if(invDueDays) invDueDays.value = 0;
        if(invCurrency) invCurrency.value = "RON";
        if(invFx) invFx.value = 1;
        if(invVatRate) invVatRate.value = 19;

        if(typeof window.loadClientsIntoSelect === "function") window.loadClientsIntoSelect();
        if(invLines){
          invLines.innerHTML = "";
          if(typeof window.addLineRow === "function") window.addLineRow({name:"", um:"", qty:1, price:0, cur:"RON"});
        }
        if(typeof window.recalcTotals === "function") window.recalcTotals();
      };

      // ---- Improve recalcTotals: robust parsing + ensure RON total always updated ----
      const invCurrency = qs("#invCurrency");
      const invFx = qs("#invFx");
      const invVatRate = qs("#invVatRate");
      const invLines = qs("#invLines");
      const tNet = qs("#tNet");
      const tVat = qs("#tVat");
      const tGross = qs("#tGross");
      const tRon = qs("#tRon");
      const tNetCur = qs("#tNetCur");
      const tVatCur = qs("#tVatCur");
      const tGrossCur = qs("#tGrossCur");

      const money = (n)=> {
        const x = Number(n);
        if(!isFinite(x)) return "0.00";
        return x.toFixed(2);
      };

      window.recalcTotals = function(){
        if(!invVatRate || !invFx || !invCurrency || !invLines) return;
        const vatRate = toNum(invVatRate.value) / 100.0;
        const fx = toNum(invFx.value) || 1;
        const docCur = invCurrency.value || "RON";

        let netDoc = 0;
        [...invLines.querySelectorAll("tr")].forEach(tr=>{
          const qty = toNum(tr.querySelector(".ln-qty")?.value);
          const price = toNum(tr.querySelector(".ln-price")?.value);
          const cur = tr.querySelector(".ln-cur")?.value || docCur;
          const lineNet = qty * price;

          if(cur === docCur){
            netDoc += lineNet;
          }else{
            // fx = 1 docCur in RON per 1 unit of foreign currency
            if(docCur === "RON"){
              netDoc += lineNet * fx;
            }else{
              netDoc += (lineNet / fx);
            }
          }
        });

        const vat = netDoc * vatRate;
        const gross = netDoc + vat;

        if(tNet) tNet.textContent = money(netDoc);
        if(tVat) tVat.textContent = money(vat);
        if(tGross) tGross.textContent = money(gross);

        if(tNetCur) tNetCur.textContent = docCur;
        if(tVatCur) tVatCur.textContent = docCur;
        if(tGrossCur) tGrossCur.textContent = docCur;

        const grossRon = (docCur === "RON") ? gross : (gross * fx);
        if(tRon) tRon.textContent = money(grossRon);
      };

      // Ensure totals recalc on BOTH input + change
      [invCurrency, invFx, invVatRate].filter(Boolean).forEach(el=>{
        el.addEventListener("input", window.recalcTotals, true);
        el.addEventListener("change", window.recalcTotals, true);
      });

      // Recalc when editing lines (qty/price/cur)
      if(invLines){
        invLines.addEventListener("input", (e)=>{
          const t = e.target;
          if(t && (t.classList.contains("ln-qty") || t.classList.contains("ln-price"))) window.recalcTotals();
        }, true);
        invLines.addEventListener("change", (e)=>{
          const t = e.target;
          if(t && t.classList.contains("ln-cur")) window.recalcTotals();
        }, true);
      }

      // ---- Ensure save uses the EXACT current number (from settings) and bump is correct (already in FIX25) ----
      // FIX25 already bumps docSettings on save; we only ensure the form always shows the current next number.
      // When invoice modal opens, we force reset to set current next number again if needed.
      const invoiceBackdrop = qs("#invoiceBackdrop");
      if(invoiceBackdrop){
        const mo = new MutationObserver(()=>{
          if(invoiceBackdrop.classList.contains("show")){
            // If not in edit mode, force number from settings
            if(!window.__editInvoiceId){
              try{ window.resetInvoiceForm(); }catch{}
            }
          }
        });
        mo.observe(invoiceBackdrop, {attributes:true, attributeFilter:["class"]});
      }

      const receiptBackdrop = qs("#receiptBackdrop");
      if(receiptBackdrop){
        const mo2 = new MutationObserver(()=>{
          if(receiptBackdrop.classList.contains("show")){
            if(!window.__editReceiptId){
              try{ window.refreshReceiptHeader(); }catch{}
            }
          }
        });
        mo2.observe(receiptBackdrop, {attributes:true, attributeFilter:["class"]});
      }

    })();
    // ===== END FIX28 =====
  </script>


  <script>
    // ===== FIX31 CAPTURE HANDLERS DOCUMENTE + SETARI (NU atingem restul) =====
    (function(){
      const qs = (s,p=document)=>p.querySelector(s);
      const qsa = (s,p=document)=>[...p.querySelectorAll(s)];
      const norm = (s)=> (s||"").toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").trim().toUpperCase();

      // storage (safe)
      const get = window.__safeJSONGet || function(key, fallback){
        try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }catch{
          const ms = window.__memStore || (window.__memStore = {});
          try{ return ms[key] ? JSON.parse(ms[key]) : fallback; }catch{ return fallback; }
        }
      };
      const set = window.__safeJSONSet || function(key, val){
        const raw = JSON.stringify(val);
        try{ localStorage.setItem(key, raw); }catch{
          const ms = window.__memStore || (window.__memStore = {});
          ms[key] = raw;
        }
      };

      // modal helpers (do not depend on existing)
      function openBackdrop(id){
        const b = document.getElementById(id);
        if(!b) return false;
        b.classList.add("show");
        b.style.display = "flex";
        b.style.pointerEvents = "auto";
        b.setAttribute("aria-hidden","false");
        document.body.style.overflow = "hidden";
        return true;
      }
      function closeBackdrop(id){
        const b = document.getElementById(id);
        if(!b) return;
        b.classList.remove("show");
        b.style.display = "";
        b.style.pointerEvents = "";
        b.setAttribute("aria-hidden","true");
        document.body.style.overflow = "";
      }
      function closeDrawer(){
        qs("#drawer")?.classList.remove("show");
        qs("#backdrop")?.classList.remove("show");
      }

      function money(n){
        const x = Number(n||0);
        return x.toLocaleString("ro-RO", { minimumFractionDigits:2, maximumFractionDigits:2 });
      }
      function docNo(serie, number){
        const sn = String(Number(number||0)).padStart(6,"0");
        return (serie ? (serie + "_" + sn) : sn);
      }
      function ensureStatus(list){
        return (Array.isArray(list)?list:[]).map(x=>({ ...x, status: x.status || "IN_LUCRU" }));
      }
      function loadList(key){ return ensureStatus(get(key, [])); }
      function saveList(key, list){ set(key, Array.isArray(list)?list:[]); }

      
      // docsStateFix: filtre (luna curenta / luna trecuta / toate) + paginare + scroll
      const DOCS_PAGE_SIZE = 12;
      const docsState = {
        invoices: { filter:"current", page:1 },
        proformas: { filter:"current", page:1 },
        receipts: { filter:"current", page:1 }
      };
      function ymOf(d){
        // expects YYYY-MM-DD; fallback empty
        const s = String(d||"");
        const m = s.match(/^(\d{4})-(\d{2})/);
        return m ? (m[1]+"-"+m[2]) : "";
      }
      function currentYM(){
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth()+1).padStart(2,"0");
        return y + "-" + m;
      }
      function prevYM(){
        const now = new Date();
        now.setMonth(now.getMonth()-1);
        const y = now.getFullYear();
        const m = String(now.getMonth()+1).padStart(2,"0");
        return y + "-" + m;
      }
      function applyMonthFilter(list, kind){
        const st = docsState[kind] || {filter:"all"};
        if(st.filter === "all") return list;
        const target = st.filter === "prev" ? prevYM() : currentYM();
        return list.filter(x => ymOf(x.date) === target);
      }
      function paginate(list, kind){
        const st = docsState[kind] || {page:1};
        const total = list.length;
        const pages = Math.max(1, Math.ceil(total / DOCS_PAGE_SIZE));
        if(st.page > pages) st.page = pages;
        if(st.page < 1) st.page = 1;
        const start = (st.page-1)*DOCS_PAGE_SIZE;
        const slice = list.slice(start, start + DOCS_PAGE_SIZE);
        return { slice, pages, total, page: st.page };
      }
      function setFilterUI(prefix, kind){
        const st = docsState[kind];
        const map = { current: prefix+"BtnCurrent", prev: prefix+"BtnPrev", all: prefix+"BtnAll" };
        Object.keys(map).forEach(k=>{
          const el = qs("#"+map[k]);
          if(el) el.classList.toggle("active", st.filter === k);
        });
      }
      function setPagerUI(prefix, info){
        const pi = qs("#"+prefix+"PageInfo");
        if(pi) pi.textContent = `Pagina ${info.page} / ${info.pages} • ${info.total} doc.`;
        const bp = qs("#"+prefix+"PrevPage"); const bn = qs("#"+prefix+"NextPage");
        if(bp) bp.disabled = (info.page <= 1);
        if(bn) bn.disabled = (info.page >= info.pages);
      }

      // 
      // ---- Stare documente (picker mic) ----
      function docStatusLabel(s){
        return (String(s||"IN_LUCRU").toUpperCase() === "FINALIZATA") ? "Finalizată" : "În lucru";
      }
      function ensureDocStatusMenu(){
        let el = qs("#docStatusMenu");
        if(el) return el;
        el = document.createElement("div");
        el.id = "docStatusMenu";
        el.className = "doc-status-menu";
        el.innerHTML = `
          <button class="opt" type="button" data-status="IN_LUCRU"><span>În lucru</span><span style="opacity:.6;">⏳</span></button>
          <button class="opt" type="button" data-status="FINALIZATA"><span>Finalizată</span><span style="opacity:.6;">✅</span></button>
        `;
        document.body.appendChild(el);

        // close on outside
        window.addEventListener("click", ()=>{ el.style.display="none"; }, {capture:true});
        window.addEventListener("resize", ()=>{ el.style.display="none"; });
        window.addEventListener("scroll", ()=>{ el.style.display="none"; }, true);

        // stop close when clicking inside
        el.addEventListener("click", (e)=>{ e.stopPropagation(); });
        return el;
      }
      function showDocStatusMenu(anchorEl, currentStatus, onPick){
        const menu = ensureDocStatusMenu();
        // position under anchor
        const r = anchorEl.getBoundingClientRect();
        const pad = 6;
        let left = Math.min(window.innerWidth - (menu.offsetWidth||190) - 10, Math.max(10, r.left));
        let top = Math.min(window.innerHeight - 10, r.bottom + pad);
        menu.style.left = left + "px";
        menu.style.top  = top + "px";
        menu.style.display = "block";

        // wire options (fresh each time)
        qsa(".opt", menu).forEach(btn=>{
          btn.onclick = (ev)=>{
            ev.preventDefault();
            ev.stopPropagation();
            const st = btn.getAttribute("data-status") || "IN_LUCRU";
            menu.style.display = "none";
            if(typeof onPick === "function") onPick(st);
          };
        });
      }
      function wireDocStatusPickers(scope){
        qsa(".docStatusPick", scope||document).forEach(el=>{
          if(el.__wiredDocStatus) return;
          el.__wiredDocStatus = true;
          const key = el.getAttribute("data-key");
          const id  = el.getAttribute("data-id");
          el.addEventListener("click", (e)=>{
            e.preventDefault();
            e.stopPropagation();
            const list = loadList(key);
            const obj = list.find(x=>String(x.id)===String(id));
            const current = obj?.status || el.getAttribute("data-status") || "IN_LUCRU";
            showDocStatusMenu(el, current, (picked)=>{
              if(obj){
                obj.status = picked;
                saveList(key, list);
              }
              // rerender only the current list
              if(key === "invoices") renderInvoices();
              else if(key === "proformas") renderProformas();
              else if(key === "receipts") renderReceipts();
            });
          });
        });
      }


      // --- Renderers (independente; NU depind de alte functii) ---
      function renderInvoices(){
        const tbody = qs("#docsInvRows");
        if(!tbody) return;

        const q = (qs("#docsInvSearch")?.value || "").trim().toLowerCase();
        const list = loadList("invoices");

        setFilterUI("docsInv", "invoices");

        let filtered = !q ? list : list.filter(x=>{
          const c = x.client||{};
          return docNo(x.serie,x.number).toLowerCase().includes(q) ||
                 (c.name||"").toLowerCase().includes(q) ||
                 (c.cui||"").toLowerCase().includes(q);
        });

        filtered = applyMonthFilter(filtered, "invoices");
        const pageInfo = paginate(filtered, "invoices");
        setPagerUI("docsInv", pageInfo);
        const pageRows = pageInfo.slice;

        tbody.innerHTML = "";
        if(pageRows.length === 0){
          tbody.innerHTML = '<tr><td colspan="6" style="padding:14px; color:var(--muted); font-weight:850;">Nu există facturi în filtrul ales.</td></tr>';
          return;
        }

        pageRows.sort((a,b)=>{
          const na = String(a.number||"");
          const nb = String(b.number||"");
          const cmp = na.localeCompare(nb, "ro-RO", {numeric:true});
          if(cmp !== 0) return cmp;
          return String(a.date||"").localeCompare(String(b.date||""));
        }).forEach(x=>{
          const c = x.client||{};
          const total = x.totals?.gross ?? 0;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><b>${docNo(x.serie,x.number)}</b></td>
            <td>${x.date||""}</td>
            <td>${c.name||"-"}</td>
            <td><b>${money(total)}</b> ${(x.currency||"RON")}</td>
            <td>
              <span class="doc-status-chip docStatusPick" data-key="invoices" data-id="${x.id}" data-status="${(x.status||"IN_LUCRU")}">${docStatusLabel(x.status)}</span>
            </td>
            <td>
              <div class="doc-actions">
                <button class="btn btn-ghost docEditFix31" type="button" data-kind="invoice" data-key="invoices" data-id="${x.id}">Modifică</button>
                <button class="btn btn-primary docPdfFix31" type="button" data-kind="invoice" data-key="invoices" data-id="${x.id}">PDF</button>
              </div>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }


      function renderProformas(){
        const tbody = qs("#docsProRows");
        if(!tbody) return;
        const q = (qs("#docsProSearch")?.value || "").trim().toLowerCase();
        const list = loadList("proformas");
        setFilterUI("docsPro", "proformas");
        let filtered = !q ? list : list.filter(x=>{
          const c = x.client||{};
          return docNo(x.serie,x.number).toLowerCase().includes(q) ||
                 (c.name||"").toLowerCase().includes(q) ||
                 (c.cui||"").toLowerCase().includes(q);
        });
        filtered = applyMonthFilter(filtered, "proformas");
        const pageInfo = paginate(filtered, "proformas");
        setPagerUI("docsPro", pageInfo);
        const pageRows = pageInfo.slice;
        tbody.innerHTML = "";
        if(pageRows.length === 0){
          tbody.innerHTML = '<tr><td colspan="6" style="padding:14px; color:var(--muted); font-weight:850;">Nu există proforme.</td></tr>';
          return;
        }
        pageRows.sort((a,b)=>Number(a.number||0)-Number(b.number||0)).forEach(x=>{
          const c = x.client||{};
          const total = x.totals?.gross ?? 0;
          const final = x.status === "FINALIZATA";
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><b>${docNo(x.serie,x.number)}</b></td>
            <td>${x.date||""}</td>
            <td>${c.name||"-"}</td>
            <td><b>${money(total)}</b> ${(x.currency||"RON")}</td>
            <td>
              <span class="doc-status-chip docStatusPick" data-key="proformas" data-id="${x.id}" data-status="${(x.status||"IN_LUCRU")}">${docStatusLabel(x.status)}</span>
            </td>
            <td>
              <div class="doc-actions">
                <button class="btn btn-ghost docEditFix31" type="button" data-kind="invoice" data-key="proformas" data-id="${x.id}">Modifică</button>
                <button class="btn btn-primary docPdfFix31" type="button" data-kind="invoice" data-key="proformas" data-id="${x.id}">PDF</button>
              </div>
            </td>
          `;
          tbody.appendChild(tr);
        });
        wireDocStatusPickers(tbody);
      }

      function renderReceipts(){
        const tbody = qs("#docsRcpRows");
        if(!tbody) return;

        const q = (qs("#docsRcpSearch")?.value || "").trim().toLowerCase();
        const dFrom = (qs("#docsRcpFrom")?.value || "").trim(); // YYYY-MM-DD
        const dTo   = (qs("#docsRcpTo")?.value || "").trim();

        const list = loadList("receipts");
        setFilterUI("docsRec", "receipts");

        const inRange = (d)=>{
          if(!d) return false;
          if(dFrom && d < dFrom) return false;
          if(dTo && d > dTo) return false;
          return true;
        };

        let filtered = list.filter(x=>{
          const p = x.partner||{};
          const okQ = !q ? true : (
            String(x.number||"").toLowerCase().includes(q) ||
            (p.name||"").toLowerCase().includes(q) ||
            (p.cui||"").toLowerCase().includes(q) ||
            (x.representative||"").toLowerCase().includes(q)
          );
          const okD = (!dFrom && !dTo) ? true : inRange(String(x.date||""));
          return okQ && okD;
        });

        // Filtru luna (luna în curs / luna trecută / toate)
        filtered = applyMonthFilter(filtered, "receipts");

        // Cache pentru print (lista filtrată, fără paginare)
        window.__docsRcpFilteredCache = filtered.slice();

        const pageInfo = paginate(filtered, "receipts");
        setPagerUI("docsRec", pageInfo);
        const pageRows = pageInfo.slice;

        tbody.innerHTML = "";
        if(pageRows.length === 0){
          tbody.innerHTML = '<tr><td colspan="8" style="padding:14px; color:var(--muted); font-weight:850;">Nu există chitanțe în filtrul ales.</td></tr>';
          return;
        }

        // sort numeric by number, then date
        pageRows.sort((a,b)=>{
          const na = String(a.number||"");
          const nb = String(b.number||"");
          const cmp = na.localeCompare(nb, "ro-RO", {numeric:true});
          if(cmp !== 0) return cmp;
          return String(a.date||"").localeCompare(String(b.date||""));
        }).forEach(x=>{
          const p = x.partner||{};
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><input type="checkbox" class="docsRcpSel" data-id="${x.id}"></td>
            <td><b>${x.number||""}</b></td>
            <td>${x.date||""}</td>
            <td>${p.name||"-"}</td>
            <td><b>${money(x.amount||0)}</b> ${(x.currency||"RON")}</td>
            <td style="max-width:280px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${(x.representative||"").replace(/"/g,'&quot;')}">${x.representative||"-"}</td>
            <td>
              <span class="doc-status-chip docStatusPick" data-key="receipts" data-id="${x.id}" data-status="${(x.status||"IN_LUCRU")}">${docStatusLabel(x.status)}</span>
            </td>
            <td>
              <button class="btn btn-primary docPdfFix31" type="button" data-kind="receipt" data-key="receipts" data-id="${x.id}">PDF</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
        wireDocStatusPickers(tbody);
      }


      
      function getSelectedReceiptIds(){
        return qsa(".docsRcpSel:checked").map(x=>x.getAttribute("data-id")).filter(Boolean);
      }
      function printReceiptsTable(){
        const list = window.__docsRcpFilteredCache || [];
        const selectedIds = getSelectedReceiptIds();
        const toPrint = selectedIds.length ? list.filter(r=>selectedIds.includes(String(r.id))) : list;

        if(!toPrint.length){
          alert("Nu există chitanțe de tipărit în filtrul ales.");
          return;
        }

        const u = (typeof getUnit === "function" ? getUnit() : null) || (typeof window.__safeJSONGet === "function" ? window.__safeJSONGet("companyProfile", {}) : {});
        const header = (u && u.name) ? `${u.name}${u.cui ? " | CUI: "+u.cui : ""}` : "Chitante";

        const period = (() => {
          const f = (qs("#docsRcpFrom")?.value||"");
          const t = (qs("#docsRcpTo")?.value||"");
          if(f && t) return `Perioada: ${f} - ${t}`;
          if(f) return `De la: ${f}`;
          if(t) return `Pana la: ${t}`;
          return "";
        })();

        const rows = toPrint.map(r=>{
          const p = r.partner||{};
          return `
            <tr>
              <td>${r.number||""}</td>
              <td>${r.date||""}</td>
              <td>${(p.name||"-")}</td>
              <td style="text-align:right;">${money(r.amount||0)} ${(r.currency||"RON")}</td>
              <td>${(r.representative||"-")}</td>
            </tr>
          `;
        }).join("");

        const htmlPage = `
          <html>
          <head>
            <title>Chitante - tabel</title>
            <style>
              body{ font-family: Arial, sans-serif; padding:20px; color:#000; }
              h1{ font-size:16px; margin:0 0 6px 0; }
              .sub{ color:#444; margin:0 0 12px 0; font-size:12px; }
              table{ width:100%; border-collapse:collapse; font-size:11px; }
              th,td{ border:1px solid #000; padding:6px 8px; vertical-align:top; }
              th{ background:#f2f2f2; text-align:left; }
              @media print { .no-print{ display:none; } }
            </style>
          </head>
          <body>
            <h1 style="text-align:center; margin:0 0 10px 0; letter-spacing:.6px;">CHITANTE</h1>
            <div style="font-size:12px; font-weight:700; margin:0 0 6px 0;">${header}</div>
            ${period ? `<div class="sub">${period}</div>` : ``}
            <table>
              <thead>
                <tr>
                  <th>Nr. doc.</th>
                  <th>Data doc.</th>
                  <th>A primit de la</th>
                  <th style="text-align:right;">Suma</th>
                  <th>Reprezentand</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
            <div class="no-print" style="margin-top:14px;">
              <button onclick="window.print()">Tipareste</button>
              <button onclick="window.close()">Inchide</button>
            </div>
            <script>setTimeout(()=>window.print(), 300);<\/script>
          
  <!-- Produse si servicii (PRODUSE) -->
  <div class="modal-backdrop" id="productsBackdrop" aria-hidden="true">
    <div class="modal products-modal" role="dialog" aria-modal="true" aria-label="Produse si servicii">
      <div class="modal-head">
        <div>
          <div class="modal-title">Produse si servicii</div>
          <div class="modal-sub">Gestiune • Lista produse (demo)</div>
        </div>
        <button class="icon-btn" type="button" id="btnCloseProducts" title="Închide">✕</button>
      </div>

      <!-- Top filter row (ca in ForIT) -->
      <div class="products-topbar">
        <div class="pt-left">
          <label class="pt-lbl">Filtru:</label>
          <select id="prodFilterMode" class="pt-sel">
            <option value="contains">contine</option>
            <option value="starts">incepe cu</option>
          </select>
          <input id="prodFilterText" class="pt-inp" type="text" placeholder="" />
          <select id="prodFilterType" class="pt-sel">
            <option value="auto">Auto</option>
            <option value="name">Denumire</option>
            <option value="barcode">Cod de bare</option>
            <option value="code">Cod produs</option>
            <option value="desc">Descriere</option>
            <option value="cat">Categorie</option>
          </select>
          <select id="prodType" class="pt-sel">
            <option value="toate">toate</option>
            <option value="nespecificat">nespecificat</option>
            <option value="materie prima">materie prima</option>
            <option value="alte materiale">alte materiale</option>
            <option value="produs finit">produs finit</option>
            <option value="marfa">marfa</option>
            <option value="obiect de inv.">obiect de inv.</option>
            <option value="ambalaje">ambalaje</option>
            <option value="semifabricate">semifabricate</option>
            <option value="reziduale">reziduale</option>
            <option value="consumabile">consumabile</option>
            <option value="servicii">servicii</option>
          </select>
        </div>

        <div class="pt-right">
          <button class="icon-btn" type="button" id="btnProdNew" title="Inregistrare produs nou">➕</button>
          <button class="icon-btn" type="button" id="btnProdPrintList" title="Tiparire lista produse">🖨</button>
          <button class="icon-btn" type="button" id="btnProdLabels" title="Tiparire etichete">🏷</button>
          <button class="icon-btn" type="button" id="btnProdExportLabels" title="Export etichete">⬇</button>
          <button class="icon-btn" type="button" id="btnProdPvmp" title="Proces verbal modificare preturi">💲</button>
          <button class="icon-btn" type="button" id="btnProdInventar" title="Proces verbal inventariere">📋</button>
          <button class="icon-btn" type="button" id="btnProdCat" title="Setare categorie/departament (multi)">🧩</button>
          <button class="icon-btn" type="button" id="btnProdRefresh" title="Actualizare lista">⟳</button>
        </div>
      </div>

      <!-- Main grid -->
      <div class="products-body">
        <div class="products-table-wrap">
          <table class="tbl products-tbl" id="productsTable">
            <thead>
              <tr>
                <th style="width:28px;"></th>
                <th style="width:44px;"></th>
                <th>Denumire</th>
                <th style="width:70px;">U.M.</th>
                <th style="width:90px;">Cod</th>
                <th style="width:150px;">Cod de bare</th>
                <th style="width:110px;">Pret Amnt.</th>
                <th style="width:70px;">TVA%</th>
                <th style="width:120px;">Clasificare</th>
                <th style="width:80px;">Adaos</th>
                <th style="width:140px;">Categorie</th>
                <th style="width:140px;">Departament</th>
              </tr>
            </thead>
            <tbody id="productsTbody"></tbody>
          </table>
        </div>

        <!-- Bottom info + tabs -->
        <div class="products-bottom">
          <div class="prod-livebar" id="prodLiveBar">—</div>

          <div class="prod-bottom-grid">
            <div class="prod-left">
              <div class="prod-pricebox" id="prodPriceBox">0.00</div>
              <div class="prod-stock">
                <div><b>Stoc curent:</b> <span id="prodStock">0.00</span></div>
                <div><b>U.M.:</b> <span id="prodUm">—</span></div>
                <button class="btn secondary" type="button" id="btnProdRaport">Raport extins…</button>
              </div>
            </div>

            <div class="prod-tabs">
              <div class="tabs" id="prodTabs">
                <button type="button" class="tab active" data-tab="hist">Istoric</button>
                <button type="button" class="tab" data-tab="pp">Evolutia pretului de achizitie</button>
                <button type="button" class="tab" data-tab="sp">Evolutia pretului de vanzare</button>
                <button type="button" class="tab" data-tab="sales">Evolutia vanzarilor</button>
                <button type="button" class="tab" data-tab="other">Alte informatii</button>
              </div>

              <div class="tabpanels">
                <div class="tabpanel show" data-tabpanel="hist">
                  <div class="prod-subhdr">
                    <div><b>Ultimul furnizor:</b> <span id="prodLastSupplier">—</span></div>
                    <div class="muted" id="prodLastSupplierInfo"></div>
                  </div>
                  <table class="tbl small">
                    <thead>
                      <tr>
                        <th style="width:110px;">Intr./iesire</th>
                        <th style="width:110px;">Data</th>
                        <th style="width:110px;">Nr. doc.</th>
                        <th style="width:120px;">Doc.</th>
                        <th>Partener</th>
                        <th style="width:90px;">Cant.</th>
                        <th style="width:90px;">Stoc</th>
                      </tr>
                    </thead>
                    <tbody id="prodHistBody">
                      <tr><td colspan="7" class="muted" style="text-align:center;padding:14px;">Istoric (demo)</td></tr>
                    </tbody>
                  </table>
                </div>

                <div class="tabpanel" data-tabpanel="pp">
                  <div class="muted" style="padding:12px;">Evolutia pretului de achizitie (demo)</div>
                </div>
                <div class="tabpanel" data-tabpanel="sp">
                  <div class="muted" style="padding:12px;">Evolutia pretului de vanzare (demo)</div>
                </div>
                <div class="tabpanel" data-tabpanel="sales">
                  <div class="muted" style="padding:12px;">Evolutia vanzarilor (demo)</div>
                </div>
                <div class="tabpanel" data-tabpanel="other">
                  <div class="muted" style="padding:12px;">Alte informatii (demo)</div>
                </div>
              </div>
            </div>
          </div>

          <div class="prod-footer">
            <div id="prodCount">Produse in lista: 0</div>
          </div>
        </div>
      </div>
    </div>
  </div>


<script>
/* PRODUSE: tooltip pe iconite (hover/long-press) - patch minimal */
(function(){
  function ensureTip(){
    var tip = document.getElementById('prodIconTip');
    if(tip) return tip;
    tip = document.createElement('div');
    tip.id = 'prodIconTip';
    tip.setAttribute('role','tooltip');
    tip.style.position = 'fixed';
    tip.style.zIndex = '99999';
    tip.style.pointerEvents = 'none';
    tip.style.padding = '6px 10px';
    tip.style.borderRadius = '10px';
    tip.style.background = 'rgba(15,15,18,.92)';
    tip.style.color = '#fff';
    tip.style.font = '700 12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial';
    tip.style.boxShadow = '0 12px 30px rgba(0,0,0,.25)';
    tip.style.opacity = '0';
    tip.style.transform = 'translateY(4px)';
    tip.style.transition = 'opacity .12s ease, transform .12s ease';
    document.body.appendChild(tip);
    return tip;
  }

  function posTip(tip, x, y){
    var pad = 14;
    var left = x + pad;
    var top  = y + pad;
    tip.style.left = left + 'px';
    tip.style.top  = top  + 'px';
  }

  function attach(){
    var backdrop = document.getElementById('productsBackdrop');
    if(!backdrop) return;

    // doar iconitele din PRODUSE (nu afectam restul aplicatiei)
    var buttons = backdrop.querySelectorAll('.pt-right .icon-btn');
    if(!buttons || !buttons.length) return;

    var tip = ensureTip();
    var hideT = null;

    function show(e, text){
      if(!text) return;
      if(hideT){ clearTimeout(hideT); hideT=null; }
      tip.textContent = text;
      tip.style.opacity = '1';
      tip.style.transform = 'translateY(0)';
      var cx = (e && (e.clientX || (e.touches && e.touches[0] && e.touches[0].clientX))) || 0;
      var cy = (e && (e.clientY || (e.touches && e.touches[0] && e.touches[0].clientY))) || 0;
      posTip(tip, cx, cy);
    }
    function move(e){
      var cx = (e && (e.clientX || (e.touches && e.touches[0] && e.touches[0].clientX))) || 0;
      var cy = (e && (e.clientY || (e.touches && e.touches[0] && e.touches[0].clientY))) || 0;
      posTip(tip, cx, cy);
    }
    function hide(){
      tip.style.opacity = '0';
      tip.style.transform = 'translateY(4px)';
    }

    buttons.forEach(function(btn){
      // fallback label: aria-label -> title -> text
      var label = btn.getAttribute('aria-label') || btn.getAttribute('title') || '';
      if(label){
        btn.setAttribute('aria-label', label);
        btn.setAttribute('title', label); // pastreaza si tooltip-ul nativ
      }
      btn.addEventListener('mouseenter', function(e){ show(e, label); });
      btn.addEventListener('mousemove', move);
      btn.addEventListener('mouseleave', hide);
      btn.addEventListener('focus', function(e){ show(e, label); });
      btn.addEventListener('blur', hide);

      // Mobile: long-press/press (fara sa blocam click)
      btn.addEventListener('touchstart', function(e){
        show(e, label);
        if(hideT){ clearTimeout(hideT); }
        hideT = setTimeout(hide, 1200);
      }, {passive:true});
      btn.addEventListener('touchmove', move, {passive:true});
      btn.addEventListener('touchend', function(){ if(hideT){ clearTimeout(hideT); } hideT = setTimeout(hide, 200); }, {passive:true});
    });
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', attach);
  } else {
    attach();
  }

  // re-attach doar pana cand legam o data (evitam atasari infinite)
  var attachedOnce = false;
  function safeAttach(){
    try{
      attach();
      // daca exista toolbar-ul si am marcat macar un buton, ne oprim
      var backdrop = document.getElementById("productsBackdrop");
      if(backdrop && backdrop.querySelector(".pt-right .icon-btn[data-prod-tip-bound=\"1\"]")){
        attachedOnce = true;
      }
    }catch(e){}
    if(attachedOnce && mo){ try{ mo.disconnect(); }catch(e){} }
  }

  var mo = new MutationObserver(function(){
    if(attachedOnce) return;
    // ruleaza doar cand apare backdrop-ul (nu pe fiecare modificare de text)
    if(document.getElementById("productsBackdrop")){
      safeAttach();
    }
  });
  mo.observe(document.documentElement, {childList:true, subtree:true});
})();
</script>

<!-- Product Editor Modal (INREGISTRARE / EDITARE PRODUS) -->
<div class="modal-backdrop" id="productEditBackdrop" aria-hidden="true">
  <div class="modal productedit-modal" role="dialog" aria-modal="true" aria-label="Proprietatile produsului sau a serviciului">
    <div class="modal-head">
      <div>
        <div class="modal-title">Proprietatile produsului sau a serviciului</div>
        <div class="modal-sub">Inregistrare / modificare produs (demo UI)</div>
      </div>
      <button class="icon-btn" type="button" id="btnCloseProdEdit" title="Închide">✕</button>
    </div>

    <div class="tabs" id="prodEditTabs" style="padding:10px 12px 0;">
      <button type="button" class="tab active" data-tab="general">General</button>
      <button type="button" class="tab" data-tab="retetar">Retetar</button>
      <button type="button" class="tab" data-tab="auxiliare">Auxiliare</button>
      <button type="button" class="tab" data-tab="disponibilitate">Disponibilitate</button>
      <button type="button" class="tab" data-tab="furnizori">Furnizori</button>
      <button type="button" class="tab" data-tab="imagini">Imagini</button>
      <button type="button" class="tab" data-tab="avansat">Avansat</button>
      <button type="button" class="tab" data-tab="attobs">Att./Obs.</button>
    </div>

    <div class="modal-body prodedit-body">
      <!-- GENERAL -->
      <div class="tab-panel active" data-panel="general">
        <div class="pe-section-title">Informatii generale despre produs/serviciu</div>

        <div class="pe-grid">
          <div class="pe-field span-6">
            <label>Denumire:</label>
            <input id="peName" type="text" />
          </div>

          <div class="pe-field span-3">
            <label>U.M.:</label>
            <input id="peUM" type="text" />
          </div>

          <div class="pe-field span-3">
            <label>Gramaj:</label>
            <input id="peGramaj" type="number" step="0.001" />
          </div>

          <div class="pe-field span-3">
            <label>U.M. 2:</label>
            <input id="peUM2" type="text" />
          </div>

          <div class="pe-field span-4">
            <label>Categoria:</label>
            <input id="peCategory" type="text" />
          </div>

          <div class="pe-field span-4">
            <label>Dept.:</label>
            <input id="peDepartment" type="text" />
          </div>

          <div class="pe-field span-12">
            <label>Descriere:</label>
            <textarea id="peDesc" rows="4"></textarea>
          </div>

          <div class="pe-field span-6 pe-inline">
            <label class="chk">
              <input id="peTransfGramaj" type="checkbox" />
              Transformare pe baza gramajului
            </label>
          </div>

          <div class="pe-field span-6"></div>

          <div class="pe-field span-4">
            <label>Clasificare:</label>
            <select id="peClasif">
              <option value="nespecificat">nespecificat</option>
              <option value="materie prima">materie prima</option>
              <option value="alte materiale">alte materiale</option>
              <option value="produs finit">produs finit</option>
              <option value="marfa" selected>marfa</option>
              <option value="obiect de inv.">obiect de inv.</option>
              <option value="ambalaje">ambalaje</option>
              <option value="semifabricate">semifabricate</option>
              <option value="reziduale">reziduale</option>
              <option value="consumabile">consumabile</option>
              <option value="servicii">servicii</option>
            </select>
          </div>

          <div class="pe-field span-3 pe-inline">
            <label class="chk">
              <input id="peIsService" type="checkbox" />
              Servicii
            </label>
          </div>

          <div class="pe-field span-5">
            <label>Amb. SGR:</label>
            <select id="peAmbSgr">
              <option value="">&lt;fara&gt;</option>
              <option value="da">da</option>
              <option value="nu">nu</option>
            </select>
          </div>

          <div class="pe-field span-4 pe-inline">
            <label class="chk">
              <input id="peMonitorMin" type="checkbox" checked />
              Monitorizare stoc minim:
            </label>
          </div>

          <div class="pe-field span-2">
            <label>&nbsp;</label>
            <input id="peMinStock" type="number" step="0.01" />
          </div>

          <div class="pe-field span-3">
            <label>Stoc optim:</label>
            <input id="peStocOptim" type="number" step="0.01" />
          </div>

          <div class="pe-field span-3">
            <label>Stoc maxim:</label>
            <input id="peStocMax" type="number" step="0.01" />
          </div>
        </div>

        <div class="pe-section-title" style="margin-top:12px;">Codurile produsului</div>

        <div class="pe-grid">
          <div class="pe-field span-6">
            <label>Cod de bare:</label>
            <div class="pe-row">
              <input id="peBarcode" type="text" />
              <button type="button" class="btn" id="btnGenBarcode" title="Genereaza cod de bare">▦</button>
              <button type="button" class="btn" id="btnPrintBarcode" title="Tipareste cod de bare">🖨️</button>
            </div>
          </div>

          <div class="pe-field span-3">
            <label>Cod:</label>
            <input id="peCode" type="text" />
          </div>

          <div class="pe-field span-3">
            <label>SKU:</label>
            <input id="peSKU" type="text" />
          </div>

          <div class="pe-field span-3">
            <label>Cota TVA:</label>
            <select id="peVAT">
              <option value="0">0</option>
              <option value="5">5</option>
              <option value="9">9</option>
              <option value="19" selected>19</option>
            </select>
          </div>

          <div class="pe-field span-3">
            <label>Pret vanzare:</label>
            <input id="pePriceRetail" type="number" step="0.01" />
          </div>

          <div class="pe-field span-3">
            <label>Fara TVA:</label>
            <input id="pePriceNet" type="text" readonly />
          </div>

          <div class="pe-field span-3">
            <label>TVA inclus:</label>
            <input id="pePriceGross" type="text" readonly />
          </div>

          <div class="pe-field span-4 pe-inline">
            <label class="chk">
              <input id="pePretFacturare" type="checkbox" checked />
              Pret facturare
            </label>
          </div>

          <div class="pe-field span-4 pe-inline">
            <label class="chk">
              <input id="peCantar" type="checkbox" />
              Cantar
            </label>
          </div>
        </div>
      </div>

      <!-- Placeholder panels -->
      <div class="tab-panel" data-panel="retetar">
        <div class="pe-empty">Retetar (demo)</div>
      </div>
      <div class="tab-panel" data-panel="auxiliare">
        <div class="pe-empty">Auxiliare (demo)</div>
      </div>
      <div class="tab-panel" data-panel="disponibilitate">
        <div class="pe-empty">Disponibilitate (demo)</div>
      </div>
      <div class="tab-panel" data-panel="furnizori">
        <div class="pe-empty">Furnizori (demo)</div>
      </div>
      <div class="tab-panel" data-panel="imagini">
        <div class="pe-empty">Imagini (demo)</div>
      </div>
      <div class="tab-panel" data-panel="avansat">
        <div class="pe-empty">Avansat (demo)</div>
      </div>
      <div class="tab-panel" data-panel="attobs">
        <div class="pe-empty">Atasamente / Observatii (demo)</div>
      </div>
    </div>

    <div class="modal-foot">
      <button class="btn" type="button" id="btnProdEditSave">Salveaza</button>
      <button class="btn secondary" type="button" id="btnProdEditCancel">Renunta</button>
    </div>
  </div>
</div>


<script>
/* PROD: delegated open for 'Inregistrare produs nou' (handles duplicate IDs + late DOM) */
(function(){
  function handler(e){
    var btn = e.target && e.target.closest ? e.target.closest('button#btnProdNew') : null;
    if(!btn) return;
    // only within Produse modal
    var bd = btn.closest ? btn.closest('.modal-backdrop') : null;
    if(!bd || bd.id !== 'productsBackdrop') return;
    if(typeof window.__openProductEditor === 'function'){
      try{ e.preventDefault(); e.stopPropagation(); }catch(_){}
      try{ window.__openProductEditor(null); }catch(err){ console.error(err); }
    }
  }
  document.addEventListener('click', handler, true);
})();
</script>


<script>
/* PATCH: PRODUSE -> Inregistrare produs nou (fallback click binding, fara alte schimbari) */
(function(){
  function fallbackOpenProductEditor(){
    var bd = document.getElementById('productEditBackdrop');
    if(!bd) return;
    bd.classList.add('show');
    bd.setAttribute('aria-hidden','false');
    document.body.style.overflow = 'hidden';
  }

  // delegated capture listener so it works even if other bindings fail
  document.addEventListener('click', function(ev){
    var t = ev.target;
    if(!t || !t.closest) return;
    var btn = t.closest('#btnProdNew');
    if(!btn) return;

    ev.preventDefault();
    ev.stopPropagation();

    try{
      if(typeof window.openProductEditor === 'function'){
        window.openProductEditor(null);
      }else if(typeof window.__openProductEditor === 'function'){
        window.__openProductEditor(null);
      }else{
        fallbackOpenProductEditor();
      }
    }catch(err){
      try{ console.error(err); }catch(_){}
      fallbackOpenProductEditor();
    }
  }, true);

  // expose existing implementation if it's in local scope (best-effort)
  try{
    if(typeof openProductEditor === 'function' && typeof window.openProductEditor !== 'function'){
      window.openProductEditor = openProductEditor;
    }
  }catch(_){}
})();
</script>

</body></html>
        `;

        const w = window.open("", "_blank");
        if(!w){
          alert("Popup blocat. Permite pop-up pentru tiparire.");
          return;
        }
        w.document.open();
        w.document.write(htmlPage);
        w.document.close();
        w.focus();
      }

      // Wire controls for receipts modal
      (function wireReceiptsControls(){
        const refreshBtn = qs("#docsRcpRefresh");
        const printBtn = qs("#docsRcpPrintTable");
        const selAll = qs("#docsRcpSelectAll");
        const selAllHead = qs("#docsRcpAllHead");

        const rer = ()=>renderReceipts();

        refreshBtn?.addEventListener("click", rer);
        qs("#docsRcpSearch")?.addEventListener("input", rer);
        qs("#docsRcpFrom")?.addEventListener("change", rer);
        qs("#docsRcpTo")?.addEventListener("change", rer);

        const setAll = (checked)=>{
          qsa(".docsRcpSel").forEach(x=>{ x.checked = checked; });
          if(selAll) selAll.checked = checked;
          if(selAllHead) selAllHead.checked = checked;
        };

        selAll?.addEventListener("change", ()=>setAll(selAll.checked));
        selAllHead?.addEventListener("change", ()=>setAll(selAllHead.checked));

        // When list rerenders, keep header checkbox off by default
        document.addEventListener("click", (e)=>{
          if(e.target && e.target.id === "docsReceiptsClose") setAll(false);
        });

        printBtn?.addEventListener("click", printReceiptsTable);
      })();

      // --- Inject "CONFIGURARE SOCIETATE" button inside SETARI drawer every time --- "CONFIGURARE SOCIETATE" button inside SETARI drawer every time ---
      function injectCompanyBtn(){
        const titleEl = qs("#drawerTitle");
        const title = titleEl ? titleEl.textContent : "";
        if(norm(title) !== norm("SETARI")) return;

        const container = qs("#drawerGrid") || qs("#drawerActions") || qs("#drawerActions, #drawerGrid");
        if(!container) return;

        const exists = qsa(".action .t", container).some(el => norm(el.textContent) === norm("CONFIGURARE SOCIETATE"));
        if(exists) return;

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "action";
        btn.innerHTML = `
          <div class="i"></div>
          <div class="t">CONFIGURARE SOCIETATE</div>
          <div class="s">Date societate (furnizor)</div>
        `;
        container.insertBefore(btn, container.firstChild);
      }

      const drawer = qs("#drawer");
      if(drawer){
        const mo = new MutationObserver(()=>{ if(drawer.classList.contains("show")) injectCompanyBtn(); });
        mo.observe(drawer, {attributes:true, attributeFilter:["class"]});
      }

      // --- CAPTURE click handler: intercept placeholder alert and open our modals ---
      document.addEventListener("click", (e)=>{
        const btn = e.target.closest && e.target.closest("button.action, .action");
        if(!btn) return;

        const title = qs("#drawerTitle")?.textContent || "";
        const label = btn.querySelector(".t") ? btn.querySelector(".t").textContent : btn.textContent;

        const T = norm(title);
        const L = norm(label);

        // SETARI -> CONFIGURARE SOCIETATE
        if(T === norm("SETARI") && L === norm("CONFIGURARE SOCIETATE")){
          e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
          closeDrawer();
          // fill fields if handler exists
          if(typeof window.__openCompanyConfig === "function"){
            window.__openCompanyConfig();
          }else{
            // fallback: open modal and try to fill from companyProfile if fields exist
            openBackdrop("companyConfigBackdrop");
            try{
              const c = get("companyProfile", {}) || {};
              if(qs("#coName")) qs("#coName").value = c.name || "";
              if(qs("#coCui")) qs("#coCui").value = c.cui || "";
              if(qs("#coOrc")) qs("#coOrc").value = c.reg || "";
              if(qs("#coAddress")) qs("#coAddress").value = c.address || "";
              if((qs("#coCounty")||null)) (qs("#coCounty")||null).value = c.county || "";
              if(qs("#coCapital")) qs("#coCapital").value = c.capital || "";
              if(qs("#coIban")) qs("#coIban").value = c.iban || "";
              if(qs("#coBank")) qs("#coBank").value = c.bank || "";
            }catch{}
          }
          return;
        }

        // DOCUMENTE -> FACTURI / PROFORME / CHITANTE
        if(T === norm("DOCUMENTE")){
          if(L === norm("FACTURI")){
            e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
            closeDrawer();
            openBackdrop("docsInvoicesBackdrop");
            docsState.invoices.page = 1;
            renderInvoices();
            return;
          }
          if(L === norm("FACTURI PROFORME")){
            e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
            closeDrawer();
            openBackdrop("docsProformasBackdrop");
            docsState.proformas.page = 1;
            renderProformas();
            return;
          }
          if(L === norm("CHITANTE")){
            e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
            closeDrawer();
            openBackdrop("docsReceiptsBackdrop");
            docsState.receipts.page = 1;
            renderReceipts();
            return;
          }
        }
      }, true);

      // --- Wire search/refresh controls (if exist) ---

      // docsPagerFix: filtre + paginare pentru ferestrele Documente
      function wireDocsControls(kind, prefix, renderFn){
        // filter buttons
        const fCur = qs("#"+prefix+"BtnCurrent");
        const fPrev = qs("#"+prefix+"BtnPrev");
        const fAll = qs("#"+prefix+"BtnAll");
        [fCur,fPrev,fAll].forEach(btn=>{
          if(!btn) return;
          btn.addEventListener("click", ()=>{
            const f = btn.getAttribute("data-filter") || "all";
            docsState[kind].filter = f;
            docsState[kind].page = 1;
            renderFn();
          });
        });
        // pager
        const pPrev = qs("#"+prefix+"PrevPage");
        const pNext = qs("#"+prefix+"NextPage");
        if(pPrev) pPrev.addEventListener("click", ()=>{
          docsState[kind].page = Math.max(1, (docsState[kind].page||1) - 1);
          renderFn();
        });
        if(pNext) pNext.addEventListener("click", ()=>{
          docsState[kind].page = (docsState[kind].page||1) + 1;
          renderFn();
        });
      }

      wireDocsControls("invoices", "docsInv", renderInvoices);
      wireDocsControls("proformas", "docsPro", renderProformas);
      wireDocsControls("receipts", "docsRec", renderReceipts);


      qs("#docsInvSearch")?.addEventListener("input", renderInvoices, true);
      qs("#docsProSearch")?.addEventListener("input", renderProformas, true);
      qs("#docsRcpSearch")?.addEventListener("input", renderReceipts, true);
      qs("#docsInvRefresh")?.addEventListener("click", renderInvoices, true);
      qs("#docsProRefresh")?.addEventListener("click", renderProformas, true);
      qs("#docsRcpRefresh")?.addEventListener("click", renderReceipts, true);

      // --- Status toggles ---
      document.addEventListener("change", (e)=>{
        const cb = e.target;
        if(!(cb && cb.classList && cb.classList.contains("docStatusFix31"))) return;
        const key = cb.getAttribute("data-key");
        const id  = cb.getAttribute("data-id");
        const list = loadList(key);
        const idx = list.findIndex(x => String(x.id) === String(id));
        if(idx >= 0){
          list[idx].status = cb.checked ? "FINALIZATA" : "IN_LUCRU";
          saveList(key, list);
        }
        if(key === "invoices") renderInvoices();
        if(key === "proformas") renderProformas();
        if(key === "receipts") renderReceipts();
      }, true);

      // --- Edit/PDF: reuse existing handlers if already present ---
      document.addEventListener("click", (e)=>{
        const b = e.target.closest && e.target.closest(".docEditFix31, .docPdfFix31");
        if(!b) return;

        const key = b.getAttribute("data-key");
        const id  = b.getAttribute("data-id");
        const kind= b.getAttribute("data-kind");
        const list = loadList(key);
        const rec = list.find(x => String(x.id) === String(id));
        if(!rec) return;

        if(b.classList.contains("docEditFix31")){
          e.preventDefault(); e.stopPropagation();
          // close list modal
          if(key==="invoices") closeBackdrop("docsInvoicesBackdrop");
          if(key==="proformas") closeBackdrop("docsProformasBackdrop");
          if(key==="receipts") closeBackdrop("docsReceiptsBackdrop");

          if(kind === "invoice"){
            // use existing edit flow from FIX25 if present
            if(typeof window.openInvoiceModal === "function"){
              window.openInvoiceModal(key==="proformas" ? "FACTURA PROFORMA" : "FACTURA");
            }else{
              openBackdrop("invoiceBackdrop");
            }
            // fill
            qs("#invSerie") && (qs("#invSerie").value = rec.serie || "");
            qs("#invNumber") && (qs("#invNumber").value = rec.number || "");
            qs("#invDate") && (qs("#invDate").value = rec.date || "");
            qs("#invDueDays") && (qs("#invDueDays").value = rec.dueDays ?? 0);
            qs("#invCurrency") && (qs("#invCurrency").value = rec.currency || "RON");
            qs("#invFx") && (qs("#invFx").value = rec.fx ?? 1);
            qs("#invVatRate") && (qs("#invVatRate").value = rec.vatRate ?? 0);

            // client option
            const sel = qs("#invClient");
            const c = rec.client || null;
            if(sel && c && c.id){
              let opt = [...sel.options].find(o => o.value === c.id);
              if(!opt){
                opt = document.createElement("option");
                opt.value = c.id;
                opt.textContent = c.name || ("Client " + c.id);
                sel.appendChild(opt);
              }
              sel.value = c.id;
            }

            // lines
            const tbody = qs("#invLines");
            if(tbody){
              tbody.innerHTML = "";
              if(typeof window.addLineRow === "function"){
                (rec.lines||[]).forEach(l=> window.addLineRow(l));
              }
            }
            try{ window.recalcTotals && window.recalcTotals(); }catch{}
            window.__editInvoiceId = rec.id;
            window.__editDocKey = key;
          }else{
            if(typeof window.openReceiptModal === "function") window.openReceiptModal();
            else openBackdrop("receiptBackdrop");

            qs("#rcptNumber") && (qs("#rcptNumber").value = rec.number || "");
            qs("#rcptDate") && (qs("#rcptDate").value = rec.date || "");
            qs("#rcptAmount") && (qs("#rcptAmount").value = rec.amount ?? 0);
            qs("#rcptCurrency") && (qs("#rcptCurrency").value = rec.currency || "RON");
            qs("#rcptFx") && (qs("#rcptFx").value = rec.fx ?? 1);
            qs("#rcptAmountWords") && (qs("#rcptAmountWords").value = rec.amountWords || "");
            qs("#rcptRepresentative") && (qs("#rcptRepresentative").value = rec.representative || "");
            qs("#rcptHasVoucher") && (qs("#rcptHasVoucher").checked = !!rec.voucherId);
            qs("#rcptVoucher") && (qs("#rcptVoucher").value = rec.voucherId || "");

            const p = rec.partner || {};
            qs("#rcptPartnerName") && (qs("#rcptPartnerName").value = p.name || "");
            qs("#rcptPartnerCui") && (qs("#rcptPartnerCui").value = p.cui || "");
            qs("#rcptPartnerReg") && (qs("#rcptPartnerReg").value = p.reg || "");
            qs("#rcptPartnerAddr") && (qs("#rcptPartnerAddr").value = p.address || "");

            window.__editReceiptId = rec.id;
            window.__editDocKey = "receipts";
          }
          return;
        }

        if(b.classList.contains("docPdfFix31")){
          e.preventDefault(); e.stopPropagation();
          // use existing pdf functions if present
          if(kind === "invoice" && typeof window.pdfInvoice === "function") return window.pdfInvoice(rec);
          if(kind === "receipt" && typeof window.pdfReceipt === "function") return window.pdfReceipt(rec);
          // fallback: alert
          alert("PDF: funcțiile nu sunt disponibile în acest build.");
          return;
        }
      }, true);

    })();
    // ===== END FIX31 =====
  </script>


  <!-- ===== FIX32 PDF LIBS (doar pentru descarcare PDF) ===== -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>


  <script>
    // ===== FIX32 INCHIDERE MODALE + PDF DOWNLOAD + SALVARE RON =====
    (function(){
      const qs = (s,p=document)=>p.querySelector(s);
      const qsa = (s,p=document)=>[...p.querySelectorAll(s)];

      function closeBackdrop(id){
        const b = document.getElementById(id);
        if(!b) return;
        b.classList.remove("show");
        b.style.display = "";
        b.style.pointerEvents = "";
        b.setAttribute("aria-hidden","true");
        document.body.style.overflow = "";
      }

      function wireClose(backdropId, closeIds){
        const b = document.getElementById(backdropId);
        if(!b) return;
        b.addEventListener("click", (e)=>{ if(e.target === b) closeBackdrop(backdropId); }, true);
        (closeIds||[]).forEach(id=>{
          const el = document.getElementById(id);
          if(el) el.addEventListener("click", ()=>closeBackdrop(backdropId), true);
        });
      }

      // 1) CLOSE pentru DOCUMENTE (facturi/proforme/chitante)
      wireClose("docsInvoicesBackdrop", ["docsInvoicesClose","docsInvCloseBottom"]);
      wireClose("docsProformasBackdrop", ["docsProformasClose","docsProCloseBottom"]);
      wireClose("docsReceiptsBackdrop", ["docsReceiptsClose","docsRcpCloseBottom"]);

      // ESC inchide ultimul modal deschis (doar pentru cele 3 liste)
      document.addEventListener("keydown", (e)=>{
        if(e.key !== "Escape") return;
        const openIds = ["docsReceiptsBackdrop","docsProformasBackdrop","docsInvoicesBackdrop"];
        for(const id of openIds){
          const b = document.getElementById(id);
          if(b && b.classList.contains("show")){
            closeBackdrop(id);
            break;
          }
        }
      }, true);

      // Helpers
      function toNum(v){
        if(typeof v === "number") return isFinite(v) ? v : 0;
        const s = (v ?? "").toString().trim().replace(/\s/g,"").replace(",", ".");
        const n = parseFloat(s);
        return isFinite(n) ? n : 0;
      }
      function money(n){
        const x = Number(n||0);
        return x.toLocaleString("ro-RO", {minimumFractionDigits:2, maximumFractionDigits:2});
      }
      function esc(s){ return (s||"").toString().replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

      // 2) MONEDA: cand schimbi moneda documentului, aplica instant pe toate liniile produsului
      const invCurrency = qs("#invCurrency");
      const invFx = qs("#invFx");
      const invLines = qs("#invLines");
      const recalcTotals = window.recalcTotals;

      function applyDocCurrencyToLines(){
        if(!invCurrency || !invLines) return;
        const cur = invCurrency.value || "RON";
        qsa(".ln-cur", invLines).forEach(sel => { sel.value = cur; });
        try{ recalcTotals && recalcTotals(); }catch{}
      }
      if(invCurrency){
        invCurrency.addEventListener("change", applyDocCurrencyToLines, true);
      }

      // 3) SALVARE IN RON (Factură/Proformă/Chitanță) – fara sa modificam structura datelor, doar normalizam inainte de save
      // Facem asta in DOCUMENT capture, inainte de handler-ul de pe buton.
      document.addEventListener("click", (e)=>{
        const btn = e.target.closest && e.target.closest("#btnSaveInvoice, #btnSaveReceipt");
        if(!btn) return;

        // FACTURA / PROFORMA
        if(btn.id === "btnSaveInvoice"){
          if(!invCurrency || !invFx || !invLines) return;
          const cur = invCurrency.value || "RON";
          const fx = toNum(invFx.value) || 1;

          if(cur !== "RON"){
            // Convertim liniile la RON: price *= fx, cur = RON
            qsa("tr", invLines).forEach(tr=>{
              const sel = tr.querySelector(".ln-cur");
              const priceEl = tr.querySelector(".ln-price");
              if(!sel || !priceEl) return;
              const lineCur = sel.value || cur;
              if(lineCur === cur){
                const p = toNum(priceEl.value);
                priceEl.value = (p * fx).toFixed(6); // pastram precizie, UI afiseaza cum are deja
                sel.value = "RON";
              }
            });

            // setam documentul in RON si fx=1
            invCurrency.value = "RON";
            invFx.value = "1";

            try{ recalcTotals && recalcTotals(); }catch{}
          }
          return;
        }

        // CHITANTA
        if(btn.id === "btnSaveReceipt"){
          const rcptCurrency = qs("#rcptCurrency");
          const rcptFx = qs("#rcptFx");
          const rcptAmount = qs("#rcptAmount");
          if(!rcptCurrency || !rcptFx || !rcptAmount) return;

          const cur = rcptCurrency.value || "RON";
          const fx = toNum(rcptFx.value) || 1;
          if(cur !== "RON"){
            const amt = toNum(rcptAmount.value);
            rcptAmount.value = (amt * fx).toFixed(2);
            rcptCurrency.value = "RON";
            rcptFx.value = "1";
          }
          return;
        }
      }, true);

      // 4) PDF DOWNLOAD (nu print). Implementam global pdfInvoice/pdfReceipt folosite de butoane.
      async function downloadPdfFromHtml(filename, html){
        if(!window.jspdf || !window.jspdf.jsPDF){
          alert("Librăria PDF nu s-a încărcat. Verifică conexiunea la internet (CDN).");
          return;
        }
        const { jsPDF } = window.jspdf;

        const container = document.createElement("div");
        container.style.position = "fixed";
        container.style.left = "-10000px";
        container.style.top = "0";
        container.style.width = "794px"; // ~A4 width @96dpi
        container.style.background = "#fff";
        container.innerHTML = html;
        document.body.appendChild(container);

        const doc = new jsPDF({orientation:"p", unit:"pt", format:"a4"});
        await doc.html(container, {
          x: 28,
          y: 28,
          html2canvas: { scale: 0.8, useCORS: true },
          autoPaging: "text",
          margin: [28,28,28,28]
        });

        document.body.removeChild(container);
        doc.save(filename);
      }

      window.pdfInvoice = function(inv){
        // inv is saved payload; build simplified template similar with example
        const unit = (typeof window.getUnit === "function") ? (window.getUnit() || {}) : {};
        const seller = {
          name: unit.name || "POSHARD IMPEX S.R.L.",
          cui: unit.cui || "",
          reg: unit.reg || "",
          address: unit.address || "",

          capital: unit.capital || "",
          iban: unit.iban || "",
          bank: unit.bank || ""
        };
        const buyer = inv.client || {};
        const vatRate = Number(inv.vatRate ?? 0);
        const lines = Array.isArray(inv.lines) ? inv.lines : [];

        let net=0, vat=0, gross=0;
        const rows = lines.map(l=>{
          const qty = Number(l.qty ?? 0);
          const price = Number(l.price ?? 0);
          const disc = Number(l.discount ?? 0);
          const ln = qty*price*(1-(disc/100));
          const lv = ln*(vatRate/100);
          net+=ln; vat+=lv; gross+=(ln+lv);
          return `
            <tr>
              <td><b>${esc(l.name||"")}</b></td>
              <td style="text-align:right">${qty}</td>
              <td style="text-align:right">${money(price)}</td>
              <td style="text-align:right">${disc? (disc+"%") : "-"}</td>
              <td style="text-align:right">${money(ln)}</td>
              <td style="text-align:right">${money(lv)}</td>
            </tr>
          `;
        }).join("");

        const title = (inv.type === "FACTURA") ? "FACTURA" : "FACTURA PROFORMA";
        const html = `
          <div style="font-family:Arial,Helvetica,sans-serif; font-size:12px; color:#000;">
            <div style="display:flex; justify-content:space-between; gap:18px;">
              <div style="width:32%;">
                <div><b>Furnizor:</b></div>
                <div><b>${esc(seller.name)}</b></div>
                <div>CUI: <b>${esc(seller.cui||"-")}</b></div>
                <div>Nr.ord.reg.com: <b>${esc(seller.reg||"-")}</b></div>
                <div>Sediul: <b>${esc(seller.address||"-")}</b></div>
                ${seller.county? `<div>Județul: <b>${esc(seller.county)}</b></div>`:""}
                ${seller.capital? `<div>Capital social: <b>${esc(seller.capital)}</b></div>`:""}
                ${seller.iban? `<div>IBAN: <b>${esc(seller.iban)}</b></div>`:""}
                ${seller.bank? `<div>Banca: <b>${esc(seller.bank)}</b></div>`:""}
              </div>

              <div style="width:36%; text-align:center;">
                <div style="font-size:34px; font-weight:900; letter-spacing:1px;">${title}</div>
                <div style="margin-top:6px;"><b>Seria:</b> ${esc(inv.serie||"")} <b>Nr.</b> ${esc(inv.number||"")} <b>din</b> ${esc(inv.date||"")}</div>
                <div style="margin-top:6px;"><b>Termen de plată:</b> ${esc(inv.dueDays ?? 0)} zile</div>
                <div style="margin-top:6px;"><b>Cota de TVA:</b> ${vatRate || 0}%</div>
              </div>

              <div style="width:32%;">
                <div><b>Cumpărător:</b></div>
                <div><b>${esc(buyer.name||"-")}</b></div>
                <div>CUI: <b>${esc(buyer.cui||"-")}</b></div>
                <div>Nr.ord.reg.com: <b>${esc(buyer.reg||buyer.orc||"-")}</b></div>
                <div>Sediul: <b>${esc(buyer.address||"-")}</b></div>
              </div>
            </div>

            <table style="width:100%; border-collapse:collapse; margin-top:12px;">
              <thead>
                <tr>
                  <th style="border:1px solid #000; padding:6px; text-align:left;">Produs</th>
                  <th style="border:1px solid #000; padding:6px; text-align:right;">Cantitate</th>
                  <th style="border:1px solid #000; padding:6px; text-align:right;">Pret unitar</th>
                  <th style="border:1px solid #000; padding:6px; text-align:right;">Discount</th>
                  <th style="border:1px solid #000; padding:6px; text-align:right;">Valoare lei, fara TVA</th>
                  <th style="border:1px solid #000; padding:6px; text-align:right;">Valoare TVA</th>
                </tr>
              </thead>
              <tbody>
                ${rows || `<tr><td colspan="6" style="border:1px solid #000; padding:6px;">-</td></tr>`}
                <tr>
                  <td colspan="4" style="border:1px solid #000; padding:6px; text-align:right;"><b>Total, fara TVA</b></td>
                  <td style="border:1px solid #000; padding:6px; text-align:right;"><b>${money(net)}</b></td>
                  <td style="border:1px solid #000; padding:6px; text-align:right;"><b>${money(vat)}</b></td>
                </tr>
                <tr>
                  <td colspan="5" style="border:1px solid #000; padding:6px; text-align:right;"><b>Total de plata</b></td>
                  <td style="border:1px solid #000; padding:6px; text-align:right;"><b>${money(gross)}</b></td>
                </tr>
              </tbody>
            </table>

            <div style="margin-top:10px;"><b>Curs:</b> ${esc(inv.fx ?? 1)}</div>
            <div style="display:flex; gap:12px; margin-top:12px;">
              <div style="flex:1; border:1px solid #000; padding:10px; font-size:11px;">
                Factura circula fara semnatura si stampila conform art 319 alin. 29 din Codul Fiscal
              </div>
              <div style="flex:1; border:1px solid #000; padding:10px; font-size:11px;">
                <div><b>Date privind expeditia</b></div>
                <div>Numele delegatului</div>
                <div>Mijlocul de transport</div>
                <div>Expedierea s-a efectuat la data de ${esc(inv.date||"")} ora 12:00</div>
              </div>
            </div>
          </div>
        `;
        const fn = `${title}_${esc(inv.serie||"")}_${String(inv.number||"")}.pdf`.replace(/[^\w\-.]+/g,"_");
        return downloadPdfFromHtml(fn, html);
      };

      window.pdfReceipt = function(r){
        const unit = (typeof window.getUnit === "function") ? (window.getUnit() || {}) : {};
        const seller = {
          name: unit.name || "POSHARD IMPEX S.R.L.",
          cui: unit.cui || "",
          reg: unit.reg || "",
          address: unit.address || "",

          capital: unit.capital || "",
          iban: unit.iban || "",
          bank: unit.bank || ""
        };
        const p = r.partner || {};
        // FIX63: recompute "suma in litere" din suma numerica (ignoram ce e salvat in r.amountWords)
        const amountWords = (typeof moneyToWordsRo === "function")
          ? String(moneyToWordsRo(r.amount||0, (r.currency||"RON")) || "").replace(/\s+/g," ").trim()
          : String(r.amountWords || "-");
        const one = () => `
          <div style="font-family:Arial,Helvetica,sans-serif; font-size:12px; color:#000;">
            <div style="display:flex; justify-content:space-between;">
              <div>
                <div><b>Furnizor:</b></div>
                <div><b>${esc(seller.name)}</b></div>
                <div>CUI: <b>${esc(seller.cui||"-")}</b></div>
                <div>Nr.ord.reg.com: <b>${esc(seller.reg||"-")}</b></div>
                <div>Sediul: <b>${esc(seller.address||"-")}</b></div>
                ${seller.county? `<div>Judetul: <b>${esc(seller.county)}</b></div>`:""}
                ${seller.capital? `<div>Capital social: <b>${esc(seller.capital)}</b></div>`:""}
                ${seller.iban? `<div>IBAN: <b>${esc(seller.iban)}</b></div>`:""}
                ${seller.bank? `<div>Banca: <b>${esc(seller.bank)}</b></div>`:""}
              </div>
              <div style="text-align:right;">
                <div style="font-size:18px; font-weight:900;">CHITANTA</div>
                <div>Numar <b>${esc(r.number||"")}</b></div>
                <div>Data <b>${esc(r.date||"")}</b></div>
              </div>
            </div>

            <div style="margin-top:16px;">
              <div style="display:flex; gap:12px;">
                <div style="width:180px;">Am primit de la:</div>
                <div><b>${esc(p.name||"-")}</b></div>
              </div>
              <div style="display:flex; gap:12px; margin-top:6px;">
                <div style="width:180px;">CIF:</div>
                <div><b>${esc(p.cui||"-")}</b></div>
              </div>
              <div style="display:flex; gap:12px; margin-top:6px;">
                <div style="width:180px;">Adresa:</div>
                <div><b>${esc(p.address||"-")}</b></div>
              </div>
              <div style="display:flex; gap:12px; margin-top:10px;">
                <div style="width:180px;">Suma de:</div>
                <div><b>${money(r.amount||0)}</b> ${esc(r.currency||"RON")} &nbsp;&nbsp;&nbsp; adica: <b>${esc((typeof cleanWords==="function"?cleanWords(amountWords||"-"):(amountWords||"-")))}</b></div>
              </div>
              <div style="display:flex; gap:12px; margin-top:6px;">
                <div style="width:180px;">Reprezentand:</div>
                <div><b>${esc(r.representative||"-")}</b></div>
              </div>

              <div style="display:flex; justify-content:flex-end; margin-top:14px;">
                <div>Semnatura:&nbsp;&nbsp;<span style="display:inline-block; min-width:240px; border-bottom:1px dotted #000;"></span></div>
              </div>
            </div>
          </div>
        `;
        const html = `${one()}<div style="border-top:1px dashed #000; margin:10mm 0;"></div>${one()}`;
        const fn = `CHITANTA_${String(r.number||"")}.pdf`.replace(/[^\w\-.]+/g,"_");
        return downloadPdfFromHtml(fn, html);
      };

    })();
    // ===== END FIX32 =====
  </script>


  <script>
    // ===== FIX33 PDF REAL (jsPDF draw) + TOTALURI EXPUSE =====
    (function(){
      const qs = (s,p=document)=>p.querySelector(s);
      const qsa = (s,p=document)=>[...p.querySelectorAll(s)];

      function toNum(v){
        if(typeof v === "number") return isFinite(v) ? v : 0;
        const s = (v ?? "").toString().trim().replace(/\s/g,"").replace(",", ".");
        const n = parseFloat(s);
        return isFinite(n) ? n : 0;
      }
      function money(n){
        const x = Number(n||0);
        return x.toLocaleString("ro-RO", { minimumFractionDigits:2, maximumFractionDigits:2 });
      }
      function safe(s){ return (s||"").toString(); }

      // 1) Extinde vizual totalurile (fara sa schimbam ce exista deja)
      function ensureTotalsExtended(){
        const totalsWrap = qs("#invoiceTotals"); // exists in your layout
        if(!totalsWrap) return;
        if(qs("#totalsExtended", totalsWrap)) return;

        const ext = document.createElement("div");
        ext.id = "totalsExtended";
        ext.innerHTML = `
          <div class="row"><span><b>Valoarea totală:</b></span><span id="xTotalFaraTVA">0.00</span></div>
          <div class="row"><span><b>Valoare TVA:</b></span><span id="xTVA">0.00</span></div>
          <div class="row"><span><b>Total document:</b></span><span id="xTotalDoc">0.00</span></div>
          <div class="row"><span><b>Discount:</b></span><span id="xDiscount">0.00</span></div>
          <div class="row"><span><b>Total factură (RON):</b></span><span id="xTotalRON">0.00</span></div>
        `;
        totalsWrap.appendChild(ext);
      }

      // Keep extended totals synced with existing totals ids
      function syncExtendedTotals(){
        ensureTotalsExtended();
        const net = toNum(qs("#tNet")?.textContent);
        const vat = toNum(qs("#tVat")?.textContent);
        const gross = toNum(qs("#tGross")?.textContent);
        const ron = toNum(qs("#tRon")?.textContent);
        const disc = 0; // no discount input yet

        const a = qs("#xTotalFaraTVA"); if(a) a.textContent = money(net);
        const b = qs("#xTVA"); if(b) b.textContent = money(vat);
        const c = qs("#xTotalDoc"); if(c) c.textContent = money(gross);
        const d = qs("#xDiscount"); if(d) d.textContent = money(disc);
        const e = qs("#xTotalRON"); if(e) e.textContent = money(ron || gross);
      }

      // Hook after any recalc
      const prevRecalc = window.recalcTotals;
      if(typeof prevRecalc === "function"){
        window.recalcTotals = function(){
          const r = prevRecalc.apply(this, arguments);
          try{ syncExtendedTotals(); }catch{}
          return r;
        };
      }

      // When invoice modal opens, ensure box exists
      const invBackdrop = qs("#invoiceBackdrop");
      if(invBackdrop){
        const mo = new MutationObserver(()=>{
          if(invBackdrop.classList.contains("show")){
            setTimeout(()=>{ try{ syncExtendedTotals(); }catch{} }, 0);
          }
        });
        mo.observe(invBackdrop, {attributes:true, attributeFilter:["class"]});
      }

      // 2) PDF download – redraw with jsPDF (no html2canvas; fixes "pagina goala")
      function ensureJsPDF(){
        return (window.jspdf && window.jspdf.jsPDF) ? window.jspdf.jsPDF : null;
      }

      function drawText(doc, text, x, y, opt={}){
        const size = opt.size || 10;
        doc.setFont("helvetica", opt.bold ? "bold" : "normal");
        doc.setFontSize(size);
        doc.text(String(text||""), x, y, { align: opt.align || "left" });
      }
      function drawKV(doc, label, value, x, y){
        drawText(doc, label, x, y, {size:9, bold:false});
        drawText(doc, value, x+42, y, {size:9, bold:true});
      }
      function hline(doc, x1,y,x2){ doc.line(x1,y,x2,y); }
      function vline(doc, x,y1,y2){ doc.line(x,y1,x,y2); }
      function rect(doc, x,y,w,h){ doc.rect(x,y,w,h); }

      function invoiceToPdfDoc(inv){
        const JsPDF = ensureJsPDF();
        if(!JsPDF){ alert("jsPDF nu s-a încărcat (CDN)."); return null; }

        const doc = new JsPDF({orientation:"p", unit:"pt", format:"a4"});
        const W = doc.internal.pageSize.getWidth();
        const left = 40, top = 40, right = W-40;

        const unit = (typeof window.getUnit === "function") ? (window.getUnit() || {}) : {};
        const seller = {
          name: unit.name || "POSHARD IMPEX S.R.L.",
          cui: unit.cui || "",
          reg: unit.reg || "",
          address: unit.address || "",

          capital: unit.capital || "",
          iban: unit.iban || "",
          bank: unit.bank || "",
          workPoint: unit.workPoint || ""
        };
        const buyer = inv.client || {};
        const vatRate = Number(inv.vatRate ?? 0);

        // Blocks
        let y = top;
        drawText(doc, "Furnizor:", left, y, {size:10, bold:true}); y += 14;
        drawText(doc, seller.name, left, y, {size:10, bold:true}); y += 12;
        drawKV(doc, "CUI:", safe(seller.cui||"-"), left, y); y += 12;
        drawKV(doc, "Nr.ord.reg.com:", safe(seller.reg||"-"), left, y); y += 12;
        drawKV(doc, "Sediu:", safe(seller.address||"-"), left, y); y += 12;
        if(seller.county){ drawKV(doc, "Judetul", safe(seller.county), left, y); y += 12; }
        if(seller.capital){ drawKV(doc, "Capital social:", safe(seller.capital), left, y); y += 12; }
        if(seller.iban){ drawKV(doc, "IBAN:", safe(seller.iban), left, y); y += 12; }
        if(seller.bank){ drawKV(doc, "Banca:", safe(seller.bank), left, y); y += 12; }
        if(seller.workPoint){ drawKV(doc, "Punct de lucru:", safe(seller.workPoint), left, y); y += 12; }

        // Buyer block right
        let yR = top;
        const bx = W/2 + 40;
        drawText(doc, "Cumparator:", bx, yR, {size:10, bold:true}); yR += 14;
        drawText(doc, safe(buyer.name||"-"), bx, yR, {size:10, bold:true}); yR += 12;
        drawKV(doc, "CUI:", safe(buyer.cui||"-"), bx, yR); yR += 12;
        drawKV(doc, "Nr.ord. reg.com:", safe(buyer.reg||buyer.orc||"-"), bx, yR); yR += 12;
        drawKV(doc, "Sediul:", safe(buyer.address||"-"), bx, yR); yR += 12;
        if(buyer.iban){ drawKV(doc, "IBAN:", safe(buyer.iban), bx, yR); yR += 12; }
        if(buyer.bank){ drawKV(doc, "Banca:", safe(buyer.bank), bx, yR); yR += 12; }

        // Title center
        const title = (inv.type === "FACTURA") ? "FACTURA" : "FACTURA PROFORMA";
        drawText(doc, title, W/2, top + 60, {size:28, bold:true, align:"center"});
        drawText(doc, `Seria: ${safe(inv.serie||"")} Nr. ${safe(inv.number||"")} din ${safe(inv.date||"")}`, W/2, top + 86, {size:10, bold:false, align:"center"});
        drawText(doc, `Termen de plata: ${safe(inv.dueDays ?? 0)} zile`, W/2, top + 100, {size:10, align:"center"});
        drawText(doc, `Cota de TVA: ${vatRate || 0}%`, W/2, top + 114, {size:10, align:"center"});

        // Table
        let yT = 190;
        const cols = [
          {t:"Produs", w: 250, a:"left"},
          {t:"Cantitate", w: 70, a:"right"},
          {t:"Pret unitar", w: 80, a:"right"},
          {t:"Discount", w: 60, a:"right"},
          {t:"Valoare lei, fara TVA", w: 90, a:"right"},
          {t:"Valoare TVA", w: 70, a:"right"},
        ];
        const x0 = left;
        const rowH = 22;
        // header row
        rect(doc, x0, yT, cols.reduce((s,c)=>s+c.w,0), rowH);
        let xx = x0;
        cols.forEach(c=>{
          vline(doc, xx, yT, yT+rowH);
          drawText(doc, c.t, xx+4, yT+15, {size:9, bold:true, align:"left"});
          xx += c.w;
        });
        vline(doc, x0+cols.reduce((s,c)=>s+c.w,0), yT, yT+rowH);

        const lines = Array.isArray(inv.lines) ? inv.lines : [];
        let net=0, vat=0, gross=0;
        let yRow = yT + rowH;

        function addRow(vals, bold=false){
          rect(doc, x0, yRow, cols.reduce((s,c)=>s+c.w,0), rowH);
          let x = x0;
          for(let i=0;i<cols.length;i++){
            vline(doc, x, yRow, yRow+rowH);
            const c = cols[i];
            const v = vals[i] ?? "";
            const pad = 4;
            const tx = (c.a==="right") ? (x + c.w - pad) : (x + pad);
            drawText(doc, v, tx, yRow+15, {size:9, bold, align: c.a});
            x += c.w;
          }
          vline(doc, x0+cols.reduce((s,c)=>s+c.w,0), yRow, yRow+rowH);
          yRow += rowH;
        }

        if(lines.length===0){
          addRow(["-","","","","",""], false);
        }else{
          lines.forEach(l=>{
            const qty = toNum(l.qty ?? 0);
            const price = toNum(l.price ?? 0);
            const disc = 0;
            const ln = qty*price;
            const lv = ln*(vatRate/100);
            net += ln; vat += lv; gross += (ln+lv);
            addRow([
              safe(l.name||""),
              String(qty),
              money(price),
              "-",
              money(ln),
              money(lv)
            ], false);
          });
        }

        // Totals rows (2)
        addRow(["","","","","Total, fara TVA", money(net)], true); // we'll place in last col? emulate example
        // tweak: show net under "Valoare lei" and vat under "Valoare TVA"
        // We'll redraw last two rows manually for accuracy
        yRow -= rowH; // rollback last row
        // erase by drawing white rect not available; instead just overwrite with correct content
        addRow(["","","","", money(net), money(vat)], true);

        // Total de plata row
        addRow(["","","","","Total de plata", money(gross)], true);

        // Currency course
        drawText(doc, `Curs ${safe(inv.currency||"RON")}: ${safe(inv.fx ?? 1)}`, left, yRow + 18, {size:10, bold:false});

        // Footer boxes
        const yF = yRow + 30;
        rect(doc, left, yF, (right-left)/2 - 6, 70);
        rect(doc, left + (right-left)/2 + 6, yF, (right-left)/2 - 6, 70);
        drawText(doc, "Factura circula fara semnatura si", left+8, yF+18, {size:9});
        drawText(doc, "stampila conform art 319 alin. 29 din", left+8, yF+32, {size:9});
        drawText(doc, "Codul Fiscal", left+8, yF+46, {size:9});

        drawText(doc, "Date privind expeditia", left + (right-left)/2 + 14, yF+18, {size:9, bold:true});
        drawText(doc, "Numele delegatului", left + (right-left)/2 + 14, yF+32, {size:9});
        drawText(doc, "Mijlocul de transport", left + (right-left)/2 + 14, yF+46, {size:9});
        drawText(doc, `Expedierea s-a efectuat la data de ${safe(inv.date||"")} ora 12:00`, left + (right-left)/2 + 14, yF+60, {size:9});

        return doc;
      }

      window.pdfInvoice = function(inv){
        const doc = invoiceToPdfDoc(inv);
        if(!doc) return;
        const title = (inv.type === "FACTURA") ? "FACTURA" : "FACTURA_PROFORMA";
        const fn = `${title}_${safe(inv.serie||"")}_${safe(inv.number||"")}.pdf`.replace(/[^\w\-.]+/g,"_");
        doc.save(fn);
      };

      function receiptToPdfDoc(r){
        const JsPDF = ensureJsPDF();
        if(!JsPDF){ alert("jsPDF nu s-a încărcat (CDN)."); return null; }
        const doc = new JsPDF({orientation:"p", unit:"pt", format:"a4"});
        const W = doc.internal.pageSize.getWidth();
        const left = 40, right = W-40;

        const unit = (typeof window.getUnit === "function") ? (window.getUnit() || {}) : {};
        const seller = {
          name: unit.name || "POSHARD IMPEX S.R.L.",
          cui: unit.cui || "",
          reg: unit.reg || "",
          address: unit.address || "",

          capital: unit.capital || "",
          iban: unit.iban || "",
          bank: unit.bank || ""
        };
        const p = r.partner || {};

        function drawCopy(y0){
          let y = y0;
          drawText(doc, "Furnizor:", left, y, {size:10, bold:true}); y+=14;
          drawText(doc, seller.name, left, y, {size:10, bold:true}); y+=12;
          drawKV(doc, "CUI:", safe(seller.cui||"-"), left, y); y+=12;
          drawKV(doc, "Nr.ord.reg.com:", safe(seller.reg||"-"), left, y); y+=12;
          drawKV(doc, "Sediu:", safe(seller.address||"-"), left, y); y+=12;
          if(seller.county){ drawKV(doc, "Judetul", safe(seller.county), left, y); y+=12; }
          if(seller.capital){ drawKV(doc, "Capital social:", safe(seller.capital), left, y); y+=12; }
          if(seller.iban){ drawKV(doc, "IBAN:", safe(seller.iban), left, y); y+=12; }
          if(seller.bank){ drawKV(doc, "Banca:", safe(seller.bank), left, y); y+=12; }

          drawText(doc, "CHITANTA", right, y0+14, {size:16, bold:true, align:"right"});
          drawText(doc, `Numar ${safe(r.number||"")}`, right, y0+32, {size:10, bold:false, align:"right"});
          drawText(doc, `Data ${safe(r.date||"")}`, right, y0+46, {size:10, bold:false, align:"right"});

          let y2 = y0 + 110;
          drawText(doc, "Am primit de la:", left, y2, {size:10}); drawText(doc, safe(p.name||"-"), left+120, y2, {size:10, bold:true}); y2+=16;
          drawText(doc, "CIF:", left, y2, {size:10}); drawText(doc, safe(p.cui||"-"), left+120, y2, {size:10, bold:true}); y2+=16;
          drawText(doc, "Adresa:", left, y2, {size:10}); drawText(doc, safe(p.address||"-"), left+120, y2, {size:10, bold:true}); y2+=22;

          drawText(doc, "Suma de:", left, y2, {size:10}); 
          drawText(doc, `${money(r.amount||0)}`, left+120, y2, {size:10, bold:true});
          drawText(doc, `adica: ${safe(r.amountWords||"-")}`, left+220, y2, {size:10}); y2+=18;

          drawText(doc, "Reprezentand:", left, y2, {size:10}); drawText(doc, safe(r.representative||"-"), left+120, y2, {size:10, bold:true}); y2+=26;

          drawText(doc, "Semnatura:", right-220, y2, {size:10});
          doc.setLineDashPattern([2,2], 0);
          hline(doc, right-140, y2, right); 
          doc.setLineDashPattern([], 0);

          return y0 + 260;
        }

        drawCopy(50);
        doc.setLineDashPattern([3,3], 0);
        hline(doc, left, 380, right);
        doc.setLineDashPattern([], 0);
        drawCopy(410);

        return doc;
      }

      window.pdfReceipt = function(r){
        const doc = receiptToPdfDoc(r);
        if(!doc) return;
        const fn = `CHITANTA_${safe(r.number||"")}.pdf`.replace(/[^\w\-.]+/g,"_");
        doc.save(fn);
      };

    })();
    // ===== END FIX33 =====
  </script>


  <script>
    // ===== FIX34 PDF REFINEMENTS (doar PDF layout/text) =====
    (function(){
      const qs = (s,p=document)=>p.querySelector(s);

      function toNum(v){
        if(typeof v === "number") return isFinite(v) ? v : 0;
        const s = (v ?? "").toString().trim().replace(/\s/g,"").replace(",", ".");
        const n = parseFloat(s);
        return isFinite(n) ? n : 0;
      }
      function money(n){
        const x = Number(n||0);
        return x.toLocaleString("ro-RO", { minimumFractionDigits:2, maximumFractionDigits:2 });
      }
      function safe(s){ return (s||"").toString(); }

      function ensureJsPDF(){
        return (window.jspdf && window.jspdf.jsPDF) ? window.jspdf.jsPDF : null;
      }
      function drawText(doc, text, x, y, opt={}){
        doc.setFont("helvetica", opt.bold ? "bold" : "normal");
        doc.setFontSize(opt.size || 10);
        doc.text(String(text||""), x, y, { align: opt.align || "left" });
      }
      function drawKV(doc, label, value, x, y){
        drawText(doc, label, x, y, {size:9});
        drawText(doc, value, x+52, y, {size:9, bold:true});
      }
      function hline(doc, x1,y,x2){ doc.line(x1,y,x2,y); }
      function vline(doc, x,y1,y2){ doc.line(x,y1,x,y2); }
      function rect(doc, x,y,w,h){ doc.rect(x,y,w,h); }

      // Override invoice pdf for better alignment + smaller title
      window.pdfInvoice = function(inv){
        const JsPDF = ensureJsPDF();
        if(!JsPDF){ alert("jsPDF nu s-a încărcat (CDN)."); return; }

        const doc = new JsPDF({orientation:"p", unit:"pt", format:"a4"});
        const W = doc.internal.pageSize.getWidth();
        const H = doc.internal.pageSize.getHeight();
        const left = 40, top = 40, right = W-40;

        const unit = (typeof window.getUnit === "function") ? (window.getUnit() || {}) : {};
        const seller = {
          name: unit.name || "POSHARD IMPEX S.R.L.",
          cui: unit.cui || "-",
          reg: unit.reg || "-",
          address: unit.address || "-",

          capital: unit.capital || "",
          iban: unit.iban || "",
          bank: unit.bank || ""
        };
        const buyer = inv.client || {};
        const vatRate = Number(inv.vatRate ?? 0);

        // Left block (seller)
        let yL = top;
        drawText(doc, "Furnizor:", left, yL, {size:10, bold:true}); yL += 14;
        drawText(doc, seller.name, left, yL, {size:10, bold:true}); yL += 12;
        drawKV(doc, "CUI:", safe(seller.cui||"-"), left, yL); yL += 12;
        drawKV(doc, "Nr.ord.reg.com:", safe(seller.reg||"-"), left, yL); yL += 12;
        drawKV(doc, "Sediu:", safe(seller.address||"-"), left, yL); yL += 12;

        // Right block (buyer) aligned top-right neatly
        const bx = W - 260; // fixed width block
        let yB = top;
        drawText(doc, "Cumparator:", bx, yB, {size:10, bold:true}); yB += 14;
        drawText(doc, safe(buyer.name||"-"), bx, yB, {size:10, bold:true}); yB += 12;
        drawKV(doc, "CUI:", safe(buyer.cui||"-"), bx, yB); yB += 12;
        drawKV(doc, "Nr.ord. reg.com:", safe(buyer.reg||buyer.orc||"-"), bx, yB); yB += 12;
        drawKV(doc, "Sediu:", safe(buyer.address||"-"), bx, yB); yB += 12;

        // Center title smaller (as requested)
        const title = (inv.type === "FACTURA") ? "Factura" : "Factura proforma";
        drawText(doc, title.toUpperCase(), W/2, top + 64, {size:22, bold:true, align:"center"}); // smaller than before
        drawText(doc, `Seria: ${safe(inv.serie||"")} Nr. ${safe(inv.number||"")} din ${safe(inv.date||"")}`, W/2, top + 88, {size:10, align:"center"});
        drawText(doc, `Termen de plata: ${safe(inv.dueDays ?? 0)} zile`, W/2, top + 104, {size:10, align:"center"});
        drawText(doc, `Cota de TVA: ${vatRate || 0}%`, W/2, top + 120, {size:10, align:"center"});

        // Table
        let yT = 190;
        const cols = [
          {t:"Produs", w: 250, a:"left"},
          {t:"Cantitate", w: 70, a:"right"},
          {t:"Pret unitar", w: 90, a:"right"},
          {t:"Discount", w: 60, a:"right"},
          {t:"Valoare lei, fara TVA", w: 95, a:"right"},
          {t:"Valoare TVA", w: 70, a:"right"},
        ];
        const tableW = cols.reduce((s,c)=>s+c.w,0);
        const x0 = left;
        const rowH = 22;

        // header row
        rect(doc, x0, yT, tableW, rowH);
        let xx = x0;
        cols.forEach(c=>{
          vline(doc, xx, yT, yT+rowH);
          drawText(doc, c.t, xx+4, yT+15, {size:9, bold:true});
          xx += c.w;
        });
        vline(doc, x0+tableW, yT, yT+rowH);

        const lines = Array.isArray(inv.lines) ? inv.lines : [];
        let net=0, vat=0, gross=0;
        let yRow = yT + rowH;

        function addRow(vals, bold=false){
          rect(doc, x0, yRow, tableW, rowH);
          let x = x0;
          for(let i=0;i<cols.length;i++){
            vline(doc, x, yRow, yRow+rowH);
            const c = cols[i];
            const v = vals[i] ?? "";
            const pad = 4;
            const tx = (c.a==="right") ? (x + c.w - pad) : (x + pad);
            drawText(doc, v, tx, yRow+15, {size:9, bold, align: c.a});
            x += c.w;
          }
          vline(doc, x0+tableW, yRow, yRow+rowH);
          yRow += rowH;
        }

        if(lines.length===0){
          addRow(["-","","","","",""], false);
        }else{
          lines.forEach(l=>{
            const qty = toNum(l.qty ?? 0);
            const price = toNum(l.price ?? 0);
            const ln = qty*price;
            const lv = ln*(vatRate/100);
            net += ln; vat += lv; gross += (ln+lv);
            addRow([safe(l.name||""), String(qty), money(price), "-", money(ln), money(lv)], false);
          });
        }

        // Totals rows: right aligned and clean
        addRow(["","","","", "Total, fara TVA", money(net)], true);
        addRow(["","","","", "Valoare TVA", money(vat)], true);
        addRow(["","","","", "Total de plata", money(gross)], true);

        // Currency line
        drawText(doc, `Curs RON: ${safe(inv.fx ?? 1)}`, left, yRow + 18, {size:10});

        // Footer boxes
        const yF = yRow + 34;
        rect(doc, left, yF, (right-left)/2 - 8, 70);
        rect(doc, left + (right-left)/2 + 8, yF, (right-left)/2 - 8, 70);
        drawText(doc, "Factura circula fara semnatura si", left+10, yF+18, {size:9});
        drawText(doc, "stampila conform art 319 alin. 29 din", left+10, yF+32, {size:9});
        drawText(doc, "Codul Fiscal", left+10, yF+46, {size:9});

        drawText(doc, "Date privind expeditia", left + (right-left)/2 + 18, yF+18, {size:9, bold:true});
        drawText(doc, "Numele delegatului", left + (right-left)/2 + 18, yF+32, {size:9});
        drawText(doc, "Mijlocul de transport", left + (right-left)/2 + 18, yF+46, {size:9});
        drawText(doc, `Expedierea s-a efectuat la data de ${safe(inv.date||"")} ora 12:00`, left + (right-left)/2 + 18, yF+60, {size:9});

        const fn = `${(inv.type==="FACTURA"?"FACTURA":"PROFORMA")}_${safe(inv.serie||"")}_${safe(inv.number||"")}.pdf`.replace(/[^\w\-.]+/g,"_");
        doc.save(fn);
      };

      // Override receipt pdf to fix "adica" (no weird spacing) and keep text normal
      window.pdfReceipt = function(r){
        const JsPDF = ensureJsPDF();
        if(!JsPDF){ alert("jsPDF nu s-a încărcat (CDN)."); return; }
        const doc = new JsPDF({orientation:"p", unit:"pt", format:"a4"});
        const W = doc.internal.pageSize.getWidth();
        const left = 40, right = W-40;

        const unit = (typeof window.getUnit === "function") ? (window.getUnit() || {}) : {};
        const seller = {
          name: unit.name || "POSHARD IMPEX S.R.L.",
          cui: unit.cui || "-",
          reg: unit.reg || "-",
          address: unit.address || "-"
        };
        const p = r.partner || {};

        function copy(y0){
          let y = y0;
          drawText(doc, "Furnizor:", left, y, {size:10, bold:true}); y+=14;
          drawText(doc, seller.name, left, y, {size:10, bold:true}); y+=12;
          drawKV(doc, "CUI:", safe(seller.cui||"-"), left, y); y+=12;
          drawKV(doc, "Nr.ord.reg.com:", safe(seller.reg||"-"), left, y); y+=12;
          drawKV(doc, "Sediu:", safe(seller.address||"-"), left, y); y+=12;

          drawText(doc, "CHITANTA", right, y0+14, {size:16, bold:true, align:"right"});
          drawText(doc, `Numar ${safe(r.number||"")}`, right, y0+32, {size:10, align:"right"});
          drawText(doc, `Data ${safe(r.date||"")}`, right, y0+46, {size:10, align:"right"});

          let y2 = y0 + 110;
          drawText(doc, "Am primit de la:", left, y2, {size:10});
          drawText(doc, safe(p.name||"-"), left+120, y2, {size:10, bold:true}); y2+=16;
          drawText(doc, "CIF:", left, y2, {size:10});
          drawText(doc, safe(p.cui||"-"), left+120, y2, {size:10, bold:true}); y2+=16;
          drawText(doc, "Adresa:", left, y2, {size:10});
          drawText(doc, safe(p.address||"-"), left+120, y2, {size:10, bold:true}); y2+=22;

          // Suma line: "adica:" normal, no letter-spacing
          drawText(doc, "Suma de:", left, y2, {size:10});
          drawText(doc, money(r.amount||0), left+120, y2, {size:10, bold:true});
          drawText(doc, "adica:", left+210, y2, {size:10});
          drawText(doc, safe(r.amountWords||"-"), left+255, y2, {size:10, bold:false}); y2+=18;

          drawText(doc, "Reprezentand:", left, y2, {size:10});
          drawText(doc, safe(r.representative||"-"), left+120, y2, {size:10, bold:true}); y2+=26;

          // signature line
          drawText(doc, "Semnatura:", right-250, y2, {size:10});
          doc.setLineDashPattern([2,2], 0);
          hline(doc, right-160, y2, right);
          doc.setLineDashPattern([], 0);

          return y0 + 260;
        }

        copy(60);
        doc.setLineDashPattern([3,3], 0);
        hline(doc, left, 390, right);
        doc.setLineDashPattern([], 0);
        copy(420);

        const fn = `CHITANTA_${safe(r.number||"")}.pdf`.replace(/[^\w\-.]+/g,"_");
        doc.save(fn);
      };

    })();
    // ===== END FIX34 =====
  </script>


  <script>
    // ===== FIX35 PDF TABLE CLEAN (doar layout PDF, fara alte schimbari) =====
    (function(){
      function ensureJsPDF(){ return (window.jspdf && window.jspdf.jsPDF) ? window.jspdf.jsPDF : null; }
      function toNum(v){
        if(typeof v === "number") return isFinite(v) ? v : 0;
        const s = (v ?? "").toString().trim().replace(/\s/g,"").replace(",", ".");
        const n = parseFloat(s);
        return isFinite(n) ? n : 0;
      }
      function money(n){
        const x = Number(n||0);
        return x.toLocaleString("ro-RO", { minimumFractionDigits:2, maximumFractionDigits:2 });
      }
      function safe(s){ return (s||"").toString(); }

      function setFont(doc, size, bold=false){
        doc.setFont("helvetica", bold ? "bold" : "normal");
        doc.setFontSize(size);
      }
      function text(doc, s, x, y, align="left"){
        doc.text(String(s||""), x, y, { align });
      }
      function rect(doc, x,y,w,h){ doc.rect(x,y,w,h); }
      function line(doc, x1,y1,x2,y2){ doc.line(x1,y1,x2,y2); }
      function dash(doc, on=true){ doc.setLineDashPattern(on ? [3,3] : [], 0); }

      function drawLabelValue(doc, label, value, x, y){
        setFont(doc, 9, false); text(doc, label, x, y);
        setFont(doc, 9, true);  text(doc, value, x+54, y);
      }

      function drawHeaderBlocks(doc, inv){
        const W = doc.internal.pageSize.getWidth();
        const left = 40, top = 40;
        const blockW = 250;

        const unit = (typeof window.getUnit === "function") ? (window.getUnit() || {}) : {};
        const seller = {
          name: unit.name || "POSHARD IMPEX S.R.L.",
          cui: unit.cui || "-",
          reg: unit.reg || "-",
          address: unit.address || "-"
        };
        const buyer = inv.client || {};
        const vatRate = Number(inv.vatRate ?? 0);

        // Seller left
        let yL = top;
        setFont(doc,10,true); text(doc,"Furnizor:", left, yL); yL+=14;
        setFont(doc,10,true); text(doc,safe(seller.name), left, yL); yL+=12;
        drawLabelValue(doc,"CUI:", safe(seller.cui||"-"), left, yL); yL+=12;
        drawLabelValue(doc,"Nr.ord.reg.com:", safe(seller.reg||"-"), left, yL); yL+=12;
        drawLabelValue(doc,"Sediu:", safe(seller.address||"-"), left, yL); yL+=12;

        // Buyer right (top-right)
        const bx = W - 40 - blockW;
        let yB = top;
        setFont(doc,10,true); text(doc,"Cumparator:", bx, yB); yB+=14;
        setFont(doc,10,true); text(doc,safe(buyer.name||"-"), bx, yB); yB+=12;
        drawLabelValue(doc,"CUI:", safe(buyer.cui||"-"), bx, yB); yB+=12;
        drawLabelValue(doc,"Nr.ord.reg.com:", safe(buyer.reg||buyer.orc||"-"), bx, yB); yB+=12;
        drawLabelValue(doc,"Sediu:", safe(buyer.address||"-"), bx, yB); yB+=12;

        // Title center (smaller, no overlap)
        const title = (inv.type === "FACTURA") ? "FACTURA" : "FACTURA PROFORMA";
        setFont(doc,22,true); text(doc,title, W/2, top+70, "center");
        setFont(doc,10,false);
        text(doc, `Seria: ${safe(inv.serie||"")} Nr. ${safe(inv.number||"")} din ${safe(inv.date||"")}`, W/2, top+92, "center");
        text(doc, `Termen de plata: ${safe(inv.dueDays ?? 0)} zile`, W/2, top+108, "center");
        text(doc, `Cota de TVA: ${vatRate || 0}%`, W/2, top+124, "center");

        const headerBottom = Math.max(yL, yB, top+140);
        return { headerBottom, vatRate };
      }

      function drawTable(doc, inv, startY, vatRate){
        const left = 40;
        const W = doc.internal.pageSize.getWidth();
        const pageH = doc.internal.pageSize.getHeight();
        const right = W - 40;

        // Column widths tuned to avoid overlap
        const cols = [
          {t:"Produs", w: 240, a:"left"},
          {t:"Cantitate", w: 70, a:"right"},
          {t:"Pret unitar", w: 85, a:"right"},
          {t:"Discount", w: 60, a:"right"},
          {t:"Valoare lei, fara TVA", w: 95, a:"right"},
          {t:"Valoare TVA", w: 75, a:"right"},
        ];
        const tableW = cols.reduce((s,c)=>s+c.w,0);
        const x0 = left;
        const headerH = 24;
        const baseRowH = 22;
        let y = startY;

        function header(){
          rect(doc, x0, y, tableW, headerH);
          let xx = x0;
          for(const c of cols){
            line(doc, xx, y, xx, y+headerH);
            setFont(doc,9,true);
            text(doc, c.t, xx+4, y+16, "left");
            xx += c.w;
          }
          line(doc, x0+tableW, y, x0+tableW, y+headerH);
          y += headerH;
        }

        function row(cellTexts, rowH, bold=false){
          rect(doc, x0, y, tableW, rowH);
          let xx = x0;
          for(let i=0;i<cols.length;i++){
            const c = cols[i];
            line(doc, xx, y, xx, y+rowH);
            const pad = 4;
            if(i===0){
              setFont(doc,9, bold);
              const maxW = c.w - pad*2;
              const lines = doc.splitTextToSize(String(cellTexts[i]||""), maxW);
              for(let k=0;k<lines.length;k++){
                text(doc, lines[k], xx+pad, y+15 + k*10, "left");
              }
            }else{
              setFont(doc,9, bold);
              const align = c.a;
              const tx = (align==="right") ? (xx + c.w - pad) : (xx + pad);
              text(doc, String(cellTexts[i]||""), tx, y+15, align);
            }
            xx += c.w;
          }
          line(doc, x0+tableW, y, x0+tableW, y+rowH);
          y += rowH;
        }

        header();

        const lines = Array.isArray(inv.lines) ? inv.lines : [];
        let net=0, vat=0, gross=0;

        function ensureSpace(needed){
          const footerReserve = 150;
          if(y + needed > pageH - footerReserve){
            doc.addPage();
            y = 40;
            header();
          }
        }

        if(lines.length===0){
          ensureSpace(baseRowH);
          row(["-","","","","",""], baseRowH);
        }else{
          for(const l of lines){
            const qty = toNum(l.qty ?? 0);
            const price = toNum(l.price ?? 0);
            const ln = qty*price;
            const lv = ln*(vatRate/100);
            net += ln; vat += lv; gross += (ln+lv);

            const prod = safe(l.name||"");
            const wrapLines = doc.splitTextToSize(prod, cols[0].w-8);
            const rowH = Math.max(baseRowH, 14 + wrapLines.length*10);
            ensureSpace(rowH);
            row([prod, String(qty), money(price), "-", money(ln), money(lv)], rowH);
          }
        }

        ensureSpace(baseRowH*3);
        row(["","","","", "Total, fara TVA", money(net)], baseRowH, true);
        row(["","","","", "Valoare TVA", money(vat)], baseRowH, true);
        row(["","","","", "Total de plata", money(gross)], baseRowH, true);

        return { yAfter: y, totals: {net, vat, gross} };
      }

      function drawFooter(doc, inv, yStart){
        const W = doc.internal.pageSize.getWidth();
        const left = 40, right = W-40;
        let y = yStart + 18;

        setFont(doc,10,false);
        text(doc, `Curs RON: ${safe(inv.fx ?? 1)}`, left, y); y += 18;

        const boxH = 70;
        const gap = 16;
        const boxW = (right-left-gap)/2;

        rect(doc, left, y, boxW, boxH);
        rect(doc, left+boxW+gap, y, boxW, boxH);

        setFont(doc,9,false);
        text(doc, "Factura circula fara semnatura si", left+10, y+18);
        text(doc, "stampila conform art 319 alin. 29 din", left+10, y+32);
        text(doc, "Codul Fiscal", left+10, y+46);

        setFont(doc,9,true);
        text(doc, "Date privind expeditia", left+boxW+gap+10, y+18);
        setFont(doc,9,false);
        text(doc, "Numele delegatului", left+boxW+gap+10, y+32);
        text(doc, "Mijlocul de transport", left+boxW+gap+10, y+46);
        text(doc, `Expedierea s-a efectuat la data de ${safe(inv.date||"")} ora 12:00`, left+boxW+gap+10, y+60);

        return y + boxH;
      }

      // Override invoice/proforma pdf with clean table
      window.pdfInvoice = function(inv){
        const JsPDF = ensureJsPDF();
        if(!JsPDF){ alert("jsPDF nu s-a încărcat (CDN)."); return; }

        const doc = new JsPDF({orientation:"p", unit:"pt", format:"a4"});
        const { headerBottom, vatRate } = drawHeaderBlocks(doc, inv);

        const startY = headerBottom + 26;
        const { yAfter } = drawTable(doc, inv, startY, vatRate);
        drawFooter(doc, inv, yAfter);

        const fn = `${(inv.type==="FACTURA"?"FACTURA":"PROFORMA")}_${safe(inv.serie||"")}_${safe(inv.number||"")}.pdf`.replace(/[^\w\-.]+/g,"_");
        doc.save(fn);
      };

      // Receipt: keep clean "adica" + wrap words so no overlap
      window.pdfReceipt = function(r){
        const JsPDF = ensureJsPDF();
        if(!JsPDF){ alert("jsPDF nu s-a încărcat (CDN)."); return; }
        const doc = new JsPDF({orientation:"p", unit:"pt", format:"a4"});
        const W = doc.internal.pageSize.getWidth();
        const left = 40, right = W-40;

        const unit = (typeof window.getUnit === "function") ? (window.getUnit() || {}) : {};
        const seller = {
          name: unit.name || "POSHARD IMPEX S.R.L.",
          cui: unit.cui || "-",
          reg: unit.reg || "-",
          address: unit.address || "-"
        };
        const p = r.partner || {};
        const words = safe(r.amountWords||"-");

        function copy(y0){
          let y = y0;
          setFont(doc,10,true); text(doc,"Furnizor:", left, y); y+=14;
          setFont(doc,10,true); text(doc,seller.name, left, y); y+=12;
          drawLabelValue(doc,"CUI:", safe(seller.cui||"-"), left, y); y+=12;
          drawLabelValue(doc,"Nr.ord.reg.com:", safe(seller.reg||"-"), left, y); y+=12;
          drawLabelValue(doc,"Sediu:", safe(seller.address||"-"), left, y); y+=12;

          setFont(doc,16,true); text(doc,"CHITANTA", right, y0+14, "right");
          setFont(doc,10,false); text(doc,`Numar ${safe(r.number||"")}`, right, y0+32, "right");
          text(doc,`Data ${safe(r.date||"")}`, right, y0+46, "right");

          let y2 = y0 + 110;
          setFont(doc,10,false);
          text(doc,"Am primit de la:", left, y2); setFont(doc,10,true); text(doc,safe(p.name||"-"), left+120, y2); y2+=16;
          setFont(doc,10,false);
          text(doc,"CIF:", left, y2); setFont(doc,10,true); text(doc,safe(p.cui||"-"), left+120, y2); y2+=16;
          setFont(doc,10,false);
          text(doc,"Adresa:", left, y2); setFont(doc,10,true); text(doc,safe(p.address||"-"), left+120, y2); y2+=22;

          setFont(doc,10,false);
          text(doc,"Suma de:", left, y2); setFont(doc,10,true); text(doc,money(r.amount||0), left+120, y2);
          setFont(doc,10,false); text(doc,"adica:", left+210, y2);

          const maxW = right - (left+255);
          const wrapped = doc.splitTextToSize(words, maxW);
          setFont(doc,10,false);
          for(let i=0;i<wrapped.length;i++){
            text(doc, wrapped[i], left+255, y2 + i*12);
          }
          y2 += Math.max(18, wrapped.length*12 + 6);

          setFont(doc,10,false);
          text(doc,"Reprezentand:", left, y2); setFont(doc,10,true); text(doc,safe(r.representative||"-"), left+120, y2); y2+=26;

          setFont(doc,10,false);
          text(doc,"Semnatura:", right-250, y2);
          dash(doc, true); line(doc, right-160, y2, right, y2); dash(doc,false);

          return y0 + 270;
        }

        copy(60);
        dash(doc,true); line(doc,left,390,right,390); dash(doc,false);
        copy(420);

        const fn = `CHITANTA_${safe(r.number||"")}.pdf`.replace(/[^\w\-.]+/g,"_");
        doc.save(fn);
      };

    })();
    // ===== END FIX35 =====
  </script>


  <script>
    // ===== FIX36 PDF WIDTH FIT A4 (fix coloane care ieseau din pagina) =====
    (function(){
      function ensureJsPDF(){ return (window.jspdf && window.jspdf.jsPDF) ? window.jspdf.jsPDF : null; }
      function toNum(v){
        if(typeof v === "number") return isFinite(v) ? v : 0;
        const s = (v ?? "").toString().trim().replace(/\s/g,"").replace(",", ".");
        const n = parseFloat(s);
        return isFinite(n) ? n : 0;
      }
      function money(n){
        const x = Number(n||0);
        return x.toLocaleString("ro-RO", { minimumFractionDigits:2, maximumFractionDigits:2 });
      }
      function safe(s){ return (s||"").toString(); }

      function setFont(doc, size, bold=false){
        doc.setFont("helvetica", bold ? "bold" : "normal");
        doc.setFontSize(size);
      }
      function text(doc, s, x, y, align="left"){
        doc.text(String(s||""), x, y, { align });
      }
      function rect(doc, x,y,w,h){ doc.rect(x,y,w,h); }
      function line(doc, x1,y1,x2,y2){ doc.line(x1,y1,x2,y2); }
      function dash(doc, on=true){ doc.setLineDashPattern(on ? [3,3] : [], 0); }

      function drawLabelValue(doc, label, value, x, y){
        setFont(doc, 9, false); text(doc, label, x, y);
        setFont(doc, 9, true);  text(doc, value, x+54, y);
      }

      function headerBlocks(doc, inv){
        const W = doc.internal.pageSize.getWidth();
        const left = 40, top = 40;
        const blockW = 240;

        const unit = (typeof window.getUnit === "function") ? (window.getUnit() || {}) : {};
        const seller = {
          name: unit.name || "POSHARD IMPEX S.R.L.",
          cui: unit.cui || "-",
          reg: unit.reg || "-",
          address: unit.address || "-"
        };
        const buyer = inv.client || {};
        const vatRate = Number(inv.vatRate ?? 0);

        let yL = top;
        setFont(doc,10,true); text(doc,"Furnizor:", left, yL); yL+=14;
        setFont(doc,10,true); text(doc,safe(seller.name), left, yL); yL+=12;
        drawLabelValue(doc,"CUI:", safe(seller.cui||"-"), left, yL); yL+=12;
        drawLabelValue(doc,"Nr.ord.reg.com:", safe(seller.reg||"-"), left, yL); yL+=12;
        drawLabelValue(doc,"Sediu:", safe(seller.address||"-"), left, yL); yL+=12;

        const bx = W - 40 - blockW;
        let yB = top;
        setFont(doc,10,true); text(doc,"Cumparator:", bx, yB); yB+=14;
        setFont(doc,10,true); text(doc,safe(buyer.name||"-"), bx, yB); yB+=12;
        drawLabelValue(doc,"CUI:", safe(buyer.cui||"-"), bx, yB); yB+=12;
        drawLabelValue(doc,"Nr.ord.reg.com:", safe(buyer.reg||buyer.orc||"-"), bx, yB); yB+=12;
        drawLabelValue(doc,"Sediu:", safe(buyer.address||"-"), bx, yB); yB+=12;

        const title = (inv.type === "FACTURA") ? "FACTURA" : "FACTURA PROFORMA";
        setFont(doc,22,true); text(doc,title, W/2, top+70, "center");
        setFont(doc,10,false);
        text(doc, `Seria: ${safe(inv.serie||"")} Nr. ${safe(inv.number||"")} din ${safe(inv.date||"")}`, W/2, top+92, "center");
        text(doc, `Termen de plata: ${safe(inv.dueDays ?? 0)} zile`, W/2, top+108, "center");
        text(doc, `Cota de TVA: ${vatRate || 0}%`, W/2, top+124, "center");

        const headerBottom = Math.max(yL, yB, top+140);
        return { headerBottom, vatRate };
      }

      function drawTable(doc, inv, startY, vatRate){
        const W = doc.internal.pageSize.getWidth();
        const pageH = doc.internal.pageSize.getHeight();
        const left = 40;
        const contentW = W - 80;

        // IMPORTANT: total width <= contentW (A4 595 - 80 = 515)
        const cols = [
          {t:"Produs", w: 190, a:"left"},
          {t:"Cantitate", w: 60, a:"right"},
          {t:"Pret unitar", w: 70, a:"right"},
          {t:"Discount", w: 55, a:"right"},
          {t:"Valoare lei, fara TVA", w: 80, a:"right"},
          {t:"Valoare TVA", w: 60, a:"right"},
        ];
        const tableW = cols.reduce((s,c)=>s+c.w,0); // must be 515
        const x0 = left;
        const headerH = 24;
        const baseRowH = 22;
        let y = startY;

        function header(){
          rect(doc, x0, y, tableW, headerH);
          let xx = x0;
          for(const c of cols){
            line(doc, xx, y, xx, y+headerH);
            setFont(doc,9,true);
            text(doc, c.t, xx+4, y+16, "left");
            xx += c.w;
          }
          line(doc, x0+tableW, y, x0+tableW, y+headerH);
          y += headerH;
        }

        function row(values, rowH, bold=false){
          rect(doc, x0, y, tableW, rowH);
          let xx = x0;
          for(let i=0;i<cols.length;i++){
            const c = cols[i];
            line(doc, xx, y, xx, y+rowH);
            const pad = 4;
            if(i===0){
              setFont(doc,9,bold);
              const maxW = c.w - pad*2;
              const wrapped = doc.splitTextToSize(String(values[i]||""), maxW);
              for(let k=0;k<wrapped.length;k++){
                text(doc, wrapped[k], xx+pad, y+15 + k*10, "left");
              }
            }else{
              setFont(doc,9,bold);
              const align = c.a;
              const tx = (align==="right") ? (xx + c.w - pad) : (xx + pad);
              text(doc, String(values[i]||""), tx, y+15, align);
            }
            xx += c.w;
          }
          line(doc, x0+tableW, y, x0+tableW, y+rowH);
          y += rowH;
        }

        function ensureSpace(needed){
          const footerReserve = 150;
          if(y + needed > pageH - footerReserve){
            doc.addPage();
            y = 40;
            header();
          }
        }

        header();

        const lines = Array.isArray(inv.lines) ? inv.lines : [];
        let net=0, vat=0, gross=0;

        if(lines.length===0){
          ensureSpace(baseRowH);
          row(["-","","","","",""], baseRowH, false);
        }else{
          for(const l of lines){
            const qty = toNum(l.qty ?? 0);
            const price = toNum(l.price ?? 0);
            const ln = qty*price;
            const lv = ln*(vatRate/100);
            net += ln; vat += lv; gross += (ln+lv);

            const prod = safe(l.name||"");
            const wrap = doc.splitTextToSize(prod, cols[0].w-8);
            const rowH = max(baseRowH, 14 + wrap.length*10);
            ensureSpace(rowH);
            row([prod, String(qty), money(price), "-", money(ln), money(lv)], rowH, false);
          }

        }

        // Totals (bold)
        ensureSpace(baseRowH*3);
        row(["","","","", "Total, fara TVA", money(net)], baseRowH, true);
        row(["","","","", "Valoare TVA", money(vat)], baseRowH, true);
        row(["","","","", "Total de plata", money(gross)], baseRowH, true);

        return { yAfter: y, totals: {net, vat, gross} };

        function max(a,b){ return a>b?a:b; }
      }

      function drawFooter(doc, inv, yStart){
        const W = doc.internal.pageSize.getWidth();
        const left = 40, right = W-40;
        let y = yStart + 18;

        setFont(doc,10,false);
        text(doc, `Curs RON: ${safe(inv.fx ?? 1)}`, left, y); y += 18;

        const boxH = 70;
        const gap = 16;
        const boxW = (right-left-gap)/2;

        rect(doc, left, y, boxW, boxH);
        rect(doc, left+boxW+gap, y, boxW, boxH);

        setFont(doc,9,false);
        text(doc, "Factura circula fara semnatura si", left+10, y+18);
        text(doc, "stampila conform art 319 alin. 29 din", left+10, y+32);
        text(doc, "Codul Fiscal", left+10, y+46);

        setFont(doc,9,true);
        text(doc, "Date privind expeditia", left+boxW+gap+10, y+18);
        setFont(doc,9,false);
        text(doc, "Numele delegatului", left+boxW+gap+10, y+32);
        text(doc, "Mijlocul de transport", left+boxW+gap+10, y+46);
        text(doc, `Expedierea s-a efectuat la data de ${safe(inv.date||"")} ora 12:00`, left+boxW+gap+10, y+60);
      }

      // Override only invoice/proforma PDF with proper width fit
      const prevPdfReceipt = window.pdfReceipt; // keep receipt from FIX35
      window.pdfInvoice = function(inv){
        const JsPDF = ensureJsPDF();
        if(!JsPDF){ alert("jsPDF nu s-a încărcat (CDN)."); return; }

        const doc = new JsPDF({orientation:"p", unit:"pt", format:"a4"});
        const { headerBottom, vatRate } = headerBlocks(doc, inv);
        const startY = headerBottom + 26;

        const { yAfter } = drawTable(doc, inv, startY, vatRate);
        drawFooter(doc, inv, yAfter);

        const fn = `${(inv.type==="FACTURA"?"FACTURA":"PROFORMA")}_${safe(inv.serie||"")}_${safe(inv.number||"")}.pdf`.replace(/[^\w\-.]+/g,"_");
        doc.save(fn);
      };
      if(prevPdfReceipt) window.pdfReceipt = prevPdfReceipt;
    })();
    // ===== END FIX36 =====
  </script>


  <script>
    // ===== FIX37 PDF BUYER TOP RIGHT (doar aliniere cumparator sus dreapta) =====
    (function(){
      function ensureJsPDF(){ return (window.jspdf && window.jspdf.jsPDF) ? window.jspdf.jsPDF : null; }
      function safe(s){ return (s||"").toString(); }

      function setFont(doc, size, bold=false){
        doc.setFont("helvetica", bold ? "bold" : "normal");
        doc.setFontSize(size);
      }
      function text(doc, s, x, y, align="left"){
        doc.text(String(s||""), x, y, { align });
      }
      function drawLabelValueRight(doc, label, value, rightX, y){
        setFont(doc, 9, false);
        text(doc, label, rightX, y, "right");
        setFont(doc, 9, true);
        // value aligned to right as well, slightly below label
        text(doc, value, rightX, y, "right");
      }

      // We override ONLY headerBlocks used by pdfInvoice in FIX36, by wrapping pdfInvoice and redrawing header with buyer at right edge.
      const prevPdfInvoice = window.pdfInvoice;
      if(typeof prevPdfInvoice !== "function") return;

      // Monkey patch: redefine pdfInvoice by copying FIX36 logic but changing header placement.
      window.pdfInvoice = function(inv){
        const JsPDF = ensureJsPDF();
        if(!JsPDF){ alert("jsPDF nu s-a încărcat (CDN)."); return; }

        const doc = new JsPDF({orientation:"p", unit:"pt", format:"a4"});
        const W = doc.internal.pageSize.getWidth();
        const left = 40, top = 40, right = W-40;
        const blockW = 240;

        const unit = (typeof window.getUnit === "function") ? (window.getUnit() || {}) : {};
        const seller = {
          name: unit.name || "POSHARD IMPEX S.R.L.",
          cui: unit.cui || "-",
          reg: unit.reg || "-",
          address: unit.address || "-"
        };
        const buyer = inv.client || {};
        const vatRate = Number(inv.vatRate ?? 0);

        // seller left
        let yL = top;
        setFont(doc,10,true); text(doc,"Furnizor:", left, yL); yL+=14;
        setFont(doc,10,true); text(doc,safe(seller.name), left, yL); yL+=12;
        setFont(doc,9,false); text(doc,"CUI:", left, yL); setFont(doc,9,true); text(doc,safe(seller.cui||"-"), left+54, yL); yL+=12;
        setFont(doc,9,false); text(doc,"Nr.ord.reg.com:", left, yL); setFont(doc,9,true); text(doc,safe(seller.reg||"-"), left+54, yL); yL+=12;
        setFont(doc,9,false); text(doc,"Sediu:", left, yL); setFont(doc,9,true); text(doc,safe(seller.address||"-"), left+54, yL); yL+=12;

        // buyer TOP-RIGHT aligned to page right edge (as requested)
        const bx = right; // align to right margin
        let yB = top;
        setFont(doc,10,true); text(doc,"Cumparator:", bx, yB, "right"); yB+=14;
        setFont(doc,10,true); text(doc,safe(buyer.name||"-"), bx, yB, "right"); yB+=12;

        setFont(doc,9,false); text(doc,"CUI:", bx - 120, yB, "left"); setFont(doc,9,true); text(doc,safe(buyer.cui||"-"), bx, yB, "right"); yB+=12;
        setFont(doc,9,false); text(doc,"Nr.ord.reg.com:", bx - 120, yB, "left"); setFont(doc,9,true); text(doc,safe(buyer.reg||buyer.orc||"-"), bx, yB, "right"); yB+=12;
        setFont(doc,9,false); text(doc,"Sediu:", bx - 120, yB, "left"); setFont(doc,9,true); text(doc,safe(buyer.address||"-"), bx, yB, "right"); yB+=12;

        // Title center
        const title = (inv.type === "FACTURA") ? "FACTURA" : "FACTURA PROFORMA";
        setFont(doc,22,true); text(doc,title, W/2, top+70, "center");
        setFont(doc,10,false);
        text(doc, `Seria: ${safe(inv.serie||"")} Nr. ${safe(inv.number||"")} din ${safe(inv.date||"")}`, W/2, top+92, "center");
        text(doc, `Termen de plata: ${safe(inv.dueDays ?? 0)} zile`, W/2, top+108, "center");
        text(doc, `Cota de TVA: ${vatRate || 0}%`, W/2, top+124, "center");

        // Reuse FIX36 internal helpers by calling previous function but after temporarily injecting doc? Not possible.
        // So we call the original pdfInvoice to render everything, but that would redraw header again.
        // Instead: we duplicate drawTable/drawFooter from FIX36 by calling globally available functions if present.
        // FIX36 defined them inside closure; not accessible. We'll implement minimal copies here (same as FIX36 widths).

        function toNum(v){
          if(typeof v === "number") return isFinite(v) ? v : 0;
          const s = (v ?? "").toString().trim().replace(/\s/g,"").replace(",", ".");
          const n = parseFloat(s);
          return isFinite(n) ? n : 0;
        }
        function money(n){
          const x = Number(n||0);
          return x.toLocaleString("ro-RO", { minimumFractionDigits:2, maximumFractionDigits:2 });
        }
        function rect(doc, x,y,w,h){ doc.rect(x,y,w,h); }
        function line(doc, x1,y1,x2,y2){ doc.line(x1,y1,x2,y2); }

        // Table (exact width fit 515)
        const cols = [
          {t:"Produs", w: 190, a:"left"},
          {t:"Cantitate", w: 60, a:"right"},
          {t:"Pret unitar", w: 70, a:"right"},
          {t:"Discount", w: 55, a:"right"},
          {t:"Valoare lei, fara TVA", w: 80, a:"right"},
          {t:"Valoare TVA", w: 60, a:"right"},
        ];
        const tableW = cols.reduce((s,c)=>s+c.w,0); // 515
        const x0 = left;
        const headerH = 24;
        const baseRowH = 22;
        let y = Math.max(yL, yB, top+140) + 26;

        function header(){
          rect(doc, x0, y, tableW, headerH);
          let xx = x0;
          for(const c of cols){
            line(doc, xx, y, xx, y+headerH);
            setFont(doc,9,true);
            text(doc, c.t, xx+4, y+16, "left");
            xx += c.w;
          }
          line(doc, x0+tableW, y, x0+tableW, y+headerH);
          y += headerH;
        }

        function row(values, rowH, bold=false){
          rect(doc, x0, y, tableW, rowH);
          let xx = x0;
          for(let i=0;i<cols.length;i++){
            const c = cols[i];
            line(doc, xx, y, xx, y+rowH);
            const pad = 4;
            setFont(doc,9,bold);
            if(i===0){
              const maxW = c.w - pad*2;
              const wrapped = doc.splitTextToSize(String(values[i]||""), maxW);
              for(let k=0;k<wrapped.length;k++){
                text(doc, wrapped[k], xx+pad, y+15 + k*10, "left");
              }
            }else{
              const align = c.a;
              const tx = (align==="right") ? (xx + c.w - pad) : (xx + pad);
              text(doc, String(values[i]||""), tx, y+15, align);
            }
            xx += c.w;
          }
          line(doc, x0+tableW, y, x0+tableW, y+rowH);
          y += rowH;
        }

        const pageH = doc.internal.pageSize.getHeight();
        function ensureSpace(needed){
          const footerReserve = 150;
          if(y + needed > pageH - footerReserve){
            doc.addPage();
            y = 40;
            header();
          }
        }

        header();

        const lines = Array.isArray(inv.lines) ? inv.lines : [];
        let net=0, vat=0, gross=0;

        if(lines.length===0){
          ensureSpace(baseRowH);
          row(["-","","","","",""], baseRowH, false);
        }else{
          for(const l of lines){
            const qty = toNum(l.qty ?? 0);
            const price = toNum(l.price ?? 0);
            const ln = qty*price;
            const lv = ln*(vatRate/100);
            net += ln; vat += lv; gross += (ln+lv);

            const prod = safe(l.name||"");
            const wrap = doc.splitTextToSize(prod, cols[0].w-8);
            const rowH = Math.max(baseRowH, 14 + wrap.length*10);
            ensureSpace(rowH);
            row([prod, String(qty), money(price), "-", money(ln), money(lv)], rowH, false);
          }
        }

        ensureSpace(baseRowH*3);
        row(["","","","", "Total, fara TVA", money(net)], baseRowH, true);
        row(["","","","", "Valoare TVA", money(vat)], baseRowH, true);
        row(["","","","", "Total de plata", money(gross)], baseRowH, true);

        // Footer
        let yF = y + 18;
        setFont(doc,10,false);
        text(doc, `Curs RON: ${safe(inv.fx ?? 1)}`, left, yF); yF += 18;

        const boxH = 70, gap = 16, boxW = (right-left-gap)/2;
        rect(doc, left, yF, boxW, boxH);
        rect(doc, left+boxW+gap, yF, boxW, boxH);

        setFont(doc,9,false);
        text(doc, "Factura circula fara semnatura si", left+10, yF+18);
        text(doc, "stampila conform art 319 alin. 29 din", left+10, yF+32);
        text(doc, "Codul Fiscal", left+10, yF+46);

        setFont(doc,9,true);
        text(doc, "Date privind expeditia", left+boxW+gap+10, yF+18);
        setFont(doc,9,false);
        text(doc, "Numele delegatului", left+boxW+gap+10, yF+32);
        text(doc, "Mijlocul de transport", left+boxW+gap+10, yF+46);
        text(doc, `Expedierea s-a efectuat la data de ${safe(inv.date||"")} ora 12:00`, left+boxW+gap+10, yF+60);

        const fn = `${(inv.type==="FACTURA"?"FACTURA":"PROFORMA")}_${safe(inv.serie||"")}_${safe(inv.number||"")}.pdf`.replace(/[^\w\-.]+/g,"_");
        doc.save(fn);
      };
    })();
    // ===== END FIX37 =====
  </script>


  <script>
    // ===== FIX38 PDF BUYER WRAP NO CUT (cumparator complet, fara taiere) =====
    (function(){
      function ensureJsPDF(){ return (window.jspdf && window.jspdf.jsPDF) ? window.jspdf.jsPDF : null; }
      function safe(s){ return (s||"").toString(); }
      function toNum(v){
        if(typeof v === "number") return isFinite(v) ? v : 0;
        const s = (v ?? "").toString().trim().replace(/\s/g,"").replace(",", ".");
        const n = parseFloat(s);
        return isFinite(n) ? n : 0;
      }
      function money(n){
        const x = Number(n||0);
        return x.toLocaleString("ro-RO", { minimumFractionDigits:2, maximumFractionDigits:2 });
      }
      function setFont(doc, size, bold=false){
        doc.setFont("helvetica", bold ? "bold" : "normal");
        doc.setFontSize(size);
      }
      function text(doc, s, x, y, align="left"){
        doc.text(String(s||""), x, y, { align });
      }
      function rect(doc, x,y,w,h){ doc.rect(x,y,w,h); }
      function line(doc, x1,y1,x2,y2){ doc.line(x1,y1,x2,y2); }

      // Final override of pdfInvoice: buyer block wraps within a fixed width, nothing is cut.
      window.pdfInvoice = function(inv){
        const JsPDF = ensureJsPDF();
        if(!JsPDF){ alert("jsPDF nu s-a încărcat (CDN)."); return; }

        const doc = new JsPDF({orientation:"p", unit:"pt", format:"a4"});
        const W = doc.internal.pageSize.getWidth();
        const H = doc.internal.pageSize.getHeight();
        const left = 40, top = 40, right = W-40;

        const unit = (typeof window.getUnit === "function") ? (window.getUnit() || {}) : {};
        const seller = {
          name: unit.name || "POSHARD IMPEX S.R.L.",
          cui: unit.cui || "-",
          reg: unit.reg || "-",
          address: unit.address || "-",

          capital: unit.capital || "",
          iban: unit.iban || "",
          bank: unit.bank || "",
          workPoint: unit.workPoint || ""
        };
        const buyer = inv.client || {};
        const vatRate = Number(inv.vatRate ?? 0);

        // SELLER (left) - keep compact, single lines (can be extended later)
        let yL = top;
        setFont(doc,10,true); text(doc,"Furnizor:", left, yL); yL+=14;
        setFont(doc,10,true); text(doc,safe(seller.name), left, yL); yL+=12;
        setFont(doc,9,false); text(doc,"CUI:", left, yL); setFont(doc,9,true); text(doc,safe(seller.cui||"-"), left+54, yL); yL+=12;
        setFont(doc,9,false); text(doc,"Nr.ord.reg.com:", left, yL); setFont(doc,9,true); text(doc,safe(seller.reg||"-"), left+54, yL); yL+=12;
        setFont(doc,9,false); text(doc,"Sediu:", left, yL); setFont(doc,9,true); text(doc,safe(seller.address||"-"), left+54, yL); yL+=12;

        // BUYER (top-right) with WRAP (no cut)
        const blockW = 250;                 // available width for buyer text
        const bxRight = right;              // align to right margin
        const bxLeft  = bxRight - blockW;   // left edge of buyer block
        let yB = top;

        setFont(doc,10,true); text(doc,"Cumparator:", bxRight, yB, "right"); yB += 14;

        // helper to draw label + wrapped value (right aligned)
        function labelValue(label, value){
          setFont(doc,9,false); text(doc, label, bxLeft, yB, "left");
          setFont(doc,9,true);
          const lines = doc.splitTextToSize(String(value||"-"), blockW-70); // value zone width
          // value starts after label zone, but right aligned to bxRight
          for(let i=0;i<lines.length;i++){
            text(doc, lines[i], bxRight, yB + i*11, "right");
          }
          yB += Math.max(12, lines.length*11);
        }

        // name (wrap, bold)
        setFont(doc,10,true);
        const nameLines = doc.splitTextToSize(String(buyer.name||"-"), blockW);
        for(let i=0;i<nameLines.length;i++){
          text(doc, nameLines[i], bxRight, yB + i*12, "right");
        }
        yB += Math.max(12, nameLines.length*12);

        labelValue("CUI:", safe(buyer.cui||"-"));
        labelValue("Nr.ord.reg.com:", safe(buyer.reg||buyer.orc||"-"));
        labelValue("Sediu:", safe(buyer.address||"-"));
        if(buyer.iban) labelValue("IBAN:", safe(buyer.iban));
        if(buyer.bank) labelValue("Banca:", safe(buyer.bank));

        // TITLE (center) – keep as before
        const title = (inv.type === "FACTURA") ? "FACTURA" : "FACTURA PROFORMA";
        setFont(doc,22,true); text(doc,title, W/2, top+70, "center");
        setFont(doc,10,false);
        text(doc, `Seria: ${safe(inv.serie||"")} Nr. ${safe(inv.number||"")} din ${safe(inv.date||"")}`, W/2, top+92, "center");
        text(doc, `Termen de plata: ${safe(inv.dueDays ?? 0)} zile`, W/2, top+108, "center");
        text(doc, `Cota de TVA: ${vatRate || 0}%`, W/2, top+124, "center");

        // ===== TABLE (same as FIX37/FIX36) =====
        const cols = [
          {t:"Produs", w: 190, a:"left"},
          {t:"Cantitate", w: 60, a:"right"},
          {t:"Pret unitar", w: 70, a:"right"},
          {t:"Discount", w: 55, a:"right"},
          {t:"Valoare lei, fara TVA", w: 80, a:"right"},
          {t:"Valoare TVA", w: 60, a:"right"},
        ];
        const tableW = cols.reduce((s,c)=>s+c.w,0); // 515
        const x0 = left;
        const headerH = 24;
        const baseRowH = 22;

        let y = Math.max(yL, yB, top+140) + 22;

        function header(){
          rect(doc, x0, y, tableW, headerH);
          let xx = x0;
          for(const c of cols){
            line(doc, xx, y, xx, y+headerH);
            setFont(doc,9,true);
            text(doc, c.t, xx+4, y+16, "left");
            xx += c.w;
          }
          line(doc, x0+tableW, y, x0+tableW, y+headerH);
          y += headerH;
        }

        function row(values, rowH, bold=false){
          rect(doc, x0, y, tableW, rowH);
          let xx = x0;
          for(let i=0;i<cols.length;i++){
            const c = cols[i];
            line(doc, xx, y, xx, y+rowH);
            const pad = 4;
            setFont(doc,9,bold);
            if(i===0){
              const maxW = c.w - pad*2;
              const wrapped = doc.splitTextToSize(String(values[i]||""), maxW);
              for(let k=0;k<wrapped.length;k++){
                text(doc, wrapped[k], xx+pad, y+15 + k*10, "left");
              }
            }else{
              const align = c.a;
              const tx = (align==="right") ? (xx + c.w - pad) : (xx + pad);
              text(doc, String(values[i]||""), tx, y+15, align);
            }
            xx += c.w;
          }
          line(doc, x0+tableW, y, x0+tableW, y+rowH);
          y += rowH;
        }

        const pageH = doc.internal.pageSize.getHeight();
        function ensureSpace(needed){
          const footerReserve = 150;
          if(y + needed > pageH - footerReserve){
            doc.addPage();
            y = 40;
            header();
          }
        }

        header();

        const lines = Array.isArray(inv.lines) ? inv.lines : [];
        let net=0, vat=0, gross=0;

        if(lines.length===0){
          ensureSpace(baseRowH);
          row(["-","","","","",""], baseRowH, false);
        }else{
          for(const l of lines){
            const qty = toNum(l.qty ?? 0);
            const price = toNum(l.price ?? 0);
            const ln = qty*price;
            const lv = ln*(vatRate/100);
            net += ln; vat += lv; gross += (ln+lv);

            const prod = safe(l.name||"");
            const wrap = doc.splitTextToSize(prod, cols[0].w-8);
            const rowH = Math.max(baseRowH, 14 + wrap.length*10);
            ensureSpace(rowH);
            row([prod, String(qty), money(price), "-", money(ln), money(lv)], rowH, false);
          }
        }

        ensureSpace(baseRowH*3);
        row(["","","","", "Total, fara TVA", money(net)], baseRowH, true);
        row(["","","","", "Valoare TVA", money(vat)], baseRowH, true);
        row(["","","","", "Total de plata", money(gross)], baseRowH, true);

        // Footer (same)
        let yF = y + 18;
        setFont(doc,10,false);
        text(doc, `Curs RON: ${safe(inv.fx ?? 1)}`, left, yF); yF += 18;

        const boxH = 70, gap = 16, boxW = (right-left-gap)/2;
        rect(doc, left, yF, boxW, boxH);
        rect(doc, left+boxW+gap, yF, boxW, boxH);

        setFont(doc,9,false);
        text(doc, "Factura circula fara semnatura si", left+10, yF+18);
        text(doc, "stampila conform art 319 alin. 29 din", left+10, yF+32);
        text(doc, "Codul Fiscal", left+10, yF+46);

        setFont(doc,9,true);
        text(doc, "Date privind expeditia", left+boxW+gap+10, yF+18, "left");
        setFont(doc,9,false);
        text(doc, "Numele delegatului", left+boxW+gap+10, yF+32, "left");
        text(doc, "Mijlocul de transport", left+boxW+gap+10, yF+46, "left");
        text(doc, `Expedierea s-a efectuat la data de ${safe(inv.date||"")} ora 12:00`, left+boxW+gap+10, yF+60, "left");

        const fn = `${(inv.type==="FACTURA"?"FACTURA":"PROFORMA")}_${safe(inv.serie||"")}_${safe(inv.number||"")}.pdf`.replace(/[^\w\-.]+/g,"_");
        doc.save(fn);
      };
    })();
    // ===== END FIX38 =====
  </script>


  <script>
    // ===== FIX39 PDF HEADER LIKE SAMPLE (furnizor stanga, cumparator dreapta, fara mizerie) =====
    (function(){
      function ensureJsPDF(){ return (window.jspdf && window.jspdf.jsPDF) ? window.jspdf.jsPDF : null; }
      function safe(s){ return (s||"").toString(); }
      function toNum(v){
        if(typeof v === "number") return isFinite(v) ? v : 0;
        const s = (v ?? "").toString().trim().replace(/\s/g,"").replace(",", ".");
        const n = parseFloat(s);
        return isFinite(n) ? n : 0;
      }
      function money(n){
        const x = Number(n||0);
        return x.toLocaleString("ro-RO", { minimumFractionDigits:2, maximumFractionDigits:2 });
      }
      function setFont(doc, size, bold=false){
        doc.setFont("helvetica", bold ? "bold" : "normal");
        doc.setFontSize(size);
      }
      function text(doc, s, x, y, align="left"){
        doc.text(String(s||""), x, y, { align });
      }
      function rect(doc, x,y,w,h){ doc.rect(x,y,w,h); }
      function line(doc, x1,y1,x2,y2){ doc.line(x1,y1,x2,y2); }

      // Override only invoice/proforma PDF rendering
      window.pdfInvoice = function(inv){
        const JsPDF = ensureJsPDF();
        if(!JsPDF){ alert("jsPDF nu s-a încărcat (CDN)."); return; }

        const doc = new JsPDF({orientation:"p", unit:"pt", format:"a4"});
        const W = doc.internal.pageSize.getWidth();
        const H = doc.internal.pageSize.getHeight();
        const left = 40, top = 40, right = W-40;

        const unit = (typeof window.getUnit === "function") ? (window.getUnit() || {}) : {};
        const seller = {
          name: unit.name || "POSHARD IMPEX S.R.L.",
          cui: unit.cui || "-",
          reg: unit.reg || "-",
          sediu: unit.address || "-",

          capital: unit.capital || "",
          iban: unit.iban || "",
          bank: unit.bank || "",
          workPoint: unit.workPoint || ""
        };
        const buyer = inv.client || {};
        const vatRate = Number(inv.vatRate ?? 0);

        // Blocks sizing like sample
        const blockW = 250;
        const gapMid = 20;
        const sellerX = left;
        const buyerX = right - blockW;

        // helper: label/value on same line (value can wrap under value column)
        function kvBlock(x, yStart, title, lines){
          let y = yStart;
          setFont(doc,10,true);
          text(doc, title, x, y);
          y += 14;

          const labelW = 88; // label column width inside block
          const valueX = x + labelW;
          const valueW = blockW - labelW;

          for(const it of lines){
            const label = it[0];
            const value = safe(it[1] ?? "-").trim() || "-";
            setFont(doc,9,false);
            text(doc, label, x, y);

            setFont(doc,9,true);
            const wrapped = doc.splitTextToSize(value, valueW);
            for(let i=0;i<wrapped.length;i++){
              text(doc, wrapped[i], valueX, y + i*11, "left");
            }
            y += Math.max(12, wrapped.length*11);
          }
          return y;
        }

        // SELLER left (more fields like sample)
        const ySellerEnd = kvBlock(sellerX, top, "Furnizor:", [
          ["", seller.name],
          ["CUI:", seller.cui],
          ["Nr.ord.reg.com:", seller.reg],
          ["Sediu:", seller.sediu],
          ["Judet:", seller.judet || "-"],
          ["Capital social:", seller.capital || "-"],
          ["IBAN:", seller.iban || "-"],
          ["Banca:", seller.bank || "-"],
          ["Punct de lucru:", seller.workPoint || "-"],
        ]);

        // BUYER right (fields like sample) - ensure it is fully visible, no cutting
        const yBuyerEnd = kvBlock(buyerX, top, "Cumparator:", [
          ["", buyer.name || "-"],
          ["CUI:", buyer.cui || "-"],
          ["Nr.ord.reg.com:", (buyer.reg || buyer.orc || "-")],
          ["Sediu:", buyer.address || "-"],
          ["Judet:", buyer.county || buyer.judet || "-"],
          ["IBAN:", buyer.iban || "-"],
          ["Banca:", buyer.bank || "-"],
        ]);

        // Title center (no overlap): start below top blocks if needed
        const headerBottom = Math.max(ySellerEnd, yBuyerEnd, top+140);
        const titleY = top + 82;
        const subY1 = top + 104;
        const subY2 = top + 120;
        const subY3 = top + 136;

        const title = (inv.type === "FACTURA") ? "FACTURA" : "FACTURA PROFORMA";
        setFont(doc,26,true);
        text(doc, title, W/2, titleY, "center");
        setFont(doc,10,false);
        text(doc, `Nr. ${safe(inv.number||"")} , din ${safe(inv.date||"")}`, W/2, subY1, "center");
        text(doc, `Termen de plata: ${safe(inv.dueDays ?? 0)} zile`, W/2, subY2, "center");
        text(doc, `Cota de TVA: ${vatRate || 0}%`, W/2, subY3, "center");

        // ===== TABLE (width fit A4 like FIX36) =====
        const cols = [
          {t:"Produs", w: 190, a:"left"},
          {t:"Cantitate", w: 60, a:"right"},
          {t:"Pret unitar", w: 70, a:"right"},
          {t:"Discount", w: 55, a:"right"},
          {t:"Valoare lei,\nfara TVA", w: 80, a:"right"},
          {t:"Valoare TVA", w: 60, a:"right"},
        ];
        const tableW = cols.reduce((s,c)=>s+c.w,0); // 515
        const x0 = left;
        const headerH = 30;
        const baseRowH = 22;

        let y = headerBottom + 30;
        // Ensure title doesn't collide with table
        y = Math.max(y, subY3 + 30);

        function header(){
          rect(doc, x0, y, tableW, headerH);
          let xx = x0;
          for(const c of cols){
            line(doc, xx, y, xx, y+headerH);
            setFont(doc,9,true);
            const lines = String(c.t).split("\n");
            for(let i=0;i<lines.length;i++){
              text(doc, lines[i], xx+4, y+14 + i*11, "left");
            }
            xx += c.w;
          }
          line(doc, x0+tableW, y, x0+tableW, y+headerH);
          y += headerH;
        }

        function row(values, rowH, bold=false){
          rect(doc, x0, y, tableW, rowH);
          let xx = x0;
          for(let i=0;i<cols.length;i++){
            const c = cols[i];
            line(doc, xx, y, xx, y+rowH);
            const pad = 4;
            setFont(doc,9,bold);
            if(i===0){
              const maxW = c.w - pad*2;
              const wrapped = doc.splitTextToSize(String(values[i]||""), maxW);
              for(let k=0;k<wrapped.length;k++){
                text(doc, wrapped[k], xx+pad, y+15 + k*10, "left");
              }
            }else{
              const align = c.a;
              const tx = (align==="right") ? (xx + c.w - pad) : (xx + pad);
              text(doc, String(values[i]||""), tx, y+15, align);
            }
            xx += c.w;
          }
          line(doc, x0+tableW, y, x0+tableW, y+rowH);
          y += rowH;
        }

        const pageH = doc.internal.pageSize.getHeight();
        function ensureSpace(needed){
          const footerReserve = 160;
          if(y + needed > pageH - footerReserve){
            doc.addPage();
            y = 40;
            header();
          }
        }

        header();

        const lines = Array.isArray(inv.lines) ? inv.lines : [];
        let net=0, vat=0, gross=0;

        if(lines.length===0){
          ensureSpace(baseRowH);
          row(["-","","","","",""], baseRowH, false);
        }else{
          for(const l of lines){
            const qty = toNum(l.qty ?? 0);
            const price = toNum(l.price ?? 0);
            const ln = qty*price;
            const lv = ln*(vatRate/100);
            net += ln; vat += lv; gross += (ln+lv);

            const prod = safe(l.name||"");
            const wrap = doc.splitTextToSize(prod, cols[0].w-8);
            const rowH = Math.max(baseRowH, 14 + wrap.length*10);
            ensureSpace(rowH);
            row([prod, String(qty), money(price), "-", money(ln), money(lv)], rowH, false);
          }
        }

        ensureSpace(baseRowH*3);
        row(["","","","", "Total, fara TVA", money(net)], baseRowH, true);
        row(["","","","", "Valoare TVA", money(vat)], baseRowH, true);
        row(["","","","", "Total de plata", money(gross)], baseRowH, true);

        // Footer
        let yF = y + 18;
        setFont(doc,10,false);
        text(doc, `Curs ${safe(inv.currency||"RON")}: ${safe(inv.fx ?? 1)}`, left, yF); yF += 18;

        const boxH = 70, gap = 16, boxW = (right-left-gap)/2;
        rect(doc, left, yF, boxW, boxH);
        rect(doc, left+boxW+gap, yF, boxW, boxH);

        setFont(doc,9,false);
        text(doc, "Factura circula fara semnatura si", left+10, yF+18);
        text(doc, "stampila conform art 319 alin. 29 din", left+10, yF+32);
        text(doc, "Codul Fiscal", left+10, yF+46);

        setFont(doc,9,true);
        text(doc, "Date privind expeditia", left+boxW+gap+10, yF+18, "left");
        setFont(doc,9,false);
        text(doc, "Numele delegatului", left+boxW+gap+10, yF+32, "left");
        text(doc, "Mijlocul de transport", left+boxW+gap+10, yF+46, "left");
        text(doc, `Expedierea s-a efectuat la data de ${safe(inv.date||"")} ora 12:00`, left+boxW+gap+10, yF+60, "left");

        const fn = `${(inv.type==="FACTURA"?"FACTURA":"PROFORMA")}_${safe(inv.serie||"")}_${safe(inv.number||"")}.pdf`.replace(/[^\w\-.]+/g,"_");
        doc.save(fn);
      };
    })();
    // ===== END FIX39 =====
  </script>


  <script>
    // ===== FIX40 PDF HEADER NO OVERLAP (cumparator NU mai intra in titlu; layout ca exemplu) =====
    (function(){
      function ensureJsPDF(){ return (window.jspdf && window.jspdf.jsPDF) ? window.jspdf.jsPDF : null; }
      function safe(s){ return (s||"").toString(); }
      function toNum(v){
        if(typeof v === "number") return isFinite(v) ? v : 0;
        const s = (v ?? "").toString().trim().replace(/\s/g,"").replace(",", ".");
        const n = parseFloat(s);
        return isFinite(n) ? n : 0;
      }
      function money(n){
        const x = Number(n||0);
        return x.toLocaleString("ro-RO", { minimumFractionDigits:2, maximumFractionDigits:2 });
      }
      function setFont(doc, size, bold=false){
        doc.setFont("helvetica", bold ? "bold" : "normal");
        doc.setFontSize(size);
      }
      function text(doc, s, x, y, align="left"){
        doc.text(String(s||""), x, y, { align });
      }
      function rect(doc, x,y,w,h){ doc.rect(x,y,w,h); }
      function line(doc, x1,y1,x2,y2){ doc.line(x1,y1,x2,y2); }

      window.pdfInvoice = function(inv){
        const JsPDF = ensureJsPDF();
        if(!JsPDF){ alert("jsPDF nu s-a încărcat (CDN)."); return; }

        const doc = new JsPDF({orientation:"p", unit:"pt", format:"a4"});
        const W = doc.internal.pageSize.getWidth();
        const left = 40, top = 40, right = W-40;

        const unit = (typeof window.getUnit === "function") ? (window.getUnit() || {}) : {};
        const seller = {
          name: unit.name || "POSHARD IMPEX S.R.L.",
          cui: unit.cui || "-",
          reg: unit.reg || "-",
          sediu: unit.address || "-",

          capital: unit.capital || "-",
          iban: unit.iban || "-",
          bank: unit.bank || "-",
          workPoint: unit.workPoint || "-"
        };
        const buyer = inv.client || {};
        const vatRate = Number(inv.vatRate ?? 0);

        // Layout constants (like sample: blocks up top, title below blocks)
        const blockW = 250;
        const sellerX = left;
        const buyerX = right - blockW;

        function kvBlock(x, yStart, title, rows){
          let y = yStart;
          setFont(doc,10,true);
          text(doc, title, x, y);
          y += 14;

          const labelW = 86;
          const valueX = x + labelW;
          const valueW = blockW - labelW;

          for(const [label, valueRaw, boldVal] of rows){
            const value = (safe(valueRaw).trim() || "-");
            setFont(doc,9,false);
            if(label) text(doc, label, x, y);

            setFont(doc,9, true); // value bold like example
            const wrapped = doc.splitTextToSize(value, valueW);
            for(let i=0;i<wrapped.length;i++){
              text(doc, wrapped[i], valueX, y + i*11, "left");
            }
            y += Math.max(12, wrapped.length*11);
          }
          return y;
        }

        // Seller block (left)
        const ySellerEnd = kvBlock(sellerX, top, "Furnizor:", [
          ["", seller.name, true],
          ["CUI:", seller.cui, true],
          ["Nr.ord.reg.com:", seller.reg, true],
          ["Sediu:", seller.sediu, true],
          ["Judet:", seller.judet, true],
          ["Capital social:", seller.capital, true],
          ["IBAN:", seller.iban, true],
          ["Banca:", seller.bank, true],
          ["Punct de lucru:", seller.workPoint, true],
        ]);

        // Buyer block (right) — stays strictly in its block (no overlap with title)
        const yBuyerEnd = kvBlock(buyerX, top, "Cumparator:", [
          ["", buyer.name || "-", true],
          ["CUI:", buyer.cui || "-", true],
          ["Nr.ord.reg.com:", (buyer.reg || buyer.orc || "-"), true],
          ["Sediu:", buyer.address || "-", true],
          ["Judet:", (buyer.county || buyer.judet || "-"), true],
          ["IBAN:", buyer.iban || "-", true],
          ["Banca:", buyer.bank || "-", true],
        ]);

        // Title area: ALWAYS below the taller of the two blocks (fix overlap)
        const blocksBottom = Math.max(ySellerEnd, yBuyerEnd);
        const titleTopGap = 18;
        const titleY = blocksBottom + titleTopGap + 26; // baseline of big title
        const sub1Y = titleY + 22;
        const sub2Y = sub1Y + 16;
        const sub3Y = sub2Y + 16;

        const title = (inv.type === "FACTURA") ? "FACTURA" : "FACTURA PROFORMA";
        setFont(doc,30,true);
        text(doc, title, W/2, titleY, "center");

        setFont(doc,10,false);
        // In sample: "Nr. 3222, din 23-01-2026"
        text(doc, `Nr. ${safe(inv.number||"")} , din ${safe(inv.date||"")}`, W/2, sub1Y, "center");
        text(doc, `Termen de plata: ${safe(inv.dueDays ?? 0)} zile`, W/2, sub2Y, "center");
        text(doc, `Cota de TVA: ${vatRate || 0}%`, W/2, sub3Y, "center");

        // ===== TABLE (A4 fit) =====
        const cols = [
          {t:"Produs", w: 190, a:"left"},
          {t:"Cantitate", w: 60, a:"right"},
          {t:"Pret unitar", w: 70, a:"right"},
          {t:"Discount", w: 55, a:"right"},
          {t:"Valoare lei,\nfara TVA", w: 80, a:"right"},
          {t:"Valoare TVA", w: 60, a:"right"},
        ];
        const tableW = cols.reduce((s,c)=>s+c.w,0); // 515
        const x0 = left;
        const headerH = 30;
        const baseRowH = 22;

        let y = sub3Y + 26;

        function header(){
          rect(doc, x0, y, tableW, headerH);
          let xx = x0;
          for(const c of cols){
            line(doc, xx, y, xx, y+headerH);
            setFont(doc,9,true);
            const lines = String(c.t).split("\n");
            for(let i=0;i<lines.length;i++){
              text(doc, lines[i], xx+4, y+14 + i*11, "left");
            }
            xx += c.w;
          }
          line(doc, x0+tableW, y, x0+tableW, y+headerH);
          y += headerH;
        }

        function row(values, rowH, bold=false){
          rect(doc, x0, y, tableW, rowH);
          let xx = x0;
          for(let i=0;i<cols.length;i++){
            const c = cols[i];
            line(doc, xx, y, xx, y+rowH);
            const pad = 4;
            setFont(doc,9,bold);
            if(i===0){
              const maxW = c.w - pad*2;
              const wrapped = doc.splitTextToSize(String(values[i]||""), maxW);
              for(let k=0;k<wrapped.length;k++){
                text(doc, wrapped[k], xx+pad, y+15 + k*10, "left");
              }
            }else{
              const align = c.a;
              const tx = (align==="right") ? (xx + c.w - pad) : (xx + pad);
              text(doc, String(values[i]||""), tx, y+15, align);
            }
            xx += c.w;
          }
          line(doc, x0+tableW, y, x0+tableW, y+rowH);
          y += rowH;
        }

        const pageH = doc.internal.pageSize.getHeight();
        function ensureSpace(needed){
          const footerReserve = 170;
          if(y + needed > pageH - footerReserve){
            doc.addPage();
            y = 40;
            header();
          }
        }

        header();

        const linesArr = Array.isArray(inv.lines) ? inv.lines : [];
        let net=0, vat=0, gross=0;

        if(linesArr.length===0){
          ensureSpace(baseRowH);
          row(["-","","","","",""], baseRowH, false);
        }else{
          for(const l of linesArr){
            const qty = toNum(l.qty ?? 0);
            const price = toNum(l.price ?? 0);
            const ln = qty*price;
            const lv = ln*(vatRate/100);
            net += ln; vat += lv; gross += (ln+lv);

            const prod = safe(l.name||"");
            const wrap = doc.splitTextToSize(prod, cols[0].w-8);
            const rowH = Math.max(baseRowH, 14 + wrap.length*10);
            ensureSpace(rowH);
            row([prod, String(qty), money(price), "-", money(ln), money(lv)], rowH, false);
          }
        }

        ensureSpace(baseRowH*2);
        // Totals like sample: show Total fara TVA + Total de plata (optional TVA line)
        row(["","","","", "Total, fara TVA", money(net)], baseRowH, true);
        row(["","","","", "Valoare TVA", money(vat)], baseRowH, true);
        row(["","","","", "Total de plata", money(gross)], baseRowH, true);

        // Footer boxes
        let yF = y + 18;
        setFont(doc,10,false);
        text(doc, `Curs ${safe(inv.currency||"RON")}: ${safe(inv.fx ?? 1)}`, left, yF); yF += 18;

        const boxH = 70, gap = 16, boxW = (right-left-gap)/2;
        rect(doc, left, yF, boxW, boxH);
        rect(doc, left+boxW+gap, yF, boxW, boxH);

        setFont(doc,9,false);
        text(doc, "Factura circula fara semnatura si", left+10, yF+18);
        text(doc, "stampila conform art 319 alin. 29 din", left+10, yF+32);
        text(doc, "Codul Fiscal", left+10, yF+46);

        setFont(doc,9,true);
        text(doc, "Date privind expeditia", left+boxW+gap+10, yF+18, "left");
        setFont(doc,9,false);
        text(doc, "Numele delegatului", left+boxW+gap+10, yF+32, "left");
        text(doc, "Mijlocul de transport", left+boxW+gap+10, yF+46, "left");
        text(doc, `Expedierea s-a efectuat la data de ${safe(inv.date||"")} ora 12:00`, left+boxW+gap+10, yF+60, "left");

        const fn = `${(inv.type==="FACTURA"?"FACTURA":"PROFORMA")}_${safe(inv.serie||"")}_${safe(inv.number||"")}.pdf`.replace(/[^\w\-.]+/g,"_");
        doc.save(fn);
      };
    })();
    // ===== END FIX40 =====
  </script>


  <script>
    // ===== FIX41 PDF INVOICE CLEAN LOOK (layout frumos: vanzator stanga, cumparator dreapta, titlu centru, tabel aliniat) =====
    (function(){
      function ensureJsPDF(){ return (window.jspdf && window.jspdf.jsPDF) ? window.jspdf.jsPDF : null; }
      function safe(s){ return (s||"").toString(); }
      function toNum(v){
        if(typeof v === "number") return isFinite(v) ? v : 0;
        const s = (v ?? "").toString().trim().replace(/\s/g,"").replace(",", ".");
        const n = parseFloat(s);
        return isFinite(n) ? n : 0;
      }
      function money(n){
        const x = Number(n||0);
        return x.toLocaleString("ro-RO", { minimumFractionDigits:2, maximumFractionDigits:2 });
      }
      function setFont(doc, size, bold=false){
        doc.setFont("helvetica", bold ? "bold" : "normal");
        doc.setFontSize(size);
      }
      function text(doc, s, x, y, align="left"){
        doc.text(String(s||""), x, y, { align });
      }
      function rect(doc, x,y,w,h){ doc.rect(x,y,w,h); }
      function line(doc, x1,y1,x2,y2){ doc.line(x1,y1,x2,y2); }

      function drawKVBlock(doc, x, y, w, title, rows){
        // rows: [label, value]
        let yy = y;
        setFont(doc, 10, true);
        text(doc, title, x, yy);
        yy += 14;

        const labelW = 78;
        const valueX = x + labelW;
        const valueW = w - labelW;

        for(const [label, valueRaw] of rows){
          const labelTxt = safe(label);
          const valueTxt = (safe(valueRaw).trim() || "-");

          setFont(doc, 8.8, false);
          text(doc, labelTxt, x, yy);

          setFont(doc, 8.8, true);
          const wrapped = doc.splitTextToSize(valueTxt, valueW);
          for(let i=0;i<wrapped.length;i++){
            text(doc, wrapped[i], valueX, yy + i*10.5, "left");
          }
          yy += Math.max(11, wrapped.length*10.5);
        }
        return yy;
      }

      function centerWrapped(doc, s, centerX, y, maxW, size, bold){
        setFont(doc, size, !!bold);
        const lines = doc.splitTextToSize(String(s||""), maxW);
        for(let i=0;i<lines.length;i++){
          text(doc, lines[i], centerX, y + i*(size+2), "center");
        }
        return y + lines.length*(size+2);
      }

      // FINAL: override invoice/proforma PDF only
      window.pdfInvoice = function(inv){
        const JsPDF = ensureJsPDF();
        if(!JsPDF){ alert("jsPDF nu s-a încărcat (CDN)."); return; }

        const doc = new JsPDF({orientation:"p", unit:"pt", format:"a4"});
        const W = doc.internal.pageSize.getWidth();
        const H = doc.internal.pageSize.getHeight();
        const margin = 40;
        const left = margin, right = W - margin;
        const top = 36;

        const unit = (typeof window.getUnit === "function") ? (window.getUnit() || {}) : {};
        const seller = {
          name: unit.name || "POSHARD IMPEX S.R.L.",
          cui: unit.cui || "-",
          reg: unit.reg || "-",
          address: unit.address || "-",

          capital: unit.capital || "-",
          iban: unit.iban || "-",
          bank: unit.bank || "-",
          workPoint: unit.workPoint || "-"
        };
        const buyer = inv.client || {};
        const vatRate = Number(inv.vatRate ?? 0);

        // Header layout zones (like your sample)
        const sideW = 205;                 // left/right blocks width
        const centerW = (right-left) - sideW*2; // center zone width
        const sellerX = left;
        const buyerX  = right - sideW;
        const centerX = left + sideW + centerW/2;

        // Left block (Seller)
        const ySellerEnd = drawKVBlock(doc, sellerX, top, sideW, "Furnizor:", [
          ["", seller.name],
          ["CUI:", seller.cui],
          ["Nr.ord.reg.com:", seller.reg],
          ["Sediu:", seller.address],
          ["Judet:", seller.judet],
          ["Capital social:", seller.capital],
          ["IBAN:", seller.iban],
          ["Banca:", seller.bank],
          ["Punct de lucru:", seller.workPoint],
        ]);

        // Right block (Buyer)
        const yBuyerEnd = drawKVBlock(doc, buyerX, top, sideW, "Cumparator:", [
          ["", buyer.name || "-"],
          ["CUI:", buyer.cui || "-"],
          ["Nr.ord.reg.com:", (buyer.reg || buyer.orc || "-")],
          ["Sediu:", buyer.address || "-"],
          ["Judet:", (buyer.county || buyer.judet || "-")],
          ["IBAN:", buyer.iban || "-"],
          ["Banca:", buyer.bank || "-"],
        ]);

        // Center title (kept strictly inside center zone, no overlap with side blocks)
        const title = (inv.type === "FACTURA") ? "FACTURA" : "FACTURA PROFORMA";
        const titleY = top + 54; // visually centered between blocks
        const titleBottom = centerWrapped(doc, title, centerX, titleY, centerW, 28, true);

        let yC = titleBottom + 6;
        yC = centerWrapped(doc, `Nr. ${safe(inv.number||"")} , din ${safe(inv.date||"")}`, centerX, yC, centerW, 10, false);
        yC = centerWrapped(doc, `Termen de plata: ${safe(inv.dueDays ?? 0)} zile`, centerX, yC, centerW, 10, false);
        yC = centerWrapped(doc, `Cota de TVA: ${vatRate || 0}%`, centerX, yC, centerW, 10, false);

        // Determine header bottom (table must start below all header content)
        const headerBottom = Math.max(ySellerEnd, yBuyerEnd, yC) + 18;

        // ===== TABLE (A4 fit, aligned, clean) =====
        const cols = [
          {t:"Produs", w: 190, a:"left"},
          {t:"Cantitate", w: 60, a:"right"},
          {t:"Pret unitar", w: 70, a:"right"},
          {t:"Discount", w: 55, a:"right"},
          {t:"Valoare lei,\nfara TVA", w: 80, a:"right"},
          {t:"Valoare TVA", w: 60, a:"right"},
        ];
        const tableW = cols.reduce((s,c)=>s+c.w,0); // 515
        const x0 = left;
        const headerH = 30;
        const baseRowH = 22;
        let y = headerBottom;

        function header(){
          rect(doc, x0, y, tableW, headerH);
          let xx = x0;
          for(const c of cols){
            line(doc, xx, y, xx, y+headerH);
            setFont(doc,9,true);
            const lines = String(c.t).split("\n");
            for(let i=0;i<lines.length;i++){
              text(doc, lines[i], xx+4, y+14 + i*11, "left");
            }
            xx += c.w;
          }
          line(doc, x0+tableW, y, x0+tableW, y+headerH);
          y += headerH;
        }

        function row(values, rowH, bold=false){
          rect(doc, x0, y, tableW, rowH);
          let xx = x0;
          for(let i=0;i<cols.length;i++){
            const c = cols[i];
            line(doc, xx, y, xx, y+rowH);
            const pad = 4;
            setFont(doc,9,bold);
            if(i===0){
              const maxW = c.w - pad*2;
              const wrapped = doc.splitTextToSize(String(values[i]||""), maxW);
              for(let k=0;k<wrapped.length;k++){
                text(doc, wrapped[k], xx+pad, y+15 + k*10, "left");
              }
            }else{
              const align = c.a;
              const tx = (align==="right") ? (xx + c.w - pad) : (xx + pad);
              text(doc, String(values[i]||""), tx, y+15, align);
            }
            xx += c.w;
          }
          line(doc, x0+tableW, y, x0+tableW, y+rowH);
          y += rowH;
        }

        function ensureSpace(needed){
          const footerReserve = 170;
          const pageH = doc.internal.pageSize.getHeight();
          if(y + needed > pageH - footerReserve){
            doc.addPage();
            y = 40;
            header();
          }
        }

        header();

        const arr = Array.isArray(inv.lines) ? inv.lines : [];
        let net=0, vat=0, gross=0;

        if(arr.length===0){
          ensureSpace(baseRowH);
          row(["-","","","","",""], baseRowH, false);
        }else{
          for(const l of arr){
            const qty = toNum(l.qty ?? 0);
            const price = toNum(l.price ?? 0);
            const ln = qty*price;
            const lv = ln*(vatRate/100);
            net += ln; vat += lv; gross += (ln+lv);

            const prod = safe(l.name||"");
            const wrap = doc.splitTextToSize(prod, cols[0].w-8);
            const rowH = Math.max(baseRowH, 14 + wrap.length*10);
            ensureSpace(rowH);
            row([prod, String(qty), money(price), "-", money(ln), money(lv)], rowH, false);
          }
        }

        ensureSpace(baseRowH*3);
        row(["","","","", "Total, fara TVA", money(net)], baseRowH, true);
        row(["","","","", "Valoare TVA", money(vat)], baseRowH, true);
        row(["","","","", "Total de plata", money(gross)], baseRowH, true);

        // Footer (clean)
        let yF = y + 18;
        setFont(doc,10,false);
        text(doc, `Curs ${safe(inv.currency||"RON")}: ${safe(inv.fx ?? 1)}`, left, yF); yF += 18;

        const boxH = 70, gap = 16, boxW = (right-left-gap)/2;
        rect(doc, left, yF, boxW, boxH);
        rect(doc, left+boxW+gap, yF, boxW, boxH);

        setFont(doc,9,false);
        text(doc, "Factura circula fara semnatura si", left+10, yF+18);
        text(doc, "stampila conform art 319 alin. 29 din", left+10, yF+32);
        text(doc, "Codul Fiscal", left+10, yF+46);

        setFont(doc,9,true);
        text(doc, "Date privind expeditia", left+boxW+gap+10, yF+18, "left");
        setFont(doc,9,false);
        text(doc, "Numele delegatului", left+boxW+gap+10, yF+32, "left");
        text(doc, "Mijlocul de transport", left+boxW+gap+10, yF+46, "left");
        text(doc, `Expedierea s-a efectuat la data de ${safe(inv.date||"")} ora 12:00`, left+boxW+gap+10, yF+60, "left");

        const fn = `${(inv.type==="FACTURA"?"FACTURA":"PROFORMA")}_${safe(inv.serie||"")}_${safe(inv.number||"")}.pdf`.replace(/[^\w\-.]+/g,"_");
        doc.save(fn);
      };
    })();
    // ===== END FIX41 =====
  </script>


  <script>
    // ===== FIX42 CONFIG SOCIETATE REUSE CLIENT MODAL (fara bife Client/Furnizor) =====
    (function(){
      const qs = (s,p=document)=>p.querySelector(s);

      // modal close helper (local)
      function closeBackdrop(id){
        const el = qs("#"+id);
        if(!el) return;
        el.classList.remove("show");
        el.setAttribute("aria-hidden","true");
        document.body.style.overflow = "";
      }

      // Ensure we have getUnit/setUnit from main app
      if(typeof window.getUnit !== "function" || typeof window.setUnit !== "function"){
        // don't break anything if not present
        return;
      }

      // Expose handler used by drawer click routing (SETARI -> CONFIGURARE SOCIETATE)
      window.__openCompanyConfig = function(){
        // open existing client modal in "company" mode
        if(typeof window.openClientModal !== "function"){
          alert("Fereastra client nu este încă disponibilă.");
          return;
        }
        window.__cfMode = "company";
        window.openClientModal({ subtitle: "Societate", mode: "company" });

        // Prefill with unit data
        const u = window.getUnit() || {};
        try{
          const cfName = qs("#cfName");
          const cfCui = qs("#cfCui");
          const cfOrc = qs("#cfOrc");
          const cfAddress = qs("#cfAddress");
          const cfCounty = qs("#cfCounty");
          const cfCapital = qs("#cfCapital");
          const cfWorkPoint = qs("#cfWorkPoint");
          const cfBankRows = qs("#cfBankRows");

          if(cfName) cfName.value = u.name || "";
          if(cfCui) cfCui.value = u.cui || "";
          if(cfOrc) cfOrc.value = u.reg || "";
          if(cfAddress) cfAddress.value = u.address || "";
          if(cfCounty) cfCounty.value = u.county || "";
          if(cfCapital) cfCapital.value = (u.capital ?? "");
          if(cfWorkPoint) cfWorkPoint.value = u.workPoint || "";

          // bank accounts: keep first row as main
          if(cfBankRows){
            cfBankRows.innerHTML = "";
            const accs = Array.isArray(u.bankAccounts) ? u.bankAccounts : [];
            const main = accs[0] || { bank: u.bank || "", iban: u.iban || "" };
            if((main.bank||"").trim() || (main.iban||"").trim()){
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${String(main.bank||"").replace(/</g,"&lt;")}</td>
                <td>${String(main.iban||"").replace(/</g,"&lt;")}</td>
                <td style="text-align:right;"><button type="button" class="btn btn-danger btnDelBank">Șterge</button></td>
              `;
              tr.querySelector(".btnDelBank").addEventListener("click", ()=>tr.remove());
              cfBankRows.appendChild(tr);
            }
          }
        }catch{}
      };

      // Hide Client/Furnizor/VAT cash row when in company mode
      function syncRoleRow(){
        const isClient = qs("#cfIsClient");
        if(!isClient) return;
        const row = isClient.closest(".row");
        if(!row) return;
        row.style.display = (window.__cfMode === "company") ? "none" : "flex";
      }

      // Wrap openClientModal to set mode and hide/show row
      const origOpen = window.openClientModal;
      if(typeof origOpen === "function" && !window.__openClientModalWrapped){
        window.__openClientModalWrapped = true;
        window.openClientModal = function(opts={}){
          window.__cfMode = opts.mode || "client";
          const res = origOpen(opts);
          // after open, update visibility
          setTimeout(syncRoleRow, 0);
          return res;
        };
      }

      // Intercept SAVE in capture phase when mode=company and save to SETTINGS (unit) only
      const btnSave = qs("#btnSaveClientFull");
      if(btnSave && !btnSave.__companyHooked){
        btnSave.__companyHooked = true;
        btnSave.addEventListener("click", function(e){
          if(window.__cfMode !== "company") return; // let normal save run
          e.preventDefault();
          e.stopImmediatePropagation();

          const cfName = qs("#cfName");
          const cfCui = qs("#cfCui");
          const cfOrc = qs("#cfOrc");
          const cfAddress = qs("#cfAddress");
          const cfCounty = qs("#cfCounty");
          const cfCapital = qs("#cfCapital");
          const cfWorkPoint = qs("#cfWorkPoint");
          const cfBankRows = qs("#cfBankRows");

          const name = (cfName?.value||"").trim();
          if(!name){
            alert("Denumirea este obligatorie.");
            try{ cfName.focus(); }catch{}
            return;
          }

          // take first bank row as main
          let bank = "", iban = "", bankAccounts = [];
          if(cfBankRows){
            bankAccounts = [...cfBankRows.querySelectorAll("tr")].map(tr=>({
              bank: (tr.children[0]?.textContent||"").trim(),
              iban: (tr.children[1]?.textContent||"").trim()
            }));
            if(bankAccounts[0]){
              bank = bankAccounts[0].bank || "";
              iban = bankAccounts[0].iban || "";
            }
          }

          const u = {
            ...(window.getUnit()||{}),
            name,
            cui: (cfCui?.value||"").trim(),
            reg: (cfOrc?.value||"").trim(),
            address: (cfAddress?.value||"").trim(),

            capital: (cfCapital?.value==="" ? "" : (cfCapital?.value||"")),
            workPoint: (cfWorkPoint?.value||"").trim(),
            bank,
            iban,
            bankAccounts
          };

          window.setUnit(u);
          closeBackdrop("clientFullBackdrop");
        }, true);
      }
    })();
    // ===== END FIX42 =====
  </script>


  <script>
    // ===== FIX43 CONFIG SOCIETATE OPEN WORKS (deschide sigur fereastra, fara bife Client/Furnizor) =====
    (function(){
      const qs = (s,p=document)=>p.querySelector(s);
      const qsa = (s,p=document)=>[...p.querySelectorAll(s)];

      function closeDrawer(){
        qs("#drawer")?.classList.remove("show");
        qs("#backdrop")?.classList.remove("show");
      }
      function hideCompanyModalIfAny(){
        qs("#companyConfigBackdrop")?.classList.remove("show");
        qs("#companyConfigBackdrop")?.setAttribute("aria-hidden","true");
      }
      function openBackdrop(id){
        const el = qs("#"+id);
        if(!el) return false;
        el.classList.add("show");
        el.setAttribute("aria-hidden","false");
        document.body.style.overflow = "hidden";
        return true;
      }
      function closeBackdrop(id){
        const el = qs("#"+id);
        if(!el) return;
        el.classList.remove("show");
        el.setAttribute("aria-hidden","true");
        document.body.style.overflow = "";
      }

      // Persist helpers (use same key as earlier fixes if present)
      function getJSON(key, fallback){
        try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }catch{ return fallback; }
      }
      function setJSON(key, val){
        try{ localStorage.setItem(key, JSON.stringify(val)); }catch{}
      }

      // Hide role row (Client/Furnizor/TVA) inside client modal when configuring company
      function hideRoleRow(){
        const row = qs("#cfIsClient")?.closest(".row");
        if(row) row.style.display = "none";
      }

      // Fill client modal fields with companyProfile (preferred) or unit
      function fillCompanyIntoClientModal(){
        const company = getJSON("companyProfile", null);
        const unit = (typeof window.getUnit === "function") ? (window.getUnit() || {}) : {};
        const base = company || unit || {};

        const setVal = (id, v)=>{ const el = qs(id); if(el) el.value = (v ?? ""); };

        setVal("#cfName", base.name || "");
        setVal("#cfCui", base.cui || "");
        setVal("#cfOrc", base.reg || base.orc || "");
        setVal("#cfAddress", base.address || "");
        setVal("#cfCounty", base.county || base.judet || "");
        setVal("#cfCapital", base.capital || "");
        setVal("#cfWorkPoint", base.workPoint || "");

        // bank table (if exists)
        const tbody = qs("#cfBankRows");
        if(tbody){
          tbody.innerHTML = "";
          const accs = Array.isArray(base.bankAccounts) ? base.bankAccounts : [];
          const main = accs[0] || { bank: base.bank || "", iban: base.iban || "" };
          if((main.bank||"").trim() || (main.iban||"").trim()){
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${String(main.bank||"").replace(/</g,"&lt;")}</td>
              <td>${String(main.iban||"").replace(/</g,"&lt;")}</td>
              <td style="text-align:right;"><button type="button" class="btn btn-danger btnDelBank">Șterge</button></td>
            `;
            tr.querySelector(".btnDelBank").addEventListener("click", ()=>tr.remove());
            tbody.appendChild(tr);
          }
        }
      }

      // Save from client modal into companyProfile, then close
      function saveCompanyFromClientModal(){
        const name = (qs("#cfName")?.value||"").trim();
        if(!name){ alert("Denumirea este obligatorie."); qs("#cfName")?.focus(); return false; }

        const tbody = qs("#cfBankRows");
        let bankAccounts = [];
        if(tbody){
          bankAccounts = [...tbody.querySelectorAll("tr")].map(tr=>({
            bank: (tr.children[0]?.textContent||"").trim(),
            iban: (tr.children[1]?.textContent||"").trim()
          }));
        }
        const main = bankAccounts[0] || {};
        const payload = {
          name,
          cui: (qs("#cfCui")?.value||"").trim(),
          reg: (qs("#cfOrc")?.value||"").trim(),
          address: (qs("#cfAddress")?.value||"").trim(),


          country: (qs("#cfCountry")?.value||"").trim() || "ROMÂNIA",

          capital: (qs("#cfCapital")?.value||"").trim(),
          workPoint: (qs("#cfWorkPoint")?.value||"").trim(),
          bank: (main.bank||"").trim(),
          iban: (main.iban||"").trim(),
          bankAccounts
        };
        setJSON("companyProfile", payload);
        // keep unit in sync if setUnit exists
        if(typeof window.setUnit === "function"){
          const u = window.getUnit ? (window.getUnit()||{}) : {};
          window.setUnit({ ...u, ...payload });
        }
        closeBackdrop("clientFullBackdrop");
        return true;
      }

      // Hard override opener used by existing click router
      window.__openCompanyConfig = function(){
        closeDrawer();
        hideCompanyModalIfAny();

        // If app exposes openClientModal, use it; else open backdrop directly
        if(typeof window.openClientModal === "function"){
          window.__cfMode = "company";
          window.openClientModal({ subtitle:"Societate", mode:"company" });
        }else{
          // fallback: direct open if modal exists
          openBackdrop("clientFullBackdrop");
        }
        // after opening, hide role row + fill values
        setTimeout(()=>{
          hideRoleRow();
          fillCompanyIntoClientModal();
        }, 0);
      };

      // Intercept save button in capture phase when company mode
      const btnSave = qs("#btnSaveClientFull");
      if(btnSave && !btnSave.__companyHookedFix43){
        btnSave.__companyHookedFix43 = true;
        btnSave.addEventListener("click", function(e){
          if(window.__cfMode !== "company") return;
          e.preventDefault(); e.stopImmediatePropagation();
          saveCompanyFromClientModal();
        }, true);
      }

      // Ensure close actions reset mode
      const closeBtn = qs("#clientFullClose");
      if(closeBtn && !closeBtn.__fix43){
        closeBtn.__fix43 = true;
        closeBtn.addEventListener("click", ()=>{ window.__cfMode = "client"; }, true);
      }
      const cancelBtn = qs("#btnCancelClientFull");
      if(cancelBtn && !cancelBtn.__fix43){
        cancelBtn.__fix43 = true;
        cancelBtn.addEventListener("click", ()=>{ window.__cfMode = "client"; }, true);
      }
    })();
    // ===== END FIX43 =====
  </script>


  <script>
    // ===== FIX44 UNIT FROM COMPANYPRO// (eliminat) FILE EVERYWHERE block removed to avoid side-effects

    // ===== END FIX44 =====
  </script>


  <script>
    // ===== FIX45 CONFIG SOCIETATE KEEP DATA AFTER SAVE (nu inchide, nu salveaza la clienti/furnizori) =====
    (function(){
      const qs = (s,p=document)=>p.querySelector(s);

      function getJSON(key, fallback){
        try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }catch{ return fallback; }
      }
      function setJSON(key, val){
        try{ localStorage.setItem(key, JSON.stringify(val)); }catch{}
      }

      // Save societate strictly to companyProfile (+ unit), keep modal open
      function saveSocietateFromModal(){
        const name = (qs("#cfName")?.value||"").trim();
        if(!name){
          alert("Denumirea este obligatorie.");
          qs("#cfName")?.focus();
          return false;
        }

        const tbody = qs("#cfBankRows");
        let bankAccounts = [];
        if(tbody){
          bankAccounts = [...tbody.querySelectorAll("tr")].map(tr=>({
            bank: (tr.children[0]?.textContent||"").trim(),
            iban: (tr.children[1]?.textContent||"").trim()
          }));
        }
        const main = bankAccounts[0] || {};

        const payload = {
          name,
          cui: (qs("#cfCui")?.value||"").trim(),
          reg: (qs("#cfOrc")?.value||"").trim(),
          address: (qs("#cfAddress")?.value||"").trim(),


          country: (qs("#cfCountry")?.value||"").trim() || "ROMÂNIA",

          capital: (qs("#cfCapital")?.value||"").trim(),
          workPoint: (qs("#cfWorkPoint")?.value||"").trim(),
          bank: (main.bank||"").trim(),
          iban: (main.iban||"").trim(),
          bankAccounts
        };

        // IMPORTANT: only these two stores; NOTHING to clienti/furnizori
        setJSON("companyProfile", payload);
        if(typeof window.setUnit === "function"){
          const u = (typeof window.getUnit === "function") ? (window.getUnit()||{}) : {};
          window.setUnit({ ...u, ...payload });
        }

        // keep modal open; just notify
        // if your UI already has a toast function, use it; else alert quietly
        if(typeof window.toast === "function"){
          window.toast("Datele societății au fost salvate.");
        }else{
          // unobtrusive: small inline hint if exists, else alert
          const hint = qs("#cfSaveHint");
          if(hint){ hint.textContent = "Salvat."; }
          else alert("Datele societății au fost salvate.");
        }
        return true;
      }

      // Force-intercept SAVE in capture phase when mode=company
      const btnSave = qs("#btnSaveClientFull");
      if(btnSave && !btnSave.__fix45SocietateHook){
        btnSave.__fix45SocietateHook = true;
        btnSave.addEventListener("click", function(e){
          if(window.__cfMode !== "company") return; // normal behavior for client/furnizor
          e.preventDefault();
          e.stopImmediatePropagation();
          saveSocietateFromModal();
        }, true);
      }

      // Ensure that opening societate mode does NOT switch to client/furnizor saving
      const origOpenCompany = window.__openCompanyConfig;
      if(typeof origOpenCompany === "function" && !window.__fix45OpenWrapped){
        window.__fix45OpenWrapped = true;
        window.__openCompanyConfig = function(){
          window.__cfMode = "company";
          return origOpenCompany();
        };
      }

      // Optional: add a small placeholder element for non-alert feedback (only if container exists)
      // (does not change layout if missing)
    })();
    // ===== END FIX45 =====
  </script>


  <script>
    // ===== FIX46 CONFIG SOCIETATE STRICT (NU salveaza la clienti/furnizori; pastreaza TOT; folosit ca VANZATOR) =====
    (function(){
      const qs = (s,p=document)=>p.querySelector(s);

      function getJSON(key, fallback){
        try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }catch{ return fallback; }
      }
      function setJSON(key, val){
        try{ localStorage.setItem(key, JSON.stringify(val)); }catch{}
      }

      // Always use companyProfile as seller data in documents (vanzator)
      const prevGetUnit = (typeof window.getUnit === "function") ? window.getUnit : null;
      window.getUnit = function(){
        const base = prevGetUnit ? (prevGetUnit() || {}) : {};
        const cp = getJSON("companyProfile", null);
        if(!cp) return base;
        // companyProfile wins
        const merged = { ...base, ...cp };
        // normalize
        if(merged.orc && !merged.reg) merged.reg = merged.orc;
        if(merged.reg && !merged.orc) merged.orc = merged.reg;
        if(merged.judet && !merged.county) merged.county = merged.judet;
        if(merged.county && !merged.judet) merged.judet = merged.county;
        if(Array.isArray(merged.bankAccounts) && merged.bankAccounts.length){
          merged.bank = merged.bank || merged.bankAccounts[0].bank || "";
          merged.iban = merged.iban || merged.bankAccounts[0].iban || "";
        }
        return merged;
      };

      // Hide role (Client/Furnizor) row in societate mode
      function hideRoleRow(){
        const row = qs("#cfIsClient")?.closest(".row");
        if(row) row.style.display = "none";
        // also ensure checkboxes are OFF so nothing can leak
        const c1 = qs("#cfIsClient"); if(c1) c1.checked = false;
        const c2 = qs("#cfIsSupplier"); if(c2) c2.checked = false;
      }

      function fillSocietateFields(){
        const cp = getJSON("companyProfile", {});
        const setVal = (id, v)=>{ const el = qs(id); if(el) el.value = (v ?? ""); };
        setVal("#cfName", cp.name || "");
        setVal("#cfCui", cp.cui || "");
        setVal("#cfOrc", cp.reg || cp.orc || "");
        setVal("#cfAddress", cp.address || "");
        setVal("#cfCity", cp.city || "");
        setVal("#cfPostal", cp.postal || "");
        setVal("#cfCountry", cp.country || "ROMÂNIA");
        setVal("#cfCounty", cp.county || cp.judet || "");
        setVal("#cfCapital", cp.capital || "");
        setVal("#cfWorkPoint", cp.workPoint || "");

        const tbody = qs("#cfBankRows");
        if(tbody){
          tbody.innerHTML = "";
          const accs = Array.isArray(cp.bankAccounts) ? cp.bankAccounts : [];
          // if none, also fallback to bank/iban
          const list = accs.length ? accs : ((cp.bank || cp.iban) ? [{bank:cp.bank||"", iban:cp.iban||""}] : []);
          for(const a of list){
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${String(a.bank||"").replace(/</g,"&lt;")}</td>
              <td>${String(a.iban||"").replace(/</g,"&lt;")}</td>
              <td style="text-align:right;"><button type="button" class="btn btn-danger btnDelBank">Șterge</button></td>
            `;
            tr.querySelector(".btnDelBank").addEventListener("click", ()=>tr.remove());
            tbody.appendChild(tr);
          }
        }
      }

      function readBankAccounts(){
        const tbody = qs("#cfBankRows");
        if(!tbody) return [];
        return [...tbody.querySelectorAll("tr")].map(tr=>({
          bank: (tr.children[0]?.textContent||"").trim(),
          iban: (tr.children[1]?.textContent||"").trim()
        })).filter(x=>x.bank || x.iban);
      }

      function saveSocietateOnly(){
        const name = (qs("#cfName")?.value||"").trim();
        if(!name){
          alert("Denumirea este obligatorie.");
          qs("#cfName")?.focus();
          return false;
        }
        const bankAccounts = readBankAccounts();
        const main = bankAccounts[0] || {};

        const payload = {
          name,
          cui: (qs("#cfCui")?.value||"").trim(),
          reg: (qs("#cfOrc")?.value||"").trim(),
          address: (qs("#cfAddress")?.value||"").trim(),


          country: (qs("#cfCountry")?.value||"").trim() || "ROMÂNIA",


          capital: (qs("#cfCapital")?.value||"").trim(),
          workPoint: (qs("#cfWorkPoint")?.value||"").trim(),
          bank: (main.bank||"").trim(),
          iban: (main.iban||"").trim(),
          bankAccounts
        };

        // STRICT: ONLY companyProfile (no clienti/furnizori)
        setJSON("companyProfile", payload);

        // do NOT call any client/furnizor save; do NOT call setUnit (it may have side effects)
        // Keeping modal open, fields remain.
        if(typeof window.toast === "function") window.toast("Datele societății au fost salvate.");
        return true;
      }

      // Open handler for Configurare societate (uses existing client modal as template)
      window.__openCompanyConfig = function(){
        // set mode and open client modal/backdrop
        window.__cfMode = "company";
        if(typeof window.openClientModal === "function"){
          window.openClientModal({ subtitle:"Societate", mode:"company" });
        }else{
          // fallback open by id
          const el = qs("#clientFullBackdrop");
          if(el){
            el.classList.add("show");
            el.setAttribute("aria-hidden","false");
            document.body.style.overflow = "hidden";
          }
        }
        setTimeout(()=>{
          hideRoleRow();
          fillSocietateFields();
        }, 0);
      };

      // Capture-phase save intercept: when in societate mode, stop all other save handlers
      const btnSave = qs("#btnSaveClientFull");
      if(btnSave && !btnSave.__fix46Hook){
        btnSave.__fix46Hook = true;
        btnSave.addEventListener("click", function(e){
          if(window.__cfMode !== "company") return; // normal client/furnizor flow
          e.preventDefault();
          e.stopImmediatePropagation();
          saveSocietateOnly();
        }, true);
      }

      // When modal is closed/cancelled, reset mode back to normal
      const closeBtn = qs("#clientFullClose");
      if(closeBtn && !closeBtn.__fix46){
        closeBtn.__fix46 = true;
        closeBtn.addEventListener("click", ()=>{ window.__cfMode = "client"; }, true);
      }
      const cancelBtn = qs("#btnCancelClientFull");
      if(cancelBtn && !cancelBtn.__fix46){
        cancelBtn.__fix46 = true;
        cancelBtn.addEventListener("click", ()=>{ window.__cfMode = "client"; }, true);
      }
    })();
    // ===== END FIX46 =====
  </script>


  <script>
    // ===== FIX48 SOCIETATE NOT IN CLIENTS (societatea NU apare la clienti/furnizori) =====
    (function(){
      function getJSON(key, fallback){
        try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }catch{ return fallback; }
      }
      function setJSON(key, val){
        try{ localStorage.setItem(key, JSON.stringify(val)); }catch{}
      }

      // Use app storage helpers if present
      const lsGet = (typeof window.lsGet === "function") ? window.lsGet : null;
      const lsSet = (typeof window.lsSet === "function") ? window.lsSet : null;

      function getList(key){
        if(lsGet) return lsGet(key, []);
        return getJSON(key, []);
      }
      function setList(key, list){
        if(lsSet) return lsSet(key, list);
        return setJSON(key, list);
      }

      function norm(s){ return (s||"").toString().trim().toLowerCase(); }

      function isSameEntity(item, cp){
        if(!item || !cp) return false;
        const n1 = norm(item.name);
        const n2 = norm(cp.name);
        const cui1 = norm(item.cui);
        const cui2 = norm(cp.cui);
        // strong match: same CUI when available
        if(cui1 && cui2 && cui1 === cui2) return true;
        // fallback: same name + same reg when available
        const r1 = norm(item.reg || item.orc);
        const r2 = norm(cp.reg || cp.orc);
        if(n1 && n2 && n1 === n2 && r1 && r2 && r1 === r2) return true;
        // last resort: exact same name (only if very specific and CUI missing)
        if(n1 && n2 && n1 === n2 && (!cui1 || !cui2)) return true;
        return false;
      }

      function purgeCompanyFrom(key){
        const cp = getJSON("companyProfile", null);
        if(!cp || !cp.name) return;
        const list = getList(key);
        if(!Array.isArray(list) || !list.length) return;
        const filtered = list.filter(it => !isSameEntity(it, cp));
        if(filtered.length !== list.length) setList(key, filtered);
      }

      // Run once on load: remove societatea din clienti/furnizori daca a ajuns acolo accidental
      purgeCompanyFrom("clients");
      purgeCompanyFrom("suppliers");

      // Also, when saving societate, purge again (in case user saved earlier)
      const prevOpen = window.__openCompanyConfig;
      window.__openCompanyConfig = function(){
        const res = (typeof prevOpen === "function") ? prevOpen() : undefined;
        // ensure mode is set
        window.__cfMode = "company";
        return res;
      };

      // Capture save click in company mode to guarantee:
      // 1) save ONLY to companyProfile
      // 2) purge from clients/suppliers
      const btnSave = document.getElementById("btnSaveClientFull");
      if(btnSave && !btnSave.__fix48){
        btnSave.__fix48 = true;
        btnSave.addEventListener("click", function(){
          if(window.__cfMode !== "company") return;
          // after whatever save handler ran, enforce purge
          setTimeout(()=>{
            purgeCompanyFrom("clients");
            purgeCompanyFrom("suppliers");
          }, 0);
        }, true);
      }
    })();
    // ===== END FIX48 =====
  </script>
  <script>
    // ===== FIX49 SOCIETATE: ascunde Localitate / Cod postal / Judet DOAR in Configurare societate =====
    (function(){
      const qs = (s,p=document)=>p.querySelector(s);

      function hideFieldByInputId(id){
        const el = qs("#"+id);
        if(!el) return;
        const field = el.closest(".field");
        if(field) field.style.display = "none";
      }

      function applyCompanyHide(){
        if(window.__cfMode !== "company") return;

        // Hide exactly the requested fields in company config
        hideFieldByInputId("cfCity");    // Localitate
        hideFieldByInputId("cfPostal");  // Cod postal
        hideFieldByInputId("cfCounty");  // Judet

        // If the whole row becomes empty, hide the row container too
        const city = qs("#cfCity");
        const row = city ? (city.closest(".row-3") || city.closest(".row") ) : null;
        if(row){
          const visibleFields = Array.from(row.querySelectorAll(".field")).filter(f=>{
            const st = (f.style && f.style.display) || "";
            return st !== "none";
          });
          if(visibleFields.length === 0) row.style.display = "none";
        }
      }

      // Apply whenever company config opens
      const prevOpen = window.__openCompanyConfig;
      if(typeof prevOpen === "function" && !window.__fix49OpenWrapped){
        window.__fix49OpenWrapped = true;
        window.__openCompanyConfig = function(){
          window.__cfMode = "company";
          const res = prevOpen();
          setTimeout(applyCompanyHide, 0);
          return res;
        };
      }

      // Also apply when modal opens via openClientModal in company mode
      const prevOpenClient = window.openClientModal;
      if(typeof prevOpenClient === "function" && !window.__fix49OpenClientWrapped){
        window.__fix49OpenClientWrapped = true;
        window.openClientModal = function(opts={}){
          const res = prevOpenClient(opts);
          setTimeout(applyCompanyHide, 0);
          return res;
        };
      }

      // Fallback: if mode is already company and backdrop is shown, apply once
      document.addEventListener("click", function(){
        try{ applyCompanyHide(); }catch(e){}
      }, true);
    })();
    // ===== END FIX49 =====
  </script>
<style>
    /* ===== FIX50 INCASARE TYPEAHEAD CLIENT ===== */
    .typeahead-box{
      position:absolute;
      left:0; right:0;
      top: calc(100% + 6px);
      background:#fff;
      border:1px solid var(--border);
      border-radius: 14px;
      box-shadow: 0 18px 48px rgba(0,0,0,.12);
      padding:6px;
      z-index: 120; /* above incasare modal */
      display:none;
      max-height: 260px;
      overflow:auto;
    }
    .typeahead-item{
      padding:10px 10px;
      border-radius:12px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .typeahead-item:hover{ background: rgba(37,99,235,.08); }
    .typeahead-item .n{ font-weight:950; }
    .typeahead-item .m{ color: var(--muted); font-weight:750; font-size:12px; }
  </style>

  <script>
    // ===== FIX50 INCASARE TYPEAHEAD CLIENT (scrii client, selectezi, apar facturile + datele) =====
    (function(){
      const qs = (s,p=document)=>p.querySelector(s);

      function getJSON(key, fallback){
        try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }catch{ return fallback; }
      }
      // Prefer app storage helpers
      const lsGet = (typeof window.lsGet === "function") ? window.lsGet : (k,f)=>getJSON(k,f);

      function normalize(s){
        return (s||"").toString().trim().toLowerCase()
          .normalize("NFD").replace(/[\u0300-\u036f]/g,"");
      }

      const incBackdrop = qs("#incasareBackdrop");
      const input = qs("#incClientName");
      const cui = qs("#incClientCui");
      const orc = qs("#incClientOrc");
      const addr = qs("#incClientAddr");
      const rowsBody = qs("#incInvoiceRows");

      if(!incBackdrop || !input || !rowsBody) return;

      // Make input editable (it was readonly)
      input.readOnly = false;
      input.setAttribute("autocomplete","off");

      // Create dropdown in the same field container
      const fieldWrap = input.closest(".field");
      if(fieldWrap && !fieldWrap.__typeahead){
        fieldWrap.__typeahead = true;
        fieldWrap.style.position = "relative";

        const box = document.createElement("div");
        box.className = "typeahead-box";
        box.id = "incClientTypeahead";
        fieldWrap.appendChild(box);

        function hide(){ box.style.display="none"; box.innerHTML=""; }
        function show(){ box.style.display="block"; }

        function getCompanyProfile(){
          const cp = getJSON("companyProfile", null);
          return cp && cp.name ? cp : null;
        }

        function getClients(){
          // clientsFull is the canonical list used by the app
          let list = lsGet("clientsFull", []);
          if(!Array.isArray(list)) list = [];
          // Remove company profile if it leaked (extra safety)
          const cp = getCompanyProfile();
          if(cp){
            const ncp = normalize(cp.name);
            const cuicp = normalize(cp.cui);
            list = list.filter(c=>{
              const n = normalize(c?.name);
              const cu = normalize(c?.cui);
              if(cuicp && cu && cu === cuicp) return false;
              if(n && n === ncp) return false;
              return true;
            });
          }
          return list;
        }

        function renderMatches(q){
          const nq = normalize(q);
          if(!nq){
            hide();
            return;
          }
          const list = getClients();
          const matches = list
            .filter(c=>{
              const n = normalize(c.name);
              const cu = normalize(c.cui);
              const rg = normalize(c.reg || c.orc);
              return n.includes(nq) || cu.includes(nq) || rg.includes(nq);
            })
            .slice(0, 12);

          box.innerHTML = "";
          if(!matches.length){
            hide();
            return;
          }

          for(const c of matches){
            const it = document.createElement("div");
            it.className = "typeahead-item";
            it.innerHTML = `
              <div class="n">${(c.name||"").replace(/</g,"&lt;")}</div>
              <div class="m">CUI: ${(c.cui||"-").replace(/</g,"&lt;")} • ORC: ${(c.orc||c.reg||"-").replace(/</g,"&lt;")}</div>
            `;
            it.addEventListener("mousedown", (e)=>{
              // mousedown so it fires before input blur
              e.preventDefault();
              selectClient(c);
            });
            box.appendChild(it);
          }
          show();
        }

        function selectClient(fullClient){
          hide();
          // Use existing function setClientFromFull if present inside page via global hook
          if(typeof window.__incSetClientFromFull === "function"){
            window.__incSetClientFromFull(fullClient);
          }else{
            // fallback: fill fields and trigger invoice render using public storage and existing UI ids
            input.value = fullClient.name || "";
            if(cui) cui.value = fullClient.cui || "";
            if(orc) orc.value = fullClient.orc || fullClient.reg || "";
            if(addr) addr.value = fullClient.address || "";
            // trigger custom event so existing incasare code can react if it listens
            input.dispatchEvent(new Event("change", { bubbles:true }));
          }
        }

        // Hook into existing incasare internal function by exposing it once (non-invasive)
        // We locate it by patching after it exists: the main app already defines setClientFromFull in its closure,
        // so we cannot access it directly. But we can capture selected client via Edit button flow:
        // When user selects via our dropdown, we also set globals expected by incasare logic through localStorage marker.
        // To ensure invoices render, we programmatically click "Modifică" if nothing renders is not desired.
        // Instead: we inject a small bridge if the app exposed it already.
        // If not exposed, the current incasare logic will still work when user uses "Adaugă". Typeahead will set fields only.
      }

      // We create a lightweight bridge by monkey-patching openClientModal callback path:
      // When incasare code calls openClientModal({onSave:setClientFromFull}), we can intercept that onSave reference.
      // We'll store it to window.__incSetClientFromFull.
      (function(){
        const origOpenClientModal = window.openClientModal;
        if(typeof origOpenClientModal !== "function" || window.__fix50ClientModalWrapped) return;
        window.__fix50ClientModalWrapped = true;
        window.openClientModal = function(opts={}){
          // If opened for incasare (subtitle contains "încasare"), capture onSave
          const sub = (opts.subtitle||"").toString().toLowerCase();
          if(sub.includes("încasare") || sub.includes("incasare")){
            if(typeof opts.onSave === "function"){
              window.__incSetClientFromFull = (full)=>opts.onSave(full);
            }
          }
          return origOpenClientModal(opts);
        };
      })();

      // Event listeners
      const box = document.getElementById("incClientTypeahead");
      function hideBox(){ if(box){ box.style.display="none"; box.innerHTML=""; } }

      input.addEventListener("input", ()=>renderMatches(input.value));
      input.addEventListener("focus", ()=>renderMatches(input.value));
      input.addEventListener("blur", ()=>setTimeout(hideBox, 120));

      // Enter selects first match
      input.addEventListener("keydown", (e)=>{
        if(e.key === "Enter"){
          const first = box?.querySelector(".typeahead-item");
          if(first){
            e.preventDefault();
            first.dispatchEvent(new MouseEvent("mousedown", { bubbles:true }));
          }
        }
        if(e.key === "Escape"){
          hideBox();
        }
      });

      // When incasare opens, focus on input and allow typing
      const mo = new MutationObserver(()=>{
        if(incBackdrop.classList.contains("show")){
          input.readOnly = false;
          setTimeout(()=>{ try{ input.focus(); }catch{} }, 0);
        }else{
          hideBox();
        }
      });
      mo.observe(incBackdrop, { attributes:true, attributeFilter:["class"] });

      // Helper renderMatches depends on fieldWrap scope if it exists
      function renderMatches(q){
        const wrap = input.closest(".field");
        const box = wrap ? wrap.querySelector("#incClientTypeahead") : null;
        if(!box) return;

        const nq = normalize(q);
        if(!nq){
          box.style.display="none"; box.innerHTML="";
          return;
        }
        let list = lsGet("clientsFull", []);
        if(!Array.isArray(list)) list = [];

        // exclude company profile
        const cp = getJSON("companyProfile", null);
        if(cp && cp.name){
          const ncp = normalize(cp.name);
          const cuicp = normalize(cp.cui);
          list = list.filter(c=>{
            const n = normalize(c?.name);
            const cu = normalize(c?.cui);
            if(cuicp && cu && cu===cuicp) return false;
            if(n && n===ncp) return false;
            return true;
          });
        }

        const matches = list.filter(c=>{
          const n = normalize(c.name);
          const cu = normalize(c.cui);
          const rg = normalize(c.reg || c.orc);
          return n.includes(nq) || cu.includes(nq) || rg.includes(nq);
        }).slice(0,12);

        box.innerHTML="";
        if(!matches.length){
          box.style.display="none";
          return;
        }
        for(const c of matches){
          const it = document.createElement("div");
          it.className="typeahead-item";
          it.innerHTML = `
            <div class="n">${(c.name||"").replace(/</g,"&lt;")}</div>
            <div class="m">CUI: ${(c.cui||"-").replace(/</g,"&lt;")} • ORC: ${(c.orc||c.reg||"-").replace(/</g,"&lt;")}</div>
          `;
          it.addEventListener("mousedown", (e)=>{
            e.preventDefault();
            box.style.display="none"; box.innerHTML="";
            // If we have bridge to incasare's setClientFromFull, use it
            if(typeof window.__incSetClientFromFull === "function"){
              window.__incSetClientFromFull(c);
            }else{
              // fallback fill (still useful)
              input.value = c.name || "";
              if(cui) cui.value = c.cui || "";
              if(orc) orc.value = c.orc || c.reg || "";
              if(addr) addr.value = c.address || "";
              input.dispatchEvent(new Event("change", {bubbles:true}));
            }
          });
          box.appendChild(it);
        }
        box.style.display="block";
      }
    })();
    // ===== END FIX50 =====
  </script>


  <script>
    // ===== FIX57: suma in litere (ASCII) + auto-populare la CHITANTA (fara a strica restul) =====
    (function(){
      const qs = (s,p=document)=>p.querySelector(s);

      // --- Helpers: numbers ---
      function parseNum(v){
        // Accept: 3073.18 , 3073,18 , 3.073,18 (RO) , 3,073.18 (US)
        let s = String(v ?? "").trim();
        if(!s) return 0;
        s = s.replace(/\s+/g, "");
        const hasDot = s.includes(".");
        const hasComma = s.includes(",");
        if(hasDot && hasComma){
          const lastDot = s.lastIndexOf(".");
          const lastComma = s.lastIndexOf(",");
          if(lastComma > lastDot){
            // RO: '.' thousands, ',' decimal
            s = s.replace(/\./g, "").replace(",", ".");
          }else{
            // US: ',' thousands, '.' decimal
            s = s.replace(/,/g, "");
          }
        }else if(hasComma && !hasDot){
          // Only comma -> decimal
          s = s.replace(",", ".");
        }else{
          // Only dot or none -> OK
        }
        const n = Number(s);
        return Number.isFinite(n) ? n : 0;
      }

      // --- Helpers: strict ASCII for documents/PDF ---
      function strictAscii(s){
        let out = "";
        try{
          out = String(s ?? "").normalize("NFD").replace(/[\u0300-\u036f]/g,"");
        }catch(e){
          out = String(s ?? "");
        }
        // Remove control/non-ascii completely (avoid spaced letters in PDF)
        out = out
          .replace(/[’‘`´]/g,"'")
          .replace(/[\x00-\x1F\x7F-\xFF]/g,"")
          .replace(/[^A-Za-z0-9\s\.,:;\-\/\(\)\[\]"'!?]/g," ")
          .replace(/\s+/g," ")
          .trim();
        return out;
      }
      // expose for other handlers already in page
      window.strictAscii = window.strictAscii || strictAscii;
      window.cleanWords  = window.cleanWords  || strictAscii;

      // --- Romanian number to words (ASCII, fara diacritice) ---
      const ones = ["zero","unu","doi","trei","patru","cinci","sase","sapte","opt","noua"];
      const teens = ["zece","unsprezece","doisprezece","treisprezece","paisprezece","cincisprezece","saisprezece","saptesprezece","optsprezece","nouasprezece"];
      const tens = ["","","douazeci","treizeci","patruzeci","cincizeci","saizeci","saptezeci","optzeci","nouazeci"];

      function under100(n){
        n = n|0;
        if(n < 10) return ones[n];
        if(n < 20) return teens[n-10];
        const t = (n/10)|0;
        const u = n%10;
        if(u === 0) return tens[t];
        return tens[t] + " si " + ones[u];
      }
      function under1000(n){
        n = n|0;
        if(n < 100) return under100(n);
        const h = (n/100)|0;
        const r = n%100;
        let out = "";
        if(h === 1) out = "o suta";
        else if(h === 2) out = "doua sute";
        else out = ones[h] + " sute";
        if(r) out += " " + under100(r);
        return out;
      }
      function intToWords(n){
        n = Math.floor(Math.abs(Number(n)||0));
        if(n === 0) return "zero";

        const mil = Math.floor(n / 1000000);
        const remMil = n % 1000000;
        const thou = Math.floor(remMil / 1000);
        const rem = remMil % 1000;

        const parts = [];
        if(mil){
          if(mil === 1) parts.push("un milion");
          else parts.push(intToWords(mil) + " milioane");
        }
        if(thou){
          if(thou === 1) parts.push("o mie");
          else if(thou === 2) parts.push("doua mii");
          else parts.push(intToWords(thou) + " mii");
        }
        if(rem){
          parts.push(under1000(rem));
        }
        return parts.join(" ").replace(/\s+/g," ").trim();
      }

      function moneyToWordsRo(amount, currency){
        const val = Math.abs(parseNum(amount));
        const main = Math.floor(val);
        const frac = Math.round((val - main) * 100);

        // currency labels (ASCII)
        let curMain = "lei", curSub = "bani";
        if((currency||"").toUpperCase()==="EUR"){ curMain = "euro"; curSub = "centi"; }
        if((currency||"").toUpperCase()==="USD"){ curMain = "dolari"; curSub = "centi"; }

        let mainLabel = curMain, subLabel = curSub;
        if((currency||"").toUpperCase()==="RON"){
          if(main === 1) mainLabel = "leu";
          if(frac === 1) subLabel = "ban";
        }

        const mainWords = intToWords(main);
        const fracWords = intToWords(frac);

        // Exact format cerut: "<lei> ... si <bani> ..."
        return strictAscii(mainWords + " " + mainLabel + " si " + fracWords + " " + subLabel);
      }
      window.moneyToWordsRo = window.moneyToWordsRo || moneyToWordsRo;

      // Override amountToWords used by existing handlers (receipt)
      window.amountToWords = function(amount, currency){
        return moneyToWordsRo(amount, currency || "RON");
      };

      // --- Wire-up: recompute in UI for CHITANTA ---
      function bindReceiptWords(){
        const amt = qs("#rcptAmount");
        const cur = qs("#rcptCurrency");
        const words = qs("#rcptAmountWords");
        if(!amt || !cur || !words) return;

        const recalc = ()=>{
          words.value = moneyToWordsRo(amt.value, cur.value);
        };
        amt.addEventListener("input", recalc);
        cur.addEventListener("input", recalc);
        recalc();
      }

      if(document.readyState === "loading"){
        document.addEventListener("DOMContentLoaded", bindReceiptWords, {once:true});
      }else{
        bindReceiptWords();
      }
    })();
    // ===== END FIX57 =====
  </script>


  <!-- Produse si servicii (PRODUSE) -->
  <div class="modal-backdrop" id="productsBackdrop" aria-hidden="true">
    <div class="modal products-modal" role="dialog" aria-modal="true" aria-label="Produse si servicii">
      <div class="modal-head">
        <div>
          <div class="modal-title">Produse si servicii</div>
          <div class="modal-sub">Gestiune • Lista produse (demo)</div>
        </div>
        <button class="icon-btn" type="button" id="btnCloseProducts" title="Închide">✕</button>
      </div>

      <!-- Top filter row (ca in ForIT) -->
      <div class="products-topbar">
        <div class="pt-left">
          <label class="pt-lbl">Filtru:</label>
          <select id="prodFilterMode" class="pt-sel">
            <option value="contains">contine</option>
            <option value="starts">incepe cu</option>
          </select>
          <input id="prodFilterText" class="pt-inp" type="text" placeholder="" />
          <select id="prodFilterType" class="pt-sel">
            <option value="auto">Auto</option>
            <option value="name">Denumire</option>
            <option value="barcode">Cod de bare</option>
            <option value="code">Cod produs</option>
            <option value="desc">Descriere</option>
            <option value="cat">Categorie</option>
          </select>
          <select id="prodType" class="pt-sel">
            <option value="toate">toate</option>
            <option value="nespecificat">nespecificat</option>
            <option value="materie prima">materie prima</option>
            <option value="alte materiale">alte materiale</option>
            <option value="produs finit">produs finit</option>
            <option value="marfa">marfa</option>
            <option value="obiect de inv.">obiect de inv.</option>
            <option value="ambalaje">ambalaje</option>
            <option value="semifabricate">semifabricate</option>
            <option value="reziduale">reziduale</option>
            <option value="consumabile">consumabile</option>
            <option value="servicii">servicii</option>
          </select>
        </div>

        <div class="pt-right">
          <button class="icon-btn" type="button" id="btnProdNew" title="Inregistrare produs nou">➕</button>
          <button class="icon-btn" type="button" id="btnProdPrintList" title="Tiparire lista produse">🖨</button>
          <button class="icon-btn" type="button" id="btnProdLabels" title="Tiparire etichete">🏷</button>
          <button class="icon-btn" type="button" id="btnProdExportLabels" title="Export etichete">⬇</button>
          <button class="icon-btn" type="button" id="btnProdPvmp" title="Proces verbal modificare preturi">💲</button>
          <button class="icon-btn" type="button" id="btnProdInventar" title="Proces verbal inventariere">📋</button>
          <button class="icon-btn" type="button" id="btnProdCat" title="Setare categorie/departament (multi)">🧩</button>
          <button class="icon-btn" type="button" id="btnProdRefresh" title="Actualizare lista">⟳</button>
        </div>
      </div>

      <!-- Main grid -->
      <div class="products-body">
        <div class="products-table-wrap">
          <table class="tbl products-tbl" id="productsTable">
            <thead>
              <tr>
                <th style="width:28px;"></th>
                <th style="width:44px;"></th>
                <th>Denumire</th>
                <th style="width:70px;">U.M.</th>
                <th style="width:90px;">Cod</th>
                <th style="width:150px;">Cod de bare</th>
                <th style="width:110px;">Pret Amnt.</th>
                <th style="width:70px;">TVA%</th>
                <th style="width:120px;">Clasificare</th>
                <th style="width:80px;">Adaos</th>
                <th style="width:140px;">Categorie</th>
                <th style="width:140px;">Departament</th>
              </tr>
            </thead>
            <tbody id="productsTbody"></tbody>
          </table>
        </div>

        <!-- Bottom info + tabs -->
        <div class="products-bottom">
          <div class="prod-livebar" id="prodLiveBar">—</div>

          <div class="prod-bottom-grid">
            <div class="prod-left">
              <div class="prod-pricebox" id="prodPriceBox">0.00</div>
              <div class="prod-stock">
                <div><b>Stoc curent:</b> <span id="prodStock">0.00</span></div>
                <div><b>U.M.:</b> <span id="prodUm">—</span></div>
                <button class="btn secondary" type="button" id="btnProdRaport">Raport extins…</button>
              </div>
            </div>

            <div class="prod-tabs">
              <div class="tabs" id="prodTabs">
                <button type="button" class="tab active" data-tab="hist">Istoric</button>
                <button type="button" class="tab" data-tab="pp">Evolutia pretului de achizitie</button>
                <button type="button" class="tab" data-tab="sp">Evolutia pretului de vanzare</button>
                <button type="button" class="tab" data-tab="sales">Evolutia vanzarilor</button>
                <button type="button" class="tab" data-tab="other">Alte informatii</button>
              </div>

              <div class="tabpanels">
                <div class="tabpanel show" data-tabpanel="hist">
                  <div class="prod-subhdr">
                    <div><b>Ultimul furnizor:</b> <span id="prodLastSupplier">—</span></div>
                    <div class="muted" id="prodLastSupplierInfo"></div>
                  </div>
                  <table class="tbl small">
                    <thead>
                      <tr>
                        <th style="width:110px;">Intr./iesire</th>
                        <th style="width:110px;">Data</th>
                        <th style="width:110px;">Nr. doc.</th>
                        <th style="width:120px;">Doc.</th>
                        <th>Partener</th>
                        <th style="width:90px;">Cant.</th>
                        <th style="width:90px;">Stoc</th>
                      </tr>
                    </thead>
                    <tbody id="prodHistBody">
                      <tr><td colspan="7" class="muted" style="text-align:center;padding:14px;">Istoric (demo)</td></tr>
                    </tbody>
                  </table>
                </div>

                <div class="tabpanel" data-tabpanel="pp">
                  <div class="muted" style="padding:12px;">Evolutia pretului de achizitie (demo)</div>
                </div>
                <div class="tabpanel" data-tabpanel="sp">
                  <div class="muted" style="padding:12px;">Evolutia pretului de vanzare (demo)</div>
                </div>
                <div class="tabpanel" data-tabpanel="sales">
                  <div class="muted" style="padding:12px;">Evolutia vanzarilor (demo)</div>
                </div>
                <div class="tabpanel" data-tabpanel="other">
                  <div class="muted" style="padding:12px;">Alte informatii (demo)</div>
                </div>
              </div>
            </div>
          </div>

          <div class="prod-footer">
            <div id="prodCount">Produse in lista: 0</div>
          </div>
        </div>
      </div>
    </div>
  </div>


<script>
/* PRODUSE: tooltip pe iconite (hover/long-press) - patch minimal */
(function(){
  function ensureTip(){
    var tip = document.getElementById('prodIconTip');
    if(tip) return tip;
    tip = document.createElement('div');
    tip.id = 'prodIconTip';
    tip.setAttribute('role','tooltip');
    tip.style.position = 'fixed';
    tip.style.zIndex = '99999';
    tip.style.pointerEvents = 'none';
    tip.style.padding = '6px 10px';
    tip.style.borderRadius = '10px';
    tip.style.background = 'rgba(15,15,18,.92)';
    tip.style.color = '#fff';
    tip.style.font = '700 12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial';
    tip.style.boxShadow = '0 12px 30px rgba(0,0,0,.25)';
    tip.style.opacity = '0';
    tip.style.transform = 'translateY(4px)';
    tip.style.transition = 'opacity .12s ease, transform .12s ease';
    document.body.appendChild(tip);
    return tip;
  }

  function posTip(tip, x, y){
    var pad = 14;
    var left = x + pad;
    var top  = y + pad;
    tip.style.left = left + 'px';
    tip.style.top  = top  + 'px';
  }

  function attach(){
    var backdrop = document.getElementById('productsBackdrop');
    if(!backdrop) return;

    // doar iconitele din PRODUSE (nu afectam restul aplicatiei)
    var buttons = backdrop.querySelectorAll('.pt-right .icon-btn');
    if(!buttons || !buttons.length) return;

    var tip = ensureTip();
    var hideT = null;

    function show(e, text){
      if(!text) return;
      if(hideT){ clearTimeout(hideT); hideT=null; }
      tip.textContent = text;
      tip.style.opacity = '1';
      tip.style.transform = 'translateY(0)';
      var cx = (e && (e.clientX || (e.touches && e.touches[0] && e.touches[0].clientX))) || 0;
      var cy = (e && (e.clientY || (e.touches && e.touches[0] && e.touches[0].clientY))) || 0;
      posTip(tip, cx, cy);
    }
    function move(e){
      var cx = (e && (e.clientX || (e.touches && e.touches[0] && e.touches[0].clientX))) || 0;
      var cy = (e && (e.clientY || (e.touches && e.touches[0] && e.touches[0].clientY))) || 0;
      posTip(tip, cx, cy);
    }
    function hide(){
      tip.style.opacity = '0';
      tip.style.transform = 'translateY(4px)';
    }

    buttons.forEach(function(btn){
      // fallback label: aria-label -> title -> text
      var label = btn.getAttribute('aria-label') || btn.getAttribute('title') || '';
      if(label){
        btn.setAttribute('aria-label', label);
        btn.setAttribute('title', label); // pastreaza si tooltip-ul nativ
      }
      btn.addEventListener('mouseenter', function(e){ show(e, label); });
      btn.addEventListener('mousemove', move);
      btn.addEventListener('mouseleave', hide);
      btn.addEventListener('focus', function(e){ show(e, label); });
      btn.addEventListener('blur', hide);

      // Mobile: long-press/press (fara sa blocam click)
      btn.addEventListener('touchstart', function(e){
        show(e, label);
        if(hideT){ clearTimeout(hideT); }
        hideT = setTimeout(hide, 1200);
      }, {passive:true});
      btn.addEventListener('touchmove', move, {passive:true});
      btn.addEventListener('touchend', function(){ if(hideT){ clearTimeout(hideT); } hideT = setTimeout(hide, 200); }, {passive:true});
    });
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', attach);
  } else {
    attach();
  }

  // re-attach doar pana cand legam o data (evitam atasari infinite)
  var attachedOnce = false;
  function safeAttach(){
    try{
      attach();
      // daca exista toolbar-ul si am marcat macar un buton, ne oprim
      var backdrop = document.getElementById("productsBackdrop");
      if(backdrop && backdrop.querySelector(".pt-right .icon-btn[data-prod-tip-bound=\"1\"]")){
        attachedOnce = true;
      }
    }catch(e){}
    if(attachedOnce && mo){ try{ mo.disconnect(); }catch(e){} }
  }

  var mo = new MutationObserver(function(){
    if(attachedOnce) return;
    // ruleaza doar cand apare backdrop-ul (nu pe fiecare modificare de text)
    if(document.getElementById("productsBackdrop")){
      safeAttach();
    }
  });
  mo.observe(document.documentElement, {childList:true, subtree:true});
})();
</script>

<!-- Product Editor Modal (INREGISTRARE / EDITARE PRODUS) -->
<div class="modal-backdrop" id="productEditBackdrop" aria-hidden="true">
  <div class="modal productedit-modal" role="dialog" aria-modal="true" aria-label="Proprietatile produsului sau a serviciului">
    <div class="modal-head">
      <div>
        <div class="modal-title">Proprietatile produsului sau a serviciului</div>
        <div class="modal-sub">Inregistrare / modificare produs (demo UI)</div>
      </div>
      <button class="icon-btn" type="button" id="btnCloseProdEdit" title="Închide">✕</button>
    </div>

    <div class="tabs" id="prodEditTabs" style="padding:10px 12px 0;">
      <button type="button" class="tab active" data-tab="general">General</button>
      <button type="button" class="tab" data-tab="retetar">Retetar</button>
      <button type="button" class="tab" data-tab="auxiliare">Auxiliare</button>
      <button type="button" class="tab" data-tab="disponibilitate">Disponibilitate</button>
      <button type="button" class="tab" data-tab="furnizori">Furnizori</button>
      <button type="button" class="tab" data-tab="imagini">Imagini</button>
      <button type="button" class="tab" data-tab="avansat">Avansat</button>
      <button type="button" class="tab" data-tab="attobs">Att./Obs.</button>
    </div>

    <div class="modal-body prodedit-body">
      <!-- GENERAL -->
      <div class="tab-panel active" data-panel="general">
        <div class="pe-section-title">Informatii generale despre produs/serviciu</div>

        <div class="pe-grid">
          <div class="pe-field span-6">
            <label>Denumire:</label>
            <input id="peName" type="text" />
          </div>

          <div class="pe-field span-3">
            <label>U.M.:</label>
            <input id="peUM" type="text" />
          </div>

          <div class="pe-field span-3">
            <label>Gramaj:</label>
            <input id="peGramaj" type="number" step="0.001" />
          </div>

          <div class="pe-field span-3">
            <label>U.M. 2:</label>
            <input id="peUM2" type="text" />
          </div>

          <div class="pe-field span-4">
            <label>Categoria:</label>
            <input id="peCategory" type="text" />
          </div>

          <div class="pe-field span-4">
            <label>Dept.:</label>
            <input id="peDepartment" type="text" />
          </div>

          <div class="pe-field span-12">
            <label>Descriere:</label>
            <textarea id="peDesc" rows="4"></textarea>
          </div>

          <div class="pe-field span-6 pe-inline">
            <label class="chk">
              <input id="peTransfGramaj" type="checkbox" />
              Transformare pe baza gramajului
            </label>
          </div>

          <div class="pe-field span-6"></div>

          <div class="pe-field span-4">
            <label>Clasificare:</label>
            <select id="peClasif">
              <option value="nespecificat">nespecificat</option>
              <option value="materie prima">materie prima</option>
              <option value="alte materiale">alte materiale</option>
              <option value="produs finit">produs finit</option>
              <option value="marfa" selected>marfa</option>
              <option value="obiect de inv.">obiect de inv.</option>
              <option value="ambalaje">ambalaje</option>
              <option value="semifabricate">semifabricate</option>
              <option value="reziduale">reziduale</option>
              <option value="consumabile">consumabile</option>
              <option value="servicii">servicii</option>
            </select>
          </div>

          <div class="pe-field span-3 pe-inline">
            <label class="chk">
              <input id="peIsService" type="checkbox" />
              Servicii
            </label>
          </div>

          <div class="pe-field span-5">
            <label>Amb. SGR:</label>
            <select id="peAmbSgr">
              <option value="">&lt;fara&gt;</option>
              <option value="da">da</option>
              <option value="nu">nu</option>
            </select>
          </div>

          <div class="pe-field span-4 pe-inline">
            <label class="chk">
              <input id="peMonitorMin" type="checkbox" checked />
              Monitorizare stoc minim:
            </label>
          </div>

          <div class="pe-field span-2">
            <label>&nbsp;</label>
            <input id="peMinStock" type="number" step="0.01" />
          </div>

          <div class="pe-field span-3">
            <label>Stoc optim:</label>
            <input id="peStocOptim" type="number" step="0.01" />
          </div>

          <div class="pe-field span-3">
            <label>Stoc maxim:</label>
            <input id="peStocMax" type="number" step="0.01" />
          </div>
        </div>

        <div class="pe-section-title" style="margin-top:12px;">Codurile produsului</div>

        <div class="pe-grid">
          <div class="pe-field span-6">
            <label>Cod de bare:</label>
            <div class="pe-row">
              <input id="peBarcode" type="text" />
              <button type="button" class="btn" id="btnGenBarcode" title="Genereaza cod de bare">▦</button>
              <button type="button" class="btn" id="btnPrintBarcode" title="Tipareste cod de bare">🖨️</button>
            </div>
          </div>

          <div class="pe-field span-3">
            <label>Cod:</label>
            <input id="peCode" type="text" />
          </div>

          <div class="pe-field span-3">
            <label>SKU:</label>
            <input id="peSKU" type="text" />
          </div>

          <div class="pe-field span-3">
            <label>Cota TVA:</label>
            <select id="peVAT">
              <option value="0">0</option>
              <option value="5">5</option>
              <option value="9">9</option>
              <option value="19" selected>19</option>
            </select>
          </div>

          <div class="pe-field span-3">
            <label>Pret vanzare:</label>
            <input id="pePriceRetail" type="number" step="0.01" />
          </div>

          <div class="pe-field span-3">
            <label>Fara TVA:</label>
            <input id="pePriceNet" type="text" readonly />
          </div>

          <div class="pe-field span-3">
            <label>TVA inclus:</label>
            <input id="pePriceGross" type="text" readonly />
          </div>

          <div class="pe-field span-4 pe-inline">
            <label class="chk">
              <input id="pePretFacturare" type="checkbox" checked />
              Pret facturare
            </label>
          </div>

          <div class="pe-field span-4 pe-inline">
            <label class="chk">
              <input id="peCantar" type="checkbox" />
              Cantar
            </label>
          </div>
        </div>
      </div>

      <!-- Placeholder panels -->
      <div class="tab-panel" data-panel="retetar">
        <div class="pe-empty">Retetar (demo)</div>
      </div>
      <div class="tab-panel" data-panel="auxiliare">
        <div class="pe-empty">Auxiliare (demo)</div>
      </div>
      <div class="tab-panel" data-panel="disponibilitate">
        <div class="pe-empty">Disponibilitate (demo)</div>
      </div>
      <div class="tab-panel" data-panel="furnizori">
        <div class="pe-empty">Furnizori (demo)</div>
      </div>
      <div class="tab-panel" data-panel="imagini">
        <div class="pe-empty">Imagini (demo)</div>
      </div>
      <div class="tab-panel" data-panel="avansat">
        <div class="pe-empty">Avansat (demo)</div>
      </div>
      <div class="tab-panel" data-panel="attobs">
        <div class="pe-empty">Atasamente / Observatii (demo)</div>
      </div>
    </div>

    <div class="modal-foot">
      <button class="btn" type="button" id="btnProdEditSave">Salveaza</button>
      <button class="btn secondary" type="button" id="btnProdEditCancel">Renunta</button>
    </div>
  </div>
</div>


<script>
/* PROD: delegated open for 'Inregistrare produs nou' (handles duplicate IDs + late DOM) */
(function(){
  function handler(e){
    var btn = e.target && e.target.closest ? e.target.closest('button#btnProdNew') : null;
    if(!btn) return;
    // only within Produse modal
    var bd = btn.closest ? btn.closest('.modal-backdrop') : null;
    if(!bd || bd.id !== 'productsBackdrop') return;
    if(typeof window.__openProductEditor === 'function'){
      try{ e.preventDefault(); e.stopPropagation(); }catch(_){}
      try{ window.__openProductEditor(null); }catch(err){ console.error(err); }
    }
  }
  document.addEventListener('click', handler, true);
})();
</script>


<script>
/* PATCH: PRODUSE -> Inregistrare produs nou (fallback click binding, fara alte schimbari) */
(function(){
  function fallbackOpenProductEditor(){
    var bd = document.getElementById('productEditBackdrop');
    if(!bd) return;
    bd.classList.add('show');
    bd.setAttribute('aria-hidden','false');
    document.body.style.overflow = 'hidden';
  }

  // delegated capture listener so it works even if other bindings fail
  document.addEventListener('click', function(ev){
    var t = ev.target;
    if(!t || !t.closest) return;
    var btn = t.closest('#btnProdNew');
    if(!btn) return;

    ev.preventDefault();
    ev.stopPropagation();

    try{
      if(typeof window.openProductEditor === 'function'){
        window.openProductEditor(null);
      }else if(typeof window.__openProductEditor === 'function'){
        window.__openProductEditor(null);
      }else{
        fallbackOpenProductEditor();
      }
    }catch(err){
      try{ console.error(err); }catch(_){}
      fallbackOpenProductEditor();
    }
  }, true);

  // expose existing implementation if it's in local scope (best-effort)
  try{
    if(typeof openProductEditor === 'function' && typeof window.openProductEditor !== 'function'){
      window.openProductEditor = openProductEditor;
    }
  }catch(_){}
})();
</script>

</body></html>`);
        w.document.close();
        w.focus();
        // open print immediately; user can Save as PDF
        w.print();
      }

      
function pdfInvoice(inv){
        // Company (Furnizor) - best effort
        const unit = (typeof window.getUnit === "function") ? (window.getUnit() || {}) : {};
        const seller = {
          name: unit.name || "POSHARD IMPEX S.R.L.",
          cui: unit.cui || unit.vat || "RO 42694617",
          reg: unit.reg || unit.orc || "J12/1800/2020",
          address: unit.address || "—",

          capital: unit.capital || "",
          iban: unit.iban || "",
          bank: unit.bank || ""
        };

        const buyer = inv.client || {};
        const vatRate = Number(inv.vatRate ?? 0);
        const currency = inv.currency || "RON";
        const fx = Number(inv.fx ?? 1);

        // Lines compute
        const lines = Array.isArray(inv.lines) ? inv.lines : [];
        let netSum = 0, vatSum = 0, grossSum = 0;
        const rows = lines.map(l=>{
          const qty = Number(l.qty ?? l.quantity ?? 0);
          const price = Number(l.price ?? l.unitPrice ?? 0);
          const disc = Number(l.discount ?? 0);
          const net = qty * price * (1 - (disc/100));
          const vat = net * (vatRate/100);
          netSum += net; vatSum += vat; grossSum += (net+vat);
          return {
            name: l.name || l.product || "",
            qty,
            price,
            disc: (disc ? disc : 0),
            net,
            vat
          };
        });

        const toMoney = (n)=> Number(n||0).toLocaleString("ro-RO", {minimumFractionDigits:2, maximumFractionDigits:2});
        const docNo = (serie, number)=>{
          const sn = String(Number(number||0)).padStart(6,"0");
          return `${serie||""} ${sn}`.trim();
        };

        const headerLeft = `
          <div class="kv"><b>Furnizor:</b></div>
          <div class="kv"><b>${seller.name}</b></div>
          <div class="kv">CUI: <b>${seller.cui||"-"}</b></div>
          <div class="kv">Nr.ord.reg.com: <b>${seller.reg||"-"}</b></div>
          <div class="kv">Sediul: <b>${seller.address||"-"}</b></div>
          ${seller.county ? `<div class="kv">Județul: <b>${seller.county}</b></div>` : ``}
          ${seller.capital ? `<div class="kv">Capital social: <b>${seller.capital}</b></div>` : ``}
          ${seller.iban ? `<div class="kv">IBAN: <b>${seller.iban}</b></div>` : ``}
          ${seller.bank ? `<div class="kv">Banca: <b>${seller.bank}</b></div>` : ``}
        `;

        const headerRight = `
          <div class="kv"><b>Cumpărător:</b></div>
          <div class="kv"><b>${buyer.name||"-"}</b></div>
          <div class="kv">CUI: <b>${buyer.cui||"-"}</b></div>
          <div class="kv">Nr.ord.reg.com: <b>${buyer.reg||buyer.orc||"-"}</b></div>
          <div class="kv">Sediul: <b>${buyer.address||"-"}</b></div>
          ${buyer.iban ? `<div class="kv">IBAN: <b>${buyer.iban}</b></div>` : ``}
          ${buyer.bank ? `<div class="kv">Banca: <b>${buyer.bank}</b></div>` : ``}
        `;

        const mid = `
          <div class="center">
            <div class="title">${inv.type === "FACTURA" ? "FACTURA" : "FACTURA PROFORMA"}</div>
            <div class="subline"><b>Seria:</b> ${inv.serie||""} <b>Nr.</b> ${inv.number||""} <b>din</b> ${(inv.date||"")}</div>
            <div class="subline"><b>Termen de plată:</b> ${(inv.dueDays ?? 0)} zile</div>
            <div class="subline"><b>Cota de TVA:</b> ${vatRate || 0}%</div>
          </div>
        `;

        const tableRows = (rows.length ? rows.map(r=>`
          <tr>
            <td><b>${(r.name||"").replace(/</g,"&lt;")}</b></td>
            <td class="right">${r.qty}</td>
            <td class="right">${toMoney(r.price)}</td>
            <td class="right">${r.disc ? (r.disc + "%") : "-"}</td>
            <td class="right">${toMoney(r.net)}</td>
            <td class="right">${toMoney(r.vat)}</td>
          </tr>
        `).join("") : `<tr><td colspan="6">-</td></tr>`);

        const totalsHtml = `
          <tr class="total-row">
            <td colspan="4" class="right">Total, fara TVA</td>
            <td class="right">${toMoney(netSum)}</td>
            <td class="right">${toMoney(vatSum)}</td>
          </tr>
          <tr class="total-row">
            <td colspan="5" class="right">Total de plata</td>
            <td class="right">${toMoney(grossSum)}</td>
          </tr>
        `;

        const footer = `
          <div class="footgrid">
            <div class="box small">
              Factura circula fara semnatura si stampila conform art 319 alin. 29 din Codul Fiscal
            </div>
            <div class="box small">
              <div><b>Date privind expeditia</b></div>
              <div>Numele delegatului</div>
              <div>Mijlocul de transport</div>
              <div>Expedierea s-a efectuat la data de ${(inv.date||"")} ora 12:00</div>
            </div>
          </div>
        `;

        const body = `
          <div class="page">
            <div class="row">
              <div class="col">${headerLeft}</div>
              <div class="col">${mid}</div>
              <div class="col right" style="text-align:left">${headerRight}</div>
            </div>

            <table class="tbl">
              <thead>
                <tr>
                  <th style="width:40%;">Produs</th>
                  <th style="width:10%;" class="right">Cantitate</th>
                  <th style="width:12%;" class="right">Pret unitar</th>
                  <th style="width:10%;" class="right">Discount</th>
                  <th style="width:14%;" class="right">Valoare lei, fara TVA</th>
                  <th style="width:14%;" class="right">Valoare TVA</th>
                </tr>
              </thead>
              <tbody>
                ${tableRows}
                ${totalsHtml}
              </tbody>
            </table>

            <div class="kv" style="margin-top:10px;"><b>Curs ${currency}:</b> ${fx}</div>

            ${footer}
          </div>
        `;

        openPdfWindow(inv.type, body);
      }

      
function pdfReceipt(r){
        const unit = (typeof window.getUnit === "function") ? (window.getUnit() || {}) : {};
        const seller = {
          name: unit.name || "POSHARD IMPEX S.R.L.",
          cui: unit.cui || unit.vat || "RO 42694617",
          reg: unit.reg || unit.orc || "J12/1800/2020",
          address: unit.address || "—",

          capital: unit.capital || "",
          iban: unit.iban || "",
          bank: unit.bank || ""
        };

        const p = r.partner || {};
        const toMoney = (n)=> Number(n||0).toLocaleString("ro-RO", {minimumFractionDigits:2, maximumFractionDigits:2});
        const fx = Number(r.fx ?? 1);

        function oneCopy(){
          return `
            <div class="copy">
              <div class="row">
                <div class="col">
                  <div class="kv"><b>Furnizor:</b></div>
                  <div class="kv"><b>${seller.name}</b></div>
                  <div class="kv">CUI: <b>${seller.cui||"-"}</b></div>
                  <div class="kv">Nr.ord.reg.com: <b>${seller.reg||"-"}</b></div>
                  <div class="kv">Sediul: <b>${seller.address||"-"}</b></div>
                  ${seller.county ? `<div class="kv">Judetul: <b>${seller.county}</b></div>` : ``}
                  ${seller.capital ? `<div class="kv">Capital social: <b>${seller.capital}</b></div>` : ``}
                  ${seller.iban ? `<div class="kv">IBAN: <b>${seller.iban}</b></div>` : ``}
                  ${seller.bank ? `<div class="kv">Banca: <b>${seller.bank}</b></div>` : ``}
                </div>
                <div class="col right">
                  <div style="text-align:right;">
                    <div style="font-size:18px; font-weight:900;">CHITANTA</div>
                    <div class="kv">Numar <b>${r.number||""}</b></div>
                    <div class="kv">Data <b>${r.date||""}</b></div>
                  </div>
                </div>
              </div>

              <div style="margin-top:18px;">
                <div class="row">
                  <div class="col" style="max-width:180px;"><div class="kv">Am primit de la:</div></div>
                  <div class="col"><div class="kv"><b>${p.name||"-"}</b></div></div>
                </div>
                <div class="row">
                  <div class="col" style="max-width:180px;"><div class="kv">CIF:</div></div>
                  <div class="col"><div class="kv"><b>${p.cui||"-"}</b></div></div>
                </div>
                <div class="row">
                  <div class="col" style="max-width:180px;"><div class="kv">Adresa:</div></div>
                  <div class="col"><div class="kv"><b>${p.address||"-"}</b></div></div>
                </div>

                <div class="row" style="margin-top:10px;">
                  <div class="col" style="max-width:180px;"><div class="kv">Suma de:</div></div>
                  <div class="col">
                    <div class="kv"><b>${toMoney(r.amount||0)}</b> ${r.currency||"RON"} &nbsp;&nbsp;&nbsp; <span class="muted">adica:</span> <b>${(r.amountWords||"-")}</b></div>
                  </div>
                </div>

                <div class="row" style="margin-top:8px;">
                  <div class="col" style="max-width:180px;"><div class="kv">Reprezentand:</div></div>
                  <div class="col"><div class="kv"><b>${(r.representative||"-")}</b></div></div>
                </div>

                <div class="sig"><div>Semnatura:&nbsp;&nbsp;<span></span></div></div>
              </div>
            </div>
          `;
        }

        const body = `
          <div class="page">
            ${oneCopy()}
            <div class="sep"></div>
            ${oneCopy()}
          </div>
        `;
        openPdfWindow("Chitanta", body);
      }

      // ---- Render lists ----
      const invRows = qs("#docsInvRows");
      const proRows = qs("#docsProRows");
      const rcpRows = qs("#docsRcpRows");

      function renderInvoices(){
        const q = (qs("#docsInvSearch")?.value||"").trim().toLowerCase();
        const list = loadList("invoices");
        const filtered = !q ? list : list.filter(x=>{
          const c = x.client||{};
          return (docNo(x.serie,x.number)).toLowerCase().includes(q) ||
                 (c.name||"").toLowerCase().includes(q) ||
                 (c.cui||"").toLowerCase().includes(q);
        });

        invRows.innerHTML = "";
        if(filtered.length === 0){
          invRows.innerHTML = '<tr><td colspan="6" style="padding:14px; color:var(--muted); font-weight:850;">Nu există facturi.</td></tr>';
          return;
        }
        filtered
          .slice()
          .sort((a,b)=> String(b.date||"").localeCompare(String(a.date||"")))
          .forEach(x=>{
            const c = x.client||{};
            const total = x.totals?.gross ?? 0;
            const statusFinal = (x.status === "FINALIZATA");
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td><b>${docNo(x.serie,x.number)}</b></td>
              <td>${x.date||""}</td>
              <td>${(c.name||"-")}</td>
              <td><b>${money(total)}</b> ${(x.currency||"RON")}</td>
              <td>
                <span class="status-pill">
                  <input type="checkbox" class="docStatus" data-key="invoices" data-id="${x.id}" ${statusFinal?"checked":""}>
                  <span>${statusFinal ? "Finalizată" : "În lucru"}</span>
                </span>
              </td>
              <td>
                <div class="doc-actions">
                  <button class="btn btn-ghost docEdit" type="button" data-kind="invoice" data-key="invoices" data-id="${x.id}">Modifică</button>
                  <button class="btn btn-primary docPdf" type="button" data-kind="invoice" data-key="invoices" data-id="${x.id}">PDF</button>
                </div>
              </td>
            `;
            invRows.appendChild(tr);
          });
      }

      function renderProformas(){
        const q = (qs("#docsProSearch")?.value||"").trim().toLowerCase();
        const list = loadList("proformas");
        const filtered = !q ? list : list.filter(x=>{
          const c = x.client||{};
          return (docNo(x.serie,x.number)).toLowerCase().includes(q) ||
                 (c.name||"").toLowerCase().includes(q) ||
                 (c.cui||"").toLowerCase().includes(q);
        });

        proRows.innerHTML = "";
        if(filtered.length === 0){
          proRows.innerHTML = '<tr><td colspan="6" style="padding:14px; color:var(--muted); font-weight:850;">Nu există proforme.</td></tr>';
          return;
        }
        filtered
          .slice()
          .sort((a,b)=> String(b.date||"").localeCompare(String(a.date||"")))
          .forEach(x=>{
            const c = x.client||{};
            const total = x.totals?.gross ?? 0;
            const statusFinal = (x.status === "FINALIZATA");
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td><b>${docNo(x.serie,x.number)}</b></td>
              <td>${x.date||""}</td>
              <td>${(c.name||"-")}</td>
              <td><b>${money(total)}</b> ${(x.currency||"RON")}</td>
              <td>
                <span class="status-pill">
                  <input type="checkbox" class="docStatus" data-key="proformas" data-id="${x.id}" ${statusFinal?"checked":""}>
                  <span>${statusFinal ? "Finalizată" : "În lucru"}</span>
                </span>
              </td>
              <td>
                <div class="doc-actions">
                  <button class="btn btn-ghost docEdit" type="button" data-kind="invoice" data-key="proformas" data-id="${x.id}">Modifică</button>
                  <button class="btn btn-primary docPdf" type="button" data-kind="invoice" data-key="proformas" data-id="${x.id}">PDF</button>
                </div>
              </td>
            `;
            proRows.appendChild(tr);
          });
      }

      function renderReceipts(){
        const q = (qs("#docsRcpSearch")?.value||"").trim().toLowerCase();
        const list = loadList("receipts");
        const filtered = !q ? list : list.filter(x=>{
          const p = x.partner||{};
          return (String(x.number||"")).toLowerCase().includes(q) ||
                 (p.name||"").toLowerCase().includes(q) ||
                 (p.cui||"").toLowerCase().includes(q);
        });

        rcpRows.innerHTML = "";
        if(filtered.length === 0){
          rcpRows.innerHTML = '<tr><td colspan="6" style="padding:14px; color:var(--muted); font-weight:850;">Nu există chitanțe.</td></tr>';
          return;
        }
        filtered
          .slice()
          .sort((a,b)=> String(b.date||"").localeCompare(String(a.date||"")))
          .forEach(x=>{
            const p = x.partner||{};
            const statusFinal = (x.status === "FINALIZATA");
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td><b>${(x.number||"")}</b></td>
              <td>${x.date||""}</td>
              <td>${(p.name||"-")}</td>
              <td><b>${money(x.amount||0)}</b> ${(x.currency||"RON")}</td>
              <td>
                <span class="status-pill">
                  <input type="checkbox" class="docStatus" data-key="receipts" data-id="${x.id}" ${statusFinal?"checked":""}>
                  <span>${statusFinal ? "Finalizată" : "În lucru"}</span>
                </span>
              </td>
              <td>
                <div class="doc-actions">
                  <button class="btn btn-ghost docEdit" type="button" data-kind="receipt" data-key="receipts" data-id="${x.id}">Modifică</button>
                  <button class="btn btn-primary docPdf" type="button" data-kind="receipt" data-key="receipts" data-id="${x.id}">PDF</button>
                </div>
              </td>
            `;
            rcpRows.appendChild(tr);
          });
      }

      // ---- Open list modals from DOCUMENTE menu ----
      const docsInvBackdrop = qs("#docsInvoicesBackdrop");
      const docsProBackdrop = qs("#docsProformasBackdrop");
      const docsRcpBackdrop = qs("#docsReceiptsBackdrop");

      function closeDrawerIfAny(){
        qs("#drawer")?.classList.remove("show");
        qs("#backdrop")?.classList.remove("show");
      }

      document.addEventListener("click", (e)=>{
        const a = e.target.closest && e.target.closest(".action");
        if(!a) return;
        const title = qs("#drawerTitle")?.textContent || "";
        const label = a.querySelector(".t")?.textContent || "";

        if(normalize(title) === normalize("DOCUMENTE")){
          if(normalize(label) === normalize("FACTURI")){
            closeDrawerIfAny();
            renderInvoices();
            openModal(docsInvBackdrop);
            e.preventDefault(); e.stopPropagation();
          }
          if(normalize(label) === normalize("FACTURI PROFORME")){
            closeDrawerIfAny();
            renderProformas();
            openModal(docsProBackdrop);
            e.preventDefault(); e.stopPropagation();
          }
          if(normalize(label) === normalize("CHITANTE")){
            closeDrawerIfAny();
            renderReceipts();
            openModal(docsRcpBackdrop);
            e.preventDefault(); e.stopPropagation();
          }
        }
      }, true);

      // Close buttons
      qs("#docsInvoicesClose").addEventListener("click", ()=>closeModal(docsInvBackdrop));
      qs("#docsInvCloseBottom").addEventListener("click", ()=>closeModal(docsInvBackdrop));
      docsInvBackdrop.addEventListener("click", (e)=>{ if(e.target===docsInvBackdrop) closeModal(docsInvBackdrop); });

      qs("#docsProformasClose").addEventListener("click", ()=>closeModal(docsProBackdrop));
      qs("#docsProCloseBottom").addEventListener("click", ()=>closeModal(docsProBackdrop));
      docsProBackdrop.addEventListener("click", (e)=>{ if(e.target===docsProBackdrop) closeModal(docsProBackdrop); });

      qs("#docsReceiptsClose").addEventListener("click", ()=>closeModal(docsRcpBackdrop));
      qs("#docsRcpCloseBottom").addEventListener("click", ()=>closeModal(docsRcpBackdrop));
      docsRcpBackdrop.addEventListener("click", (e)=>{ if(e.target===docsRcpBackdrop) closeModal(docsRcpBackdrop); });

      // Search + refresh
      qs("#docsInvRefresh").addEventListener("click", renderInvoices);
      qs("#docsProRefresh").addEventListener("click", renderProformas);
      qs("#docsRcpRefresh").addEventListener("click", renderReceipts);

      qs("#docsInvSearch").addEventListener("input", renderInvoices);
      qs("#docsProSearch").addEventListener("input", renderProformas);
      qs("#docsRcpSearch").addEventListener("input", renderReceipts);

      // ---- Status toggle + Edit + PDF actions (delegated) ----
      function updateStatus(key, id, final){
        const list = loadList(key);
        const idx = list.findIndex(x => String(x.id) === String(id));
        if(idx < 0) return;
        list[idx].status = final ? "FINALIZATA" : "IN_LUCRU";
        saveList(key, list);
      }

      document.addEventListener("change", (e)=>{
        const cb = e.target;
        if(!(cb && cb.classList && cb.classList.contains("docStatus"))) return;
        const key = cb.getAttribute("data-key");
        const id = cb.getAttribute("data-id");
        updateStatus(key, id, cb.checked);
        // refresh that table only
        if(key === "invoices") renderInvoices();
        if(key === "proformas") renderProformas();
        if(key === "receipts") renderReceipts();
      }, true);

      // ---- Edit document: open same modal as registration ----
      window.__editInvoiceId = null;
      window.__editReceiptId = null;
      window.__editDocKey = null; // invoices/proformas/receipts

      function fillInvoice(inv){
        // inv fields exist in main script; use DOM IDs
        const invClient = qs("#invClient");
        const invSerie = qs("#invSerie");
        const invNumber = qs("#invNumber");
        const invDate = qs("#invDate");
        const invDueDays = qs("#invDueDays");
        const invCurrency = qs("#invCurrency");
        const invFx = qs("#invFx");
        const invVatRate = qs("#invVatRate");
        const invLines = qs("#invLines");

        // Set mode/title using existing openInvoiceModal but we want keep existing id; call openInvoiceModal label by type
        // resetInvoiceForm exists globally in page scope; we'll call it if exists.
        if(typeof window.resetInvoiceForm === "function") window.resetInvoiceForm();

        // set mode and headings by calling openInvoiceModal-like behavior without clearing after we fill; easiest: call openInvoiceModal then fill.
      }

      function openInvoiceForEdit(key, rec){
        // call existing function to open, then fill
        const label = (key === "proformas") ? "FACTURA PROFORMA" : "FACTURA";
        if(typeof window.openInvoiceModal === "function"){
          window.openInvoiceModal(label);
        }else{
          // fallback: open backdrop
          const b = qs("#invoiceBackdrop"); if(b) openModal(b);
        }

        // Now fill values
        qs("#invSerie").value = rec.serie || "";
        qs("#invNumber").value = rec.number || "";
        qs("#invDate").value = rec.date || "";
        qs("#invDueDays").value = rec.dueDays ?? 0;
        qs("#invCurrency").value = rec.currency || "RON";
        qs("#invFx").value = rec.fx ?? 1;
        qs("#invVatRate").value = rec.vatRate ?? 0;

        // client selection
        const c = rec.client || null;
        const sel = qs("#invClient");
        if(sel){
          if(c && c.id){
            // ensure option exists
            let opt = [...sel.options].find(o => o.value === c.id);
            if(!opt){
              opt = document.createElement("option");
              opt.value = c.id;
              opt.textContent = c.name || ("Client " + c.id);
              sel.appendChild(opt);
            }
            sel.value = c.id;
          }else{
            sel.value = "";
          }
        }

        // lines
        const tbody = qs("#invLines");
        if(tbody){
          tbody.innerHTML = "";
          if(typeof window.addLineRow === "function"){
            (rec.lines||[]).forEach(l=> window.addLineRow(l));
          }
        }

        // totals recalc
        try{ window.recalcTotals && window.recalcTotals(); }catch{}

        // set editing state
        window.__editInvoiceId = rec.id;
        window.__editDocKey = key;

        // subtitle
        const sub = qs("#invoiceSubtitle");
        if(sub) sub.textContent = "Modificare document";
      }

      function openReceiptForEdit(rec){
        if(typeof window.openReceiptModal === "function"){
          window.openReceiptModal();
        }else{
          const b = qs("#receiptBackdrop"); if(b) openModal(b);
        }

        qs("#rcptNumber").value = rec.number || "";
        qs("#rcptDate").value = rec.date || "";
        qs("#rcptAmount").value = rec.amount ?? 0;
        qs("#rcptCurrency").value = rec.currency || "RON";
        qs("#rcptFx").value = rec.fx ?? 1;
        qs("#rcptAmountWords").value = rec.amountWords || "";
        qs("#rcptRepresentative").value = rec.representative || "";
        qs("#rcptHasVoucher").checked = !!rec.voucherId;
        qs("#rcptVoucher").value = rec.voucherId || "";

        // partner
        const p = rec.partner || {};
        qs("#rcptPartnerName").value = p.name || "";
        qs("#rcptPartnerCui").value = p.cui || "";
        qs("#rcptPartnerReg").value = p.reg || "";
        qs("#rcptPartnerAddr").value = p.address || "";

        // keep id
        window.__editReceiptId = rec.id;
        window.__editDocKey = "receipts";

        // title/subtitle if exist
        const t = qs("#receiptTitle");
        if(t) t.textContent = "Chitanță (Modificare)";
      }

      document.addEventListener("click", (e)=>{
        const btn = e.target.closest && e.target.closest(".docEdit, .docPdf");
        if(!btn) return;

        const key = btn.getAttribute("data-key");
        const id = btn.getAttribute("data-id");
        const kind = btn.getAttribute("data-kind");

        const list = loadList(key);
        const rec = list.find(x => String(x.id) === String(id));
        if(!rec) return;

        if(btn.classList.contains("docPdf")){
          if(kind === "invoice") pdfInvoice(rec);
          if(kind === "receipt") pdfReceipt(rec);
          e.preventDefault(); e.stopPropagation();
          return;
        }

        if(btn.classList.contains("docEdit")){
          if(kind === "invoice"){
            closeModal(key==="invoices"?docsInvBackdrop:docsProBackdrop);
            openInvoiceForEdit(key, rec);
          }else if(kind === "receipt"){
            closeModal(docsRcpBackdrop);
            openReceiptForEdit(rec);
          }
          e.preventDefault(); e.stopPropagation();
          return;
        }
      }, true);

      // ---- Override Save logic for Invoice & Receipt to support editing + default status + save into DOCUMENTE ----

      function loadDocSettings(){
        const s = get("docSettings", null);
        return s && typeof s === "object" ? s : null;
      }
      function bumpNext(kind){
        const s = loadDocSettings();
        if(!s) return;
        if(kind === "inv") s.inv.next = Math.max(1, (parseInt(s.inv.next,10)||1) + 1);
        if(kind === "pro") s.pro.next = Math.max(1, (parseInt(s.pro.next,10)||1) + 1);
        if(kind === "rcp") s.rcp.next = Math.max(1, (parseInt(s.rcp.next,10)||1) + 1);
        set("docSettings", s);
      }

      const btnSaveInvoice = qs("#btnSaveInvoice");
      if(btnSaveInvoice && !btnSaveInvoice.__fix25){
        btnSaveInvoice.__fix25 = true;
        btnSaveInvoice.addEventListener("click", (ev)=>{
          // IMPORTANT: keep modal open until next tick so FIX24 bump does NOT trigger
          ev.preventDefault();
          ev.stopPropagation();
          ev.stopImmediatePropagation();

          if(typeof window.gatherInvoicePayload !== "function"){
            alert("Eroare: gatherInvoicePayload lipsă.");
            return;
          }

          const payload = window.gatherInvoicePayload();
          if(!payload.serie || !String(payload.number).trim()){
            alert("Seria și numărul sunt obligatorii.");
            return;
          }

          // preserve id/status when editing
          const key = (payload.type === "FACTURA") ? "invoices" : "proformas";
          const list = loadList(key);

          if(window.__editInvoiceId){
            const idx = list.findIndex(x => String(x.id) === String(window.__editInvoiceId));
            if(idx >= 0){
              payload.id = list[idx].id;
              payload.status = list[idx].status || "IN_LUCRU";
            }else{
              payload.id = window.__editInvoiceId;
              payload.status = "IN_LUCRU";
            }
            window.__editInvoiceId = null;
          }else{
            payload.status = "IN_LUCRU";
          }

          upsert(list, payload);
          saveList(key, list);

          // bump numbering (only for new documents)
          if(!payload.__edited){
            bumpNext(payload.type === "FACTURA" ? "inv" : "pro");
          }

          // Close invoice modal next tick (so FIX24 won't bump)
          const invoiceBackdrop = qs("#invoiceBackdrop");
          setTimeout(()=>{ closeModal(invoiceBackdrop); }, 0);

          // Refresh lists if open
          setTimeout(()=>{
            if(docsInvBackdrop.classList.contains("show")) renderInvoices();
            if(docsProBackdrop.classList.contains("show")) renderProformas();
          }, 0);
        }, true);
      }

      const btnSaveReceipt = qs("#btnSaveReceipt");
      if(btnSaveReceipt && !btnSaveReceipt.__fix25){
        btnSaveReceipt.__fix25 = true;
        btnSaveReceipt.addEventListener("click", (ev)=>{
          ev.preventDefault();
          ev.stopPropagation();
          ev.stopImmediatePropagation();

          // We reconstruct payload similarly to original (but support edit/status)
          const rcptNumber = qs("#rcptNumber");
          const rcptDate = qs("#rcptDate");
          const rcptAmount = qs("#rcptAmount");
          const rcptCurrency = qs("#rcptCurrency");
          const rcptFx = qs("#rcptFx");
          const rcptAmountWords = qs("#rcptAmountWords");
          const rcptRepresentative = qs("#rcptRepresentative");
          const rcptHasVoucher = qs("#rcptHasVoucher");
          const rcptVoucher = qs("#rcptVoucher");
          const rcptPartnerName = qs("#rcptPartnerName");
          const rcptPartnerCui = qs("#rcptPartnerCui");
          const rcptPartnerReg = qs("#rcptPartnerReg");
          const rcptPartnerAddr = qs("#rcptPartnerAddr");
      let receiptSelectedPartner = null; // selected from typeahead


          const payload = {
            id: "RCPT-" + Math.random().toString(16).slice(2) + "-" + Date.now(),
            number: rcptNumber.value,
            date: rcptDate.value,
            unit: (typeof window.getUnit === "function") ? window.getUnit() : {},
            partner: {
              name: (rcptPartnerName.value||"").trim(),
              cui: (rcptPartnerCui.value||"").trim(),
              reg: (rcptPartnerReg.value||"").trim(),
              address: (rcptPartnerAddr.value||"").trim()
            },
            amount: Number(rcptAmount.value||0),
            currency: rcptCurrency.value,
            fx: Number(rcptFx.value||1),
            amountWords: rcptAmountWords.value,
            representative: (rcptRepresentative.value||"").trim(),
            voucherId: rcptHasVoucher.checked ? (rcptVoucher.value||"").trim() : ""
          };

          if(!String(payload.number||"").trim()){
            alert("Numărul chitanței este obligatoriu.");
            return;
          }
          if(!payload.partner.name){
            alert("Partenerul este obligatoriu.");
            return;
          }

          const list = loadList("receipts");
          if(window.__editReceiptId){
            const idx = list.findIndex(x => String(x.id) === String(window.__editReceiptId));
            if(idx >= 0){
              payload.id = list[idx].id;
              payload.status = list[idx].status || "IN_LUCRU";
            }else{
              payload.id = window.__editReceiptId;
              payload.status = "IN_LUCRU";
            }
            window.__editReceiptId = null;
          }else{
            payload.status = "IN_LUCRU";
            bumpNext("rcp");
          }

          upsert(list, payload);
          saveList("receipts", list);

          const receiptBackdrop = qs("#receiptBackdrop");
          setTimeout(()=>{ closeModal(receiptBackdrop); }, 0);

          setTimeout(()=>{
            if(docsRcpBackdrop.classList.contains("show")) renderReceipts();
          }, 0);

        }, true);
      }

    })();
    // ===== END FIX25 =====
  
    // FIX82: hook Internet buttons (CUI lookup)
    const _btnCuiLookup = document.getElementById("btnCuiLookup");
    if(_btnCuiLookup){
      _btnCuiLookup.addEventListener("click", ()=> handleCuiInternetClick({
        cuiSelector:"#cfCui",
        fill:(info)=>{
          // Societate config fields
          fillFieldsIfPresent({
            "#cfCui": info.cui,
            "#cfName": info.denumire,
            "#cfOrc": info.nrRegCom,
            "#cfPostal": info.codPostal,
            "#cfCity": info.localitate,
            "#cfCounty": info.judet,
            "#cfCountry": info.tara
          });
          // Address: if already structured in fields, compose a readable string for cfAddress
          const addr = (info.strada ? (info.strada + (info.nr ? (" " + info.nr) : "")) : info.adresa) || "";
          const more = info.detalii ? (" " + info.detalii) : "";
          fillFieldsIfPresent({ "#cfAddress": (addr + more).trim() });
        }
      }));
    }

    // Optional: if in your build you also have Internet buttons in Partner(Client/Furnizor) modal, they will work automatically:
    // - Button ids supported: btnPartnerCuiLookup / btnClientCuiLookup / btnSupplierCuiLookup
    [["btnPartnerCuiLookup","#pCui","#pName","#pReg","#pAddr"],
     ["btnClientCuiLookup","#cCui","#cName","#cReg","#cAddr"],
     ["btnSupplierCuiLookup","#cCui","#cName","#cReg","#cAddr"]].forEach(([bid,cuiSel,nameSel,regSel,addrSel])=>{
      const b = document.getElementById(bid);
      if(!b) return;
      b.addEventListener("click", ()=> handleCuiInternetClick({
        cuiSelector:cuiSel,
        fill:(info)=>{
          fillFieldsIfPresent({
            [cuiSel]: info.cui,
            [nameSel]: info.denumire,
            [regSel]: info.nrRegCom,
            [addrSel]: (info.adresa || "").trim()
          });
        }
      }));
    });
</script>


<script>
/* === PATCH: Configurare societate (salvare completa + eliminare localitate/judet/cod postal) + deschidere DOCUMENTE === */
(function(){
  const qs = (s,p=document)=>p.querySelector(s);
  const qsa = (s,p=document)=>Array.from(p.querySelectorAll(s));
  const norm = (s)=> (s||"").toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").trim().toUpperCase();

  // Storage (cu fallback in memorie daca localStorage e blocat)
  const _mem = window.__memStore || (window.__memStore = {});
  function getJSON(key, fallback){
    try{
      const raw = localStorage.getItem(key);
      return raw ? JSON.parse(raw) : fallback;
    }catch(e){
      try{ return _mem[key] ? JSON.parse(_mem[key]) : fallback; }catch(_e){ return fallback; }
    }
  }
  function setJSON(key, val){
    const raw = JSON.stringify(val);
    try{ localStorage.setItem(key, raw); }catch(e){ _mem[key] = raw; }
  }

  // Modal helpers (fallback daca nu exista openBackdrop)
  function openBackdrop(id){
    if(typeof window.openBackdrop === "function"){ window.openBackdrop(id); return; }
    const b = qs("#"+id);
    if(!b) return;
    b.classList.add("show");
    b.style.display = "flex";
    b.style.pointerEvents = "auto";
    b.setAttribute("aria-hidden","false");
    document.body.style.overflow = "hidden";
  }
  function closeBackdrop(id){
    if(typeof window.closeBackdrop === "function"){ window.closeBackdrop(id); return; }
    const b = qs("#"+id);
    if(!b) return;
    b.classList.remove("show");
    b.style.display = "";
    b.style.pointerEvents = "";
    b.setAttribute("aria-hidden","true");
    document.body.style.overflow = "";
  }
  function closeDrawer(){
    qs("#drawer")?.classList.remove("show");
    qs("#backdrop")?.classList.remove("show");
  }

  // 1) Eliminare campuri: Localitate / Judet / Cod postal (doar in Configurare societate)
  function removeCompanyLocationFields(){
    ["coCity","coCounty","coPostal"].forEach(id=>{
      const el = qs("#"+id);
      if(!el) return;
      const field = el.closest(".field");
      if(field) field.remove();
    });
  }

  // 2) Salvare completa configurare societate (toate campurile ramase)
  const COMPANY_FIELD_IDS = [
    "coName","coEntityType","coGestiune","coCui","coOrc","coCapital","coAddress","coCountry",
    "coIban","coBank","coWorkPoint","coPhone","coEmail"
  ];

  function readCompanyProfileFromForm(){
    const obj = {};
    COMPANY_FIELD_IDS.forEach(id=>{
      const el = qs("#"+id);
      if(!el) return;
      obj[id] = (el.value ?? "").toString().trim();
    });

    // Normalizare chei catre modelul folosit in restul aplicatiei
    const profile = {
      name: obj.coName || "",
      entityType: obj.coEntityType || "societate",
      gestiune: obj.coGestiune || "",
      cui: obj.coCui || "",
      reg: obj.coOrc || "",
      capital: obj.coCapital || "",
      address: obj.coAddress || "",
      country: obj.coCountry || "",
      iban: obj.coIban || "",
      bank: obj.coBank || "",
      workPoint: obj.coWorkPoint || "",
      phone: obj.coPhone || "",
      email: obj.coEmail || ""
    };
    return profile;
  }

  function fillCompanyForm(profile){
    const p = profile || {};
    if(qs("#coName")) qs("#coName").value = p.name || "";
    if(qs("#coEntityType")) qs("#coEntityType").value = p.entityType || "societate";
    if(qs("#coGestiune")) qs("#coGestiune").value = p.gestiune || "";
    if(qs("#coCui")) qs("#coCui").value = p.cui || "";
    if(qs("#coOrc")) qs("#coOrc").value = p.reg || "";
    if(qs("#coCapital")) qs("#coCapital").value = p.capital || "";
    if(qs("#coAddress")) qs("#coAddress").value = p.address || "";
    if(qs("#coCountry")) qs("#coCountry").value = p.country || "";
    if(qs("#coIban")) qs("#coIban").value = p.iban || "";
    if(qs("#coBank")) qs("#coBank").value = p.bank || "";
    if(qs("#coWorkPoint")) qs("#coWorkPoint").value = p.workPoint || "";
    if(qs("#coPhone")) qs("#coPhone").value = p.phone || "";
    if(qs("#coEmail")) qs("#coEmail").value = p.email || "";
  }

  function openCompanyConfig(){
    removeCompanyLocationFields();
    const saved = getJSON("companyProfile", null) || getJSON("unit", null) || {};
    fillCompanyForm(saved);
    openBackdrop("companyConfigBackdrop");
  }

  function wireCompanyConfigButtons(){
    const saveBtn = qs("#companyConfigSave");
    if(saveBtn && !saveBtn.__patched){
      saveBtn.__patched = true;
      saveBtn.addEventListener("click", ()=>{
        const profile = readCompanyProfileFromForm();
        setJSON("companyProfile", profile);
        // compat: unele zone citesc "unit"
        setJSON("unit", profile);
        // feedback discret daca exista toast helper
        if(typeof window.toast === "function") window.toast("Salvat.", "ok");
      });
    }

    const closeIds = ["companyConfigClose","companyConfigCancel"];
    closeIds.forEach(cid=>{
      const b = qs("#"+cid);
      if(b && !b.__patched){
        b.__patched = true;
        b.addEventListener("click", ()=>closeBackdrop("companyConfigBackdrop"));
      }
    });

    // Reset: doar golire campuri ramase
    const resetBtn = qs("#companyConfigReset");
    if(resetBtn && !resetBtn.__patched){
      resetBtn.__patched = true;
      resetBtn.addEventListener("click", ()=>{
        COMPANY_FIELD_IDS.forEach(id=>{
          const el = qs("#"+id);
          if(el) el.value = "";
        });
      });
    }
  }

  // 3) Asigura butonul in SETARI (daca lipseste)
  function ensureConfigButtonInSettings(){
    const grid = qs("#drawerGrid");
    const titleEl = qs("#drawerTitle");
    if(!grid || !titleEl) return;

    const title = norm(titleEl.textContent);
    if(title !== norm("SETARI")) return;

    const exists = qsa("button.action .t", grid).some(el => norm(el.textContent) === norm("CONFIGURARE SOCIETATE"));
    if(exists) return;

    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "action";
    btn.innerHTML = `
      <div class="i">
        <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 2a4 4 0 014 4v2h2a4 4 0 014 4v6a4 4 0 01-4 4H6a4 4 0 01-4-4v-6a4 4 0 014-4h2V6a4 4 0 014-4z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
          <path d="M9 8V6a3 3 0 016 0v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <div class="t">CONFIGURARE SOCIETATE</div>
      <div class="s">Date societate (furnizor)</div>
    `;
    grid.insertBefore(btn, grid.firstChild);
  }

  function observeDrawer(){
    const grid = qs("#drawerGrid");
    if(!grid) return;
    const mo = new MutationObserver(()=>ensureConfigButtonInSettings());
    mo.observe(grid, {childList:true, subtree:true});
  }



  // ---- NIR (Nota de receptie) ----
  const nirState = { lines: [], header: null };

  function nirTodayISO(){
    const d = new Date();
    const pad = (n)=>String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }

  function nirGetSettings(){
    const s = (typeof window.lsGet === "function") ? window.lsGet("nirSettings", null) : null;
    return s || { serie: "NIR_NR1", lastNumber: 0 };
  }
  function nirSetSettings(s){
    if(typeof window.lsSet === "function") window.lsSet("nirSettings", s);
  }
  function nirNextNumber(){
    const s = nirGetSettings();
    return Number(s.lastNumber || 0) + 1;
  }
  function nirAllocateDocNo(){
    const s = nirGetSettings();
    const serie = s.serie || "NIR_NR1";
    const number = nirNextNumber();
    const text = (typeof window.docNo === "function") ? window.docNo(serie, number) : `${serie}_${String(number).padStart(6,"0")}`;
    return { serie, number, text };
  }

  function nirLoadSuppliers(){
    return (typeof window.lsGet === "function") ? window.lsGet("gestiune_suppliers", []) : [];
  }
  function nirSaveSupplier(entry){
    const list = nirLoadSuppliers().slice();
    const normName = (entry.name||"").trim().toUpperCase();
    const idx = list.findIndex(x => (x && (x.name||"").trim().toUpperCase()) === normName);
    if(idx >= 0) list[idx] = { ...list[idx], ...entry };
    else list.unshift(entry);
    if(typeof window.lsSet === "function") window.lsSet("gestiune_suppliers", list);
  }

  function nirLoadProducts(){
    return (typeof window.lsGet === "function") ? window.lsGet("gestiune_products", []) : [];
  }
  function nirSaveProduct(p){
    const list = nirLoadProducts().slice();
    const normName = (p.name||"").trim().toUpperCase();
    const idx = list.findIndex(x => (x && (x.name||"").trim().toUpperCase()) === normName);
    if(idx >= 0) list[idx] = { ...list[idx], ...p };
    else list.unshift(p);
    if(typeof window.lsSet === "function") window.lsSet("gestiune_products", list);
  }

  function nirFillSupplierSelect(){
    const sel = qs("#nirSupplier");
    if(!sel) return;
    const list = nirLoadSuppliers();
    sel.innerHTML = '<option value="">Selectează furnizor…</option>' + list.map(s=>{
      const name = (s && s.name) ? String(s.name) : "";
      const cui = (s && s.cui) ? ` • ${s.cui}` : "";
      return `<option value="${name.replaceAll('"','&quot;')}">${name.replaceAll('<','&lt;')}${cui.replaceAll('<','&lt;')}</option>`;
    }).join("");
  }

  function nirUpdateVatInfo(){
    const our = qs("#nirVatOur")?.value || "19";
    const buy = qs("#nirVatBuy")?.value || "19";
    const vatInfo = `${our}% / ${buy}%`;
    const vatEl = qs("#nirLineVatInfo"); if(vatEl) vatEl.value = vatInfo;
  }
  function nirUpdateLineCurrency(){
    const cur = qs("#nirCurrency")?.value || "RON";
    const cEl = qs("#nirLineCurrency"); if(cEl) cEl.value = cur;
    const fx = qs("#nirFx");
    if(fx){
      if(cur === "RON"){ if(!fx.value || Number(fx.value) === 0) fx.value = "1"; }
      else { if(!fx.value || Number(fx.value) === 1) fx.value = ""; }
    }
  }  function nirSelectTab(key){
    const tabs = qsa('[data-nir-tab]');
    const panels = qsa('[data-nir-panel]');
    tabs.forEach(t=>{
      const k = t.getAttribute('data-nir-tab');
      t.classList.toggle('active', k===key);
    });
    panels.forEach(p=>{
      const k = p.getAttribute('data-nir-panel');
      p.classList.toggle('show', k===key);
    });
  }

  function nirFindSupplierByName(name){
    const n = (name||"").trim().toUpperCase();
    if(!n) return null;
    const list = nirLoadSuppliers();
    return list.find(s => (s.name||"").trim().toUpperCase() === n) || null;
  }

  function nirApplySupplierDetails(s){
    const cui = qs("#nirSupplierCui"); if(cui) cui.value = (s?.cui||"");
    const reg = qs("#nirSupplierReg"); if(reg) reg.value = (s?.reg||"");
    const addr = qs("#nirSupplierAddr"); if(addr) addr.value = (s?.address||"");
  }

  function nirRenderAttachments(){
    const tbody = qs("#nirAttachRows");
    if(!tbody) return;
    tbody.innerHTML = "";
    const list = (nirState.header && Array.isArray(nirState.header.attachments)) ? nirState.header.attachments : [];
    if(!list.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="2" style="padding:14px; color:var(--muted);">Nu există atașamente.</td>`;
      tbody.appendChild(tr);
      return;
    }
    list.forEach((fn, i)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${String(fn||"").replaceAll("<","&lt;")}</td>
        <td class="doc-actions">
          <button class="btn btn-danger" type="button" data-nir-att-del="${i}">Șterge</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }



  function nirRenderLines(){
    const tbody = qs("#nirLinesRows");
    if(!tbody) return;
    tbody.innerHTML = "";

    const currency = qs("#nirCurrency")?.value || "RON";
    const vatBuy = Number(qs("#nirVatBuy")?.value || 0);

    let totalFaraTVA = 0;

    if(!nirState.lines.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="10" style="padding:14px; color:var(--muted);">Nu există linii.</td>`;
      tbody.appendChild(tr);
    }else{
      nirState.lines.forEach((ln, i)=>{
        const qtyDoc = Number(ln.qtyDoc || 0);
        const qty = Number(ln.qty || 0);
        const buy = Number(ln.buy || 0);
        const sell = Number(ln.sell || 0);
        const valBuy = qty * buy;
        totalFaraTVA += valBuy;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${(ln.name||"").toString().replaceAll("<","&lt;")}</td>
          <td>${(ln.um||"").toString().replaceAll("<","&lt;")}</td>
          <td style="text-align:right;">${fmt(qtyDoc)}</td>
          <td style="text-align:right;">${fmt(qty)}</td>
          <td style="text-align:right;">${fmt(buy)}</td>
          <td style="text-align:right;">${fmt(valBuy)}</td>
          <td>${(ln.vatInfo||"").toString().replaceAll("<","&lt;")}</td>
          <td style="text-align:right;">${fmt(sell)}</td>
          <td class="doc-actions">
            <button class="btn btn-danger" type="button" data-nir-del="${i}">Șterge</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Totals (achiziție)
    const vatTotal = totalFaraTVA * (vatBuy/100);
    const grandTotal = totalFaraTVA + vatTotal;

    const t = qs("#nirTotal"); if(t) t.value = `${fmt(totalFaraTVA)} ${currency}`;
    const v = qs("#nirVatTotal"); if(v) v.value = `${fmt(vatTotal)} ${currency}`;
    const g = qs("#nirGrandTotal"); if(g) g.value = `${fmt(grandTotal)} ${currency}`;
  }



  function nirResetForm(){
    nirState.lines = [];
    nirState.header = { attachments: [] };

    nirFillSupplierSelect();
    nirRenderLines();
    nirUpdateVatInfo();
    nirUpdateLineCurrency();

    const d = nirAllocateDocNo();
    const no = qs("#nirDocNo"); if(no) no.value = d.text;

    const today = nirTodayISO();
    const dt = qs("#nirDocDate"); if(dt) dt.value = today;
    const dr = qs("#nirDateReceived"); if(dr) dr.value = today;

    const supName = qs("#nirSupplierName"); if(supName) supName.value = "";
    const gest = qs("#nirGestiune"); if(gest && !gest.value) gest.value = "";

    // clear supplier readonly details
    qs("#nirSupplierCui") && (qs("#nirSupplierCui").value = "");
    qs("#nirSupplierReg") && (qs("#nirSupplierReg").value = "");
    qs("#nirSupplierAddr") && (qs("#nirSupplierAddr").value = "");

    // operator default (if exists in local storage)
    const op = qs("#nirOperator");
    if(op && !op.value){
      const u = (typeof window.lsGet==="function") ? (window.lsGet("currentUser","")||"") : "";
      op.value = u;
    }

    // base doc defaults
    const bdt = qs("#nirBaseDocType"); if(bdt) bdt.value = "";
    const bdn = qs("#nirBaseDocNo"); if(bdn) bdn.value = "";
    const bdd = qs("#nirBaseDocDate"); if(bdd) bdd.value = "";
    const notes = qs("#nirNotes"); if(notes) notes.value = "";

    const mg = qs("#nirManagementName"); if(mg) mg.value = "";
    const c1 = qs("#nirComm1"); if(c1) c1.value = "";
    const c2 = qs("#nirComm2"); if(c2) c2.value = "";
    const c3 = qs("#nirComm3"); if(c3) c3.value = "";

    nirRenderAttachments();

    // keep number in state
    nirState.header.serie = d.serie;
    nirState.header.number = d.number;

    // default: first tab
    nirSelectTab("items");
  }



  function nirOpen(){
    try{ nirResetForm(); }
    catch(err){ console.error("NIR: nirResetForm failed", err); }
    openBackdrop("nirBackdrop");
  }
  function nirClose(){
    closeBackdrop("nirBackdrop");
  }

  function nirWire(){
    if(window.__nirWired) return;
    window.__nirWired = true;
    const b = qs("#nirBackdrop");
    if(!b) return;

    qs("#nirCloseTop")?.addEventListener("click", nirClose);
    qs("#nirCancel")?.addEventListener("click", nirClose);
    b.addEventListener("click", (e)=>{ if(e.target === b) nirClose(); });

    // Tabs
    qsa('[data-nir-tab]').forEach((t)=>{
      t.addEventListener('click', ()=>{
        const k = t.getAttribute('data-nir-tab');
        nirSelectTab(k);
      });
    });


    qs("#nirVatOur")?.addEventListener("change", ()=>{ nirUpdateVatInfo(); nirRenderLines(); });
    qs("#nirVatBuy")?.addEventListener("change", ()=>{ nirUpdateVatInfo(); nirRenderLines(); });
    qs("#nirCurrency")?.addEventListener("change", ()=>{ nirUpdateLineCurrency(); nirRenderLines(); });

    // Supplier: simple suggest/select
    const supName = qs("#nirSupplierName");
    const supSel = qs("#nirSupplier");
    if(supName && supSel){
      supName.addEventListener("input", ()=>{
        const q = supName.value.trim();
        if(q.length >= 3){
          nirFillSupplierSelect();
          const list = Array.from(supSel.options).slice(1).filter(o => o.value.toUpperCase().includes(q.toUpperCase()));
          if(list.length){
            // rebuild select with filtered list
            supSel.innerHTML = '<option value="">Selectează furnizor…</option>' + list.map(o=>`<option value="${o.value.replaceAll('"','&quot;')}">${o.text.replaceAll('<','&lt;')}</option>`).join("");
            supSel.style.display = "block";
          }else{
            supSel.style.display = "none";
          }
        }else{
          supSel.style.display = "none";
        }
      });
      supSel.addEventListener("change", ()=>{
        const v = supSel.value || "";
        if(v){ supName.value = v; const hit = nirFindSupplierByName(v); nirApplySupplierDetails(hit); }
        supSel.style.display = "none";
      });

      supName.addEventListener("blur", ()=>{
        const hit = nirFindSupplierByName(supName.value||"");
        nirApplySupplierDetails(hit);
      });

    }

    // Add / Internet supplier -> reuse client modal (existing)
    qs("#btnNirSupplierAdd")?.addEventListener("click", ()=>{
      if(typeof window.openClientModal !== "function"){ alert("Fereastra pentru furnizor nu este disponibilă."); return; }
      window.openClientModal({
        subtitle: "Furnizor (NIR)",
        onSave: (full)=>{
          const entry = { id: full.id, name: full.name||"", cui: full.cui||"", reg: full.orc||"", address: full.address||"" };
          nirSaveSupplier(entry);
          const s = qs("#nirSupplierName"); if(s) s.value = entry.name || ""; nirApplySupplierDetails(entry); nirApplySupplierDetails(entry);
          nirFillSupplierSelect();
        }
      });
    });
    qs("#btnNirSupplierInternet")?.addEventListener("click", ()=>{
      // in demo, Internet lives in fereastra de partener; deschidem aceea fereastra
      if(typeof window.openClientModal !== "function"){ alert("Fereastra pentru furnizor nu este disponibilă."); return; }
      window.openClientModal({
        subtitle: "Furnizor (NIR) – Internet",
        onSave: (full)=>{
          const entry = { id: full.id, name: full.name||"", cui: full.cui||"", reg: full.orc||"", address: full.address||"" };
          nirSaveSupplier(entry);
          const s = qs("#nirSupplierName"); if(s) s.value = entry.name || "";
          nirFillSupplierSelect();
        }
      });
      // user poate folosi butonul Internet în formularul partenerului
    });

    // Product add modal
    const pb = qs("#nirProductBackdrop");
    const closeProd = ()=>closeBackdrop("nirProductBackdrop");
    qs("#nirProductCloseTop")?.addEventListener("click", closeProd);
    qs("#btnNirProdCancel")?.addEventListener("click", closeProd);
    pb?.addEventListener("click", (e)=>{ if(e.target===pb) closeProd(); });

    qs("#btnNirAddProduct")?.addEventListener("click", ()=>{
      const name = qs("#nirLineName")?.value || "";
      qs("#nirProdName").value = name;
      // preset VAT from header
      const hv = qs("#nirVatOur")?.value || "19";
      qs("#nirProdVat").value = hv;
      openBackdrop("nirProductBackdrop");
      qs("#nirProdName")?.focus();
    });

    qs("#btnNirProdSave")?.addEventListener("click", ()=>{
      const name = (qs("#nirProdName")?.value || "").trim();
      if(!name){ alert("Denumirea produsului este obligatorie."); return; }
      const p = {
        id: Date.now(),
        name,
        um: qs("#nirProdUM")?.value || "buc.",
        vat: Number(qs("#nirProdVat")?.value || 19),
        buy: Number(qs("#nirProdBuy")?.value || 0),
        sell: Number(qs("#nirProdSell")?.value || 0),
      };
      nirSaveProduct(p);
      closeProd();

      // apply to current line
      const lnName = qs("#nirLineName"); if(lnName) lnName.value = p.name;
      const um = qs("#nirLineUM"); if(um) um.value = p.um;
      const buy = qs("#nirLineBuy"); if(buy) buy.value = String(p.buy||0);
      const sell = qs("#nirLineSell"); if(sell) sell.value = String(p.sell||0);
    });

    // Auto-fill line defaults when product matches
    qs("#nirLineName")?.addEventListener("blur", ()=>{
      const name = (qs("#nirLineName")?.value || "").trim();
      if(!name) return;
      const list = nirLoadProducts();
      const hit = list.find(p => (p.name||"").trim().toUpperCase() === name.toUpperCase());
      if(!hit) return;
      qs("#nirLineUM").value = hit.um || qs("#nirLineUM").value;
      qs("#nirLineBuy").value = String(Number(hit.buy||0));
      qs("#nirLineSell").value = String(Number(hit.sell||0));
    });

    // Add line
    qs("#btnNirAddLine")?.addEventListener("click", ()=>{
      const name = (qs("#nirLineName")?.value || "").trim();
      if(!name){ alert("Denumirea produsului este obligatorie."); return; }
      const um = qs("#nirLineUM")?.value || "buc.";
      const qty = Number(qs("#nirLineQty")?.value || 0);
      if(!(qty > 0)){ alert("Cantitatea trebuie să fie > 0."); return; }
      const buy = Number(qs("#nirLineBuy")?.value || 0);
      const sell = Number(qs("#nirLineSell")?.value || 0);
      const vatInfo = qs("#nirLineVatInfo")?.value || "";
      const currency = qs("#nirCurrency")?.value || "RON";
      const qtyDoc = Number(qs("#nirLineQtyDoc")?.value || 0);
      nirState.lines.push({ name, um, qtyDoc, qty, buy, sell, vatInfo, currency });
      nirRenderLines();
      // keep name, reset qty/prices lightly
      qs("#nirLineQty").value = "1";
      qs("#nirLineQtyDoc") && (qs("#nirLineQtyDoc").value = "0");
    });

    // Delete line
    qs("#nirLinesRows")?.addEventListener("click", (e)=>{
      const del = e.target.closest && e.target.closest("[data-nir-del]");
      if(!del) return;
      const i = Number(del.getAttribute("data-nir-del"));
      if(Number.isFinite(i)){
        nirState.lines.splice(i,1);
        nirRenderLines();
      }
    });

    // Attachments (demo: store only filenames)
    qs("#nirAttach")?.addEventListener("change", (e)=>{
      const files = Array.from(e.target.files || []).map(f=>f.name).filter(Boolean);
      if(!nirState.header) nirState.header = {};
      if(!Array.isArray(nirState.header.attachments)) nirState.header.attachments = [];
      files.forEach(fn=>{
        if(!nirState.header.attachments.includes(fn)) nirState.header.attachments.push(fn);
      });
      e.target.value = "";
      nirRenderAttachments();
    });

    qs("#nirAttachRows")?.addEventListener("click", (e)=>{
      const del = e.target.closest && e.target.closest("[data-nir-att-del]");
      if(!del) return;
      const i = Number(del.getAttribute("data-nir-att-del"));
      if(Number.isFinite(i) && nirState.header && Array.isArray(nirState.header.attachments)){
        nirState.header.attachments.splice(i,1);
        nirRenderAttachments();
      }
    });

    // Save
    qs("#btnNirSave")?.addEventListener("click", ()=>{
      const docNoText = qs("#nirDocNo")?.value || "";
      const docDate = qs("#nirDocDate")?.value || nirTodayISO();
      const supplierName = (qs("#nirSupplierName")?.value || "").trim();
      if(!supplierName){ alert("Furnizorul este obligatoriu."); return; }
      if(!nirState.lines.length){ alert("Adaugă cel puțin o linie."); return; }

      const currency = qs("#nirCurrency")?.value || "RON";
      const fx = Number(qs("#nirFx")?.value || (currency==="RON"?1:0));
      const vatOur = Number(qs("#nirVatOur")?.value || 19);
      const vatBuy = Number(qs("#nirVatBuy")?.value || 19);
      const gestiune = (qs("#nirGestiune")?.value || "").trim();
      const dateReceived = qs("#nirDateReceived")?.value || docDate;
      const operator = (qs("#nirOperator")?.value || "").trim();
      const baseDocType = (qs("#nirBaseDocType")?.value || "").trim();
      const baseDocNumber = (qs("#nirBaseDocNo")?.value || "").trim();
      const baseDocDate = qs("#nirBaseDocDate")?.value || "";
      const notes = (qs("#nirNotes")?.value || "").trim();
      const managementName = (qs("#nirManagementName")?.value || "").trim();
      const commission = [qs("#nirComm1")?.value||"", qs("#nirComm2")?.value||"", qs("#nirComm3")?.value||""].map(s=>String(s).trim()).filter(Boolean);
      const supplier = nirFindSupplierByName(supplierName) || { name: supplierName, cui: qs("#nirSupplierCui")?.value||"", reg: qs("#nirSupplierReg")?.value||"", address: qs("#nirSupplierAddr")?.value||"" };


            const totalFaraTVA = nirState.lines.reduce((s,ln)=> s + (Number(ln.qty||0) * Number(ln.buy||0)), 0);
      const vatTotal = totalFaraTVA * (vatBuy/100);
      const grandTotal = totalFaraTVA + vatTotal;

const doc = {
        id: Date.now(),
        kind: "nir",
        docNo: docNoText,
        serie: nirState.header?.serie || "NIR_NR1",
        number: nirState.header?.number || 0,
        date: docDate,
        supplier: supplier,
        currency,
        fx,
        vatOur,
        vatBuy,
        gestiune,
        dateReceived,
        operator,
        baseDoc: { type: baseDocType, number: baseDocNumber, date: baseDocDate },
        notes,
        managementName,
        commission: commission.slice(),
        totals: { totalFaraTVA, vatTotal, grandTotal },
        attachments: (nirState.header && Array.isArray(nirState.header.attachments)) ? nirState.header.attachments.slice() : [],
        lines: nirState.lines.slice(),
        createdAt: new Date().toISOString(),
      };

      const list = (typeof window.lsGet === "function") ? window.lsGet("nirDocs", []) : [];
      list.unshift(doc);
      if(typeof window.lsSet === "function") window.lsSet("nirDocs", list);

      // advance numbering
      const s = nirGetSettings();
      s.lastNumber = doc.number;
      nirSetSettings(s);

      nirClose();
    });

    // Init computed
    nirUpdateVatInfo();
    nirUpdateLineCurrency();
  }

  // 4) Click routing robust pentru SETARI + DOCUMENTE (nu modificam alte actiuni)
  document.addEventListener("click", (e)=>{
    const btn = e.target.closest("button.action");
    if(!btn) return;

    const label = btn.querySelector(".t") ? btn.querySelector(".t").textContent : btn.textContent;
    const L = norm(label);
    const T = norm(qs("#drawerTitle")?.textContent || "");

    // SETARI -> CONFIGURARE SOCIETATE
    if((T === norm("SETARI") && L === norm("CONFIGURARE SOCIETATE")) || L === norm("CONFIGURARE SOCIETATE")){
      e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
      closeDrawer();
      wireCompanyConfigButtons();
      openCompanyConfig();
      return;
    }

    

    // INREGISTRARE DOCUMENTE -> NOTA DE RECEPTIE (NIR)
    if(T === norm("INREGISTRARE DOCUMENTE")){
      if(L === norm("NOTA DE RECEPTIE")){
        e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
        closeDrawer();
        nirOpen();
        return;
      }
    }

// DOCUMENTE -> FACTURI / PROFORME / CHITANTE
    if(T === norm("DOCUMENTE")){
      if(L === norm("FACTURI")){
        e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
        closeDrawer();
        openBackdrop("docsInvoicesBackdrop");
        return;
      }
      if(L === norm("PROFORME") || L === norm("FACTURI PROFORME")){
        e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
        closeDrawer();
        openBackdrop("docsProformasBackdrop");
        return;
      }
      if(L === norm("CHITANTE")){
        e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
        closeDrawer();
        openBackdrop("docsReceiptsBackdrop");
        return;
      }
    }
  }, true);

  // init
  window.addEventListener("DOMContentLoaded", ()=>{
    removeCompanyLocationFields();
    wireCompanyConfigButtons();
    nirWire();
    observeDrawer();
  });

})();
</script>

  <!-- Produse si servicii (PRODUSE) -->
  <div class="modal-backdrop" id="productsBackdrop" aria-hidden="true">
    <div class="modal products-modal" role="dialog" aria-modal="true" aria-label="Produse si servicii">
      <div class="modal-head">
        <div>
          <div class="modal-title">Produse si servicii</div>
          <div class="modal-sub">Gestiune • Lista produse (demo)</div>
        </div>
        <button class="icon-btn" type="button" id="btnCloseProducts" title="Închide">✕</button>
      </div>

      <!-- Top filter row (ca in ForIT) -->
      <div class="products-topbar">
        <div class="pt-left">
          <label class="pt-lbl">Filtru:</label>
          <select id="prodFilterMode" class="pt-sel">
            <option value="contains">contine</option>
            <option value="starts">incepe cu</option>
          </select>
          <input id="prodFilterText" class="pt-inp" type="text" placeholder="" />
          <select id="prodFilterType" class="pt-sel">
            <option value="auto">Auto</option>
            <option value="name">Denumire</option>
            <option value="barcode">Cod de bare</option>
            <option value="code">Cod produs</option>
            <option value="desc">Descriere</option>
            <option value="cat">Categorie</option>
          </select>
          <select id="prodType" class="pt-sel">
            <option value="toate">toate</option>
            <option value="nespecificat">nespecificat</option>
            <option value="materie prima">materie prima</option>
            <option value="alte materiale">alte materiale</option>
            <option value="produs finit">produs finit</option>
            <option value="marfa">marfa</option>
            <option value="obiect de inv.">obiect de inv.</option>
            <option value="ambalaje">ambalaje</option>
            <option value="semifabricate">semifabricate</option>
            <option value="reziduale">reziduale</option>
            <option value="consumabile">consumabile</option>
            <option value="servicii">servicii</option>
          </select>
        </div>

        <div class="pt-right">
          <button class="icon-btn" type="button" id="btnProdNew" title="Inregistrare produs nou">➕</button>
          <button class="icon-btn" type="button" id="btnProdPrintList" title="Tiparire lista produse">🖨</button>
          <button class="icon-btn" type="button" id="btnProdLabels" title="Tiparire etichete">🏷</button>
          <button class="icon-btn" type="button" id="btnProdExportLabels" title="Export etichete">⬇</button>
          <button class="icon-btn" type="button" id="btnProdPvmp" title="Proces verbal modificare preturi">💲</button>
          <button class="icon-btn" type="button" id="btnProdInventar" title="Proces verbal inventariere">📋</button>
          <button class="icon-btn" type="button" id="btnProdCat" title="Setare categorie/departament (multi)">🧩</button>
          <button class="icon-btn" type="button" id="btnProdRefresh" title="Actualizare lista">⟳</button>
        </div>
      </div>

      <!-- Main grid -->
      <div class="products-body">
        <div class="products-table-wrap">
          <table class="tbl products-tbl" id="productsTable">
            <thead>
              <tr>
                <th style="width:28px;"></th>
                <th style="width:44px;"></th>
                <th>Denumire</th>
                <th style="width:70px;">U.M.</th>
                <th style="width:90px;">Cod</th>
                <th style="width:150px;">Cod de bare</th>
                <th style="width:110px;">Pret Amnt.</th>
                <th style="width:70px;">TVA%</th>
                <th style="width:120px;">Clasificare</th>
                <th style="width:80px;">Adaos</th>
                <th style="width:140px;">Categorie</th>
                <th style="width:140px;">Departament</th>
              </tr>
            </thead>
            <tbody id="productsTbody"></tbody>
          </table>
        </div>

        <!-- Bottom info + tabs -->
        <div class="products-bottom">
          <div class="prod-livebar" id="prodLiveBar">—</div>

          <div class="prod-bottom-grid">
            <div class="prod-left">
              <div class="prod-pricebox" id="prodPriceBox">0.00</div>
              <div class="prod-stock">
                <div><b>Stoc curent:</b> <span id="prodStock">0.00</span></div>
                <div><b>U.M.:</b> <span id="prodUm">—</span></div>
                <button class="btn secondary" type="button" id="btnProdRaport">Raport extins…</button>
              </div>
            </div>

            <div class="prod-tabs">
              <div class="tabs" id="prodTabs">
                <button type="button" class="tab active" data-tab="hist">Istoric</button>
                <button type="button" class="tab" data-tab="pp">Evolutia pretului de achizitie</button>
                <button type="button" class="tab" data-tab="sp">Evolutia pretului de vanzare</button>
                <button type="button" class="tab" data-tab="sales">Evolutia vanzarilor</button>
                <button type="button" class="tab" data-tab="other">Alte informatii</button>
              </div>

              <div class="tabpanels">
                <div class="tabpanel show" data-tabpanel="hist">
                  <div class="prod-subhdr">
                    <div><b>Ultimul furnizor:</b> <span id="prodLastSupplier">—</span></div>
                    <div class="muted" id="prodLastSupplierInfo"></div>
                  </div>
                  <table class="tbl small">
                    <thead>
                      <tr>
                        <th style="width:110px;">Intr./iesire</th>
                        <th style="width:110px;">Data</th>
                        <th style="width:110px;">Nr. doc.</th>
                        <th style="width:120px;">Doc.</th>
                        <th>Partener</th>
                        <th style="width:90px;">Cant.</th>
                        <th style="width:90px;">Stoc</th>
                      </tr>
                    </thead>
                    <tbody id="prodHistBody">
                      <tr><td colspan="7" class="muted" style="text-align:center;padding:14px;">Istoric (demo)</td></tr>
                    </tbody>
                  </table>
                </div>

                <div class="tabpanel" data-tabpanel="pp">
                  <div class="muted" style="padding:12px;">Evolutia pretului de achizitie (demo)</div>
                </div>
                <div class="tabpanel" data-tabpanel="sp">
                  <div class="muted" style="padding:12px;">Evolutia pretului de vanzare (demo)</div>
                </div>
                <div class="tabpanel" data-tabpanel="sales">
                  <div class="muted" style="padding:12px;">Evolutia vanzarilor (demo)</div>
                </div>
                <div class="tabpanel" data-tabpanel="other">
                  <div class="muted" style="padding:12px;">Alte informatii (demo)</div>
                </div>
              </div>
            </div>
          </div>

          <div class="prod-footer">
            <div id="prodCount">Produse in lista: 0</div>
          </div>
        </div>
      </div>
    </div>
  </div>


<script>
/* PRODUSE: tooltip pe iconite (hover/long-press) - patch minimal */
(function(){
  function ensureTip(){
    var tip = document.getElementById('prodIconTip');
    if(tip) return tip;
    tip = document.createElement('div');
    tip.id = 'prodIconTip';
    tip.setAttribute('role','tooltip');
    tip.style.position = 'fixed';
    tip.style.zIndex = '99999';
    tip.style.pointerEvents = 'none';
    tip.style.padding = '6px 10px';
    tip.style.borderRadius = '10px';
    tip.style.background = 'rgba(15,15,18,.92)';
    tip.style.color = '#fff';
    tip.style.font = '700 12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial';
    tip.style.boxShadow = '0 12px 30px rgba(0,0,0,.25)';
    tip.style.opacity = '0';
    tip.style.transform = 'translateY(4px)';
    tip.style.transition = 'opacity .12s ease, transform .12s ease';
    document.body.appendChild(tip);
    return tip;
  }

  function posTip(tip, x, y){
    var pad = 14;
    var left = x + pad;
    var top  = y + pad;
    tip.style.left = left + 'px';
    tip.style.top  = top  + 'px';
  }

  function attach(){
    var backdrop = document.getElementById('productsBackdrop');
    if(!backdrop) return;

    // doar iconitele din PRODUSE (nu afectam restul aplicatiei)
    var buttons = backdrop.querySelectorAll('.pt-right .icon-btn');
    if(!buttons || !buttons.length) return;

    var tip = ensureTip();
    var hideT = null;

    function show(e, text){
      if(!text) return;
      if(hideT){ clearTimeout(hideT); hideT=null; }
      tip.textContent = text;
      tip.style.opacity = '1';
      tip.style.transform = 'translateY(0)';
      var cx = (e && (e.clientX || (e.touches && e.touches[0] && e.touches[0].clientX))) || 0;
      var cy = (e && (e.clientY || (e.touches && e.touches[0] && e.touches[0].clientY))) || 0;
      posTip(tip, cx, cy);
    }
    function move(e){
      var cx = (e && (e.clientX || (e.touches && e.touches[0] && e.touches[0].clientX))) || 0;
      var cy = (e && (e.clientY || (e.touches && e.touches[0] && e.touches[0].clientY))) || 0;
      posTip(tip, cx, cy);
    }
    function hide(){
      tip.style.opacity = '0';
      tip.style.transform = 'translateY(4px)';
    }

    buttons.forEach(function(btn){
      // fallback label: aria-label -> title -> text
      var label = btn.getAttribute('aria-label') || btn.getAttribute('title') || '';
      if(label){
        btn.setAttribute('aria-label', label);
        btn.setAttribute('title', label); // pastreaza si tooltip-ul nativ
      }
      btn.addEventListener('mouseenter', function(e){ show(e, label); });
      btn.addEventListener('mousemove', move);
      btn.addEventListener('mouseleave', hide);
      btn.addEventListener('focus', function(e){ show(e, label); });
      btn.addEventListener('blur', hide);

      // Mobile: long-press/press (fara sa blocam click)
      btn.addEventListener('touchstart', function(e){
        show(e, label);
        if(hideT){ clearTimeout(hideT); }
        hideT = setTimeout(hide, 1200);
      }, {passive:true});
      btn.addEventListener('touchmove', move, {passive:true});
      btn.addEventListener('touchend', function(){ if(hideT){ clearTimeout(hideT); } hideT = setTimeout(hide, 200); }, {passive:true});
    });
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', attach);
  } else {
    attach();
  }

  // re-attach doar pana cand legam o data (evitam atasari infinite)
  var attachedOnce = false;
  function safeAttach(){
    try{
      attach();
      // daca exista toolbar-ul si am marcat macar un buton, ne oprim
      var backdrop = document.getElementById("productsBackdrop");
      if(backdrop && backdrop.querySelector(".pt-right .icon-btn[data-prod-tip-bound=\"1\"]")){
        attachedOnce = true;
      }
    }catch(e){}
    if(attachedOnce && mo){ try{ mo.disconnect(); }catch(e){} }
  }

  var mo = new MutationObserver(function(){
    if(attachedOnce) return;
    // ruleaza doar cand apare backdrop-ul (nu pe fiecare modificare de text)
    if(document.getElementById("productsBackdrop")){
      safeAttach();
    }
  });
  mo.observe(document.documentElement, {childList:true, subtree:true});
})();
</script>

<!-- Product Editor Modal (INREGISTRARE / EDITARE PRODUS) -->
<div class="modal-backdrop" id="productEditBackdrop" aria-hidden="true">
  <div class="modal productedit-modal" role="dialog" aria-modal="true" aria-label="Proprietatile produsului sau a serviciului">
    <div class="modal-head">
      <div>
        <div class="modal-title">Proprietatile produsului sau a serviciului</div>
        <div class="modal-sub">Inregistrare / modificare produs (demo UI)</div>
      </div>
      <button class="icon-btn" type="button" id="btnCloseProdEdit" title="Închide">✕</button>
    </div>

    <div class="tabs" id="prodEditTabs" style="padding:10px 12px 0;">
      <button type="button" class="tab active" data-tab="general">General</button>
      <button type="button" class="tab" data-tab="retetar">Retetar</button>
      <button type="button" class="tab" data-tab="auxiliare">Auxiliare</button>
      <button type="button" class="tab" data-tab="disponibilitate">Disponibilitate</button>
      <button type="button" class="tab" data-tab="furnizori">Furnizori</button>
      <button type="button" class="tab" data-tab="imagini">Imagini</button>
      <button type="button" class="tab" data-tab="avansat">Avansat</button>
      <button type="button" class="tab" data-tab="attobs">Att./Obs.</button>
    </div>

    <div class="modal-body prodedit-body">
      <!-- GENERAL -->
      <div class="tab-panel active" data-panel="general">
        <div class="pe-stack">
          <div class="pe-card">
            <div class="pe-card-title">Informatii generale despre produs/serviciu</div>
            <div class="pe-grid">
          <div class="pe-field span-6">
            <label>Denumire:</label>
            <input id="peName" type="text" />
          </div>

          <div class="pe-field span-3">
            <label>U.M.:</label>
            <input id="peUM" type="text" />
          </div>

          <div class="pe-field span-3">
            <label>Gramaj:</label>
            <input id="peGramaj" type="number" step="0.001" />
          </div>

          <div class="pe-field span-3">
            <label>U.M. 2:</label>
            <input id="peUM2" type="text" />
          </div>

          <div class="pe-field span-4">
            <label>Categoria:</label>
            <input id="peCategory" type="text" />
          </div>

          <div class="pe-field span-4">
            <label>Dept.:</label>
            <input id="peDepartment" type="text" />
          </div>

          <div class="pe-field span-12">
            <label>Descriere:</label>
            <textarea id="peDesc" rows="4"></textarea>
          </div>

          <div class="pe-field span-6 pe-inline">
            <label class="chk">
              <input id="peTransfGramaj" type="checkbox" />
              Transformare pe baza gramajului
            </label>
          </div>

          <div class="pe-field span-6"></div>

          <div class="pe-field span-4">
            <label>Clasificare:</label>
            <select id="peClasif">
              <option value="nespecificat">nespecificat</option>
              <option value="materie prima">materie prima</option>
              <option value="alte materiale">alte materiale</option>
              <option value="produs finit">produs finit</option>
              <option value="marfa" selected>marfa</option>
              <option value="obiect de inv.">obiect de inv.</option>
              <option value="ambalaje">ambalaje</option>
              <option value="semifabricate">semifabricate</option>
              <option value="reziduale">reziduale</option>
              <option value="consumabile">consumabile</option>
              <option value="servicii">servicii</option>
            </select>
          </div>

          <div class="pe-field span-3 pe-inline">
            <label class="chk">
              <input id="peIsService" type="checkbox" />
              Servicii
            </label>
          </div>

          <div class="pe-field span-5">
            <label>Amb. SGR:</label>
            <select id="peAmbSgr">
              <option value="">&lt;fara&gt;</option>
              <option value="da">da</option>
              <option value="nu">nu</option>
            </select>
          </div>

          <div class="pe-field span-4 pe-inline">
            <label class="chk">
              <input id="peMonitorMin" type="checkbox" checked />
              Monitorizare stoc minim:
            </label>
          </div>

          <div class="pe-field span-2">
            <label>&nbsp;</label>
            <input id="peMinStock" type="number" step="0.01" />
          </div>

          <div class="pe-field span-3">
            <label>Stoc optim:</label>
            <input id="peStocOptim" type="number" step="0.01" />
          </div>

          <div class="pe-field span-3">
            <label>Stoc maxim:</label>
            <input id="peStocMax" type="number" step="0.01" />
          </div>
        </div>
          </div>

          <div class="pe-card">
            <div class="pe-card-title">Codurile produsului</div>
            <div class="pe-grid">
          <div class="pe-field span-6">
            <label>Cod de bare:</label>
            <div class="pe-row">
              <input id="peBarcode" type="text" />
              <button type="button" class="btn" id="btnGenBarcode" title="Genereaza cod de bare">▦</button>
              <button type="button" class="btn" id="btnPrintBarcode" title="Tipareste cod de bare">🖨️</button>
            </div>
          </div>

          <div class="pe-field span-3">
            <label>Cod:</label>
            <input id="peCode" type="text" />
          </div>

          <div class="pe-field span-3">
            <label>SKU:</label>
            <input id="peSKU" type="text" />
          </div>

          <div class="pe-field span-3">
            <label>Cota TVA:</label>
            <select id="peVAT">
              <option value="0">0</option>
              <option value="5">5</option>
              <option value="9">9</option>
              <option value="19" selected>19</option>
            </select>
          </div>

          <div class="pe-field span-3">
            <label>Pret vanzare:</label>
            <input id="pePriceRetail" type="number" step="0.01" />
          </div>

          <div class="pe-field span-3">
            <label>Fara TVA:</label>
            <input id="pePriceNet" type="text" readonly />
          </div>

          <div class="pe-field span-3">
            <label>TVA inclus:</label>
            <input id="pePriceGross" type="text" readonly />
          </div>

          <div class="pe-field span-4 pe-inline">
            <label class="chk">
              <input id="pePretFacturare" type="checkbox" checked />
              Pret facturare
            </label>
          </div>

          <div class="pe-field span-4 pe-inline">
            <label class="chk">
              <input id="peCantar" type="checkbox" />
              Cantar
            </label>
          </div>
        </div>
          </div>
        </div>
      </div>

      <!-- Placeholder panels -->
      <div class="tab-panel" data-panel="retetar">
        <div class="pe-empty">Retetar (demo)</div>
      </div>
      <div class="tab-panel" data-panel="auxiliare">
        <div class="pe-empty">Auxiliare (demo)</div>
      </div>
      <div class="tab-panel" data-panel="disponibilitate">
        <div class="pe-empty">Disponibilitate (demo)</div>
      </div>
      <div class="tab-panel" data-panel="furnizori">
        <div class="pe-empty">Furnizori (demo)</div>
      </div>
      <div class="tab-panel" data-panel="imagini">
        <div class="pe-empty">Imagini (demo)</div>
      </div>
      <div class="tab-panel" data-panel="avansat">
        <div class="pe-empty">Avansat (demo)</div>
      </div>
      <div class="tab-panel" data-panel="attobs">
        <div class="pe-empty">Atasamente / Observatii (demo)</div>
      </div>
    </div>

    <div class="modal-foot">
      <button class="btn" type="button" id="btnProdEditSave">Salveaza</button>
      <button class="btn secondary" type="button" id="btnProdEditCancel">Renunta</button>
    </div>
  </div>
</div>


<script>
/* FIX: bind "Inregistrare produs nou" (+) after DOM exists (nu atinge alta logica) */
(function(){
  function bindProdNew(){
    var btn = document.getElementById('btnProdNew');
    if(!btn || btn.__boundProdNew) return;
    btn.__boundProdNew = true;
    btn.addEventListener('click', function(e){
      e.preventDefault();
      e.stopPropagation();
      try{
        if(typeof window.openProductEditor === 'function'){
          window.openProductEditor(null);
        }
      }catch(_){}
    }, {passive:false});
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', bindProdNew, {once:true});
  } else {
    bindProdNew();
  }
})();
</script>

<script>
/* PROD: delegated open for 'Inregistrare produs nou' (handles duplicate IDs + late DOM) */
(function(){
  function handler(e){
    var btn = e.target && e.target.closest ? e.target.closest('button#btnProdNew') : null;
    if(!btn) return;
    // only within Produse modal
    var bd = btn.closest ? btn.closest('.modal-backdrop') : null;
    if(!bd || bd.id !== 'productsBackdrop') return;
    if(typeof window.__openProductEditor === 'function'){
      try{ e.preventDefault(); e.stopPropagation(); }catch(_){}
      try{ window.__openProductEditor(null); }catch(err){ console.error(err); }
    }
  }
  document.addEventListener('click', handler, true);
})();
</script>


<script>
/* PATCH: PRODUSE -> Inregistrare produs nou (fallback click binding, fara alte schimbari) */
(function(){
  function fallbackOpenProductEditor(){
    var bd = document.getElementById('productEditBackdrop');
    if(!bd) return;
    bd.classList.add('show');
    bd.setAttribute('aria-hidden','false');
    document.body.style.overflow = 'hidden';
  }

  // delegated capture listener so it works even if other bindings fail
  document.addEventListener('click', function(ev){
    var t = ev.target;
    if(!t || !t.closest) return;
    var btn = t.closest('#btnProdNew');
    if(!btn) return;

    ev.preventDefault();
    ev.stopPropagation();

    try{
      if(typeof window.openProductEditor === 'function'){
        window.openProductEditor(null);
      }else if(typeof window.__openProductEditor === 'function'){
        window.__openProductEditor(null);
      }else{
        fallbackOpenProductEditor();
      }
    }catch(err){
      try{ console.error(err); }catch(_){}
      fallbackOpenProductEditor();
    }
  }, true);

  // expose existing implementation if it's in local scope (best-effort)
  try{
    if(typeof openProductEditor === 'function' && typeof window.openProductEditor !== 'function'){
      window.openProductEditor = openProductEditor;
    }
  }catch(_){}
})();
</script>

</body>
</html>
